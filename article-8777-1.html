<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Samba 系列（十四）：在命令行中将 CentOS 7 与 Samba4 AD 集成 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="Samba 系列（十四）：在命令行中将 CentOS 7 与 Samba4 AD 集成"><meta property="og:description" content="本指南将向你介绍如何使用 Authconfig 在命令行中将无图形界面的 CentOS 7 服务器集成到 Samba4 AD 域控制器中。"><meta property="og:type" content="article"><meta property="og:url" content="/article-8777-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-08-14T17:58:03+00:00"><meta property="article:modified_time" content="2017-08-14T17:58:03+00:00"><meta itemprop=name content="Samba 系列（十四）：在命令行中将 CentOS 7 与 Samba4 AD 集成"><meta itemprop=description content="本指南将向你介绍如何使用 Authconfig 在命令行中将无图形界面的 CentOS 7 服务器集成到 Samba4 AD 域控制器中。"><meta itemprop=datePublished content="2017-08-14T17:58:03+00:00"><meta itemprop=dateModified content="2017-08-14T17:58:03+00:00"><meta itemprop=wordCount content="561"><meta itemprop=keywords content="Samba,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Samba 系列（十四）：在命令行中将 CentOS 7 与 Samba4 AD 集成</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2017-08-14T17:58:03Z>August 14, 2017</time></div></div></header><div class="content post__content clearfix"><p><img src=/data/attachment/album/201708/14/175556fx2zo3er3vxuumun.jpg alt></p><p>本指南将向你介绍如何使用 Authconfig 在命令行中将无图形界面的 CentOS 7 服务器集成到 <a href=/article-8065-1.html>Samba4 AD 域控制器</a>中。</p><p>这类设置提供了由 Samba 持有的单一集中式帐户数据库，允许 AD 用户通过网络基础设施对 CentOS 服务器进行身份验证。</p><h4 id=要求>要求</h4><ol><li><a href=/article-8065-1.html>在 Ubuntu 上使用 Samba4 创建 AD 基础架构</a></li><li><a href=/article-8048-1.html>CentOS 7.3 安装指南</a></li></ol><h3 id=步骤-1为-samba4-ad-dc-配置-centos>步骤 1：为 Samba4 AD DC 配置 CentOS</h3><p>1、 在开始将 CentOS 7 服务器加入 Samba4 DC 之前，你需要确保网络接口被正确配置为通过 DNS 服务查询域。</p><p>运行 <code>ip address</code> 命令列出你机器网络接口，选择要编辑的特定网卡，通过针对接口名称运行 <code>nmtui-edit</code> 命令（如本例中的 ens33），如下所示。</p><pre tabindex=0><code># ip address
# nmtui-edit ens33
</code></pre><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/List-Network-Interfaces.jpg><img src=/data/attachment/album/201708/14/175810uz3uwc1iw2r21i92.jpg alt="List Network Interfaces"></a></p><p><em>列出网络接口</em></p><p>2、 打开网络接口进行编辑后，添加最适合 LAN 的静态 IPv4 配置，并确保为 DNS 服务器设置 Samba AD 域控制器 IP 地址。</p><p>另外，在搜索域中追加你的域的名称，并使用 [TAB] 键跳到确定按钮来应用更改。</p><p>当你仅对域 dns 记录使用短名称时, 已提交的搜索域保证域对应项会自动追加到 dns 解析 (FQDN) 中。</p><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/Configure-Network-Interface.png><img src=/data/attachment/album/201708/14/175810sgkfhckg6vkovjph.png alt="Configure Network Interface"></a></p><p><em>配置网络接口</em></p><p>3、最后，重启网络守护进程以应用更改，并通过对域名和域控制器 ping 来测试 DNS 解析是否正确配置，如下所示。</p><pre tabindex=0><code># systemctl restart network.service
# ping -c2 tecmint.lan
# ping -c2 adc1
# ping -c2 adc2
</code></pre><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/Verify-DNS-Resolution-on-Domain.png><img src=/data/attachment/album/201708/14/175810akrfkkok620r2jz3.png alt="Verify DNS Resolution on Domain"></a></p><p><em>验证域上的 DNS 解析</em></p><p>4、 另外，使用下面的命令配置你的计算机主机名并重启机器应用更改。</p><pre tabindex=0><code># hostnamectl set-hostname your_hostname
# init 6
</code></pre><p>使用以下命令验证主机名是否正确配置。</p><pre tabindex=0><code># cat /etc/hostname
# hostname
</code></pre><p>5、 最后，使用 root 权限运行以下命令，与 Samba4 AD DC 同步本地时间。</p><pre tabindex=0><code># yum install ntpdate
# ntpdate domain.tld
</code></pre><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/Sync-Time-with-Samba4-AD-DC.png><img src=/data/attachment/album/201708/14/175811b9963uhbsywwbw96.png alt="Sync Time with Samba4 AD DC"></a></p><p><em>与 Samba4 AD DC 同步时间</em></p><h3 id=步骤-2将-centos-7-服务器加入到-samba4-ad-dc>步骤 2：将 CentOS 7 服务器加入到 Samba4 AD DC</h3><p>6、 要将 CentOS 7 服务器加入到 Samba4 AD 中，请先用具有 root 权限的帐户在计算机上安装以下软件包。</p><pre tabindex=0><code># yum install authconfig samba-winbind samba-client samba-winbind-clients
</code></pre><p>7、 为了将 CentOS 7 服务器与域控制器集成，可以使用 root 权限运行 <code>authconfig-tui</code>，并使用下面的配置。</p><pre tabindex=0><code># authconfig-tui
</code></pre><p>首屏选择：</p><ul><li>在 User Information 中：<ul><li>Use Winbind</li></ul></li><li>在 Authentication 中使用[空格键]选择:<ul><li>Use Shadow Password</li><li>Use Winbind Authentication</li><li>Local authorization is sufficient</li></ul></li></ul><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/Authentication-Configuration.png><img src=/data/attachment/album/201708/14/175812n2nm84lmmh7jc8jc.png alt="Authentication Configuration"></a></p><p><em>验证配置</em></p><p>8、 点击 Next 进入 Winbind 设置界面并配置如下：</p><ul><li>Security Model: ads</li><li>Domain = YOUR_DOMAIN (use upper case)</li><li>Domain Controllers = domain machines FQDN (comma separated if more than one)</li><li>ADS Realm = YOUR_DOMAIN.TLD</li><li>Template Shell = /bin/bash</li></ul><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/Winbind-Settings.png><img src=/data/attachment/album/201708/14/175812vlssskbsyzqdssd7.png alt="Winbind Settings"></a></p><p><em>Winbind 设置</em></p><p>9、 要加入域，使用 [tab] 键跳到 “Join Domain” 按钮，然后按[回车]键加入域。</p><p>在下一个页面，添加具有提升权限的 Samba4 AD 帐户的凭据，以将计算机帐户加入 AD，然后单击 “OK” 应用设置并关闭提示。</p><p>请注意，当你输入用户密码时，凭据将不会显示在屏幕中。在下面再次点击 OK，完成 CentOS 7 的域集成。</p><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/Join-Domain-to-Samba4-AD-DC.png><img src=/data/attachment/album/201708/14/175814ma11plvh00hapu6b.png alt="Join Domain to Samba4 AD DC"></a></p><p><em>加入域到 Samba4 AD DC</em></p><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/Confirm-Winbind-Settings.png><img src=/data/attachment/album/201708/14/175814r7558a8aamhmb7bt.png alt="Confirm Winbind Settings"></a></p><p><em>确认 Winbind 设置</em></p><p>要强制将机器添加到特定的 Samba AD OU 中，请使用 hostname 命令获取计算机的完整名称，并使用机器名称在该 OU 中创建一个新的计算机对象。</p><p>将新对象添加到 Samba4 AD 中的最佳方法是已经集成到<a href=/article-8097-1.html>安装了 RSAT 工具</a>的域的 Windows 机器上使用 ADUC 工具。</p><p>重要：加入域的另一种方法是使用 <code>authconfig</code> 命令行，它可以对集成过程进行广泛的控制。</p><p>但是，这种方法很容易因为其众多参数造成错误，如下所示。该命令必须输入一条长命令行。</p><pre tabindex=0><code># authconfig --enablewinbind --enablewinbindauth --smbsecurity ads --smbworkgroup=YOUR_DOMAIN --smbrealm YOUR_DOMAIN.TLD --smbservers=adc1.yourdomain.tld --krb5realm=YOUR_DOMAIN.TLD --enablewinbindoffline --enablewinbindkrb5 --winbindtemplateshell=/bin/bash--winbindjoin=domain_admin_user --update  --enablelocauthorize   --savebackup=/backups
</code></pre><p>10、 机器加入域后，通过使用以下命令验证 winbind 服务是否正常运行。</p><pre tabindex=0><code># systemctl status winbind.service
</code></pre><p>11、 接着检查是否在 Samba4 AD 中成功创建了 CentOS 机器对象。从安装了 RSAT 工具的 Windows 机器使用 AD 用户和计算机工具，并进入到你的域计算机容器。一个名为 CentOS 7 Server 的新 AD 计算机帐户对象应该在右边的列表中。</p><p>12、 最后，使用文本编辑器打开 samba 主配置文件（<code>/etc/samba/smb.conf</code>）来调整配置，并在 <code>[global]</code> 配置块的末尾附加以下行，如下所示：</p><pre tabindex=0><code>winbind use default domain = true
winbind offline logon = true
</code></pre><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/Configure-Samba.jpg><img src=/data/attachment/album/201708/14/175817no5sm6nrxssyy6y3.jpg alt="Configure Samba"></a></p><p><em>配置 Samba</em></p><p>13、 为了在 AD 帐户首次登录时在机器上创建本地家目录，请运行以下命令：</p><pre tabindex=0><code># authconfig --enablemkhomedir --update
</code></pre><p>14、 最后，重启 Samba 守护进程使更改生效，并使用一个 AD 账户登陆验证域加入。AD 帐户的家目录应该会自动创建。</p><pre tabindex=0><code># systemctl restart winbind
# su - domain_account
</code></pre><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/Verify-Domain-Joining.jpg><img src=/data/attachment/album/201708/14/175818c228xkmaxmvl84h8.jpg alt="Verify Domain Joining"></a></p><p><em>验证域加入</em></p><p>15、 通过以下命令之一列出域用户或域组。</p><pre tabindex=0><code># wbinfo -u
# wbinfo -g
</code></pre><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/List-Domain-Users-and-Groups.png><img src=/data/attachment/album/201708/14/175818b5i4x789pk18ivbo.png alt="List Domain Users and Groups"></a></p><p><em>列出域用户和组</em></p><p>16、 要获取有关域用户的信息，请运行以下命令。</p><pre tabindex=0><code># wbinfo -i domain_user
</code></pre><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/List-Domain-User-Info.jpg><img src=/data/attachment/album/201708/14/175818le5soht6mwsxze58.jpg alt="List Domain User Info"></a></p><p><em>列出域用户信息</em></p><p>17、 要显示域摘要信息，请使用以下命令。</p><pre tabindex=0><code># net ads info
</code></pre><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/List-Domain-Summary.jpg><img src=/data/attachment/album/201708/14/175819iygqzt6m8ddbmdma.jpg alt="List Domain Summary"></a></p><p><em>列出域摘要</em></p><h3 id=步骤-3使用-samba4-ad-dc-帐号登录centos>步骤 3：使用 Samba4 AD DC 帐号登录CentOS</h3><p>18、 要在 CentOS 中与域用户进行身份验证，请使用以下命令语法之一。</p><pre tabindex=0><code># su - ‘domain\domain_user’
# su - domain\\domain_user
</code></pre><p>或者在 samba 配置文件中设置了 <code>winbind use default domain = true</code> 参数的情况下，使用下面的语法。</p><pre tabindex=0><code># su - domain_user
# su - domain_user@domain.tld
</code></pre><p>19、 要为域用户或组添加 root 权限，请使用 <code>visudocommand</code> 编辑 <code>sudoers</code> 文件，并添加以下截图所示的行。</p><pre tabindex=0><code>YOUR_DOMAIN\\domain_username             ALL=(ALL:ALL) ALL      #For domain users
%YOUR_DOMAIN\\your_domain\  group            ALL=(ALL:ALL) ALL  #For domain groups
</code></pre><p>或者在 samba 配置文件中设置了 <code>winbind use default domain = true</code> 参数的情况下，使用下面的语法。</p><pre tabindex=0><code>domain_username                  ALL=(ALL:ALL) ALL      #For domain users
%your_domain\  group             ALL=(ALL:ALL) ALL  #For domain groups
</code></pre><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/Grant-Root-Privileges-on-Domain-Users.jpg><img src=/data/attachment/album/201708/14/175821r616i6k3fs191ijc.jpg alt="Grant Root Privileges on Domain Users"></a></p><p><em>授予域用户 root 权限</em></p><p>20、 针对 Samba4 AD DC 的以下一系列命令也可用于故障排除：</p><pre tabindex=0><code># wbinfo -p #Ping domain
# wbinfo -n domain_account #Get the SID of a domain account
# wbinfo -t  #Check trust relationship
</code></pre><p>21、 要离开该域, 请使用具有提升权限的域帐户对你的域名运行以下命令。从 AD 中删除计算机帐户后, 重启计算机以在集成进程之前还原更改。</p><pre tabindex=0><code># net ads leave -w DOMAIN -U domain_admin
# init 6
</code></pre><p>就是这样了！尽管此过程主要集中在将 CentOS 7 服务器加入到 Samba4 AD DC 中，但这里描述的相同步骤也适用于将 CentOS 服务器集成到 Microsoft Windows Server 2012 AD 中。</p><hr><p>作者简介：</p><p>Matei Cezar - 我是一个电脑上瘾的家伙，开源和基于 linux 的系统软件的粉丝，在 Linux 发行版桌面、服务器和 bash 脚本方面拥有大约 4 年的经验。</p><hr><p>via: <a href=https://www.tecmint.com/integrate-centos-7-to-samba4-active-directory/>https://www.tecmint.com/integrate-centos-7-to-samba4-active-directory/</a></p><p>作者：<a href=https://www.tecmint.com/author/cezarmatei/>Matei Cezar</a> 译者：<a href=https://github.com/geekpi>geekpi</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/samba/ rel=tag>Samba</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>