<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>如何在 Ubuntu 上使用 Grafana 监控 Docker - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="如何在 Ubuntu 上使用 Grafana 监控 Docker"><meta property="og:description" content="Grafana 是一个有着丰富指标的开源控制面板。在可视化大规模测量数据的时候是非常有用的。根据不同的指标数据，它提供了一个强大、优雅的来创建、分享和浏览数据的方式。"><meta property="og:type" content="article"><meta property="og:url" content="/article-7929-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-11-03T10:43:00+00:00"><meta property="article:modified_time" content="2016-11-03T10:43:00+00:00"><meta itemprop=name content="如何在 Ubuntu 上使用 Grafana 监控 Docker"><meta itemprop=description content="Grafana 是一个有着丰富指标的开源控制面板。在可视化大规模测量数据的时候是非常有用的。根据不同的指标数据，它提供了一个强大、优雅的来创建、分享和浏览数据的方式。"><meta itemprop=datePublished content="2016-11-03T10:43:00+00:00"><meta itemprop=dateModified content="2016-11-03T10:43:00+00:00"><meta itemprop=wordCount content="712"><meta itemprop=keywords content="Docker,监控,Grafana,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>如何在 Ubuntu 上使用 Grafana 监控 Docker</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2016-11-03T10:43:00Z>November 03, 2016</time></div></div></header><div class="content post__content clearfix"><p>Grafana 是一个有着丰富指标的开源控制面板。在可视化大规模测量数据的时候是非常有用的。根据不同的指标数据，它提供了一个强大、优雅的来创建、分享和浏览数据的方式。</p><p>它提供了丰富多样、灵活的图形选项。此外，针对 数据源 （ Data Source ） ，它支持许多不同的存储后端。每个数据源都有针对特定数据源的特性和功能所定制的查询编辑器。Grafana 提供了对下述数据源的正式支持：Graphite、InfluxDB、OpenTSDB、 Prometheus、Elasticsearch 和 Cloudwatch。</p><p>每个数据源的查询语言和能力显然是不同的，你可以将来自多个数据源的数据混合到一个单一的仪表盘上，但每个 面板 （ Panel ） 被绑定到属于一个特定 组织 （ Organization ） 的特定数据源上。它支持验证登录和基于角色的访问控制方案。它是作为一个独立软件部署，使用 Go 和 JavaScript 编写的。</p><p><img src=/data/attachment/album/201611/03/095645ok0uehrwdehr4eeu.jpg alt></p><p>在这篇文章，我将讲解如何在 Ubuntu 16.04 上安装 Grafana 并使用这个软件配置 Docker 监控。</p><h3 id=先决条件>先决条件</h3><ul><li>安装好 Docker 的服务器</li></ul><h3 id=安装-grafana>安装 Grafana</h3><p>我们可以在 Docker 中构建我们的 Grafana。 有一个官方提供的 Grafana Docker 镜像。请运行下述命令来构建Grafana 容器。</p><pre tabindex=0><code>root@ubuntu:~# docker run -i -p 3000:3000 grafana/grafana

Unable to find image &#39;grafana/grafana:latest&#39; locally
latest: Pulling from grafana/grafana
5c90d4a2d1a8: Pull complete
b1a9a0b6158e: Pull complete
acb23b0d58de: Pull complete
Digest: sha256:34ca2f9c7986cb2d115eea373083f7150a2b9b753210546d14477e2276074ae1
Status: Downloaded newer image for grafana/grafana:latest
t=2016-07-27T15:20:19+0000 lvl=info msg=&#34;Starting Grafana&#34; logger=main version=3.1.0 commit=v3.1.0 compiled=2016-07-12T06:42:28+0000
t=2016-07-27T15:20:19+0000 lvl=info msg=&#34;Config loaded from&#34; logger=settings file=/usr/share/grafana/conf/defaults.ini
t=2016-07-27T15:20:19+0000 lvl=info msg=&#34;Config loaded from&#34; logger=settings file=/etc/grafana/grafana.ini
t=2016-07-27T15:20:19+0000 lvl=info msg=&#34;Config overriden from command line&#34; logger=settings arg=&#34;default.paths.data=/var/lib/grafana&#34;
t=2016-07-27T15:20:19+0000 lvl=info msg=&#34;Config overriden from command line&#34; logger=settings arg=&#34;default.paths.logs=/var/log/grafana&#34;
t=2016-07-27T15:20:19+0000 lvl=info msg=&#34;Config overriden from command line&#34; logger=settings arg=&#34;default.paths.plugins=/var/lib/grafana/plugins&#34;
t=2016-07-27T15:20:19+0000 lvl=info msg=&#34;Path Home&#34; logger=settings path=/usr/share/grafana
t=2016-07-27T15:20:19+0000 lvl=info msg=&#34;Path Data&#34; logger=settings path=/var/lib/grafana
t=2016-07-27T15:20:19+0000 lvl=info msg=&#34;Path Logs&#34; logger=settings path=/var/log/grafana
t=2016-07-27T15:20:19+0000 lvl=info msg=&#34;Path Plugins&#34; logger=settings path=/var/lib/grafana/plugins
t=2016-07-27T15:20:19+0000 lvl=info msg=&#34;Initializing DB&#34; logger=sqlstore dbtype=sqlite3

t=2016-07-27T15:20:20+0000 lvl=info msg=&#34;Executing migration&#34; logger=migrator id=&#34;create playlist table v2&#34;
t=2016-07-27T15:20:20+0000 lvl=info msg=&#34;Executing migration&#34; logger=migrator id=&#34;create playlist item table v2&#34;
t=2016-07-27T15:20:20+0000 lvl=info msg=&#34;Executing migration&#34; logger=migrator id=&#34;drop preferences table v2&#34;
t=2016-07-27T15:20:20+0000 lvl=info msg=&#34;Executing migration&#34; logger=migrator id=&#34;drop preferences table v3&#34;
t=2016-07-27T15:20:20+0000 lvl=info msg=&#34;Executing migration&#34; logger=migrator id=&#34;create preferences table v3&#34;
t=2016-07-27T15:20:20+0000 lvl=info msg=&#34;Created default admin user: [admin]&#34;
t=2016-07-27T15:20:20+0000 lvl=info msg=&#34;Starting plugin search&#34; logger=plugins
t=2016-07-27T15:20:20+0000 lvl=info msg=&#34;Server Listening&#34; logger=server address=0.0.0.0:3000 protocol=http subUrl=
</code></pre><p>我们可以通过运行此命令确认 Grafana 容器的工作状态 <code>docker ps -a</code> 或通过这个URL访问 <code>http://Docker IP:3000</code>。</p><p>所有的 Grafana 配置设置都使用环境变量定义，在使用容器技术时这个是非常有用的。Grafana 配置文件路径为 <code>/etc/grafana/grafana.ini</code>。</p><h3 id=理解配置项>理解配置项</h3><p>Grafana 可以在它的 ini 配置文件中指定几个配置选项，或可以使用前面提到的环境变量来指定。</p><h4 id=配置文件位置>配置文件位置</h4><p>通常配置文件路径：</p><ul><li>默认配置文件路径 : <code>$WORKING_DIR/conf/defaults.ini</code></li><li>自定义配置文件路径 : <code>$WORKING_DIR/conf/custom.ini</code></li></ul><p>PS：当你使用 deb、rpm 或 docker 镜像安装 Grafana 时，你的配置文件在 <code>/etc/grafana/grafana.ini</code>。</p><h4 id=理解配置变量>理解配置变量</h4><p>现在我们看一些配置文件中的变量：</p><ul><li><code>instance_name</code>：这是 Grafana 服务器实例的名字。默认值从 <code>${HOSTNAME}</code> 获取，其值是环境变量<code>HOSTNAME</code>，如果该变量为空或不存在，Grafana 将会尝试使用系统调用来获取机器名。</li><li><code>[paths]</code>：这些路径通常都是在 init.d 脚本或 systemd service 文件中通过命令行指定。<ul><li><code>data</code>：这个是 Grafana 存储 sqlite3 数据库（如果使用）、基于文件的会话（如果使用），和其他数据的路径。</li><li><code>logs</code>：这个是 Grafana 存储日志的路径。</li></ul></li><li><code>[server]</code><ul><li><code>http_addr</code>：应用监听的 IP 地址，如果为空，则监听所有的接口。</li><li><code>http_port</code>：应用监听的端口，默认是 3000，你可以使用下面的命令将你的 80 端口重定向到 3000 端口：<code>$iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 3000</code></li><li><code>root_url</code> : 这个 URL 用于从浏览器访问 Grafana 。</li><li><code>cert_file</code> : 证书文件的路径（如果协议是 HTTPS）。</li><li><code>cert_key</code> : 证书密钥文件的路径（如果协议是 HTTPS）。</li></ul></li><li><code>[database]</code>：Grafana 使用数据库来存储用户和仪表盘以及其他信息，默认配置为使用内嵌在 Grafana 主二进制文件中的 SQLite3。<ul><li><code>type</code>：你可以根据你的需求选择 MySQL、Postgres、SQLite3。</li><li><code>path</code>：仅用于选择 SQLite3 数据库时，这个是数据库所存储的路径。</li><li><code>host</code>：仅适用 MySQL 或者 Postgres。它包括 IP 地址或主机名以及端口。例如，Grafana 和 MySQL 运行在同一台主机上设置如： <code>host = 127.0.0.1:3306</code>。</li><li><code>name</code>：Grafana 数据库的名称，把它设置为 Grafana 或其它名称。</li><li><code>user</code>：数据库用户（不适用于 SQLite3）。</li><li><code>password</code>：数据库用户密码（不适用于 SQLite3）。</li><li><code>ssl_mode</code>：对于 Postgres，使用 <code>disable</code>，<code>require</code>，或 <code>verify-full</code> 等值。对于 MySQL，使用 <code>true</code>，<code>false</code>，或 <code>skip-verify</code>。</li><li><code>ca_cert_path</code>：（只适用于 MySQL）CA 证书文件路径，在多数 Linux 系统中，证书可以在 <code>/etc/ssl/certs</code> 找到。</li><li><code>client_key_path</code>：（只适用于 MySQL）客户端密钥的路径，只在服务端需要用户端验证时使用。</li><li><code>client_cert_path</code>：（只适用于 MySQL）客户端证书的路径，只在服务端需要用户端验证时使用。</li><li><code>server_cert_name</code>：（只适用于 MySQL）MySQL 服务端使用的证书的通用名称字段。如果 <code>ssl_mode</code> 设置为 <code>skip-verify</code> 时可以不设置。</li></ul></li><li><code>[security]</code><ul><li><code>admin_user</code>：这个是 Grafana 默认的管理员用户的用户名，默认设置为 admin。</li><li><code>admin_password</code>：这个是 Grafana 默认的管理员用户的密码，在第一次运行时设置，默认为 admin。</li><li><code>login_remember_days</code>：保持登录/记住我的持续天数。</li><li><code>secret_key</code>：用于保持登录/记住我的 cookies 的签名。</li></ul></li></ul><h3 id=设置监控的重要组件>设置监控的重要组件</h3><p>我们可以使用下面的组件来创建我们的 Docker 监控系统。</p><ul><li><code>cAdvisor</code>：它被称为 Container Advisor。它给用户提供了一个资源利用和性能特征的解读。它会收集、聚合、处理、导出运行中的容器的信息。你可以通过<a href=https://github.com/google/cadvisor>这个文档</a>了解更多。</li><li><code>InfluxDB</code>：这是一个包含了时间序列、度量和分析数据库。我们使用这个数据源来设置我们的监控。cAdvisor 只展示实时信息，并不保存这些度量信息。Influx Db 帮助保存 cAdvisor 提供的监控数据，以展示非某一时段的数据。</li><li><code>Grafana Dashboard</code>：它可以帮助我们在视觉上整合所有的信息。这个强大的仪表盘使我们能够针对 InfluxDB 数据存储进行查询并将他们放在一个布局合理好看的图表中。</li></ul><h3 id=docker-监控的安装>Docker 监控的安装</h3><p>我们需要一步一步的在我们的 Docker 系统中安装以下每一个组件：</p><h4 id=安装-influxdb>安装 InfluxDB</h4><p>我们可以使用这个命令来拉取 InfluxDB 镜像，并部署了 influxDB 容器。</p><pre tabindex=0><code>root@ubuntu:~# docker run -d -p 8083:8083 -p 8086:8086 --expose 8090 --expose 8099 -e PRE_CREATE_DB=cadvisor --name influxsrv tutum/influxdb:0.8.8
Unable to find image &#39;tutum/influxdb:0.8.8&#39; locally
0.8.8: Pulling from tutum/influxdb
a3ed95caeb02: Already exists
23efb549476f: Already exists
aa2f8df21433: Already exists
ef072d3c9b41: Already exists
c9f371853f28: Already exists
a248b0871c3c: Already exists
749db6d368d0: Already exists
7d7c7d923e63: Pull complete
e47cc7808961: Pull complete
1743b6eeb23f: Pull complete
Digest: sha256:8494b31289b4dbc1d5b444e344ab1dda3e18b07f80517c3f9aae7d18133c0c42
Status: Downloaded newer image for tutum/influxdb:0.8.8
d3b6f7789e0d1d01fa4e0aacdb636c221421107d1df96808ecbe8e241ceb1823

    -p 8083:8083 : user interface, log in with username-admin, pass-admin
    -p 8086:8086 : interaction with other application
    --name influxsrv : container have name influxsrv, use to cAdvisor link it.
</code></pre><p>你可以测试 InfluxDB 是否安装好，通过访问这个 URL <code>http://你的 IP 地址:8083</code>，用户名和密码都是 ”root“。</p><p><img src=/data/attachment/album/201611/03/095728jjvtvuvvrluckvjb.png alt="InfluxDB Administration 2016-08-01 14-10-08"></p><p>我们可以在这个界面上创建我们所需的数据库。</p><p><img src=/data/attachment/album/201611/03/095729gcgzg7jboivgjo7b.png alt="createDB influx"></p><h4 id=安装-cadvisor>安装 cAdvisor</h4><p>我们的下一个步骤是安装 cAdvisor 容器，并将其链接到 InfluxDB 容器。你可以使用此命令来创建它。</p><pre tabindex=0><code>root@ubuntu:~# docker run --volume=/:/rootfs:ro --volume=/var/run:/var/run:rw --volume=/sys:/sys:ro --volume=/var/lib/docker/:/var/lib/docker:ro --publish=8080:8080 --detach=true --link influxsrv:influxsrv --name=cadvisor google/cadvisor:latest -storage_driver_db=cadvisor -storage_driver_host=influxsrv:8086
Unable to find image &#39;google/cadvisor:latest&#39; locally
latest: Pulling from google/cadvisor
09d0220f4043: Pull complete
151807d34af9: Pull complete
14cd28dce332: Pull complete
Digest: sha256:8364c7ab7f56a087b757a304f9376c3527c8c60c848f82b66dd728980222bd2f
Status: Downloaded newer image for google/cadvisor:latest
3bfdf7fdc83872485acb06666a686719983a1172ac49895cd2a260deb1cdde29
root@ubuntu:~#

    --publish=8080:8080 : user interface
    --link=influxsrv:influxsrv: link to container influxsrv
    -storage_driver=influxdb: set the storage driver as InfluxDB
    Specify what InfluxDB instance to push data to:
    -storage_driver_host=influxsrv:8086: The ip:port of the database. Default is ‘localhost:8086’
    -storage_driver_db=cadvisor: database name. Uses db ‘cadvisor’ by default
</code></pre><p>你可以通过访问这个地址来测试安装 cAdvisor 是否正常 <code>http://你的 IP 地址:8080</code>。 这将为你的 Docker 主机和容器提供统计信息。</p><p><img src=/data/attachment/album/201611/03/095730mc4y0lb3qjiv6y4v.png alt="cAdvisor - Docker Containers 2016-08-01 14-24-18"></p><h4 id=安装-grafana-控制面板>安装 Grafana 控制面板</h4><p>最后，我们需要安装 Grafana 仪表板并连接到 InfluxDB，你可以执行下面的命令来设置它。</p><pre tabindex=0><code>root@ubuntu:~# docker run -d -p 3000:3000 -e INFLUXDB_HOST=localhost -e INFLUXDB_PORT=8086 -e INFLUXDB_NAME=cadvisor -e INFLUXDB_USER=root -e INFLUXDB_PASS=root --link influxsrv:influxsrv --name grafana grafana/grafana
f3b7598529202b110e4e6b998dca6b6e60e8608d75dcfe0d2b09ae408f43684a
</code></pre><p>现在我们可以登录 Grafana 来配置数据源. 访问 <code>http://你的 IP 地址:3000</code> 或 <code>http://你的 IP 地址</code>（如果你在前面做了端口映射的话）:</p><ul><li>用户名 - admin</li><li>密码 - admin</li></ul><p>一旦我们安装好了 Grafana，我们可以连接 InfluxDB。登录到仪表盘并且点击面板左上方角落的 Grafana 图标（那个火球）。点击 数据源 （ Data Sources ） 来配置。</p><p><img src=/data/attachment/album/201611/03/095731jo3nll2p1ssk5lnb.png alt=addingdatabsource></p><p>现在你可以添加新的 图形 （ Graph ） 到我们默认的数据源 InfluxDB。</p><p><img src=/data/attachment/album/201611/03/095732i9ht99q6ey8j19ri.png alt=panelgraph></p><p>我们可以通过在 测量 （ Metric ） 页面编辑和调整我们的查询以调整我们的图形。</p><p><img src=/data/attachment/album/201611/03/095732mx2zoifp1ptop2oo.png alt="Grafana - Grafana Dashboard 2016-08-01 14-53-40"></p><p><img src=/data/attachment/album/201611/03/095733qitcr9bzi77up599.png alt="Grafana - Grafana Dashboard"></p><p>关于 Docker 监控，你可用<a href=https://github.com/vegasbrianc/docker-monitoring>从此了解</a>更多信息。 感谢你的阅读。我希望你可以留下有价值的建议和评论。希望你有个美好的一天。</p><hr><p>via: <a href=http://linoxide.com/linux-how-to/monitor-docker-containers-grafana-ubuntu/>http://linoxide.com/linux-how-to/monitor-docker-containers-grafana-ubuntu/</a></p><p>作者：<a href=http://linoxide.com/author/saheethas/>Saheetha Shameer</a> 译者：<a href=https://github.com/bestony>Bestony</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/docker/ rel=tag>Docker</a></li><li class=tags__item><a class="tags__link btn" href=/tags/%E7%9B%91%E6%8E%A7/ rel=tag>监控</a></li><li class=tags__item><a class="tags__link btn" href=/tags/grafana/ rel=tag>Grafana</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>