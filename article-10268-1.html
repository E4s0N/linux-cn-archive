<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>在 Grails 中使用 jQuery 和 DataTables - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="在 Grails 中使用 jQuery 和 DataTables"><meta property="og:description" content="本文介绍如何构建一个基于 Grails 的数据浏览器来可视化复杂的表格数据。"><meta property="og:type" content="article"><meta property="og:url" content="/article-10268-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-11-24T10:24:47+00:00"><meta property="article:modified_time" content="2018-11-24T10:24:47+00:00"><meta itemprop=name content="在 Grails 中使用 jQuery 和 DataTables"><meta itemprop=description content="本文介绍如何构建一个基于 Grails 的数据浏览器来可视化复杂的表格数据。"><meta itemprop=datePublished content="2018-11-24T10:24:47+00:00"><meta itemprop=dateModified content="2018-11-24T10:24:47+00:00"><meta itemprop=wordCount content="1182"><meta itemprop=keywords content="Grails,Groovy,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>在 Grails 中使用 jQuery 和 DataTables</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2018-11-24T10:24:47Z>November 24, 2018</time></div></div></header><div class="content post__content clearfix"><blockquote><p>本文介绍如何构建一个基于 Grails 的数据浏览器来可视化复杂的表格数据。</p></blockquote><p><img src=/data/attachment/album/201811/24/102451gfdc52bnvg7fr7nv.png alt></p><p>我是 <a href=https://grails.org/>Grails</a> 的忠实粉丝。当然，我主要是热衷于利用命令行工具来探索和分析数据的数据从业人员。数据从业人员经常需要<em>查看</em>数据，这也意味着他们通常拥有优秀的数据浏览器。利用 Grails、<a href=https://jquery.com/>jQuery</a>，以及 <a href=https://datatables.net/>DataTables jQuery 插件</a>，我们可以制作出非常友好的表格数据浏览器。</p><p><a href=https://datatables.net/>DataTables 网站</a>提供了许多“食谱式”的教程文档，展示了如何组合一些优秀的示例应用程序，这些程序包含了完成一些非常漂亮的东西所必要的 JavaScript、HTML，以及偶尔出现的 <a href=http://php.net/>PHP</a>。但对于那些宁愿使用 Grails 作为后端的人来说，有必要进行一些说明示教。此外，样本程序中使用的数据是一个虚构公司的员工的单个平面表格数据，因此处理这些复杂的表关系可以作为读者的一个练习项目。</p><p>本文中，我们将创建具有略微复杂的数据结构和 DataTables 浏览器的 Grails 应用程序。我们将介绍 Grails 标准，它是 <a href=http://groovy-lang.org/>Groovy</a> 式的 Java Hibernate 标准。我已将代码托管在 <a href=https://github.com/monetschemist/grails-datatables>GitHub</a> 上方便大家访问，因此本文主要是对代码细节的解读。</p><p>首先，你需要配置 Java、Groovy、Grails 的使用环境。对于 Grails，我倾向于使用终端窗口和 <a href=https://www.vim.org/>Vim</a>，本文也使用它们。为获得现代的 Java 环境，建议下载并安装 Linux 发行版提供的 <a href=http://openjdk.java.net/>Open Java Development Kit</a> （OpenJDK）（应该是 Java 8、9、10 或 11 之一，撰写本文时，我正在使用 Java 8）。从我的角度来看，获取最新的 Groovy 和 Grails 的最佳方法是使用 <a href=http://sdkman.io/>SDKMAN!</a>。</p><p>从未尝试过 Grails 的读者可能需要做一些背景资料阅读。作为初学者，推荐文章 <a href=http://guides.grails.org/creating-your-first-grails-app/guide/index.html>创建你的第一个 Grails 应用程序</a>。</p><h3 id=获取员工信息浏览器应用程序>获取员工信息浏览器应用程序</h3><p>正如上文所提，我将本文中员工信息浏览器的源代码托管在 <a href=https://github.com/monetschemist/grails-datatables>GitHub</a>上。进一步讲，应用程序 <strong>embrow</strong> 是在 Linux 终端中用如下命令构建的：</p><pre tabindex=0><code>cd Projects
grails create-app com.nuevaconsulting.embrow
</code></pre><p>域类和单元测试创建如下：</p><pre tabindex=0><code>grails create-domain-class com.nuevaconsulting.embrow.Position
grails create-domain-class com.nuevaconsulting.embrow.Office
grails create-domain-class com.nuevaconsulting.embrow.Employeecd embrowgrails createdomaincom.grails createdomaincom.grails createdomaincom.
</code></pre><p>这种方式构建的域类没有属性，因此必须按如下方式编辑它们：</p><p><code>Position</code> 域类：</p><pre tabindex=0><code>package com.nuevaconsulting.embrow
 
class Position {

    String name
    int starting

    static constraints = {
        name nullable: false, blank: false
        starting nullable: false
    }
}com.Stringint startingstatic constraintsnullableblankstarting nullable
</code></pre><p><code>Office</code> 域类：</p><pre tabindex=0><code>package com.nuevaconsulting.embrow
 
class Office {

    String name
    String address
    String city
    String country

    static constraints = {
        name nullable: false, blank: false
        address nullable: false, blank: false
        city nullable: false, blank: false
        country nullable: false, blank: false
    }
}
</code></pre><p><code>Enployee</code> 域类：</p><pre tabindex=0><code>package com.nuevaconsulting.embrow
 
class Employee {

    String surname
    String givenNames
    Position position
    Office office
    int extension
    Date hired
    int salary
    static constraints = {
        surname nullable: false, blank: false
        givenNames nullable: false, blank: false
        : false
        office nullable: false
        extension nullable: false
        hired nullable: false
        salary nullable: false
    }
}
</code></pre><p>请注意，虽然 <code>Position</code> 和 <code>Office</code> 域类使用了预定义的 Groovy 类型 <code>String</code> 以及 <code>int</code>，但 <code>Employee</code> 域类定义了 <code>Position</code> 和 <code>Office</code> 字段（以及预定义的 <code>Date</code>）。这会导致创建数据库表，其中存储的 <code>Employee</code> 实例中包含了指向存储 <code>Position</code> 和 <code>Office</code> 实例表的引用或者外键。</p><p>现在你可以生成控制器，视图，以及其他各种测试组件：</p><pre tabindex=0><code>-all com.nuevaconsulting.embrow.Position
grails generate-all com.nuevaconsulting.embrow.Office
grails generate-all com.nuevaconsulting.embrow.Employeegrails generateall com.grails generateall com.grails generateall com.
</code></pre><p>此时，你已经准备好了一个基本的增删改查（CRUD）应用程序。我在 <code>grails-app/init/com/nuevaconsulting/BootStrap.groovy</code> 中包含了一些基础数据来填充表格。</p><p>如果你用如下命令来启动应用程序：</p><pre tabindex=0><code>grails run-app
</code></pre><p>在浏览器输入 <code>http://localhost:8080/</code>，你将会看到如下界面：</p><p><img src=/data/attachment/album/201811/24/102453x1n1tygy5g35r15z.png alt="Embrow home screen"></p><p><em>Embrow 应用程序主界面。</em></p><p>单击 “OfficeController” 链接，会跳转到如下界面：</p><p><img src=/data/attachment/album/201811/24/102455e23cwdo3yydhl3y3.png alt="Office list"></p><p><em>Office 列表</em></p><p>注意，此表由 <code>OfficeController</code> 的 <code>index</code> 方式生成，并由视图 <code>office/index.gsp</code> 显示。</p><p>同样，单击 “EmployeeController” 链接 跳转到如下界面：</p><p><img src=/data/attachment/album/201811/24/102457xfhihxh3h2mjf2j6.png alt="Employee controller"></p><p><em>employee 控制器</em></p><p>好吧，这很丑陋： Position 和 Office 链接是什么？</p><p>上面的命令 <code>generate-all</code> 生成的视图创建了一个叫 <code>index.gsp</code> 的文件，它使用 Grails <code>&lt;f:table/></code> 标签，该标签默认会显示类名（<code>com.nuevaconsulting.embrow.Position</code>）和持久化示例标识符（<code>30</code>）。这个操作可以自定义用来产生更好看的东西，并且自动生成链接，自动生成分页以及自动生成可排序列的一些非常简洁直观的东西。</p><p>但该员工信息浏览器功能也是有限的。例如，如果想查找 “position” 信息中包含 “dev” 的员工该怎么办？如果要组合排序，以姓氏为主排序关键字，“office” 为辅助排序关键字，该怎么办？或者，你需要将已排序的数据导出到电子表格或 PDF 文档以便通过电子邮件发送给无法访问浏览器的人，该怎么办？</p><p>jQuery DataTables 插件提供了这些所需的功能。允许你创建一个完成的表格数据浏览器。</p><h3 id=创建员工信息浏览器视图和控制器的方法>创建员工信息浏览器视图和控制器的方法</h3><p>要基于 jQuery DataTables 创建员工信息浏览器，你必须先完成以下两个任务：</p><ol><li>创建 Grails 视图，其中包含启用 DataTable 所需的 HTML 和 JavaScript</li><li>给 Grails 控制器增加一个方法来控制新视图。</li></ol><h4 id=员工信息浏览器视图>员工信息浏览器视图</h4><p>在目录 <code>embrow/grails-app/views/employee</code> 中，首先复制 <code>index.gsp</code> 文件，重命名为 <code>browser.gsp</code>：</p><pre tabindex=0><code>cd Projects
cd embrow/grails-app/views/employee
cp gsp browser.gsp
</code></pre><p>此刻，你自定义新的 <code>browser.gsp</code> 文件来添加相关的 jQuery DataTables 代码。</p><p>通常，在可能的时候，我喜欢从内容提供商处获得 JavaScript 和 CSS；在下面这行后面：</p><pre tabindex=0><code>&lt;title&gt;&lt;g:message code=&#34;default.list.label&#34; args=&#34;[entityName]&#34; /&gt;&lt;/title&gt;
</code></pre><p>插入如下代码：</p><pre tabindex=0><code>&lt;script src=&#34;https://code.jquery.com/jquery-2.2.4.min.js&#34; integrity=&#34;sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=&#34; crossorigin=&#34;anonymous&#34;&gt;&lt;/script&gt;
&lt;link rel=&#34;stylesheet&#34; type=&#34;text/css&#34; href=&#34;https://cdn.datatables.net/1.10.16/css/jquery.dataTables.css&#34;&gt;
&lt;script type=&#34;text/javascript&#34; charset=&#34;utf8&#34; src=&#34;https://cdn.datatables.net/1.10.16/js/jquery.dataTables.js&#34;&gt;&lt;/script&gt;
&lt;link rel=&#34;stylesheet&#34; type=&#34;text/css&#34; href=&#34;https://cdn.datatables.net/scroller/1.4.4/css/scroller.dataTables.min.css&#34;&gt;
&lt;script type=&#34;text/javascript&#34; charset=&#34;utf8&#34; src=&#34;https://cdn.datatables.net/scroller/1.4.4/js/dataTables.scroller.min.js&#34;&gt;&lt;/script&gt;
&lt;script type=&#34;text/javascript&#34; charset=&#34;utf8&#34; src=&#34;https://cdn.datatables.net/buttons/1.5.1/js/dataTables.buttons.min.js&#34;&gt;&lt;/script&gt;
&lt;script type=&#34;text/javascript&#34; charset=&#34;utf8&#34; src=&#34;https://cdn.datatables.net/buttons/1.5.1/js/buttons.flash.min.js&#34;&gt;&lt;/script&gt;
&lt;script type=&#34;text/javascript&#34; charset=&#34;utf8&#34; src=&#34;https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js&#34;&gt;&lt;/script&gt;
&lt;script type=&#34;text/javascript&#34; charset=&#34;utf8&#34; src=&#34;https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/pdfmake.min.js&#34;&gt;&lt;/script&gt;
&lt;script type=&#34;text/javascript&#34; charset=&#34;utf8&#34; src=&#34;https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/vfs_fonts.js&#34;&gt;&lt;/script&gt;
&lt;script type=&#34;text/javascript&#34; charset=&#34;utf8&#34; src=&#34;https://cdn.datatables.net/buttons/1.5.1/js/buttons.html5.min.js&#34;&gt;&lt;/script&gt;
&lt;script type=&#34;text/javascript&#34; charset=&#34;utf8&#34; src=&#34;https://cdn.datatables.net/buttons/1.5.1/js/buttons.print.min.js &#34;&gt;&lt;/script&gt;
</code></pre><p>然后删除 <code>index.gsp</code> 中提供数据分页的代码：</p><pre tabindex=0><code>&lt;div id=&#34;list-employee&#34; class=&#34;content scaffold-list&#34; role=&#34;main&#34;&gt;
&lt;h1&gt;&lt;g:message code=&#34;default.list.label&#34; args=&#34;[entityName]&#34; /&gt;&lt;/h1&gt;
&lt;g:if test=&#34;${flash.message}&#34;&gt;
&lt;div class=&#34;message&#34; role=&#34;status&#34;&gt;${flash.message}&lt;/div&gt;
&lt;/g:if&gt;
&lt;f:table collection=&#34;${employeeList}&#34; /&gt;

&lt;div class=&#34;pagination&#34;&gt;
&lt;g:paginate total=&#34;${employeeCount ?: 0}&#34; /&gt;
&lt;/div&gt;
&lt;/div&gt;
</code></pre><p>并插入实现 jQuery DataTables 的代码。</p><p>要插入的第一部分是 HTML，它将创建浏览器的基本表格结构。DataTables 与后端通信的应用程序来说，它们只提供表格页眉和页脚；DataTables JavaScript 则负责表中内容。</p><pre tabindex=0><code>&lt;div id=&#34;employee-browser&#34; class=&#34;content&#34; role=&#34;main&#34;&gt;
&lt;h1&gt;Employee Browser&lt;/h1&gt;
&lt;table id=&#34;employee_dt&#34; class=&#34;display compact&#34; style=&#34;width:99%;&#34;&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Surname&lt;/th&gt;
&lt;th&gt;Given name(s)&lt;/th&gt;
&lt;th&gt;Position&lt;/th&gt;
&lt;th&gt;Office&lt;/th&gt;
&lt;th&gt;Extension&lt;/th&gt;
&lt;th&gt;Hired&lt;/th&gt;
&lt;th&gt;Salary&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tfoot&gt;
&lt;tr&gt;
&lt;th&gt;Surname&lt;/th&gt;
&lt;th&gt;Given name(s)&lt;/th&gt;
&lt;th&gt;Position&lt;/th&gt;
&lt;th&gt;Office&lt;/th&gt;
&lt;th&gt;Extension&lt;/th&gt;
&lt;th&gt;Hired&lt;/th&gt;
&lt;th&gt;Salary&lt;/th&gt;
&lt;/tr&gt;
&lt;/tfoot&gt;
&lt;/table&gt;
&lt;/div&gt;
</code></pre><p>接下来，插入一个 JavaScript 块，它主要提供三个功能：它设置页脚中显示的文本框的大小，以进行列过滤，建立 DataTables 表模型，并创建一个处理程序来进行列过滤。</p><pre tabindex=0><code>&lt;g:javascript&gt;
$(&#39;#employee_dt tfoot th&#39;).each( function() {javascript
</code></pre><p>下面的代码处理表格列底部的过滤器框的大小：</p><pre tabindex=0><code>var title = $(this).text();
if (title == &#39;Extension&#39; || title == &#39;Hired&#39;)
$(this).html(&#39;&lt;input type=&#34;text&#34; size=&#34;5&#34; placeholder=&#34;&#39; + title + &#39;?&#34; /&gt;&#39;);
else
$(this).html(&#39;&lt;input type=&#34;text&#34; size=&#34;15&#34; placeholder=&#34;&#39; + title + &#39;?&#34; /&gt;&#39;);
});titletitletitletitletitle
</code></pre><p>接下来，定义表模型。这是提供所有表选项的地方，包括界面的滚动，而不是分页，根据 DOM 字符串提供的装饰，将数据导出为 CSV 和其他格式的能力，以及建立与服务器的 AJAX 连接。 请注意，使用 Groovy GString 调用 Grails <code>createLink()</code> 的方法创建 URL，在 <code>EmployeeController</code> 中指向 <code>browserLister</code> 操作。同样有趣的是表格列的定义。此信息将发送到后端，后端查询数据库并返回相应的记录。</p><pre tabindex=0><code>var table = $(&#39;#employee_dt&#39;).DataTable( {
&#34;scrollY&#34;: 500,
&#34;deferRender&#34;: true,
&#34;scroller&#34;: true,
&#34;dom&#34;: &#34;Brtip&#34;,
&#34;buttons&#34;: [ &#39;copy&#39;, &#39;csv&#39;, &#39;excel&#39;, &#39;pdf&#39;, &#39;print&#39; ],
&#34;processing&#34;: true,
&#34;serverSide&#34;: true,
&#34;ajax&#34;: {
&#34;url&#34;: &#34;${createLink(controller: &#39;employee&#39;, action: &#39;browserLister&#39;)}&#34;,
&#34;type&#34;: &#34;POST&#34;,
},
&#34;columns&#34;: [
{ &#34;data&#34;: &#34;surname&#34; },
{ &#34;data&#34;: &#34;givenNames&#34; },
{ &#34;data&#34;: &#34;position&#34; },
{ &#34;data&#34;: &#34;office&#34; },
{ &#34;data&#34;: &#34;extension&#34; },
{ &#34;data&#34;: &#34;hired&#34; },
{ &#34;data&#34;: &#34;salary&#34; }
]
});
</code></pre><p>最后，监视过滤器列以进行更改，并使用它们来应用过滤器。</p><pre tabindex=0><code>table.columns().every(function() {
var that = this;
$(&#39;input&#39;, this.footer()).on(&#39;keyup change&#39;, function(e) {
if (that.search() != this.value &amp;&amp; 8 &lt; e.keyCode &amp;&amp; e.keyCode &lt; 32)
that.search(this.value).draw();
});
</code></pre><p>这就是 JavaScript，这样就完成了对视图代码的更改。</p><pre tabindex=0><code>});
&lt;/g:javascript&gt;
</code></pre><p>以下是此视图创建的UI的屏幕截图：</p><p><img src=/data/attachment/album/201811/24/102458wiezvqvvwdguwfqv.png alt></p><p>这是另一个屏幕截图，显示了过滤和多列排序（寻找 “position” 包括字符 “dev” 的员工，先按 “office” 排序，然后按姓氏排序）：</p><p><img src=/data/attachment/album/201811/24/102500fee5wc2z3x6w3xxp.png alt></p><p>这是另一个屏幕截图，显示单击 CSV 按钮时会发生什么：</p><p><img src=/data/attachment/album/201811/24/102504u2bkkzg2g3gz9b38.png alt></p><p>最后，这是一个截图，显示在 LibreOffice 中打开的 CSV 数据：</p><p><img src=/data/attachment/album/201811/24/102508udp96d9ewdb0emt2.png alt></p><p>好的，视图部分看起来非常简单；因此，控制器必须做所有繁重的工作，对吧？ 让我们来看看……</p><h4 id=控制器-browserlister-操作>控制器 browserLister 操作</h4><p>回想一下，我们看到过这个字符串：</p><pre tabindex=0><code>&#34;${createLink(controller: &#39;employee&#39;, action: &#39;browserLister&#39;)}&#34;
</code></pre><p>对于从 DataTables 模型中调用 AJAX 的 URL，是在 Grails 服务器上动态创建 HTML 链接，其 Grails 标记背后通过调用 <a href=https://gsp.grails.org/latest/ref/Tags/createLink.html>createLink()</a> 的方法实现的。这会最终产生一个指向 <code>EmployeeController</code> 的链接，位于：</p><pre tabindex=0><code>embrow/grails-app/controllers/com/nuevaconsulting/embrow/EmployeeController.groovy
</code></pre><p>特别是控制器方法 <code>browserLister()</code>。我在代码中留了一些 <code>print</code> 语句，以便在运行时能够在终端看到中间结果。</p><pre tabindex=0><code>    def browserLister() {
        // Applies filters and sorting to return a list of desired employees
</code></pre><p>首先，打印出传递给 <code>browserLister()</code> 的参数。我通常使用此代码开始构建控制器方法，以便我完全清楚我的控制器正在接收什么。</p><pre tabindex=0><code>      println &#34;employee browserLister params $params&#34;
        println()
</code></pre><p>接下来，处理这些参数以使它们更加有用。首先，jQuery DataTables 参数，一个名为 <code>jqdtParams</code> 的 Groovy 映射：</p><pre tabindex=0><code>def jqdtParams = [:]
params.each { key, value -&gt;
    def keyFields = key.replace(&#39;]&#39;,&#39;&#39;).split(/\[/)
    def table = jqdtParams
    for (int f = 0; f &lt; keyFields.size() - 1; f++) {
        def keyField = keyFields[f]
        if (!table.containsKey(keyField))
            table[keyField] = [:]
        table = table[keyField]
    }
    table[keyFields[-1]] = value
}
println &#34;employee dataTableParams $jqdtParams&#34;
println()
</code></pre><p>接下来，列数据，一个名为 <code>columnMap</code> 的 Groovy 映射：</p><pre tabindex=0><code>def columnMap = jqdtParams.columns.collectEntries { k, v -&gt;
    def whereTerm = null
    switch (v.data) {
    case &#39;extension&#39;:
    case &#39;hired&#39;:
    case &#39;salary&#39;:
        if (v.search.value ==~ /\d+(,\d+)*/)
            whereTerm = v.search.value.split(&#39;,&#39;).collect { it as Integer }
        break
    default:
        if (v.search.value ==~ /[A-Za-z0-9 ]+/)
            whereTerm = &#34;%${v.search.value}%&#34; as String
        break
    }
    [(v.data): [where: whereTerm]]
}
println &#34;employee columnMap $columnMap&#34;
println()
</code></pre><p>接下来，从 <code>columnMap</code> 中检索的所有列表，以及在视图中应如何排序这些列表，Groovy 列表分别称为 <code>allColumnList</code> 和 <code>orderList</code> ：</p><pre tabindex=0><code>def allColumnList = columnMap.keySet() as List
println &#34;employee allColumnList $allColumnList&#34;
def orderList = jqdtParams.order.collect { k, v -&gt; [allColumnList[v.column as Integer], v.dir] }
println &#34;employee orderList $orderList&#34;
</code></pre><p>我们将使用 Grails 的 Hibernate 标准实现来实际选择要显示的元素以及它们的排序和分页。标准要求过滤器关闭；在大多数示例中，这是作为标准实例本身的创建的一部分给出的，但是在这里我们预先定义过滤器闭包。请注意，在这种情况下，“date hired” 过滤器的相对复杂的解释被视为一年并应用于建立日期范围，并使用 <code>createAlias</code> 以允许我们进入相关类别 <code>Position</code> 和 <code>Office</code>：</p><pre tabindex=0><code>def filterer = {
    createAlias &#39;position&#39;,        &#39;p&#39;
    createAlias &#39;office&#39;,          &#39;o&#39;

    if (columnMap.surname.where)    ilike  &#39;surname&#39;,     columnMap.surname.where
    if (columnMap.givenNames.where) ilike  &#39;givenNames&#39;,  columnMap.givenNames.where
    if (columnMap.position.where)   ilike  &#39;p.name&#39;,      columnMap.position.where
    if (columnMap.office.where)     ilike  &#39;o.name&#39;,      columnMap.office.where
    if (columnMap.extension.where)  inList &#39;extension&#39;,   columnMap.extension.where
    if (columnMap.salary.where)     inList &#39;salary&#39;,      columnMap.salary.where
    if (columnMap.hired.where) {
        if (columnMap.hired.where.size() &gt; 1) {
            or {
                columnMap.hired.where.each {
                    between &#39;hired&#39;, Date.parse(&#39;yyyy/MM/dd&#39;,&#34;${it}/01/01&#34; as String),
                        Date.parse(&#39;yyyy/MM/dd&#39;,&#34;${it}/12/31&#34; as String)
                }
            }
        } else {
            between &#39;hired&#39;, Date.parse(&#39;yyyy/MM/dd&#39;,&#34;${columnMap.hired.where[0]}/01/01&#34; as String),
                Date.parse(&#39;yyyy/MM/dd&#39;,&#34;${columnMap.hired.where[0]}/12/31&#34; as String)
        }
    }
}
</code></pre><p>是时候应用上述内容了。第一步是获取分页代码所需的所有 <code>Employee</code> 实例的总数：</p><pre tabindex=0><code>        def recordsTotal = Employee.count()
        println &#34;employee recordsTotal $recordsTotal&#34;
</code></pre><p>接下来，将过滤器应用于 <code>Employee</code> 实例以获取过滤结果的计数，该结果将始终小于或等于总数（同样，这是针对分页代码）：</p><pre tabindex=0><code>        def c = Employee.createCriteria()
        def recordsFiltered = c.count {
            filterer.delegate = delegate
            filterer()
        }
        println &#34;employee recordsFiltered $recordsFiltered&#34;
</code></pre><p>获得这两个计数后，你还可以使用分页和排序信息获取实际过滤的实例。</p><pre tabindex=0><code>      def orderer = Employee.withCriteria {
            filterer.delegate = delegate
            filterer()
            orderList.each { oi -&gt;
                switch (oi[0]) {
                case &#39;surname&#39;:    order &#39;surname&#39;,    oi[1]; break
                case &#39;givenNames&#39;: order &#39;givenNames&#39;, oi[1]; break
                case &#39;position&#39;:   order &#39;p.name&#39;,     oi[1]; break
                case &#39;office&#39;:     order &#39;o.name&#39;,     oi[1]; break
                case &#39;extension&#39;:  order &#39;extension&#39;,  oi[1]; break
                case &#39;hired&#39;:      order &#39;hired&#39;,      oi[1]; break
                case &#39;salary&#39;:     order &#39;salary&#39;,     oi[1]; break
                }
            }
            maxResults (jqdtParams.length as Integer)
            firstResult (jqdtParams.start as Integer)
        }
</code></pre><p>要完全清楚，JTable 中的分页代码管理三个计数：数据集中的记录总数，应用过滤器后得到的数字，以及要在页面上显示的数字（显示是滚动还是分页）。 排序应用于所有过滤的记录，并且分页应用于那些过滤的记录的块以用于显示目的。</p><p>接下来，处理命令返回的结果，在每行中创建指向 <code>Employee</code>、<code>Position</code> 和 <code>Office</code> 实例的链接，以便用户可以单击这些链接以获取相关实例的所有详细信息：</p><pre tabindex=0><code>        def dollarFormatter = new DecimalFormat(&#39;$##,###.##&#39;)
        def employees = orderer.collect { employee -&gt;
            [&#39;surname&#39;: &#34;&lt;a href=&#39;${createLink(controller: &#39;employee&#39;, action: &#39;show&#39;, id: employee.id)}&#39;&gt;${employee.surname}&lt;/a&gt;&#34;,
                &#39;givenNames&#39;: employee.givenNames,
                &#39;position&#39;: &#34;&lt;a href=&#39;${createLink(controller: &#39;position&#39;, action: &#39;show&#39;, id: employee.position?.id)}&#39;&gt;${employee.position?.name}&lt;/a&gt;&#34;,
                &#39;office&#39;: &#34;&lt;a href=&#39;${createLink(controller: &#39;office&#39;, action: &#39;show&#39;, id: employee.office?.id)}&#39;&gt;${employee.office?.name}&lt;/a&gt;&#34;,
                &#39;extension&#39;: employee.extension,
                &#39;hired&#39;: employee.hired.format(&#39;yyyy/MM/dd&#39;),
                &#39;salary&#39;: dollarFormatter.format(employee.salary)]
        }
</code></pre><p>最后，创建要返回的结果并将其作为 JSON 返回，这是 jQuery DataTables 所需要的。</p><pre tabindex=0><code>        def result = [draw: jqdtParams.draw, recordsTotal: recordsTotal, recordsFiltered: recordsFiltered, data: employees]
        render(result as JSON)
    }
</code></pre><p>大功告成。</p><p>如果你熟悉 Grails，这可能看起来比你原先想象的要多，但这里没有火箭式的一步到位方法，只是很多分散的操作步骤。但是，如果你没有太多接触 Grails（或 Groovy），那么需要了解很多新东西 - 闭包，代理和构建器等等。</p><p>在那种情况下，从哪里开始？ 最好的地方是了解 Groovy 本身，尤其是 <a href=http://groovy-lang.org/closures.html>Groovy closures</a> 和 <a href=http://groovy-lang.org/dsls.html>Groovy delegates and builders</a>。然后再去阅读上面关于 Grails 和 Hibernate 条件查询的建议阅读文章。</p><h3 id=结语>结语</h3><p>jQuery DataTables 为 Grails 制作了很棒的表格数据浏览器。对视图进行编码并不是太棘手，但 DataTables 文档中提供的 PHP 示例提供的功能仅到此位置。特别是，它们不是用 Grails 程序员编写的，也不包含探索使用引用其他类（实质上是查找表）的元素的更精细的细节。</p><p>我使用这种方法制作了几个数据浏览器，允许用户选择要查看和累积记录计数的列，或者只是浏览数据。即使在相对适度的 VPS 上的百万行表中，性能也很好。</p><p>一个警告：我偶然发现了 Grails 中暴露的各种 Hibernate 标准机制的一些问题（请参阅我的其他 GitHub 代码库），因此需要谨慎和实验。如果所有其他方法都失败了，另一种方法是动态构建 SQL 字符串并执行它们。在撰写本文时，我更喜欢使用 Grails 标准，除非我遇到杂乱的子查询，但这可能只反映了我在 Hibernate 中对子查询的相对缺乏经验。</p><p>我希望 Grails 程序员发现本文的有趣性。请随时在下面留下评论或建议。</p><hr><p>via: <a href=https://opensource.com/article/18/9/using-grails-jquery-and-datatables>https://opensource.com/article/18/9/using-grails-jquery-and-datatables</a></p><p>作者：<a href=https://opensource.com/users/clhermansen>Chris Hermansen</a> 选题：<a href=https://github.com/lujun9972>lujun9972</a> 译者：<a href=https://github.com/jrglinux>jrg</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/grails/ rel=tag>Grails</a></li><li class=tags__item><a class="tags__link btn" href=/tags/groovy/ rel=tag>Groovy</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>