<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>20 个 OpenSSH 最佳安全实践 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="20 个 OpenSSH 最佳安全实践"><meta property="og:description" content="时不时会出现关于 OpenSSH 零日漏洞的传言。本文将描述如何设置你的 Linux 或类 Unix 系统以提高 sshd 的安全性。"><meta property="og:type" content="article"><meta property="og:url" content="/article-9394-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-02-28T15:45:00+00:00"><meta property="article:modified_time" content="2018-02-28T15:45:00+00:00"><meta itemprop=name content="20 个 OpenSSH 最佳安全实践"><meta itemprop=description content="时不时会出现关于 OpenSSH 零日漏洞的传言。本文将描述如何设置你的 Linux 或类 Unix 系统以提高 sshd 的安全性。"><meta itemprop=datePublished content="2018-02-28T15:45:00+00:00"><meta itemprop=dateModified content="2018-02-28T15:45:00+00:00"><meta itemprop=wordCount content="1510"><meta itemprop=keywords content="SSH,OpenSSH,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>20 个 OpenSSH 最佳安全实践</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2018-02-28T15:45:00Z>February 28, 2018</time></div></div></header><div class="content post__content clearfix"><p><img src=/data/attachment/album/201802/28/154506wnfo36ipba3fxfya.jpg alt></p><p>OpenSSH 是 SSH 协议的一个实现。一般通过 <code>scp</code> 或 <code>sftp</code> 用于远程登录、备份、远程文件传输等功能。SSH能够完美保障两个网络或系统间数据传输的保密性和完整性。尽管如此，它最大的优势是使用公匙加密来进行服务器验证。时不时会出现关于 OpenSSH 零日漏洞的<a href=https://isc.sans.edu/diary/OpenSSH+Rumors/6742>传言</a>。本文将描述如何设置你的 Linux 或类 Unix 系统以提高 sshd 的安全性。</p><h3 id=openssh-默认设置>OpenSSH 默认设置</h3><ul><li>TCP 端口 - 22</li><li>OpenSSH 服务配置文件 - <code>sshd_config</code> (位于 <code>/etc/ssh/</code>）</li></ul><h3 id=1-基于公匙的登录>1、 基于公匙的登录</h3><p>OpenSSH 服务支持各种验证方式。推荐使用公匙加密验证。首先，使用以下 <code>ssh-keygen</code> 命令在本地电脑上创建密匙对：</p><blockquote><p>1024 位或低于它的 DSA 和 RSA 加密是很弱的，请不要使用。当考虑 ssh 客户端向后兼容性的时候，请使用 RSA密匙代替 ECDSA 密匙。所有的 ssh 密钥要么使用 ED25519 ，要么使用 RSA，不要使用其它类型。</p></blockquote><pre tabindex=0><code>$ ssh-keygen -t key_type -b bits -C &#34;comment&#34;
</code></pre><p>示例：</p><pre tabindex=0><code>$ ssh-keygen -t ed25519 -C &#34;Login to production cluster at xyz corp&#34;
或
$ ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa_aws_$(date +%Y-%m-%d) -C &#34;AWS key for abc corp clients&#34;
</code></pre><p>下一步，使用 <code>ssh-copy-id</code> 命令安装公匙：</p><pre tabindex=0><code>$ ssh-copy-id -i /path/to/public-key-file user@host
或
$ ssh-copy-id user@remote-server-ip-or-dns-name
</code></pre><p>示例：</p><pre tabindex=0><code>$ ssh-copy-id vivek@rhel7-aws-server
</code></pre><p>提示输入用户名和密码的时候，确认基于 ssh 公匙的登录是否工作：</p><pre tabindex=0><code>$ ssh vivek@rhel7-aws-server
</code></pre><p><a href=https://www.cyberciti.biz/tips/wp-content/uploads/2009/07/OpenSSH-server-security-best-practices.png><img src=/data/attachment/album/201802/28/154555diiz80sscg33mrci.png alt="OpenSSH 服务安全最佳实践"></a></p><p>更多有关 ssh 公匙的信息，参照以下文章：</p><ul><li><a href=https://www.cyberciti.biz/faq/ssh-passwordless-login-with-keychain-for-scripts/>为备份脚本设置无密码安全登录</a></li><li><a href=/article-8086-1.html>sshpass：使用脚本密码登录 SSH 服务器</a></li><li><a href=https://www.cyberciti.biz/faq/how-to-set-up-ssh-keys-on-linux-unix/>如何为一个 Linux/类 Unix 系统设置 SSH 登录密匙</a></li><li><a href=https://www.cyberciti.biz/faq/how-to-upload-ssh-public-key-to-as-authorized_key-using-ansible/>如何使用 Ansible 工具上传 ssh 登录授权公匙</a></li></ul><h3 id=2-禁用-root-用户登录>2、 禁用 root 用户登录</h3><p>禁用 root 用户登录前，确认普通用户可以以 root 身份登录。例如，允许用户 vivek 使用 <code>sudo</code> 命令以 root 身份登录。</p><h4 id=在-debianubuntu-系统中如何将用户-vivek-添加到-sudo-组中>在 Debian/Ubuntu 系统中如何将用户 vivek 添加到 sudo 组中</h4><p>允许 sudo 组中的用户执行任何命令。 <a href=https://www.cyberciti.biz/faq/how-to-create-a-sudo-user-on-ubuntu-linux-server/>将用户 vivek 添加到 sudo 组中</a>：</p><pre tabindex=0><code>$ sudo adduser vivek sudo
</code></pre><p>使用 <a href=https://www.cyberciti.biz/faq/unix-linux-id-command-examples-usage-syntax/ title="See Linux/Unix id command examples for more info">id 命令</a> 验证用户组。</p><pre tabindex=0><code>$ id vivek
</code></pre><h4 id=在-centosrhel-系统中如何将用户-vivek-添加到-sudo-组中>在 CentOS/RHEL 系统中如何将用户 vivek 添加到 sudo 组中</h4><p>在 CentOS/RHEL 和 Fedora 系统中允许 wheel 组中的用户执行所有的命令。使用 <code>usermod</code> 命令将用户 vivek 添加到 wheel 组中：</p><pre tabindex=0><code>$ sudo usermod -aG wheel vivek
$ id vivek
</code></pre><h4 id=测试-sudo-权限并禁用-ssh-root-登录>测试 sudo 权限并禁用 ssh root 登录</h4><p>测试并确保用户 vivek 可以以 root 身份登录执行以下命令：</p><pre tabindex=0><code>$ sudo -i
$ sudo /etc/init.d/sshd status
$ sudo systemctl status httpd
</code></pre><p>添加以下内容到 <code>sshd_config</code> 文件中来禁用 root 登录：</p><pre tabindex=0><code>PermitRootLogin no
ChallengeResponseAuthentication no
PasswordAuthentication no
UsePAM no
</code></pre><p>更多信息参见“<a href=https://www.cyberciti.biz/faq/how-to-disable-ssh-password-login-on-linux/>如何通过禁用 Linux 的 ssh 密码登录来增强系统安全</a>” 。</p><h3 id=3-禁用密码登录>3、 禁用密码登录</h3><p>所有的密码登录都应该禁用，仅留下公匙登录。添加以下内容到 <code>sshd_config</code> 文件中：</p><pre tabindex=0><code>AuthenticationMethods publickey
PubkeyAuthentication yes
</code></pre><p>CentOS 6.x/RHEL 6.x 系统中老版本的 sshd 用户可以使用以下设置：</p><pre tabindex=0><code>PubkeyAuthentication yes
</code></pre><h3 id=4-限制用户的-ssh-访问>4、 限制用户的 ssh 访问</h3><p>默认状态下，所有的系统用户都可以使用密码或公匙登录。但是有些时候需要为 FTP 或者 email 服务创建 UNIX/Linux 用户。然而，这些用户也可以使用 ssh 登录系统。他们将获得访问系统工具的完整权限，包括编译器和诸如 Perl、Python（可以打开网络端口干很多疯狂的事情）等的脚本语言。通过添加以下内容到 <code>sshd_config</code> 文件中来仅允许用户 root、vivek 和 jerry 通过 SSH 登录系统：</p><pre tabindex=0><code>AllowUsers vivek jerry
</code></pre><p>当然，你也可以添加以下内容到 <code>sshd_config</code> 文件中来达到仅拒绝一部分用户通过 SSH 登录系统的效果。</p><pre tabindex=0><code>DenyUsers root saroj anjali foo
</code></pre><p>你也可以通过<a href=https://www.cyberciti.biz/tips/linux-pam-configuration-that-allows-or-deny-login-via-the-sshd-server.html>配置 Linux PAM</a> 来禁用或允许用户通过 sshd 登录。也可以允许或禁止一个<a href=https://www.cyberciti.biz/tips/openssh-deny-or-restrict-access-to-users-and-groups.html>用户组列表</a>通过 ssh 登录系统。</p><h3 id=5-禁用空密码>5、 禁用空密码</h3><p>你需要明确禁止空密码账户远程登录系统，更新 <code>sshd_config</code> 文件的以下内容：</p><pre tabindex=0><code>PermitEmptyPasswords no
</code></pre><h3 id=6-为-ssh-用户或者密匙使用强密码>6、 为 ssh 用户或者密匙使用强密码</h3><p>为密匙使用强密码和短语的重要性再怎么强调都不过分。暴力破解可以起作用就是因为用户使用了基于字典的密码。你可以强制用户避开<a href=https://www.cyberciti.biz/tips/linux-check-passwords-against-a-dictionary-attack.html>字典密码</a>并使用<a href=https://www.cyberciti.biz/faq/unix-linux-password-cracking-john-the-ripper/>约翰的开膛手工具</a>来检测弱密码。以下是一个随机密码生成器（放到你的 <code>~/.bashrc</code> 下）：</p><pre tabindex=0><code>genpasswd() {
    local l=$1
    [ &#34;$l&#34; == &#34;&#34; ] &amp;&amp; l=20
    tr -dc A-Za-z0-9_ &lt; /dev/urandom | head -c ${l} | xargs
}
</code></pre><p>运行：</p><pre tabindex=0><code>genpasswd 16
</code></pre><p>输出：</p><pre tabindex=0><code>uw8CnDVMwC6vOKgW
</code></pre><ul><li><a href=https://www.cyberciti.biz/faq/generating-random-password/>使用 mkpasswd / makepasswd / pwgen 生成随机密码</a></li><li><a href=https://www.cyberciti.biz/faq/linux-unix-generating-passwords-command/>Linux / UNIX: 生成密码</a></li><li><a href=https://www.cyberciti.biz/faq/linux-random-password-generator/>Linux 随机密码生成命令</a></li></ul><h3 id=7-为-ssh-的-22端口配置防火墙>7、 为 SSH 的 22端口配置防火墙</h3><p>你需要更新 <code>iptables</code>/<code>ufw</code>/<code>firewall-cmd</code> 或 pf 防火墙配置来为 ssh 的 TCP 端口 22 配置防火墙。一般来说，OpenSSH 服务应该仅允许本地或者其他的远端地址访问。</p><h4 id=netfilteriptables-配置>Netfilter（Iptables） 配置</h4><p>更新 <a href=https://www.cyberciti.biz/faq/rhel-fedorta-linux-iptables-firewall-configuration-tutorial/>/etc/sysconfig/iptables （Redhat 和其派生系统特有文件）</a> 实现仅接受来自于 192.168.1.0/24 和 202.54.1.5/29 的连接，输入：</p><pre tabindex=0><code>-A RH-Firewall-1-INPUT -s 192.168.1.0/24 -m state --state NEW -p tcp --dport 22 -j ACCEPT
-A RH-Firewall-1-INPUT -s 202.54.1.5/29 -m state --state NEW -p tcp --dport 22 -j ACCEPT
</code></pre><p>如果同时使用 IPv6 的话，可以编辑 <code>/etc/sysconfig/ip6tables</code> （Redhat 和其派生系统特有文件），输入：</p><pre tabindex=0><code>-A RH-Firewall-1-INPUT -s ipv6network::/ipv6mask -m tcp -p tcp --dport 22 -j ACCEPT
</code></pre><p>将 <code>ipv6network::/ipv6mask</code> 替换为实际的 IPv6 网段。</p><h4 id=debianubuntu-linux-下的-ufw>Debian/Ubuntu Linux 下的 UFW</h4><p><a href=https://www.cyberciti.biz/faq/howto-configure-setup-firewall-with-ufw-on-ubuntu-linux/>UFW 是 Uncomplicated FireWall 的首字母缩写，主要用来管理 Linux 防火墙</a>，目的是提供一种用户友好的界面。输入<a href=https://www.cyberciti.biz/faq/ufw-allow-incoming-ssh-connections-from-a-specific-ip-address-subnet-on-ubuntu-debian/>以下命令使得系统仅允许网段 202.54.1.5/29 接入端口 22</a>：</p><pre tabindex=0><code>$ sudo ufw allow from 202.54.1.5/29 to any port 22
</code></pre><p>更多信息请参见 “<a href=https://www.cyberciti.biz/tips/linux-iptables-examples.html>Linux：菜鸟管理员的 25 个 Iptables Netfilter 命令</a>”。</p><h4 id=bsd-pf-防火墙配置>*BSD PF 防火墙配置</h4><p>如果使用 PF 防火墙 <a href=https://bash.cyberciti.biz/firewall/pf-firewall-script/>/etc/pf.conf</a> 配置如下：</p><pre tabindex=0><code>pass in on $ext_if inet proto tcp from {192.168.1.0/24, 202.54.1.5/29} to $ssh_server_ip port ssh flags S/SA synproxy state
</code></pre><h3 id=8-修改-ssh-端口和绑定-ip>8、 修改 SSH 端口和绑定 IP</h3><p>ssh 默认监听系统中所有可用的网卡。修改并绑定 ssh 端口有助于避免暴力脚本的连接（许多暴力脚本只尝试端口 22）。更新文件 <code>sshd_config</code> 的以下内容来绑定端口 300 到 IP 192.168.1.5 和 202.54.1.5：</p><pre tabindex=0><code>Port 300 
ListenAddress 192.168.1.5
ListenAddress 202.54.1.5
</code></pre><p>当需要接受动态广域网地址的连接时，使用主动脚本是个不错的选择，比如 fail2ban 或 denyhosts。</p><h3 id=9-使用-tcp-wrappers-可选的>9、 使用 TCP wrappers （可选的）</h3><p>TCP wrapper 是一个基于主机的访问控制系统，用来过滤来自互联网的网络访问。OpenSSH 支持 TCP wrappers。只需要更新文件 <code>/etc/hosts.allow</code> 中的以下内容就可以使得 SSH 只接受来自于 192.168.1.2 和 172.16.23.12 的连接：</p><pre tabindex=0><code>sshd : 192.168.1.2 172.16.23.12
</code></pre><p>在 Linux/Mac OS X 和类 UNIX 系统中参见 <a href=https://www.cyberciti.biz/faq/tcp-wrappers-hosts-allow-deny-tutorial/>TCP wrappers 设置和使用的常见问题</a>。</p><h3 id=10-阻止-ssh-破解或暴力攻击>10、 阻止 SSH 破解或暴力攻击</h3><p>暴力破解是一种在单一或者分布式网络中使用大量（用户名和密码的）组合来尝试连接一个加密系统的方法。可以使用以下软件来应对暴力攻击：</p><ul><li><a href=https://www.cyberciti.biz/faq/block-ssh-attacks-with-denyhosts/>DenyHosts</a> 是一个基于 Python SSH 安全工具。该工具通过监控授权日志中的非法登录日志并封禁原始 IP 的方式来应对暴力攻击。<ul><li>RHEL / Fedora 和 CentOS Linux 下如何设置 <a href=https://www.cyberciti.biz/faq/rhel-linux-block-ssh-dictionary-brute-force-attacks/>DenyHosts</a>。</li></ul></li><li><a href=https://www.fail2ban.org>Fail2ban</a> 是另一个类似的用来预防针对 SSH 攻击的工具。</li><li><a href=https://sshguard.sourceforge.net/>sshguard</a> 是一个使用 pf 来预防针对 SSH 和其他服务攻击的工具。</li><li><a href=http://www.bsdconsulting.no/tools/>security/sshblock</a> 阻止滥用 SSH 尝试登录。</li><li><a href=https://savannah.nongnu.org/projects/ipqbdb/>IPQ BDB filter</a> 可以看做是 fail2ban 的一个简化版。</li></ul><h3 id=11-限制-tcp-端口-22-的传入速率可选的>11、 限制 TCP 端口 22 的传入速率（可选的）</h3><p>netfilter 和 pf 都提供速率限制选项可以对端口 22 的传入速率进行简单的限制。</p><h4 id=iptables-示例>Iptables 示例</h4><p>以下脚本将会阻止 60 秒内尝试登录 5 次以上的客户端的连入。</p><pre tabindex=0><code>#!/bin/bash
inet_if=eth1
ssh_port=22
$IPT -I INPUT -p tcp --dport ${ssh_port} -i ${inet_if} -m state --state NEW -m recent --set
$IPT -I INPUT -p tcp --dport ${ssh_port} -i ${inet_if} -m state --state NEW -m recent --update --seconds 60 --hitcount 5
</code></pre><p>在你的 iptables 脚本中调用以上脚本。其他配置选项：</p><pre tabindex=0><code>$IPT -A INPUT -i ${inet_if} -p tcp --dport ${ssh_port} -m state --state NEW -m limit --limit 3/min --limit-burst 3 -j ACCEPT
$IPT -A INPUT -i ${inet_if} -p tcp --dport ${ssh_port} -m state --state ESTABLISHED -j ACCEPT
$IPT -A OUTPUT -o ${inet_if} -p tcp --sport ${ssh_port} -m state --state ESTABLISHED -j ACCEPT
# another one line example
# $IPT -A INPUT -i ${inet_if} -m state --state NEW,ESTABLISHED,RELATED -p tcp --dport 22 -m limit --limit 5/minute --limit-burst 5-j ACCEPT
</code></pre><p>其他细节参见 iptables 用户手册。</p><h4 id=bsd-pf-示例>*BSD PF 示例</h4><p>以下脚本将限制每个客户端的连入数量为 20，并且 5 秒内的连接不超过 15 个。如果客户端触发此规则，则将其加入 abusive_ips 表并限制该客户端连入。最后 flush 关键词杀死所有触发规则的客户端的连接。</p><pre tabindex=0><code>sshd_server_ip = &#34;202.54.1.5&#34; 
table &lt;abusive_ips&gt; persist
block in quick from &lt;abusive_ips&gt;
pass in on $ext_if proto tcp to $sshd_server_ip port ssh flags S/SA keep state (max-src-conn 20, max-src-conn-rate 15/5, overload &lt;abusive_ips&gt; flush) 
</code></pre><h3 id=12-使用端口敲门可选的>12、 使用端口敲门（可选的）</h3><p><a href=https://en.wikipedia.org/wiki/Port_knocking>端口敲门</a>是通过在一组预先指定的封闭端口上生成连接尝试，以便从外部打开防火墙上的端口的方法。一旦指定的端口连接顺序被触发，防火墙规则就被动态修改以允许发送连接的主机连入指定的端口。以下是一个使用 iptables 实现的端口敲门的示例：</p><pre tabindex=0><code>$IPT -N stage1
$IPT -A stage1 -m recent --remove --name knock
$IPT -A stage1 -p tcp --dport 3456 -m recent --set --name knock2

$IPT -N stage2
$IPT -A stage2 -m recent --remove --name knock2
$IPT -A stage2 -p tcp --dport 2345 -m recent --set --name heaven

$IPT -N door
$IPT -A door -m recent --rcheck --seconds 5 --name knock2 -j stage2
$IPT -A door -m recent --rcheck --seconds 5 --name knock -j stage1
$IPT -A door -p tcp --dport 1234 -m recent --set --name knock

$IPT -A INPUT -m --state ESTABLISHED,RELATED -j ACCEPT
$IPT -A INPUT -p tcp --dport 22 -m recent --rcheck --seconds 5 --name heaven -j ACCEPT
$IPT -A INPUT -p tcp --syn -j door
</code></pre><p>更多信息请参见：</p><p><a href=https://www.cyberciti.biz/faq/debian-ubuntu-linux-iptables-knockd-port-knocking-tutorial/>Debian / Ubuntu: 使用 Knockd and Iptables 设置端口敲门</a></p><h3 id=13-配置空闲超时注销时长>13、 配置空闲超时注销时长</h3><p>用户可以通过 ssh 连入服务器，可以配置一个超时时间间隔来避免无人值守的 ssh 会话。 打开 <code>sshd_config</code> 并确保配置以下值：</p><pre tabindex=0><code>ClientAliveInterval 300
ClientAliveCountMax 0
</code></pre><p>以秒为单位设置一个空闲超时时间（300秒 = 5分钟）。一旦空闲时间超过这个值，空闲用户就会被踢出会话。更多细节参见<a href=https://www.cyberciti.biz/faq/linux-unix-login-bash-shell-force-time-outs/>如何自动注销空闲超时的 BASH / TCSH / SSH 用户</a>。</p><h3 id=14-为-ssh-用户启用警示标语>14、 为 ssh 用户启用警示标语</h3><p>更新 <code>sshd_config</code> 文件如下行来设置用户的警示标语：</p><pre tabindex=0><code>Banner /etc/issue
</code></pre><p>`/etc/issue 示例文件：</p><pre tabindex=0><code>----------------------------------------------------------------------------------------------
You are accessing a XYZ Government (XYZG) Information System (IS) that is provided for authorized use only.
By using this IS (which includes any device attached to this IS), you consent to the following conditions:

+ The XYZG routinely intercepts and monitors communications on this IS for purposes including, but not limited to,
penetration testing, COMSEC monitoring, network operations and defense, personnel misconduct (PM),
law enforcement (LE), and counterintelligence (CI) investigations.

+ At any time, the XYZG may inspect and seize data stored on this IS.

+ Communications using, or data stored on, this IS are not private, are subject to routine monitoring,
interception, and search, and may be disclosed or used for any XYZG authorized purpose.

+ This IS includes security measures (e.g., authentication and access controls) to protect XYZG interests--not
for your personal benefit or privacy.

+ Notwithstanding the above, using this IS does not constitute consent to PM, LE or CI investigative searching
or monitoring of the content of privileged communications, or work product, related to personal representation
or services by attorneys, psychotherapists, or clergy, and their assistants. Such communications and work
product are private and confidential. See User Agreement for details.
----------------------------------------------------------------------------------------------
</code></pre><p>以上是一个标准的示例，更多的用户协议和法律细节请咨询你的律师团队。</p><h3 id=15-禁用-rhosts-文件需核实>15、 禁用 .rhosts 文件（需核实）</h3><p>禁止读取用户的 <code>~/.rhosts</code> 和 <code>~/.shosts</code> 文件。更新 <code>sshd_config</code> 文件中的以下内容：</p><pre tabindex=0><code>IgnoreRhosts yes
</code></pre><p>SSH 可以模拟过时的 rsh 命令，所以应该禁用不安全的 RSH 连接。</p><h3 id=16-禁用基于主机的授权需核实>16、 禁用基于主机的授权（需核实）</h3><p>禁用基于主机的授权，更新 <code>sshd_config</code> 文件的以下选项：</p><pre tabindex=0><code>HostbasedAuthentication no
</code></pre><h3 id=17-为-openssh-和操作系统打补丁>17、 为 OpenSSH 和操作系统打补丁</h3><p>推荐你使用类似 <a href=https://www.cyberciti.biz/faq/rhel-centos-fedora-linux-yum-command-howto/>yum</a>、<a href=https://www.cyberciti.biz/tips/linux-debian-package-management-cheat-sheet.html>apt-get</a> 和 <a href=https://www.cyberciti.biz/tips/howto-keep-freebsd-system-upto-date.html>freebsd-update</a> 等工具保持系统安装了最新的安全补丁。</p><h3 id=18-chroot-openssh-将用户锁定在主目录>18、 Chroot OpenSSH （将用户锁定在主目录）</h3><p>默认设置下用户可以浏览诸如 <code>/etc</code>、<code>/bin</code> 等目录。可以使用 chroot 或者其他专有工具如 <a href=https://www.cyberciti.biz/tips/rhel-centos-linux-install-configure-rssh-shell.html>rssh</a> 来保护 ssh 连接。从版本 4.8p1 或 4.9p1 起，OpenSSH 不再需要依赖诸如 rssh 或复杂的 chroot(1) 等第三方工具来将用户锁定在主目录中。可以使用新的 <code>ChrootDirectory</code> 指令将用户锁定在其主目录，参见<a href=https://www.debian-administration.org/articles/590>这篇博文</a>。</p><h3 id=19-禁用客户端的-openssh-服务>19. 禁用客户端的 OpenSSH 服务</h3><p>工作站和笔记本不需要 OpenSSH 服务。如果不需要提供 ssh 远程登录和文件传输功能的话，可以禁用 sshd 服务。CentOS / RHEL 用户可以使用 <a href=https://www.cyberciti.biz/faq/rhel-centos-fedora-linux-yum-command-howto/ title="See Linux/Unix yum command examples for more info">yum 命令</a> 禁用或删除 openssh-server：</p><pre tabindex=0><code>$ sudo yum erase openssh-server
</code></pre><p>Debian / Ubuntu 用户可以使用 <a href=https://www.cyberciti.biz/faq/ubuntu-lts-debian-linux-apt-command-examples/ title="See Linux/Unix apt command examples for more info">apt 命令</a>/<a href=https://www.cyberciti.biz/tips/linux-debian-package-management-cheat-sheet.html title="See Linux/Unix apt-get command examples for more info">apt-get 命令</a> 删除 openssh-server：</p><pre tabindex=0><code>$ sudo apt-get remove openssh-server
</code></pre><p>有可能需要更新 iptables 脚本来移除 ssh 的例外规则。CentOS / RHEL / Fedora 系统可以编辑文件 <code>/etc/sysconfig/iptables</code> 和 <code>/etc/sysconfig/ip6tables</code>。最后<a href=https://www.cyberciti.biz/faq/howto-rhel-linux-open-port-using-iptables/>重启 iptables</a> 服务：</p><pre tabindex=0><code># service iptables restart
# service ip6tables restart
</code></pre><h3 id=20-来自-mozilla-的额外提示>20. 来自 Mozilla 的额外提示</h3><p>如果使用 6.7+ 版本的 OpenSSH，可以尝试下<a href=https://wiki.mozilla.org/Security/Guidelines/OpenSSH>以下设置</a>：</p><pre tabindex=0><code>#################[ WARNING ]########################
# Do not use any setting blindly. Read sshd_config #
# man page. You must understand cryptography to    #
# tweak following settings. Otherwise use defaults #
####################################################

# Supported HostKey algorithms by order of preference.
HostKey /etc/ssh/ssh_host_ed25519_key
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_ecdsa_key

# Specifies the available KEX (Key Exchange) algorithms.
KexAlgorithms curve25519-sha256@libssh.org,ecdh-sha2-nistp521,ecdh-sha2-nistp384,ecdh-sha2-nistp256,diffie-hellman-group-exchange-sha256

# Specifies the ciphers allowed
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr

#Specifies the available MAC (message authentication code) algorithms
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512,hmac-sha2-256,umac-128@openssh.com

# LogLevel VERBOSE logs user&#39;s key fingerprint on login. Needed to have a clear audit track of which key was using to log in.
LogLevel VERBOSE

# Log sftp level file access (read/write/etc.) that would not be easily logged otherwise.
Subsystem sftp /usr/lib/ssh/sftp-server -f AUTHPRIV -l INFO
</code></pre><p>使用以下命令获取 OpenSSH 支持的加密方法：</p><pre tabindex=0><code>$ ssh -Q cipher
$ ssh -Q cipher-auth
$ ssh -Q mac
$ ssh -Q kex
$ ssh -Q key
</code></pre><p><a href=https://www.cyberciti.biz/tips/wp-content/uploads/2009/07/OpenSSH-Security-Tutorial-Query-Ciphers-and-algorithms-choice.jpg><img src=/data/attachment/album/201802/28/154556yizvchkjzgh3pim3.jpg alt=OpenSSH安全教程查询密码和算法选择></a></p><h3 id=如何测试-sshd_config-文件并重启重新加载-ssh-服务>如何测试 sshd_config 文件并重启/重新加载 SSH 服务？</h3><p>在重启 sshd 前检查配置文件的有效性和密匙的完整性，运行：</p><pre tabindex=0><code>$ sudo sshd -t
</code></pre><p>扩展测试模式：</p><pre tabindex=0><code>$ sudo sshd -T
</code></pre><p>最后，根据系统的的版本<a href=https://www.cyberciti.biz/faq/howto-restart-ssh/>重启 Linux 或类 Unix 系统中的 sshd 服务</a>：</p><pre tabindex=0><code>$ [sudo systemctl start ssh][38] ## Debian/Ubunt Linux##
$ [sudo systemctl restart sshd.service][39] ## CentOS/RHEL/Fedora Linux##
$ doas /etc/rc.d/sshd restart ## OpenBSD##
$ sudo service sshd restart ## FreeBSD## 
</code></pre><h3 id=其他建议>其他建议</h3><ol><li><a href=https://www.cyberciti.biz/open-source/howto-protect-linux-ssh-login-with-google-authenticator/>使用 2FA 加强 SSH 的安全性</a> - 可以使用 <a href=http://www.nongnu.org/oath-toolkit/>OATH Toolkit</a> 或 <a href=https://duo.com>DuoSecurity</a> 启用多重身份验证。</li><li><a href=https://www.cyberciti.biz/faq/ssh-passwordless-login-with-keychain-for-scripts/>基于密匙链的身份验证</a> - 密匙链是一个 bash 脚本，可以使得基于密匙的验证非常的灵活方便。相对于无密码密匙，它提供更好的安全性。</li></ol><h3 id=更多信息>更多信息</h3><ul><li><a href=https://www.openssh.com/>OpenSSH 官方</a> 项目。</li><li>用户手册: sshd(8)、ssh(1)、ssh-add(1)、ssh-agent(1)。</li></ul><p>如果知道这里没用提及的方便的软件或者技术，请在下面的评论中分享，以帮助读者保持 OpenSSH 的安全。</p><h3 id=关于作者>关于作者</h3><p>作者是 nixCraft 的创始人，一个经验丰富的系统管理员和 Linux/Unix 脚本培训师。他曾与全球客户合作，领域涉及 IT，教育，国防和空间研究以及非营利部门等多个行业。请在 <a href=https://twitter.com/nixcraft>Twitter</a>、<a href=https://facebook.com/nixcraft>Facebook</a>、<a href=https://plus.google.com/+CybercitiBiz>Google+</a> 上关注他。</p><hr><p>via: <a href=https://www.cyberciti.biz/tips/linux-unix-bsd-openssh-server-best-practices.html>https://www.cyberciti.biz/tips/linux-unix-bsd-openssh-server-best-practices.html</a></p><p>作者：<a href=https://www.cyberciti.biz>Vivek Gite</a> 译者：<a href=https://github.com/shipsw>shipsw</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/ssh/ rel=tag>SSH</a></li><li class=tags__item><a class="tags__link btn" href=/tags/openssh/ rel=tag>OpenSSH</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>