<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>如何在 CentOS 7 中使用 Nginx 和 PHP7-FPM 安装 Nextcloud - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="如何在 CentOS 7 中使用 Nginx 和 PHP7-FPM 安装 Nextcloud"><meta property="og:description" content="Nextcloud 是一款自由 (开源) 的类 Dropbox 软件，由 ownCloud 分支演化形成。Nextcloud 并非只是 Dropbox 的克隆，它还提供了很多附加特性，如日历、联系人、计划任务以及流媒体 Ampache。"><meta property="og:type" content="article"><meta property="og:url" content="/article-8242-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-02-27T11:51:20+00:00"><meta property="article:modified_time" content="2017-02-27T11:51:20+00:00"><meta itemprop=name content="如何在 CentOS 7 中使用 Nginx 和 PHP7-FPM 安装 Nextcloud"><meta itemprop=description content="Nextcloud 是一款自由 (开源) 的类 Dropbox 软件，由 ownCloud 分支演化形成。Nextcloud 并非只是 Dropbox 的克隆，它还提供了很多附加特性，如日历、联系人、计划任务以及流媒体 Ampache。"><meta itemprop=datePublished content="2017-02-27T11:51:20+00:00"><meta itemprop=dateModified content="2017-02-27T11:51:20+00:00"><meta itemprop=wordCount content="1024"><meta itemprop=keywords content="Nextcloud,ownCloud,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>如何在 CentOS 7 中使用 Nginx 和 PHP7-FPM 安装 Nextcloud</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2017-02-27T11:51:20Z>February 27, 2017</time></div></div></header><div class="content post__content clearfix"><p>Nextcloud 是一款自由 (开源) 的类 Dropbox 软件，由 ownCloud 分支演化形成。它使用 PHP 和 JavaScript 编写，支持多种数据库系统，比如 MySQL/MariaDB、PostgreSQL、Oracle 数据库和 SQLite。它可以使你的桌面系统和云服务器中的文件保持同步，Nextcloud 为 Windows、Linux、Mac、安卓以及苹果手机都提供了客户端支持。Nextcloud 并非只是 Dropbox 的克隆，它还提供了很多附加特性，如日历、联系人、计划任务以及流媒体 Ampache。</p><p>在这篇文章中，我将向你展示如何在 CentOS 7 服务器中安装和配置最新版本的 Nextcloud 10。我会通过 Nginx 和 PHP7-FPM 来运行 Nextcloud，同时使用 MariaDB 做为数据库系统。</p><p><img src=/data/attachment/album/201702/27/115114jv8a6y6awr83a6i3.jpg alt></p><p><strong>先决条件</strong></p><ul><li>64 位的 CentOS 7</li><li>服务器的 Root 权限</li></ul><h3 id=步骤-1---在-centos-7-中安装-nginx-和-php7-fpm>步骤 1 - 在 CentOS 7 中安装 Nginx 和 PHP7-FPM</h3><p>在开始安装 Nginx 和 php7-fpm 之前，我们还学要先添加 EPEL 包的仓库源。使用如下命令：</p><pre tabindex=0><code>yum -y install epel-release
</code></pre><p>现在开始从 EPEL 仓库来安装 Nginx：</p><pre tabindex=0><code>yum -y install nginx
</code></pre><p>然后我们还需要为 php7-fpm 添加另外一个仓库。互联网中有很个远程仓库提供了 PHP 7 系列包，我在这里使用的是 webtatic。</p><p>添加 PHP7-FPM webtatic 仓库：</p><pre tabindex=0><code>rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm
</code></pre><p>然后就是安装 PHP7-FPM 以及 Nextcloud 需要的一些包。</p><pre tabindex=0><code>yum -y install php70w-fpm php70w-cli php70w-gd php70w-mcrypt php70w-mysql php70w-pear php70w-xml php70w-mbstring php70w-pdo php70w-json php70w-pecl-apcu php70w-pecl-apcu-devel
</code></pre><p>最后，从服务器终端里查看 PHP 的版本号，以便验证 PHP 是否正确安装。</p><pre tabindex=0><code>php -v
</code></pre><p><img src=/data/attachment/album/201702/27/115122utlo8okp2g6ook02.png alt="查看 PHP 版本号"></p><h3 id=步骤-2---配置-php7-fpm>步骤 2 - 配置 PHP7-FPM</h3><p>在这一个步骤中，我们将配置 php-fpm 与 Nginx 协同运行。Php7-fpm 将使用 <code>nginx</code> 用户来运行，并监听 <code>9000</code> 端口。</p><p>使用 vim 编辑默认的 php7-fpm 配置文件。</p><pre tabindex=0><code>vim /etc/php-fpm.d/www.conf
</code></pre><p>在第 8 行和第 10行，<code>user</code> 和 <code>group</code> 赋值为 <code>nginx</code>。</p><pre tabindex=0><code>user = nginx
group = nginx
</code></pre><p>在第 22 行，确保 php-fpm 运行在指定端口。</p><pre tabindex=0><code>listen = 127.0.0.1:9000
</code></pre><p>取消第 366-370 行的注释，启用 php-fpm 的系统环境变量。</p><pre tabindex=0><code>env[HOSTNAME] = $HOSTNAME
env[PATH] = /usr/local/bin:/usr/bin:/bin
env[TMP] = /tmp
env[TMPDIR] = /tmp
env[TEMP] = /tmp
</code></pre><p>保存文件并退出 vim 编辑器。</p><p>下一步，就是在 <code>/var/lib/</code> 目录下创建一个新的文件夹 <code>session</code>，并将其拥有者变更为 <code>nginx</code> 用户。</p><pre tabindex=0><code>mkdir -p /var/lib/php/session
chown nginx:nginx -R /var/lib/php/session/
</code></pre><p>然后启动 php-fpm 和 Nginx，并且将它们设置为随开机启动的服务。</p><pre tabindex=0><code>sudo systemctl start php-fpm
sudo systemctl start nginx

sudo systemctl enable php-fpm
sudo systemctl enable nginx
</code></pre><p><img src=/data/attachment/album/201702/27/115123wc21ae2yl1e42akw.png alt="启动 php-fpm 和 Nginx"></p><p>PHP7-FPM 配置完成</p><h3 id=步骤-3---安装和配置-mariadb>步骤 3 - 安装和配置 MariaDB</h3><p>我这里使用 MariaDB 作为 Nextcloud 的数据库。可以直接使用 <code>yum</code> 命令从 CentOS 默认远程仓库中安装 <code>mariadb-server</code> 包。</p><pre tabindex=0><code>yum -y install mariadb mariadb-server
</code></pre><p>启动 MariaDB，并将其添加到随系统启动的服务中去。</p><pre tabindex=0><code>systemctl start mariadb
systemctl enable mariadb
</code></pre><p>现在开始配置 MariaDB 的 root 用户密码。</p><pre tabindex=0><code>mysql_secure_installation
</code></pre><p>键入 <code>Y</code> ，然后设置 MariaDB 的 root 密码。</p><pre tabindex=0><code>Set root password? [Y/n] Y
New password:
Re-enter new password:

Remove anonymous users? [Y/n] Y
Disallow root login remotely? [Y/n] Y
Remove test database and access to it? [Y/n] Y
Reload privilege tables now? [Y/n] Y
</code></pre><p>这样就设置好了密码，现在登录到 mysql shell 并为 Nextcloud 创建一个新的数据库和用户。这里我创建名为 <code>nextcloud_db</code> 的数据库以及名为 <code>nextclouduser</code> 的用户，用户密码为 <code>nextclouduser@</code>。当然了，要给你自己的系统选用一个更安全的密码。</p><pre tabindex=0><code>mysql -u root -p
</code></pre><p>输入 MariaDB 的 root 密码，即可登录 mysql shell。</p><p>输入以下 mysql 查询语句来创建新的数据库和用户。</p><pre tabindex=0><code>create database nextcloud_db;
create user nextclouduser@localhost identified by &#39;nextclouduser@&#39;;
grant all privileges on nextcloud_db.* to&amp;nbsp;nextclouduser@localhost identified by &#39;nextclouduser@&#39;;
flush privileges;
</code></pre><p><img src=/data/attachment/album/201702/27/115123dk7wcda7ndfccnfz.png alt="为 Nextcloud 创建一个新的数据库和用户"></p><p><code>nextcloud_db</code> 数据库和 <code>nextclouduser</code> 数据库用户创建完成</p><h3 id=步骤-4---为-nextcloud-生成一个自签名-ssl-证书>步骤 4 - 为 Nextcloud 生成一个自签名 SSL 证书</h3><p>在教程中，我会让客户端以 https 连接来运行 Nextcloud。你可以使用诸如 let&rsquo;s encrypt 等免费 SSL 证书，或者是自己创建自签名 (self signed) SSL 证书。这里我使用 OpenSSL 来创建自己的自签名 SSL 证书。</p><p>为 SSL 文件创建新目录：</p><pre tabindex=0><code>mkdir -p /etc/nginx/cert/
</code></pre><p>如下，使用 <code>openssl</code> 生成一个新的 SSL 证书。</p><pre tabindex=0><code>openssl req -new -x509 -days 365 -nodes -out /etc/nginx/cert/nextcloud.crt -keyout /etc/nginx/cert/nextcloud.key
</code></pre><p>最后使用 <code>chmod</code> 命令将所有证书文件的权限设置为 <code>600</code>。</p><pre tabindex=0><code>chmod 700 /etc/nginx/cert
chmod 600 /etc/nginx/cert/*
</code></pre><p><img src=/data/attachment/album/201702/27/115124dmwotmrvuow3wrxu.png alt="为 Nextcloud 生成一个自签名 SSL 证书"></p><h3 id=步骤-5---下载和安装-nextcloud>步骤 5 - 下载和安装 Nextcloud</h3><p>我直接使用 <code>wget</code> 命令下载 Nextcloud 到服务器上，因此需要先行安装 <code>wget</code>。此外，还需要安装 <code>unzip</code> 来进行解压。使用 <code>yum</code> 命令来安装这两个程序。</p><pre tabindex=0><code>yum -y install wget unzip
</code></pre><p>先进入 <code>/tmp</code> 目录，然后使用 <code>wget</code> 从官网下载最新的 Nextcloud 10。</p><pre tabindex=0><code>cd /tmp
wget https://download.nextcloud.com/server/releases/nextcloud-10.0.2.zip
</code></pre><p>解压 Nextcloud，并将其移动到 <code>/usr/share/nginx/html/</code> 目录。</p><pre tabindex=0><code>unzip nextcloud-10.0.2.zip
mv nextcloud/ /usr/share/nginx/html/
</code></pre><p>下一步，转到 Nginx 的 web 根目录为 Nextcloud 创建一个 <code>data</code> 文件夹。</p><pre tabindex=0><code>cd /usr/share/nginx/html/
mkdir -p nextcloud/data/
</code></pre><p>变更 <code>nextcloud</code> 目录的拥有者为 <code>nginx</code> 用户和组。</p><pre tabindex=0><code>chown nginx:nginx -R nextcloud/
</code></pre><h3 id=步骤-6---在-nginx-中为-nextcloud-配置虚拟主机>步骤 6 - 在 Nginx 中为 Nextcloud 配置虚拟主机</h3><p>在步骤 5 我们已经下载好了 Nextcloud 源码，并配置好了让它运行于 Nginx 服务器中，但我们还需要为它配置一个虚拟主机。在 Nginx 的 <code>conf.d</code> 目录下创建一个新的虚拟主机配置文件 <code>nextcloud.conf</code>。</p><pre tabindex=0><code>cd /etc/nginx/conf.d/
vim nextcloud.conf
</code></pre><p>将以下内容粘贴到虚拟主机配置文件中：</p><pre tabindex=0><code>upstream php-handler {
    server 127.0.0.1:9000;
    #server unix:/var/run/php5-fpm.sock;
}

server {
    listen 80;
    server_name cloud.nextcloud.co;
    # enforce https
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl;
    server_name cloud.nextcloud.co;

    ssl_certificate /etc/nginx/cert/nextcloud.crt;
    ssl_certificate_key /etc/nginx/cert/nextcloud.key;

    # Add headers to serve security related headers
    # Before enabling Strict-Transport-Security headers please read into this
    # topic first.
    add_header Strict-Transport-Security &#34;max-age=15768000;
    includeSubDomains; preload;&#34;;
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options &#34;SAMEORIGIN&#34;;
    add_header X-XSS-Protection &#34;1; mode=block&#34;;
    add_header X-Robots-Tag none;
    add_header X-Download-Options noopen;
    add_header X-Permitted-Cross-Domain-Policies none;

    # Path to the root of your installation
    root /usr/share/nginx/html/nextcloud/;

    location = /robots.txt {
        allow all;
        log_not_found off;
        access_log off;
    }

    # The following 2 rules are only needed for the user_webfinger app.
    # Uncomment it if you&#39;re planning to use this app.
    #rewrite ^/.well-known/host-meta /public.php?service=host-meta last;
    #rewrite ^/.well-known/host-meta.json /public.php?service=host-meta-json
    # last;

    location = /.well-known/carddav {
      return 301 $scheme://$host/remote.php/dav;
    }
    location = /.well-known/caldav {
      return 301 $scheme://$host/remote.php/dav;
    }

    # set max upload size
    client_max_body_size 512M;
    fastcgi_buffers 64 4K;

    # Disable gzip to avoid the removal of the ETag header
    gzip off;

    # Uncomment if your server is build with the ngx_pagespeed module
    # This module is currently not supported.
    #pagespeed off;

    error_page 403 /core/templates/403.php;
    error_page 404 /core/templates/404.php;

    location / {
        rewrite ^ /index.php$uri;
    }

    location ~ ^/(?:build|tests|config|lib|3rdparty|templates|data)/ {
        deny all;
    }
    location ~ ^/(?:\.|autotest|occ|issue|indie|db_|console) {
        deny all;
    }

    location ~ ^/(?:index|remote|public|cron|core/ajax/update|status|ocs/v[12]|updater/.+|ocs-provider/.+|core/templates/40[34])\.php(?:$|/) {
        include fastcgi_params;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param HTTPS on;
        #Avoid sending the security headers twice
        fastcgi_param modHeadersAvailable true;
        fastcgi_param front_controller_active true;
        fastcgi_pass php-handler;
        fastcgi_intercept_errors on;
        fastcgi_request_buffering off;
    }

    location ~ ^/(?:updater|ocs-provider)(?:$|/) {
        try_files $uri/ =404;
        index index.php;
    }

    # Adding the cache control header for js and css files
    # Make sure it is BELOW the PHP block
    location ~* \.(?:css|js)$ {
        try_files $uri /index.php$uri$is_args$args;
        add_header Cache-Control &#34;public, max-age=7200&#34;;
        # Add headers to serve security related headers (It is intended to
        # have those duplicated to the ones above)
        # Before enabling Strict-Transport-Security headers please read into
        # this topic first.
        add_header Strict-Transport-Security &#34;max-age=15768000;
        includeSubDomains; preload;&#34;;
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options &#34;SAMEORIGIN&#34;;
        add_header X-XSS-Protection &#34;1; mode=block&#34;;
        add_header X-Robots-Tag none;
        add_header X-Download-Options noopen;
        add_header X-Permitted-Cross-Domain-Policies none;
        # Optional: Don&#39;t log access to assets
        access_log off;
    }

    location ~* \.(?:svg|gif|png|html|ttf|woff|ico|jpg|jpeg)$ {
        try_files $uri /index.php$uri$is_args$args;
        # Optional: Don&#39;t log access to other assets
        access_log off;
    }
}
</code></pre><p>保存文件并退出 vim。</p><p>下载测试以下该 Nginx 配置文件是否有错误，没有的话就可以重启服务了。</p><pre tabindex=0><code>nginx -t
systemctl restart nginx
</code></pre><p><img src=/data/attachment/album/201702/27/115124zj7jqngyvc9rjpyq.png alt="在 Nginx 中为 Nextcloud 配置虚拟主机"></p><h3 id=步骤-7---为-nextcloud-配置-selinux-和-firewalld-规则>步骤 7 - 为 Nextcloud 配置 SELinux 和 FirewallD 规则</h3><p>本教程中，我们将以强制模式运行 SELinux，因此需要一个 SELinux 管理工具来为 Nextcloud 配置 SELinux。</p><p>使用以下命令安装 SELinux 管理工具。</p><pre tabindex=0><code>yum -y install policycoreutils-python
</code></pre><p>然后以 root 用户来运行以下命令，以便让 Nextcloud 运行于 SELinux 环境之下。如果你是用的其他名称的目录，记得将 <code>nextcloud</code> 替换掉。</p><pre tabindex=0><code>semanage fcontext -a -t httpd_sys_rw_content_t &#39;/usr/share/nginx/html/nextcloud/data(/.*)?&#39;
semanage fcontext -a -t httpd_sys_rw_content_t &#39;/usr/share/nginx/html/nextcloud/config(/.*)?&#39;
semanage fcontext -a -t httpd_sys_rw_content_t &#39;/usr/share/nginx/html/nextcloud/apps(/.*)?&#39;
semanage fcontext -a -t httpd_sys_rw_content_t &#39;/usr/share/nginx/html/nextcloud/assets(/.*)?&#39;
semanage fcontext -a -t httpd_sys_rw_content_t &#39;/usr/share/nginx/html/nextcloud/.htaccess&#39;
semanage fcontext -a -t httpd_sys_rw_content_t &#39;/usr/share/nginx/html/nextcloud/.user.ini&#39;

restorecon -Rv &#39;/usr/share/nginx/html/nextcloud/&#39;
</code></pre><p>接下来，我们要启用 firewalld 服务，同时为 Nextcloud 开启 http 和 https 端口。</p><p>启动 firewalld 并设置随系统启动。</p><pre tabindex=0><code>systemctl start firewalld
systemctl enable firewalld
</code></pre><p>现在使用 <code>firewall-cmd</code> 命令来开启 http 和 https 端口，然后重新加载防火墙。</p><pre tabindex=0><code>firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --reload
</code></pre><p><img src=/data/attachment/album/201702/27/115125fcx3sr7sw317zc53.png alt="为 Nextcloud 配置 FirewallD 规则"></p><p>至此，服务器配置完成。</p><h3 id=步骤-8---nextcloud-安装>步骤 8 - Nextcloud 安装</h3><p>打开你的 Web 浏览器，输入你为 Nextcloud 设置的域名，我这里设置为 <code>cloud.nextcloud.co</code>，然后会重定向到安全性更好的 https 连接。</p><p>设置你的管理员用户名和密码，然后输入数据验证信息，点击 &lsquo;<strong>完成安装 (Finish Setup)</strong>&rsquo;。</p><p><img src=/data/attachment/album/201702/27/115125gs4ojzf7h1fobrdo.png alt="Nextcloud 安装"></p><p>Nextcloud 管理面板大致如下：</p><p><img src=/data/attachment/album/201702/27/115126kn65n94gi1nnd5i5.png alt="Nextcloud 管理面板"></p><p>Nextcloud 用户设置：</p><p><img src=/data/attachment/album/201702/27/115126zo7y3krynetk9eek.png alt="Nextcloud 用户设置"></p><p>管理设置：</p><p><img src=/data/attachment/album/201702/27/115127rhpkkk7wv568whhj.png alt=管理设置></p><p>至此，我们在 CentOS 7 服务器上通过使用 Nginx、PHP7-FPM、MariaDB 完成了 Nextcloud 的安装。</p><h3 id=参考链接>参考链接</h3><ul><li><a href=https://docs.nextcloud.com/>https://docs.nextcloud.com/</a></li></ul><hr><p>译者简介：</p><p><a href=http://GHLandy.com>GHLandy</a> —— 划不完粉腮柳眉泣别离。</p><hr><p>via: <a href=https://www.howtoforge.com/tutorial/how-to-install-nextcloud-with-nginx-and-php-fpm-on-centos-7/>https://www.howtoforge.com/tutorial/how-to-install-nextcloud-with-nginx-and-php-fpm-on-centos-7/</a></p><p>作者：<a href=https://www.howtoforge.com/tutorial/how-to-install-nextcloud-with-nginx-and-php-fpm-on-centos-7/>Muhammad Arul</a> 译者：<a href=https://github.com/GHLandy>GHLandy</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/nextcloud/ rel=tag>Nextcloud</a></li><li class=tags__item><a class="tags__link btn" href=/tags/owncloud/ rel=tag>ownCloud</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>