<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>如何配置 MongoDB 副本集 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="如何配置 MongoDB 副本集"><meta property="og:description" content="MongoDB 已经成为市面上最知名的 NoSQL 数据库。MongoDB 是面向文档的，它的无模式设计使得它在各种各样的WEB 应用当中广受欢迎。最让我喜欢的特性之一是它的副本集（Replica Set），副本集将同一数据的多份拷贝放在一组 mongod 节点上，从而实现数据的冗余以及高可用性。  这篇教程将向你介绍如何配置一个 MongoDB 副本集。 副本集的最常见配置需要一个主节点以及多个副节点。这之后启动的复制行为会从这个主节点到其他副节点。副本集不止可以针对意外的硬件故障和停机事件对数据库提供保护，同时也因为提供了更多的节点从而提高了数据库"><meta property="og:type" content="article"><meta property="og:url" content="/article-6107-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-08-28T14:31:00+00:00"><meta property="article:modified_time" content="2015-08-28T14:31:00+00:00"><meta itemprop=name content="如何配置 MongoDB 副本集"><meta itemprop=description content="MongoDB 已经成为市面上最知名的 NoSQL 数据库。MongoDB 是面向文档的，它的无模式设计使得它在各种各样的WEB 应用当中广受欢迎。最让我喜欢的特性之一是它的副本集（Replica Set），副本集将同一数据的多份拷贝放在一组 mongod 节点上，从而实现数据的冗余以及高可用性。  这篇教程将向你介绍如何配置一个 MongoDB 副本集。 副本集的最常见配置需要一个主节点以及多个副节点。这之后启动的复制行为会从这个主节点到其他副节点。副本集不止可以针对意外的硬件故障和停机事件对数据库提供保护，同时也因为提供了更多的节点从而提高了数据库"><meta itemprop=datePublished content="2015-08-28T14:31:00+00:00"><meta itemprop=dateModified content="2015-08-28T14:31:00+00:00"><meta itemprop=wordCount content="362"><meta itemprop=keywords content="MongoDB,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>如何配置 MongoDB 副本集</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2015-08-28T14:31:00Z>August 28, 2015</time></div></div></header><div class="content post__content clearfix"><p>MongoDB 已经成为市面上最知名的 NoSQL 数据库。MongoDB 是面向文档的，它的无模式设计使得它在各种各样的WEB 应用当中广受欢迎。最让我喜欢的特性之一是它的副本集（Replica Set），副本集将同一数据的多份拷贝放在一组 mongod 节点上，从而实现数据的冗余以及高可用性。</p><p><img src=/data/attachment/album/201508/28/142937age17oo7nmh8ja1a.png alt></p><p>这篇教程将向你介绍如何配置一个 MongoDB 副本集。</p><p>副本集的最常见配置需要一个主节点以及多个副节点。这之后启动的复制行为会从这个主节点到其他副节点。副本集不止可以针对意外的硬件故障和停机事件对数据库提供保护，同时也因为提供了更多的节点从而提高了数据库客户端数据读取的吞吐量。</p><h3 id=配置环境>配置环境</h3><p>这个教程里，我们会配置一个包括一个主节点以及两个副节点的副本集。</p><p><img src=/data/attachment/album/201508/28/143104twyzce2ukizzf91w.jpg alt></p><p>为了达到这个目的，我们使用了3个运行在 VirtualBox 上的虚拟机。我会在这些虚拟机上安装 Ubuntu 14.04，并且安装 MongoDB 官方包。</p><p>我会在一个虚拟机实例上配置好所需的环境，然后将它克隆到其他的虚拟机实例上。因此，选择一个名为 master 的虚拟机，执行以下安装过程。</p><p>首先，我们需要给 apt 增加一个 MongoDB 密钥：</p><pre tabindex=0><code>$ sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 7F0CEB10
</code></pre><p>然后，将官方的 MongoDB 仓库添加到 source.list 中：</p><pre tabindex=0><code>$ sudo su
# echo &#34;deb http://repo.mongodb.org/apt/ubuntu &#34;$(lsb_release -sc)&#34;/mongodb-org/3.0 multiverse&#34; | sudo tee /etc/apt/sources.list.d/mongodb-org-3.0.list
</code></pre><p>接下来更新 apt 仓库并且安装 MongoDB。</p><pre tabindex=0><code>$ sudo apt-get update
$ sudo apt-get install -y mongodb-org
</code></pre><p>现在对 /etc/mongodb.conf 做一些更改</p><pre tabindex=0><code>auth = true
dbpath=/var/lib/mongodb
logpath=/var/log/mongodb/mongod.log
logappend=true
keyFile=/var/lib/mongodb/keyFile
replSet=myReplica
</code></pre><p>第一行的作用是表明我们的数据库需要验证才可以使用。keyfile 配置用于 MongoDB 节点间复制行为的密钥文件。replSet 为副本集设置一个名称。</p><p>接下来我们创建一个用于所有实例的密钥文件。</p><pre tabindex=0><code>$ echo -n &#34;MyRandomStringForReplicaSet&#34; | md5sum &gt; keyFile
</code></pre><p>这将会创建一个含有 MD5 字符串的密钥文件，但是由于其中包含了一些噪音，我们需要对他们清理后才能正式在 MongoDB 中使用。</p><pre tabindex=0><code>$ echo -n &#34;MyReplicaSetKey&#34; | md5sum|grep -o &#34;[0-9a-z]\+&#34; &gt; keyFile
</code></pre><p>grep 命令的作用的是把将空格等我们不想要的内容过滤掉之后的 MD5 字符串打印出来。</p><p>现在我们对密钥文件进行一些操作，让它真正可用。</p><pre tabindex=0><code>$ sudo cp keyFile /var/lib/mongodb
$ sudo chown mongodb:nogroup keyFile
$ sudo chmod 400 keyFile
</code></pre><p>接下来，关闭此虚拟机。将其 Ubuntu 系统克隆到其他虚拟机上。</p><p><img src=/data/attachment/album/201508/28/143107ncyy06fjfv28z162.jpg alt></p><p>这是克隆后的副节点1和副节点2。确认你已经将它们的MAC地址重新初始化，并且克隆整个硬盘。</p><p><img src=/data/attachment/album/201508/28/143201za2wqvv5506e151v.jpg alt></p><p>请注意，三个虚拟机示例需要在同一个网络中以便相互通讯。因此，我们需要它们弄到“互联网"上去。</p><p>这里推荐给每个虚拟机设置一个静态 IP 地址，而不是使用 DHCP。这样它们就不至于在 DHCP 分配IP地址给他们的时候失去连接。</p><p>像下面这样编辑每个虚拟机的 /etc/networks/interfaces 文件。</p><p>在主节点上:</p><pre tabindex=0><code>auto eth1
    iface eth1 inet static
    address 192.168.50.2
    netmask 255.255.255.0
</code></pre><p>在副节点1上:</p><pre tabindex=0><code>auto eth1
    iface eth1 inet static
    address 192.168.50.3
    netmask 255.255.255.0
</code></pre><p>在副节点2上:</p><pre tabindex=0><code>auto eth1
    iface eth1 inet static
    address 192.168.50.4
    netmask 255.255.255.0
</code></pre><p>由于我们没有 DNS 服务，所以需要设置设置一下 /etc/hosts 这个文件，手工将主机名称放到此文件中。</p><p>在主节点上:</p><pre tabindex=0><code>127.0.0.1 localhost primary
192.168.50.2 primary
192.168.50.3 secondary1
192.168.50.4 secondary2
</code></pre><p>在副节点1上:</p><pre tabindex=0><code>127.0.0.1 localhost secondary1
192.168.50.2 primary
192.168.50.3 secondary1
192.168.50.4 secondary2
</code></pre><p>在副节点2上:</p><pre tabindex=0><code>127.0.0.1 localhost secondary2
192.168.50.2 primary
192.168.50.3 secondary1
192.168.50.4 secondary2
</code></pre><p>使用 ping 命令检查各个节点之间的连接。</p><pre tabindex=0><code>$ ping primary
$ ping secondary1
$ ping secondary2
</code></pre><h3 id=配置副本集>配置副本集</h3><p>验证各个节点可以正常连通后，我们就可以新建一个管理员用户，用于之后的副本集操作。</p><p>在主节点上，打开 /etc/mongodb.conf 文件，将 auth 和 replSet 两项注释掉。</p><pre tabindex=0><code>dbpath=/var/lib/mongodb
logpath=/var/log/mongodb/mongod.log
logappend=true
#auth = true
keyFile=/var/lib/mongodb/keyFile
#replSet=myReplica
</code></pre><p>在一个新安装的 MongoDB 上配置任何用户或副本集之前，你需要注释掉 auth 行。默认情况下，MongoDB 并没有创建任何用户。而如果在你创建用户前启用了 auth，你就不能够做任何事情。你可以在创建一个用户后再次启用 auth。</p><p>修改 /etc/mongodb.conf 之后，重启 mongod 进程。</p><pre tabindex=0><code>$ sudo service mongod restart
</code></pre><p>现在连接到 MongoDB master：</p><pre tabindex=0><code>$ mongo &lt;master-ip-address&gt;:27017
</code></pre><p>连接 MongoDB 后，新建管理员用户。</p><pre tabindex=0><code>&gt; use admin
&gt; db.createUser({
user:&#34;admin&#34;,
pwd:&#34;
})
</code></pre><p>重启 MongoDB：</p><pre tabindex=0><code>$ sudo service mongod restart
</code></pre><p>再次连接到 MongoDB，用以下命令将 副节点1 和副节点2节点添加到我们的副本集中。</p><pre tabindex=0><code>&gt; use admin
&gt; db.auth(&#34;admin&#34;,&#34;myreallyhardpassword&#34;)
&gt; rs.initiate()
&gt; rs.add (&#34;secondary1:27017&#34;)
&gt; rs.add(&#34;secondary2:27017&#34;)
</code></pre><p>现在副本集到手了，可以开始我们的项目了。参照 <a href=http://docs.mongodb.org/ecosystem/drivers/>官方驱动文档</a> 来了解如何连接到副本集。如果你想要用 Shell 来请求数据，那么你需要连接到主节点上来插入或者请求数据，副节点不行。如果你执意要尝试用副本集操作，那么以下错误信息就蹦出来招呼你了。</p><pre tabindex=0><code>myReplica:SECONDARY&gt;
myReplica:SECONDARY&gt; show databases
2015-05-10T03:09:24.131+0000 E QUERY    Error: listDatabases failed:{ &#34;note&#34; : &#34;from execCommand&#34;, &#34;ok&#34; : 0, &#34;errmsg&#34; : &#34;not master&#34; }
    at Error ()
    at Mongo.getDBs (src/mongo/shell/mongo.js:47:15)
    at shellHelper.show (src/mongo/shell/utils.js:630:33)
at shellHelper (src/mongo/shell/utils.js:524:36)
    at (shellhelp2):1:1 at src/mongo/shell/mongo.js:47
</code></pre><p>如果你要从 shell 连接到整个副本集，你可以安装如下命令。在副本集中的失败切换是自动的。</p><pre tabindex=0><code>$ mongo primary,secondary1,secondary2:27017/?replicaSet=myReplica
</code></pre><p>如果你使用其它驱动语言（例如，JavaScript、Ruby 等等），格式也许不同。</p><p>希望这篇教程能对你有所帮助。你可以使用Vagrant来自动完成你的本地环境配置，并且加速你的代码。</p><hr><p>via: <a href=http://xmodulo.com/setup-replica-set-mongodb.html>http://xmodulo.com/setup-replica-set-mongodb.html</a></p><p>作者：<a href=http://xmodulo.com/author/valerio>Christopher Valerio</a> 译者：<a href=https://github.com/mr-ping>mr-ping</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创翻译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/mongodb/ rel=tag>MongoDB</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>