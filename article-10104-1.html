<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>树莓派自建 NAS 云盘之——树莓派搭建网络存储盘 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="树莓派自建 NAS 云盘之——树莓派搭建网络存储盘"><meta property="og:description" content="跟随这些逐步指导构建你自己的基于树莓派的 NAS 系统。"><meta property="og:type" content="article"><meta property="og:url" content="/article-10104-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-10-12T01:48:11+00:00"><meta property="article:modified_time" content="2018-10-12T01:48:11+00:00"><meta itemprop=name content="树莓派自建 NAS 云盘之——树莓派搭建网络存储盘"><meta itemprop=description content="跟随这些逐步指导构建你自己的基于树莓派的 NAS 系统。"><meta itemprop=datePublished content="2018-10-12T01:48:11+00:00"><meta itemprop=dateModified content="2018-10-12T01:48:11+00:00"><meta itemprop=wordCount content="596"><meta itemprop=keywords content="NAS,树莓派,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>树莓派自建 NAS 云盘之——树莓派搭建网络存储盘</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2018-10-12T01:48:11Z>October 12, 2018</time></div></div></header><div class="content post__content clearfix"><blockquote><p>跟随这些逐步指导构建你自己的基于树莓派的 NAS 系统。</p></blockquote><p><img src=/data/attachment/album/201810/12/014802z3369tgclgclmz3t.jpg alt></p><p>我将在接下来的这三篇文章中讲述如何搭建一个简便、实用的 NAS 云盘系统。我在这个中心化的存储系统中存储数据，并且让它每晚都会自动的备份增量数据。本系列文章将利用 NFS 文件系统将磁盘挂载到同一网络下的不同设备上，使用 <a href=https://nextcloud.com/>Nextcloud</a> 来离线访问数据、分享数据。</p><p>本文主要讲述将数据盘挂载到远程设备上的软硬件步骤。本系列第二篇文章将讨论数据备份策略、如何添加定时备份数据任务。最后一篇文章中我们将会安装 Nextcloud 软件，用户通过 Nextcloud 提供的 web 界面可以方便的离线或在线访问数据。本系列教程最终搭建的 NAS 云盘支持多用户操作、文件共享等功能，所以你可以通过它方便的分享数据，比如说你可以发送一个加密链接，跟朋友分享你的照片等等。</p><p>最终的系统架构如下图所示：</p><p><img src=/data/attachment/album/201810/12/014813ih7a49pq74qe0kr6.png alt></p><h3 id=硬件>硬件</h3><p>首先需要准备硬件。本文所列方案只是其中一种示例，你也可以按不同的硬件方案进行采购。</p><p>最主要的就是<a href=https://www.raspberrypi.org/products/raspberry-pi-3-model-b/>树莓派 3</a>，它带有四核 CPU、1G RAM，以及（比较）快速的网络接口。数据将存储在两个 USB 磁盘驱动器上（这里使用 1TB 磁盘）；其中一个磁盘用于每天数据存储，另一个用于数据备份。请务必使用有源 USB 磁盘驱动器或者带附加电源的 USB 集线器，因为树莓派无法为两个 USB 磁盘驱动器供电。</p><h3 id=软件>软件</h3><p>在该社区中最活跃的操作系统当属 <a href=https://www.raspbian.org/>Raspbian</a>，便于定制个性化项目。已经有很多 <a href=https://www.raspberrypi.org/documentation/installation/installing-images/>操作指南</a> 讲述如何在树莓派中安装 Raspbian 系统，所以这里不再赘述。在撰写本文时，最新的官方支持版本是 <a href=https://www.raspberrypi.org/blog/raspbian-stretch/>Raspbian Stretch</a>，它对我来说很好使用。</p><p>到此，我将假设你已经配置好了基本的 Raspbian 系统并且可以通过 <code>ssh</code> 访问到你的树莓派。</p><h3 id=准备-usb-磁盘驱动器>准备 USB 磁盘驱动器</h3><p>为了更好地读写数据，我建议使用 ext4 文件系统去格式化磁盘。首先，你必须先找到连接到树莓派的磁盘。你可以在 <code>/dev/sd/&lt;x></code> 中找到磁盘设备。使用命令 <code>fdisk -l</code>，你可以找到刚刚连接的两块 USB 磁盘驱动器。请注意，操作下面的步骤将会清除 USB 磁盘驱动器上的所有数据，请做好备份。</p><pre tabindex=0><code>pi@raspberrypi:~ $ sudo fdisk -l

&lt;...&gt;

Disk /dev/sda: 931.5 GiB, 1000204886016 bytes, 1953525168 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xe8900690

Device     Boot Start        End    Sectors   Size Id Type
/dev/sda1        2048 1953525167 1953523120 931.5G 83 Linux


Disk /dev/sdb: 931.5 GiB, 1000204886016 bytes, 1953525168 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x6aa4f598

Device     Boot Start        End    Sectors   Size Id Type
/dev/sdb1  *     2048 1953521663 1953519616 931.5G  83 Linux
</code></pre><p>由于这些设备是连接到树莓派的唯一的 1TB 的磁盘，所以我们可以很容易的辨别出 <code>/dev/sda</code> 和 <code>/dev/sdb</code> 就是那两个 USB 磁盘驱动器。每个磁盘末尾的分区表提示了在执行以下的步骤后如何查看，这些步骤将会格式化磁盘并创建分区表。为每个 USB 磁盘驱动器按以下步骤进行操作（假设你的磁盘也是 <code>/dev/sda</code> 和 <code>/dev/sdb</code>，第二次操作你只要替换命令中的 <code>sda</code> 为 <code>sdb</code> 即可）。</p><p>首先，删除磁盘分区表，创建一个新的并且只包含一个分区的新分区表。在 <code>fdisk</code> 中，你可以使用交互单字母命令来告诉程序你想要执行的操作。只需要在提示符 <code>Command(m for help):</code> 后输入相应的字母即可（可以使用 <code>m</code> 命令获得更多详细信息）：</p><pre tabindex=0><code>pi@raspberrypi:~ $ sudo fdisk /dev/sda

Welcome to fdisk (util-linux 2.29.2).
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.


Command (m for help): o
Created a new DOS disklabel with disk identifier 0x9c310964.

Command (m for help): n
Partition type
   p   primary (0 primary, 0 extended, 4 free)
   e   extended (container for logical partitions)
Select (default p): p
Partition number (1-4, default 1):
First sector (2048-1953525167, default 2048):
Last sector, +sectors or +size{K,M,G,T,P} (2048-1953525167, default 1953525167):

Created a new partition 1 of type &#39;Linux&#39; and of size 931.5 GiB.

Command (m for help): p

Disk /dev/sda: 931.5 GiB, 1000204886016 bytes, 1953525168 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x9c310964

Device     Boot Start        End    Sectors   Size Id Type
/dev/sda1        2048 1953525167 1953523120 931.5G 83 Linux

Command (m for help): w
The partition table has been altered.
Syncing disks.
</code></pre><p>现在，我们将用 ext4 文件系统格式化新创建的分区 <code>/dev/sda1</code>：</p><pre tabindex=0><code>pi@raspberrypi:~ $ sudo mkfs.ext4 /dev/sda1
mke2fs 1.43.4 (31-Jan-2017)
Discarding device blocks: done

&lt;...&gt;

Allocating group tables: done
Writing inode tables: done
Creating journal (1024 blocks): done
Writing superblocks and filesystem accounting information: done
</code></pre><p>重复以上步骤后，让我们根据用途来对它们建立标签：</p><pre tabindex=0><code>pi@raspberrypi:~ $ sudo e2label /dev/sda1 data
pi@raspberrypi:~ $ sudo e2label /dev/sdb1 backup
</code></pre><p>现在，让我们安装这些磁盘并存储一些数据。以我运营该系统超过一年的经验来看，当树莓派启动时（例如在断电后），USB 磁盘驱动器并不是总被挂载，因此我建议使用 autofs 在需要的时候进行挂载。</p><p>首先，安装 autofs 并创建挂载点：</p><pre tabindex=0><code>pi@raspberrypi:~ $ sudo apt install autofs
pi@raspberrypi:~ $ sudo mkdir /nas
</code></pre><p>然后添加下面这行来挂载设备 <code>/etc/auto.master</code>：</p><pre tabindex=0><code>/nas    /etc/auto.usb
</code></pre><p>如果不存在以下内容，则创建 <code>/etc/auto.usb</code>，然后重新启动 autofs 服务：</p><pre tabindex=0><code>data -fstype=ext4,rw :/dev/disk/by-label/data
backup -fstype=ext4,rw :/dev/disk/by-label/backup
pi@raspberrypi3:~ $ sudo service autofs restart
</code></pre><p>现在你应该可以分别访问 <code>/nas/data</code> 以及 <code>/nas/backup</code> 磁盘了。显然，到此还不会令人太兴奋，因为你只是擦除了磁盘中的数据。不过，你可以执行以下命令来确认设备是否已经挂载成功：</p><pre tabindex=0><code>pi@raspberrypi3:~ $ cd /nas/data
pi@raspberrypi3:/nas/data $ cd /nas/backup
pi@raspberrypi3:/nas/backup $ mount
&lt;...&gt;
/etc/auto.usb on /nas type autofs (rw,relatime,fd=6,pgrp=463,timeout=300,minproto=5,maxproto=5,indirect)
&lt;...&gt;
/dev/sda1 on /nas/data type ext4 (rw,relatime,data=ordered)
/dev/sdb1 on /nas/backup type ext4 (rw,relatime,data=ordered)
</code></pre><p>首先进入对应目录以确保 autofs 能够挂载设备。autofs 会跟踪文件系统的访问记录，并随时挂载所需要的设备。然后 <code>mount</code> 命令会显示这两个 USB 磁盘驱动器已经挂载到我们想要的位置了。</p><p>设置 autofs 的过程容易出错，如果第一次尝试失败，请不要沮丧。你可以上网搜索有关教程。</p><h3 id=挂载网络存储>挂载网络存储</h3><p>现在你已经设置了基本的网络存储，我们希望将它安装到远程 Linux 机器上。这里使用 NFS 文件系统，首先在树莓派上安装 NFS 服务器：</p><pre tabindex=0><code>pi@raspberrypi:~ $ sudo apt install nfs-kernel-server
</code></pre><p>然后，需要告诉 NFS 服务器公开 <code>/nas/data</code> 目录，这是从树莓派外部可以访问的唯一设备（另一个用于备份）。编辑 <code>/etc/exports</code> 添加如下内容以允许所有可以访问 NAS 云盘的设备挂载存储：</p><pre tabindex=0><code>/nas/data *(rw,sync,no_subtree_check)
</code></pre><p>更多有关限制挂载到单个设备的详细信息，请参阅 <code>man exports</code>。经过上面的配置，任何人都可以访问数据，只要他们可以访问 NFS 所需的端口：<code>111</code> 和 <code>2049</code>。我通过上面的配置，只允许通过路由器防火墙访问到我的家庭网络的 22 和 443 端口。这样，只有在家庭网络中的设备才能访问 NFS 服务器。</p><p>如果要在 Linux 计算机挂载存储，运行以下命令：</p><pre tabindex=0><code>you@desktop:~ $ sudo mkdir /nas/data
you@desktop:~ $ sudo mount -t nfs &lt;raspberry-pi-hostname-or-ip&gt;:/nas/data /nas/data
</code></pre><p>同样，我建议使用 autofs 来挂载该网络设备。如果需要其他帮助，请参看 <a href=https://opensource.com/article/18/6/using-autofs-mount-nfs-shares>如何使用 Autofs 来挂载 NFS 共享</a>。</p><p>现在你可以在远程设备上通过 NFS 系统访问位于你树莓派 NAS 云盘上的数据了。在后面一篇文章中，我将介绍如何使用 <code>rsync</code> 自动将数据备份到第二个 USB 磁盘驱动器。你将会学到如何使用 <code>rsync</code> 创建增量备份，在进行日常备份的同时还能节省设备空间。</p><hr><p>via: <a href=https://opensource.com/article/18/7/network-attached-storage-Raspberry-Pi>https://opensource.com/article/18/7/network-attached-storage-Raspberry-Pi</a></p><p>作者：<a href=https://opensource.com/users/ntlx>Manuel Dewald</a> 选题：<a href=https://github.com/lujun9972>lujun9972</a> 译者：<a href=https://github.com/jrglinux>jrg</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/nas/ rel=tag>NAS</a></li><li class=tags__item><a class="tags__link btn" href=/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/ rel=tag>树莓派</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>