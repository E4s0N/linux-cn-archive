<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>如何在 CentOS 7 / RHEL 7 终端服务器上安装 KVM - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="如何在 CentOS 7 / RHEL 7 终端服务器上安装 KVM"><meta property="og:description" content="基于内核的虚拟机（KVM）是 CentOS 或 RHEL 7 的虚拟化软件。KVM 可以将你的服务器变成虚拟机管理器。"><meta property="og:type" content="article"><meta property="og:url" content="/article-9459-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-03-18T21:12:05+00:00"><meta property="article:modified_time" content="2018-03-18T21:12:05+00:00"><meta itemprop=name content="如何在 CentOS 7 / RHEL 7 终端服务器上安装 KVM"><meta itemprop=description content="基于内核的虚拟机（KVM）是 CentOS 或 RHEL 7 的虚拟化软件。KVM 可以将你的服务器变成虚拟机管理器。"><meta itemprop=datePublished content="2018-03-18T21:12:05+00:00"><meta itemprop=dateModified content="2018-03-18T21:12:05+00:00"><meta itemprop=wordCount content="732"><meta itemprop=keywords content="KVM,虚拟机,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>如何在 CentOS 7 / RHEL 7 终端服务器上安装 KVM</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2018-03-18T21:12:05Z>March 18, 2018</time></div></div></header><div class="content post__content clearfix"><p><img src=/data/attachment/album/201803/18/211158v4zl4v4bick7frcf.jpg alt></p><p>如何在 CnetOS 7 或 RHEL 7（Red Hat 企业版 Linux）服务器上安装和配置 KVM（基于内核的虚拟机）？如何在 CentOS 7 上设置 KVM 并使用云镜像 / cloud-init 来安装客户虚拟机？</p><p>基于内核的虚拟机（KVM）是 CentOS 或 RHEL 7 的虚拟化软件。KVM 可以将你的服务器变成虚拟机管理器。本文介绍如何在 CentOS 7 或 RHEL 7 中使用 KVM 设置和管理虚拟化环境。还介绍了如何使用命令行在物理服务器上安装和管理虚拟机（VM）。请确保在服务器的 BIOS 中启用了<strong>虚拟化技术(VT)</strong>。你也可以运行以下命令<a href=https://www.cyberciti.biz/faq/linux-xen-vmware-kvm-intel-vt-amd-v-support/>测试 CPU 是否支持 Intel VT 和 AMD_V 虚拟化技术</a>。</p><pre tabindex=0><code>$ lscpu | grep Virtualization
Virtualization: VT-x
</code></pre><p>按照 CentOS 7/RHEL 7 终端服务器上的 KVM 安装步骤进行操作。</p><h3 id=步骤-1-安装-kvm>步骤 1： 安装 kvm</h3><p>输入以下 <a href=https://www.cyberciti.biz/faq/rhel-centos-fedora-linux-yum-command-howto/ title="See Linux/Unix yum command examples for more info">yum 命令</a>:</p><pre tabindex=0><code># yum install qemu-kvm libvirt libvirt-python libguestfs-tools virt-install
</code></pre><p><a href=https://www.cyberciti.biz/media/new/faq/2018/01/How-to-install-KVM-on-CentOS-7-RHEL-7-Headless-Server.jpg><img src=/data/attachment/album/201803/18/211208xf30du7ri7fueii0.jpg alt="How to install KVM on CentOS 7 RHEL 7 Headless Server"></a></p><p>启动 libvirtd 服务：</p><pre tabindex=0><code># systemctl enable libvirtd
# systemctl start libvirtd
</code></pre><h3 id=步骤-2-确认-kvm-安装>步骤 2： 确认 kvm 安装</h3><p>使用 <code>lsmod</code> 命令和 <a href=https://www.cyberciti.biz/faq/howto-use-grep-command-in-linux-unix/ title="See Linux/Unix grep command examples for more info">grep命令</a> 确认加载了 KVM 模块：</p><pre tabindex=0><code># lsmod | grep -i kvm
</code></pre><h3 id=步骤-3-配置桥接网络>步骤 3： 配置桥接网络</h3><p>默认情况下，由 libvirtd 配置基于 dhcpd 的网桥。你可以使用以下命令验证：</p><pre tabindex=0><code># brctl show
# virsh net-list
</code></pre><p><a href=https://www.cyberciti.biz/media/new/faq/2018/01/KVM-default-networking.jpg><img src=/data/attachment/album/201803/18/211208vkmkz2qjmixp2sqn.jpg alt="KVM default networking"></a></p><p>所有虚拟机（客户机）只能对同一台服务器上的其它虚拟机进行网络访问。为你创建的私有网络是 192.168.122.0/24。验证：</p><pre tabindex=0><code># virsh net-dumpxml default
</code></pre><p>如果你希望你的虚拟机可用于 LAN 上的其他服务器，请在连接到你的 LAN 的服务器上设置一个网桥。更新你的网卡配置文件，如 ifcfg-enp3s0 或 em1：</p><pre tabindex=0><code># vi /etc/sysconfig/network-scripts/ifcfg-enp3s0 
</code></pre><p>添加一行：</p><pre tabindex=0><code>BRIDGE=br0
</code></pre><p><a href=https://www.cyberciti.biz/faq/linux-unix-vim-save-and-quit-command/>使用 vi 保存并关闭文件</a>。编辑 <code>/etc/sysconfig/network-scripts/ifcfg-br0</code>：</p><pre tabindex=0><code># vi /etc/sysconfig/network-scripts/ifcfg-br0
</code></pre><p>添加以下内容：</p><pre tabindex=0><code>DEVICE=&#34;br0&#34;
# I am getting ip from DHCP server #
BOOTPROTO=&#34;dhcp&#34;
IPV6INIT=&#34;yes&#34;
IPV6_AUTOCONF=&#34;yes&#34;
ONBOOT=&#34;yes&#34;
TYPE=&#34;Bridge&#34;
DELAY=&#34;0&#34;
</code></pre><p>重新启动网络服务（警告：ssh 命令将断开连接，最好重新启动该设备）：</p><pre tabindex=0><code># systemctl restart NetworkManager
</code></pre><p>用 <code>brctl</code> 命令验证它：</p><pre tabindex=0><code># brctl show
</code></pre><h3 id=步骤-4-创建你的第一个虚拟机>步骤 4： 创建你的第一个虚拟机</h3><p>我将会创建一个 CentOS 7.x 虚拟机。首先，使用 <code>wget</code> 命令获取 CentOS 7.x 最新的 ISO 镜像：</p><pre tabindex=0><code># cd /var/lib/libvirt/boot/
# wget https://mirrors.kernel.org/centos/7.4.1708/isos/x86_64/CentOS-7-x86_64-Minimal-1708.iso
</code></pre><p>验证 ISO 镜像：</p><pre tabindex=0><code># wget https://mirrors.kernel.org/centos/7.4.1708/isos/x86_64/sha256sum.txt
# sha256sum -c sha256sum.txt
</code></pre><h4 id=创建-centos-7x-虚拟机>创建 CentOS 7.x 虚拟机</h4><p>在这个例子中，我创建了 2GB RAM，2 个 CPU 核心，1 个网卡和 40 GB 磁盘空间的 CentOS 7.x 虚拟机，输入：</p><pre tabindex=0><code># virt-install \
--virt-type=kvm \
--name centos7 \
--ram 2048 \
--vcpus=1 \
--os-variant=centos7.0 \
--cdrom=/var/lib/libvirt/boot/CentOS-7-x86_64-Minimal-1708.iso \
--network=bridge=br0,model=virtio \
--graphics vnc \
--disk path=/var/lib/libvirt/images/centos7.qcow2,size=40,bus=virtio,format=qcow2
</code></pre><p>从另一个终端通过 <code>ssh</code> 配置 vnc 登录，输入：</p><pre tabindex=0><code># virsh dumpxml centos7 | grep v nc
&lt;graphics type=&#39;vnc&#39; port=&#39;5901&#39; autoport=&#39;yes&#39; listen=&#39;127.0.0.1&#39;&gt;
</code></pre><p>请记录下端口值（即 5901）。你需要使用 SSH 客户端来建立隧道和 VNC 客户端才能访问远程 vnc 服务器。在客户端/桌面/ macbook pro 系统中输入以下 SSH 端口转发命令：</p><pre tabindex=0><code>$ ssh vivek@server1.cyberciti.biz -L 5901:127.0.0.1:5901
</code></pre><p>一旦你建立了 ssh 隧道，你可以将你的 VNC 客户端指向你自己的 127.0.0.1 (localhost) 地址和端口 5901，如下所示：</p><p><a href=https://www.cyberciti.biz/media/new/faq/2016/01/vnc-client.jpg><img src=/data/attachment/album/201803/18/211208wwehdw6z4ezs6ems.jpg alt></a></p><p>你应该看到 CentOS Linux 7 客户虚拟机安装屏幕如下：</p><p><a href=https://www.cyberciti.biz/media/new/faq/2016/01/centos7-guest-vnc.jpg><img src=/data/attachment/album/201803/18/211208mh7zczpsc9xp7ckz.jpg alt></a></p><p>现在只需按照屏幕说明进行操作并安装CentOS 7。一旦安装完成后，请继续并单击重启按钮。 远程服务器关闭了我们的 VNC 客户端的连接。 你可以通过 KVM 客户端重新连接，以配置服务器的其余部分，包括基于 SSH 的会话或防火墙。</p><h3 id=使用云镜像>使用云镜像</h3><p>以上安装方法对于学习目的或单个虚拟机而言是可行的。你需要部署大量的虚拟机吗？ 可以试试云镜像。你可以根据需要修改预先构建的云镜像。例如，使用 <a href=https://cloudinit.readthedocs.io/en/latest/index.html>Cloud-init</a> 添加用户、ssh 密钥、设置时区等等，这是处理云实例的早期初始化的事实上的多分发包。让我们看看如何创建带有 1024MB RAM，20GB 磁盘空间和 1 个 vCPU 的 CentOS 7 虚拟机。（LCTT 译注： vCPU 即电脑中的虚拟处理器）</p><h4 id=获取-centos-7-云镜像>获取 CentOS 7 云镜像</h4><pre tabindex=0><code># cd /var/lib/libvirt/boot
# wget http://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud.qcow2
</code></pre><h4 id=创建所需的目录>创建所需的目录</h4><pre tabindex=0><code># D=/var/lib/libvirt/images
# VM=centos7-vm1 ## vm name ##
# mkdir -vp $D/$VM
mkdir: created directory &#39;/var/lib/libvirt/images/centos7-vm1&#39;
</code></pre><h4 id=创建元数据文件>创建元数据文件</h4><pre tabindex=0><code># cd $D/$VM
# vi meta-data
</code></pre><p>添加以下内容：</p><pre tabindex=0><code>instance-id: centos7-vm1
local-hostname: centos7-vm1
</code></pre><h4 id=创建用户数据文件>创建用户数据文件</h4><p>我将使用 ssh 密钥登录到虚拟机。所以确保你有 ssh 密钥：</p><pre tabindex=0><code># ssh-keygen -t ed25519 -C &#34;VM Login ssh key&#34;
</code></pre><p><a href=https://www.cyberciti.biz/faq/linux-unix-generating-ssh-keys/><img src=/data/attachment/album/201803/18/211208tzaiamw8scttmxwt.jpg alt="ssh-keygen command"></a></p><p>请参阅 “<a href=https://www.cyberciti.biz/faq/how-to-set-up-ssh-keys-on-linux-unix/>如何在 Linux/Unix 系统上设置 SSH 密钥</a>” 来获取更多信息。编辑用户数据如下：</p><pre tabindex=0><code># cd $D/$VM
# vi user-data
</code></pre><p>添加如下（根据你的设置替换 <code>hostname</code>、<code>users</code>、<code>ssh-authorized-keys</code>）：</p><pre tabindex=0><code>#cloud-config

# Hostname management
preserve_hostname: False
hostname: centos7-vm1
fqdn: centos7-vm1.nixcraft.com

# Users
users:
    - default
    - name: vivek
      groups: [&#39;wheel&#39;]
      shell: /bin/bash
      sudo: ALL=(ALL) NOPASSWD:ALL
      ssh-authorized-keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIMP3MOF2ot8MOdNXCpHem0e2Wemg4nNmL2Tio4Ik1JY VM Login ssh key

# Configure where output will go
output:
  all: &#34;&gt;&gt; /var/log/cloud-init.log&#34;

# configure interaction with ssh server
ssh_genkeytypes: [&#39;ed25519&#39;, &#39;rsa&#39;]

# Install my public ssh key to the first user-defined user configured
# in cloud.cfg in the template (which is centos for CentOS cloud images)
ssh_authorized_keys:
  - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIMP3MOF2ot8MOdNXCpHem0e2Wemg4nNmL2Tio4Ik1JY VM Login ssh key

# set timezone for VM
timezone: Asia/Kolkata

# Remove cloud-init 
runcmd:
  - systemctl stop network &amp;&amp; systemctl start network
  - yum -y remove cloud-init
</code></pre><h4 id=复制云镜像>复制云镜像</h4><pre tabindex=0><code># cd $D/$VM
# cp /var/lib/libvirt/boot/CentOS-7-x86_64-GenericCloud.qcow2 $VM.qcow2
</code></pre><h4 id=创建-20gb-磁盘映像>创建 20GB 磁盘映像</h4><pre tabindex=0><code># cd $D/$VM
# export LIBGUESTFS_BACKEND=direct
# qemu-img create -f qcow2 -o preallocation=metadata $VM.new.image 20G
# virt-resize --quiet --expand /dev/sda1 $VM.qcow2 $VM.new.image
</code></pre><p><a href=https://www.cyberciti.biz/media/new/faq/2018/01/Set-VM-image-disk-size.jpg><img src=/data/attachment/album/201803/18/211209f3cs2sg6z02fj0c5.jpg alt="Set VM image disk size"></a></p><p>用缩放后的镜像覆盖它：</p><pre tabindex=0><code># cd $D/$VM
# mv $VM.new.image $VM.qcow2
</code></pre><h4 id=创建一个-cloud-init-iso>创建一个 cloud-init ISO</h4><pre tabindex=0><code># mkisofs -o $VM-cidata.iso -V cidata -J -r user-data meta-data
</code></pre><p><a href=https://www.cyberciti.biz/media/new/faq/2018/01/Creating-a-cloud-init-ISO.jpg><img src=/data/attachment/album/201803/18/211209qjobjrsgb4tt4ovj.jpg alt="Creating a cloud-init ISO"></a></p><h4 id=创建一个池>创建一个池</h4><pre tabindex=0><code># virsh pool-create-as --name $VM --type dir --target $D/$VM
Pool centos7-vm1 created
</code></pre><h4 id=安装-centos-7-虚拟机>安装 CentOS 7 虚拟机</h4><pre tabindex=0><code># cd $D/$VM
# virt-install --import --name $VM \
--memory 1024 --vcpus 1 --cpu host \
--disk $VM.qcow2,format=qcow2,bus=virtio \
--disk $VM-cidata.iso,device=cdrom \
--network bridge=virbr0,model=virtio \
--os-type=linux \
--os-variant=centos7.0 \
--graphics spice \
--noautoconsole
</code></pre><p>删除不需要的文件：</p><pre tabindex=0><code># cd $D/$VM
# virsh change-media $VM hda --eject --config
# rm meta-data user-data centos7-vm1-cidata.iso
</code></pre><h4 id=查找虚拟机的-ip-地址>查找虚拟机的 IP 地址</h4><pre tabindex=0><code># virsh net-dhcp-leases default
</code></pre><p><a href=https://www.cyberciti.biz/media/new/faq/2018/01/CentOS7-VM1-Created.jpg><img src=/data/attachment/album/201803/18/211209sbyr1mfa36ad2b3f.jpg alt="CentOS7-VM1- Created"></a></p><h4 id=登录到你的虚拟机>登录到你的虚拟机</h4><p>使用 ssh 命令：</p><pre tabindex=0><code># ssh vivek@192.168.122.85
</code></pre><p><a href=https://www.cyberciti.biz/media/new/faq/2018/01/Sample-VM-session.jpg><img src=/data/attachment/album/201803/18/211209zx29bf5444505a2r.jpg alt="Sample VM session"></a></p><h3 id=有用的命令>有用的命令</h3><p>让我们看看管理虚拟机的一些有用的命令。</p><h4 id=列出所有虚拟机>列出所有虚拟机</h4><pre tabindex=0><code># virsh list --all
</code></pre><h4 id=获取虚拟机信息>获取虚拟机信息</h4><pre tabindex=0><code># virsh dominfo vmName
# virsh dominfo centos7-vm1
</code></pre><h4 id=停止关闭虚拟机>停止/关闭虚拟机</h4><pre tabindex=0><code># virsh shutdown centos7-vm1
</code></pre><h4 id=开启虚拟机>开启虚拟机</h4><pre tabindex=0><code># virsh start centos7-vm1
</code></pre><h4 id=将虚拟机标记为在引导时自动启动>将虚拟机标记为在引导时自动启动</h4><pre tabindex=0><code># virsh autostart centos7-vm1
</code></pre><h4 id=重新启动软安全重启虚拟机>重新启动（软安全重启）虚拟机</h4><pre tabindex=0><code># virsh reboot centos7-vm1
</code></pre><p>重置（硬重置/不安全）虚拟机</p><pre tabindex=0><code># virsh reset centos7-vm1
</code></pre><h4 id=删除虚拟机>删除虚拟机</h4><pre tabindex=0><code># virsh shutdown centos7-vm1
# virsh undefine centos7-vm1
# virsh pool-destroy centos7-vm1
# D=/var/lib/libvirt/images
# VM=centos7-vm1
# rm -ri $D/$VM
</code></pre><p>查看 virsh 命令类型的完整列表：</p><pre tabindex=0><code># virsh help | less
# virsh help | grep reboot
</code></pre><h3 id=关于作者>关于作者</h3><p>作者是 nixCraft 的创建者，也是经验丰富的系统管理员和 Linux 操作系统/ Unix shell 脚本的培训师。 他曾与全球客户以及 IT，教育，国防和空间研究以及非营利部门等多个行业合作。 在 <a href=https://twitter.com/nixcraft>Twitter</a>，<a href=https://facebook.com/nixcraft>Facebook</a>，<a href=https://plus.google.com/+CybercitiBiz>Google +</a> 上关注他。</p><hr><p>via: <a href=https://www.cyberciti.biz/faq/how-to-install-kvm-on-centos-7-rhel-7-headless-server/>https://www.cyberciti.biz/faq/how-to-install-kvm-on-centos-7-rhel-7-headless-server/</a></p><p>作者：<a href=https://www.cyberciti.biz>Vivek Gite</a> 译者：<a href=https://github.com/MjSeven>MjSeven</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/kvm/ rel=tag>KVM</a></li><li class=tags__item><a class="tags__link btn" href=/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/ rel=tag>虚拟机</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>