<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>如何配置使用 HTTP 严格传输安全（HSTS） - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="如何配置使用 HTTP 严格传输安全（HSTS）"><meta property="og:description" content="HTTP 严格传输安全（HSTS）是一种安全功能，web 服务器通过它来告诉浏览器仅用 HTTPS 来与之通讯，而不是使用 HTTP。本文会说明如何在 Apache2、Nginx 和 Lighttpd 上如何启用 HSTS。在主流的 web 服务器上测试通过： Nginx1.1.19、 Lighttpd 1.4.28 和Apache 2.2.22 ，环境为 Ubuntu 12.04、 Debian 6  7 和 CentOS 6，只需要调整部分参数就可以工作在其它的发行版上。  什么是 HTTP 严格传输安全？ 引用自Mozilla Developer Network：  如果一个 web 服务器支持 HTTP 访问，并将其重定向到 HTTPS 访问的话，那么访问者在重定向前的初始"><meta property="og:type" content="article"><meta property="og:url" content="/article-5266-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-04-15T08:40:00+00:00"><meta property="article:modified_time" content="2015-04-15T08:40:00+00:00"><meta itemprop=name content="如何配置使用 HTTP 严格传输安全（HSTS）"><meta itemprop=description content="HTTP 严格传输安全（HSTS）是一种安全功能，web 服务器通过它来告诉浏览器仅用 HTTPS 来与之通讯，而不是使用 HTTP。本文会说明如何在 Apache2、Nginx 和 Lighttpd 上如何启用 HSTS。在主流的 web 服务器上测试通过： Nginx1.1.19、 Lighttpd 1.4.28 和Apache 2.2.22 ，环境为 Ubuntu 12.04、 Debian 6  7 和 CentOS 6，只需要调整部分参数就可以工作在其它的发行版上。  什么是 HTTP 严格传输安全？ 引用自Mozilla Developer Network：  如果一个 web 服务器支持 HTTP 访问，并将其重定向到 HTTPS 访问的话，那么访问者在重定向前的初始"><meta itemprop=datePublished content="2015-04-15T08:40:00+00:00"><meta itemprop=dateModified content="2015-04-15T08:40:00+00:00"><meta itemprop=wordCount content="223"><meta itemprop=keywords content="HSTS,https,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>如何配置使用 HTTP 严格传输安全（HSTS）</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2015-04-15T08:40:00Z>April 15, 2015</time></div></div></header><div class="content post__content clearfix"><p>HTTP 严格传输安全（HSTS）是一种安全功能，web 服务器通过它来告诉浏览器仅用 HTTPS 来与之通讯，而不是使用 HTTP。本文会说明如何在 Apache2、Nginx 和 Lighttpd 上如何启用 HSTS。在主流的 web 服务器上测试通过： Nginx 1.1.19、 Lighttpd 1.4.28 和 Apache 2.2.22 ，环境为 Ubuntu 12.04、 Debian 6 & 7 和 CentOS 6，只需要调整部分参数就可以工作在其它的发行版上。</p><p><img src=/data/attachment/album/201504/14/142928nt90umljtulb8nte.gif alt></p><h3 id=什么是-http-严格传输安全>什么是 HTTP 严格传输安全？</h3><p>引用自 <a href=https://developer.mozilla.org/en-US/docs/Security/HTTP_Strict_Transport_Security>Mozilla Developer Network</a>：</p><blockquote><p>如果一个 web 服务器支持 HTTP 访问，并将其重定向到 HTTPS 访问的话，那么访问者在重定向前的初始会话是非加密的。举个例子，比如访问者输入 <a href=http://www.foo.com/>http://www.foo.com/</a> 或直接输入 foo.com 时。</p><p>这就给了中间人攻击的一个机会，重定向可能会被破坏，从而定向到一个恶意站点而不是应该访问的加密页面。</p><p>HTTP 严格传输安全（HSTS）功能使 Web 服务器告知浏览器绝不使用 HTTP 访问，在浏览器端自动将所有到该站点的 HTTP 访问替换为 HTTPS 访问。</p></blockquote><p>以下引自<a href=http://zh.wikipedia.org/wiki/HTTP%E4%B8%A5%E6%A0%BC%E4%BC%A0%E8%BE%93%E5%AE%89%E5%85%A8>维基百科</a>：</p><blockquote><p>HSTS 可以用来抵御 SSL 剥离攻击。SSL 剥离攻击是中间人攻击的一种，由 Moxie Marlinspike 于2009年发明。他在当年的黑帽大会上发表的题为 “New Tricks For Defeating SSL In Practice” 的演讲中将这种攻击方式公开。SSL剥离的实施方法是阻止浏览器与服务器创建HTTPS连接。它的前提是用户很少直接在地址栏输入https://，用户总是通过点击链接或3xx重定向，从HTTP页面进入HTTPS页面。所以攻击者可以在用户访问HTTP页面时替换所有https://开头的链接为http://，达到阻止HTTPS的目的。</p><p>HSTS可以很大程度上解决SSL剥离攻击，因为只要浏览器曾经与服务器创建过一次安全连接，之后浏览器会强制使用HTTPS，即使链接被换成了HTTP。</p><p>另外，如果中间人使用自己的自签名证书来进行攻击，浏览器会给出警告，但是许多用户会忽略警告。HSTS解决了这一问题，一旦服务器发送了HSTS字段，用户将不再允许忽略警告。</p></blockquote><p>场景举例：</p><blockquote><p>当你通过一个无线路由器的免费 WiFi 访问你的网银时，很不幸的，这个免费 WiFi 也许就是由黑客的笔记本所提供的，他们会劫持你的原始请求，并将其重定向到克隆的网银站点，然后，你的所有的隐私数据都曝光在黑客眼下。</p><p>严格传输安全可以解决这个问题。如果你之前使用 HTTPS 访问过你的网银，而且网银的站点支持 HSTS，那么你的浏览器就知道应该只使用 HTTPS，无论你是否输入了 HTTPS。这样就防范了中间人劫持攻击。</p></blockquote><p>注意，如果你之前没有使用 HTTPS 访问过该站点，那么 HSTS 是不奏效的。网站需要通过 HTTPS 协议告诉你的浏览器它支持 HSTS。</p><p>服务器开启 HSTS 的方法是，当客户端通过HTTPS发出请求时，在服务器返回的 HTTP 响应头中包含 <code>Strict-Transport-Security</code> 字段。非加密传输时设置的HSTS字段无效。</p><h3 id=在-apache2-中设置-hsts>在 Apache2 中设置 HSTS</h3><p>编辑你的 apache 配置文件（如 <code>/etc/apache2/sites-enabled/website.conf</code> 和 <code>/etc/apache2/httpd.conf ），并加以下行到你的 HTTPS</code> VirtualHost：</p><pre tabindex=0><code># Optionally load the headers module:
LoadModule headers_module modules/mod_headers.so

&lt;VirtualHost 67.89.123.45:443&gt;
    Header always set Strict-Transport-Security &#34;max-age=63072000; includeSubdomains; preload&#34;
&lt;/VirtualHost&gt;
</code></pre><p>现在你的 web 站点在每次访问时都会发送该请求头，失效时间是两年（秒数）。这个失效时间每次都会设置为两年后，所以，明天你访问时，它会设置为明天的两年后。</p><p>你只能在 HTTPS 虚拟机中设置这个头，而不能设置在 HTTP 虚拟机中。</p><p>要将你的访问者重定向到对应 HTTPS 站点，可使用如下设置：</p><pre tabindex=0><code>&lt;VirtualHost *:80&gt;
  [...]
  ServerName example.com
  Redirect permanent / https://example.com/
&lt;/VirtualHost&gt;
</code></pre><p>如果仅仅是做重定向的话，甚至不需要设置 DocumentRoot。</p><p>你也可以使用 mod_rewrite 来做重定向，但是上述的方式更简单更安全。不过，mod_rewrite 可以重定向页面到对应的 HTTPS 页面，而上述配置则只重定向到“/”：</p><pre tabindex=0><code>&lt;VirtualHost *:80&gt;
  [...]
  &lt;IfModule mod_rewrite.c&gt;
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI}
  &lt;/IfModule&gt;
&lt;/VirtualHost&gt;
</code></pre><p>不要忘记重启 Apache。</p><h3 id=lighttpd>Lighttpd</h3><p>对于 lighttpd 来说很简单，将下述配置增加到你的 Lighttpd 配置文件（例如：<code>/etc/lighttpd/lighttpd.conf）：</code></p><pre tabindex=0><code>server.modules += ( &#34;mod_setenv&#34; )
$HTTP[&#34;scheme&#34;] == &#34;https&#34; {
    setenv.add-response-header  = ( &#34;Strict-Transport-Security&#34; =&gt; &#34;max-age=63072000; includeSubdomains; preload&#34;)
}
</code></pre><p>重启 Lighttpd。失效时间也是两年。</p><h3 id=nginx>Nginx</h3><p>Nginx 甚至更简单，将下述行添加到你的 HTTPS 配置的 server 块中：</p><pre tabindex=0><code>add_header Strict-Transport-Security &#34;max-age=63072000; includeSubdomains; preload&#34;;
</code></pre><p>不要忘记重启 Nginx。</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/hsts/ rel=tag>HSTS</a></li><li class=tags__item><a class="tags__link btn" href=/tags/https/ rel=tag>https</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>