<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>如何在 Linux 系统上安装 Suricata 入侵检测系统 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="如何在 Linux 系统上安装 Suricata 入侵检测系统"><meta property="og:description" content="一种提升入侵检测系统性能的途径是多线程入侵检测系统，它将 CPU 密集型的深度包检测工作并行的分配给多个并发任务来完成。这样的并行检测可以充分利用多核硬件的优势来轻松提升入侵检测系统的吞吐量。"><meta property="og:type" content="article"><meta property="og:url" content="/article-6985-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-02-07T10:10:00+00:00"><meta property="article:modified_time" content="2016-02-07T10:10:00+00:00"><meta itemprop=name content="如何在 Linux 系统上安装 Suricata 入侵检测系统"><meta itemprop=description content="一种提升入侵检测系统性能的途径是多线程入侵检测系统，它将 CPU 密集型的深度包检测工作并行的分配给多个并发任务来完成。这样的并行检测可以充分利用多核硬件的优势来轻松提升入侵检测系统的吞吐量。"><meta itemprop=datePublished content="2016-02-07T10:10:00+00:00"><meta itemprop=dateModified content="2016-02-07T10:10:00+00:00"><meta itemprop=wordCount content="501"><meta itemprop=keywords content="IDS,Suricata,入侵检测系统,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>如何在 Linux 系统上安装 Suricata 入侵检测系统</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2016-02-07T10:10:00Z>February 07, 2016</time></div></div></header><div class="content post__content clearfix"><p>随着安全威胁的不断发生，入侵检测系统（IDS）在如今的数据中心环境中显得尤为必要。然而，随着越来越多的服务器将他们的网卡升级到10GB/40GB以太网，对如此线路上的硬件进行计算密集型的入侵检测越来越困难。其中一种提升入侵检测系统性能的途径是<strong>多线程入侵检测系统</strong>，它将 CPU 密集型的深度包检测工作并行的分配给多个并发任务来完成。这样的并行检测可以充分利用多核硬件的优势来轻松提升入侵检测系统的吞吐量。在这方面有两个知名的开源项目，分别是 <a href=http://suricata-ids.org/>Suricata</a> 和 <a href=https://www.bro.org/>Bro</a>。</p><p><img src=https://img.linux.net.cn/data/attachment/album/201602/06/201834hv668284gg6miu48.jpg alt></p><p>这个教程里，我会向大家演示<strong>如何在 Linux 服务器上安装和配置 Suricata 入侵检测系统。</strong></p><h3 id=在-linux-上安装-suricata-ids>在 Linux 上安装 Suricata IDS</h3><p>让我们从源文件来构建 Suricata，但在此之前，需要按如下所示先安装几个依赖包。</p><h4 id=在-debian-ubuntu-或者-linux-mint-操作系统上安装依赖包>在 Debian, Ubuntu 或者 Linux Mint 操作系统上安装依赖包</h4><pre tabindex=0><code>$ sudo apt-get install wget build-essential libpcre3-dev libpcre3-dbg automake autoconf libtool libpcap-dev libnet1-dev libyaml-dev zlib1g-dev libcap-ng-dev libjansson-dev
</code></pre><h4 id=在-centos-fedora-或者-rhel-操作系统上安装依赖包>在 CentOS, Fedora 或者 RHEL 操作系统上安装依赖包</h4><pre tabindex=0><code>$ sudo yum install wget libpcap-devel libnet-devel pcre-devel gcc-c++ automake autoconf libtool make libyaml-devel zlib-devel file-devel jansson-devel nss-devel
</code></pre><p>一旦将所有依赖包安装完毕，我们就可以继续安装 Suricata 了。</p><p>首先从 <a href=http://suricata-ids.org/download/>http://suricata-ids.org/download/</a> 下载 Suricata 源代码，然后构建它。撰写这篇文章的时候，其最新版本号为 2.0.8 。</p><pre tabindex=0><code>$ wget http://www.openinfosecfoundation.org/download/suricata-2.0.8.tar.gz
$ tar -xvf suricata-2.0.8.tar.gz
$ cd suricata-2.0.8
$ ./configure --sysconfdir=/etc --localstatedir=/var
</code></pre><p>以下是配置信息的样例。</p><pre tabindex=0><code>Suricata Configuration:
  AF_PACKET support:                       yes
  PF_RING support:                         no
  NFQueue support:                         no
  NFLOG support:                           no
  IPFW support:                            no
  DAG enabled:                             no
  Napatech enabled:                        no
  Unix socket enabled:                     yes
  Detection enabled:                       yes

  libnss support:                          yes
  libnspr support:                         yes
  libjansson support:                      yes
  Prelude support:                         no
  PCRE jit:                                yes
  LUA support:                             no
  libluajit:                               no
  libgeoip:                                no
  Non-bundled htp:                         no
  Old barnyard2 support:                   no
  CUDA enabled:                            no
</code></pre><p>现在可以编译、安装了。</p><pre tabindex=0><code>$ make
$ sudo make install
</code></pre><p>Suricata 源代码带有默认的配置文件。按照如下方法安装这些默认配置文件即可。</p><pre tabindex=0><code>$ sudo make install-conf
</code></pre><p>正如你所料，如果没有IDS规则集的话，Suricata 什么用也没有。幸好 Makefile 为我们提供了 IDS 规则集的安装选项。安装方法如下。</p><pre tabindex=0><code>$ sudo make install-rules
</code></pre><p>以上的规则安装命令会从 <a href=http://rules.emergingthreats.net/>EmergingThreats.net</a> 上下载可用的社区规则集快照，并且将其存储在 /etc/suricata/rules 目录下。</p><p><img src=https://img.linux.net.cn/data/attachment/album/201602/06/201839zkpdiz6eeqiibiin.jpg alt></p><h3 id=首次配置-suricata-ids>首次配置 Suricata IDS</h3><p>现在到了配置 Suricata 的时候了。配置文件的位置是 <strong>/etc/suricata/suricata.yaml</strong>。参照以下命令，用文本编辑器打开这个文件。</p><pre tabindex=0><code>$ sudo vi /etc/suricata/suricata.yaml
</code></pre><p>文件中有一些运行所需的基本配置。</p><p>为<code>default-log-dir</code>关键字指定 Suricata 日志文件所在的位置。</p><pre tabindex=0><code>default-log-dir: /var/log/suricata/
</code></pre><p>在<code>vars</code>部分下方，你会发现几项对 Suricata 来说很重要变量。<code>HOME_NET</code>变量需要指定 Suricata 检查的网络。被分配给 <code>EXTERNAL_NET</code> 变量的 <code>!$HOME_NET</code> 代表除本地网络之外的其他网络。<code>XXX_PORTS</code>变量用来辨别不同服务所用到的端口号。需要注意的是无论使用什么端口，Suricata 都可以自动检测 HTTP 流量。所以是不是正确指定端口就显得没那么重要了。</p><pre tabindex=0><code>vars:
    HOME_NET: &#34;[192.168.122.0/24]&#34;
    EXTERNAL_NET: &#34;!$HOME_NET&#34;
    HTTP_PORTS: &#34;80&#34;
    SHELLCODE_PORTS: &#34;!80&#34;
    SSH_PORTS: 22
</code></pre><p><code>host-os-policy</code> 部分用于防御利用操作系统网络栈的自身行为来逃避检测的一些知名攻击手段（例如：TCP reassembly）。作为对策，通过针对目标操作系统而对检测引擎算法进行微调，现代 IDC 提供了“基于目标”的检测手段。因此，如果你知道某台主机运行了什么操作系统的话，将这个信息提供给 Suricata 就可以大幅提高检测的成功率。这就是 <code>host-os-policy</code> 存在的意义。本例中，默认的 IDC 策略是 Linux 系统。如果针对某个 IP 地址没有指定操作系统信息，Suricata 会默认应用基于 Linux 系统的检测策略。如下，当捕获到对 192.168.122.0/28 和 192.168.122.155通讯时，Suricata 就会应用基于 Windows 系统的检测策略。</p><pre tabindex=0><code>host-os-policy:
  # These are Windows machines.
  windows: [192.168.122.0/28, 192.168.122.155]
  bsd: []
  bsd-right: []
  old-linux: []
  # Make the default policy Linux.
  linux: [0.0.0.0/0]
  old-solaris: []
  solaris: [&#34;::1&#34;]
  hpux10: []
  hpux11: []
  irix: []
  macos: []
  vista: []
  windows2k3: []
</code></pre><p>在 <code>threading</code> 部分下，你可以为不同的 Suricata 线程指定 CPU 关联。默认状态下，<a href=http://xmodulo.com/run-program-process-specific-cpu-cores-linux.html>CPU 关联</a> 是被禁止使用的 (<code>set-cpu-affinity: no</code>)，这意味着 Suricata 会分配其线程到所有可用的 CPU 核心上。Suricata 会默认为每一个 CPU 核心创建一个检测线程。你可以通过指定 <code>detect-thread-ratio: N</code> 来调整此行为。此处会创建 N*M 个检测线程，M 代表 CPU 核心总数。</p><pre tabindex=0><code>threading:
  set-cpu-affinity: no
  detect-thread-ratio: 1.5
</code></pre><p>通过以上对线程的设置，Suricata 会创建 1.5*M 个检测线程，M 是系统的 CPU 核心总数。</p><p>如果你想对 Suricata 配置有更多的了解，可以去翻阅默认配置文件。里边配有有大量的注释以供你清晰理解。</p><h3 id=使用-suricata-进行入侵监控>使用 Suricata 进行入侵监控</h3><p>现在是时候让 Suricata 跑起来了，但在这之前还有一个步骤需要去完成。</p><p>当你使用 pcap 捕获模式的时候，强烈建议关闭 Suricata 监听网卡上的任何的包卸载（例如 LRO/GRO）功能。这些功能会干扰包的实时捕获行为。</p><p>按照以下方法关闭 eth0 接口的 LRO/GRO 功能。</p><pre tabindex=0><code>$ sudo ethtool -K eth0 gro off lro off
</code></pre><p>这里要注意，在使用某些网卡的情况下，你会看到如下警告信息。忽略它们就行了，这些信息只不过告诉你你的网卡不支持 LRO 功能而已。</p><pre tabindex=0><code>Cannot change large-receive-offload
</code></pre><p>Suricata 支持许多运行模式。运行模式决定着 IDC 会使用何种线程。以下命令可以查看所有 <a href=https://redmine.openinfosecfoundation.org/projects/suricata/wiki/Runmodes>可用的运行模式</a>。</p><pre tabindex=0><code>$ sudo /usr/local/bin/suricata --list-runmodes
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/201602/06/201841gv2d1zk8u16pyud6.jpg alt></p><p>Suricata 使用的默认运行模式是 autofp（ auto flow pinned load balancing （ 自动流绑定负载均衡 ） 的缩写）。这个模式下，来自某一个流的包会被分配到一个单独的检测线程中。这些流会根据未被处理的包的最低数量来分配相应的线程。</p><p>最后，让我们将 Suricata 运行起来，看看它表现如何。</p><pre tabindex=0><code>$ sudo /usr/local/bin/suricata -c /etc/suricata/suricata.yaml -i eth0 --init-errors-fatal
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/201602/06/201842j78hx9yh0tyy7y99.jpg alt></p><p>本例中，我们在一个8核心系统中监控 eth0 网络接口。如上所示，Suricata 创建了13个包处理线程和3个管理线程。包处理线程中包括一个 PCAP 包捕获线程，12个检测线程(由8*1.5得出)。这表示 IDS 内的1个包捕获线程均衡负载到12个检测线程中。管理线程包括1个流管理和2个计数/统计相关线程。</p><p>以下是一个关于Suricata处理的线程截图(由 <a href=http://ask.xmodulo.com/view-threads-process-linux.html>htop</a> 绘制)。</p><p><img src=https://img.linux.net.cn/data/attachment/album/201602/06/201843pf0702clc22hsf28.jpg alt></p><p>Suricata 检测日志存储在 /var/log/suricata 目录下。</p><pre tabindex=0><code>$ tail -f /var/log/suricata/fast.log
</code></pre><hr><pre tabindex=0><code>04/01/2015-15:47:12.559075  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} 172.16.253.158:22 -&gt; 172.16.253.1:46997
04/01/2015-15:49:06.565901  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} 172.16.253.158:22 -&gt; 172.16.253.1:46317
04/01/2015-15:49:06.566759  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} 172.16.253.158:22 -&gt; 172.16.253.1:46317
</code></pre><p>日志也可以提供 Json 格式以便导入：</p><pre tabindex=0><code>$ tail -f /var/log/suricata/eve.json
</code></pre><hr><pre tabindex=0><code>{&#34;timestamp&#34;:&#34;2015-04-01T15:49:06.565901&#34;,&#34;event_type&#34;:&#34;alert&#34;,&#34;src_ip&#34;:&#34;172.16.253.158&#34;,&#34;src_port&#34;:22,&#34;dest_ip&#34;:&#34;172.16.253.1&#34;,&#34;dest_port&#34;:46317,&#34;proto&#34;:&#34;TCP&#34;,&#34;alert&#34;:{&#34;action&#34;:&#34;allowed&#34;,&#34;gid&#34;:1,&#34;signature_id&#34;:2200074,&#34;rev&#34;:1,&#34;signature&#34;:&#34;SURICATA TCPv4 invalid checksum&#34;,&#34;category&#34;:&#34;&#34;,&#34;severity&#34;:3}}
{&#34;timestamp&#34;:&#34;2015-04-01T15:49:06.566759&#34;,&#34;event_type&#34;:&#34;alert&#34;,&#34;src_ip&#34;:&#34;172.16.253.158&#34;,&#34;src_port&#34;:22,&#34;dest_ip&#34;:&#34;172.16.253.1&#34;,&#34;dest_port&#34;:46317,&#34;proto&#34;:&#34;TCP&#34;,&#34;alert&#34;:{&#34;action&#34;:&#34;allowed&#34;,&#34;gid&#34;:1,&#34;signature_id&#34;:2200074,&#34;rev&#34;:1,&#34;signature&#34;:&#34;SURICATA TCPv4 invalid checksum&#34;,&#34;category&#34;:&#34;&#34;,&#34;severity&#34;:3}}
</code></pre><h3 id=总结>总结</h3><p>这篇教程中，我为大家演示了如何在一台多核 Linux 服务器上安装 Suricata 入侵检测系统。不同于单线程的 <a href=http://xmodulo.com/how-to-compile-and-install-snort-from-source-code-on-ubuntu.html>Snort IDS</a> ，Suricata 可以很容易的从多核硬件的多进程特性所带来的好处中获益。定制 Suricata 来最大化其效能和检测范围是一个很好的主意。Suricata 的粉丝们维护着一个 <a href=https://redmine.openinfosecfoundation.org/projects/suricata/wiki>在线 Wiki</a>，如果你打算将 Suricata 部署到你的环境中，我强烈建议你去那儿取取经。</p><p>如果你现在已经开始使用 Suricata 了的话，把你的经验也分享出来吧。</p><hr><p>via: <a href=http://xmodulo.com/install-suricata-intrusion-detection-system-linux.html>http://xmodulo.com/install-suricata-intrusion-detection-system-linux.html</a></p><p>作者：<a href=http://xmodulo.com/author/nanni>Dan Nanni</a> 译者：<a href=https://github.com/mr-ping>mr-ping</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/ids/ rel=tag>IDS</a></li><li class=tags__item><a class="tags__link btn" href=/tags/suricata/ rel=tag>Suricata</a></li><li class=tags__item><a class="tags__link btn" href=/tags/%E5%85%A5%E4%BE%B5%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F/ rel=tag>入侵检测系统</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>