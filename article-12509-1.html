<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>在 Linux 上挖掘 DNS 应答中的秘密 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="在 Linux 上挖掘 DNS 应答中的秘密"><meta property="og:description" content="dig 是一个强大而灵活的工具，用于查询域名系统（DNS）服务器。在这篇文章中，我们将深入了解它的工作原理以及它能告诉你什么。"><meta property="og:type" content="article"><meta property="og:url" content="/article-12509-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-08-11T23:52:16+00:00"><meta property="article:modified_time" content="2020-08-11T23:52:16+00:00"><meta itemprop=name content="在 Linux 上挖掘 DNS 应答中的秘密"><meta itemprop=description content="dig 是一个强大而灵活的工具，用于查询域名系统（DNS）服务器。在这篇文章中，我们将深入了解它的工作原理以及它能告诉你什么。"><meta itemprop=datePublished content="2020-08-11T23:52:16+00:00"><meta itemprop=dateModified content="2020-08-11T23:52:16+00:00"><meta itemprop=wordCount content="632"><meta itemprop=keywords content="dig,DNS,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>在 Linux 上挖掘 DNS 应答中的秘密</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2020-08-11T23:52:16Z>August 11, 2020</time></div></div></header><div class="content post__content clearfix"><blockquote><p>dig 是一个强大而灵活的工具，用于查询域名系统（DNS）服务器。在这篇文章中，我们将深入了解它的工作原理以及它能告诉你什么。</p></blockquote><p><img src=/data/attachment/album/202008/11/235200wlyytlaymlylfdff.jpg alt></p><p><code>dig</code> 是一款强大而灵活的查询 DNS 名称服务器的工具。它执行 DNS 查询，并显示参与该过程的名称服务器返回的应答以及与搜索相关的细节。系统管理员和 <a href=https://www.networkworld.com/article/3268449/what-is-dns-and-how-does-it-work.html>DNS</a> 管理员经常使用 <code>dig</code> 来帮助排除 DNS 问题。在这篇文章中，我们将深入了解它的工作原理，看看它能告诉我们什么。</p><p>开始之前，对 DNS（域名系统）的工作方式有一个基本的印象是很有帮助的。它是全球互联网的关键部分，因为它提供了一种查找世界各地的服务器的方式，从而可以与之连接。你可以把它看作是互联网的地址簿，任何正确连接到互联网的系统，都应该能够使用它来查询任何正确注册的服务器的 IP 地址。</p><h3 id=dig-入门>dig 入门</h3><p>Linux 系统上一般都默认安装了 <code>dig</code> 工具。下面是一个带有一点注释的 <code>dig</code> 命令的例子：</p><pre tabindex=0><code>$ dig www.networkworld.com

; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; www.networkworld.com &lt;== 你使用的 dig 版本
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 6034
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:                            &lt;== 你的查询细节
;www.networkworld.com.          IN      A

;; ANSWER SECTION:                              &lt;== 结果

www.networkworld.com.   3568    IN      CNAME   idg.map.fastly.net.
idg.map.fastly.net.     30      IN      A       151.101.250.165

;; Query time: 36 msec                          &lt;== 查询用时
;; SERVER: 127.0.0.53#53(127.0.0.53)            &lt;== 本地缓存解析器
;; WHEN: Fri Jul 24 19:11:42 EDT 2020           &lt;== 查询的时间
;; MSG SIZE  rcvd: 97                           &lt;== 返回的字节数
</code></pre><p>如果你得到了一个这样的应答，是好消息吗？简短的回答是“是”。你得到了及时的回复。状态字段（<code>status: NOERROR</code>）显示没有问题。你正在连接到一个能够提供所要求的信息的名称服务器，并得到一个回复，告诉你一些关于你所查询的系统的重要细节。简而言之，你已经验证了你的系统和域名系统相处得很好。</p><p>其他可能的状态指标包括：</p><ul><li><code>SERVFAIL</code>：被查询的名称存在，但没有数据或现有数据无效。</li><li><code>NXDOMAIN</code>：所查询的名称不存在。</li><li><code>REFUSED</code>：该区域的数据不存在于所请求的权威服务器中，并且在这种情况下，基础设施没有设置为提供响应服务。</li></ul><p>下面是一个例子，如果你要查找一个不存在的域名，你会看到什么？</p><pre tabindex=0><code>$ dig cannotbe.org

; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; cannotbe.org
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NXDOMAIN, id: 35348
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1
</code></pre><p>一般来说，<code>dig</code> 比 <code>ping</code> 会提供更多的细节，如果域名不存在，<code>ping</code> 会回复 “名称或服务未知”。当你查询一个合法的系统时，你可以看到域名系统对该系统知道些什么，这些记录是如何配置的，以及检索这些数据需要多长时间。</p><p>（LCTT 译注：<code>dig</code> 也比 <code>nslookup</code> 提供的数据更多。此外，<code>dig</code> 采用的是操作系统的解析库，而 <code>nslookup</code> 采用的是自己提供的解析库，这有时候会带来不同的行为。最后，有趣的一点是，<code>dig</code> 的返回的格式是符合 BIND 区域文件格式的。）</p><p>事实上，有时 <code>dig</code> 可以在 <code>ping</code> 完全不能响应的时候进行响应，当你试图确定一个连接问题时，这种信息是非常有用的。</p><h3 id=dns-记录类型和标志>DNS 记录类型和标志</h3><p>在上面的第一个查询中，我们可以看到一个问题，那就是同时存在 <code>CNAME</code> 和 <code>A</code> 记录。<code>CNAME</code>（ 规范名称 canonical name ）就像一个别名，把一个域名指向另一个域名。你查询的大多数系统不会有 <code>CNAME</code> 记录，而只有 <code>A</code> 记录。如果你运行 <code>dig localhost</code> 命令，你会看到一个 <code>A</code> 记录，它就指向 <code>127.0.0.1</code> —— 这是每个系统都使用的“回环”地址。<code>A</code> 记录用于将一个名字映射到一个 IP 地址。</p><p>DNS 记录类型包括：</p><ul><li><code>A</code> 或 <code>AAAA</code>：IPv4 或 IPv6 地址</li><li><code>CNAME</code>：别名</li><li><code>MX</code>：邮件交换器</li><li><code>NS</code>：名称服务器</li><li><code>PTR</code>：一个反向条目，让你根据 IP 地址找到系统名称</li><li><code>SOA</code>：表示授权记录开始</li><li><code>TXT</code> 一些相关文本</li></ul><p>我们还可以在上述输出的第五行看到一系列的“标志”。这些定义在 <a href=https://tools.ietf.org/html/rfc1035>RFC 1035</a> 中 —— 它定义了 DNS 报文头中包含的标志，甚至显示了报文头的格式。</p><pre tabindex=0><code>                                1  1  1  1  1  1
  0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                      ID                       |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|QR|   Opcode  |AA|TC|RD|RA|   Z    |   RCODE   |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    QDCOUNT                    |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    ANCOUNT                    |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    NSCOUNT                    |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    ARCOUNT                    |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
</code></pre><p>在上面的初始查询中，第五行显示的标志是：</p><ul><li><code>qr</code> = 查询</li><li><code>rd</code> = 进行递归查询</li><li><code>ra</code> = 递归数据可用</li></ul><p>RFC 中描述的其他标志包括：</p><ul><li><code>aa</code> = 权威答复</li><li><code>cd</code> = 检查是否禁用</li><li><code>ad</code> = 真实数据</li><li><code>opcode</code> = 一个 4 位字段</li><li><code>tc</code> = 截断</li><li><code>z</code>（未使用）</li></ul><h3 id=添加-trace-选项>添加 +trace 选项</h3><p>如果你添加 <code>+trace</code> 选项，你将从 <code>dig</code> 得到更多的输出。它会添加更多信息，显示你的 DNS 查询如何通过名称服务器的层次结构找到你要找的答案。</p><p>下面显示的所有 <code>NS</code> 记录都反映了名称服务器 —— 这只是你将看到的数据的第一部分，因为查询通过名称服务器的层次结构来追踪你要找的东西：</p><pre tabindex=0><code>$ dig +trace networkworld.com

; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; +trace networkworld.com
;; global options: +cmd
.                       84895   IN      NS      k.root-servers.net.
.                       84895   IN      NS      e.root-servers.net.
.                       84895   IN      NS      m.root-servers.net.
.                       84895   IN      NS      h.root-servers.net.
.                       84895   IN      NS      c.root-servers.net.
.                       84895   IN      NS      f.root-servers.net.
.                       84895   IN      NS      a.root-servers.net.
.                       84895   IN      NS      g.root-servers.net.
.                       84895   IN      NS      l.root-servers.net.
.                       84895   IN      NS      d.root-servers.net.
.                       84895   IN      NS      b.root-servers.net.
.                       84895   IN      NS      i.root-servers.net.
.                       84895   IN      NS      j.root-servers.net.
;; Received 262 bytes from 127.0.0.53#53(127.0.0.53) in 28 ms
...
</code></pre><p>最终，你会得到与你的要求直接挂钩的信息：</p><pre tabindex=0><code>networkworld.com.       300     IN      A       151.101.2.165
networkworld.com.       300     IN      A       151.101.66.165
networkworld.com.       300     IN      A       151.101.130.165
networkworld.com.       300     IN      A       151.101.194.165
networkworld.com.       14400   IN      NS      ns-d.pnap.net.
networkworld.com.       14400   IN      NS      ns-a.pnap.net.
networkworld.com.       14400   IN      NS      ns0.pcworld.com.
networkworld.com.       14400   IN      NS      ns1.pcworld.com.
networkworld.com.       14400   IN      NS      ns-b.pnap.net.
networkworld.com.       14400   IN      NS      ns-c.pnap.net.
;; Received 269 bytes from 70.42.185.30#53(ns0.pcworld.com) in 116 ms
</code></pre><h3 id=挑选响应者>挑选响应者</h3><p>你可以使用 <code>@</code> 符号来指定一个特定的名称服务器来处理你的查询。在这里，我们要求 Google 的主名称服务器响应我们的查询：</p><pre tabindex=0><code>$ dig @8.8.8.8 networkworld.com

; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; @8.8.8.8 networkworld.com
; (1 server found)
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 43640
;; flags: qr rd ra; QUERY: 1, ANSWER: 4, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 512
;; QUESTION SECTION:
;networkworld.com.              IN      A

;; ANSWER SECTION:
networkworld.com.       299     IN      A       151.101.66.165
networkworld.com.       299     IN      A       151.101.194.165
networkworld.com.       299     IN      A       151.101.130.165
networkworld.com.       299     IN      A       151.101.2.165

;; Query time: 48 msec
;; SERVER: 8.8.8.8#53(8.8.8.8)
;; WHEN: Sat Jul 25 11:21:19 EDT 2020
;; MSG SIZE  rcvd: 109
</code></pre><p>下面所示的命令对 <code>8.8.8.8</code> IP 地址进行反向查找，以显示它属于 Google 的 DNS 服务器。</p><pre tabindex=0><code>$ nslookup 8.8.8.8
8.8.8.8.in-addr.arpa    name = dns.google.
</code></pre><h3 id=总结>总结</h3><p><code>dig</code> 命令是掌握 DNS 工作原理和在出现连接问题时排除故障的重要工具。</p><hr><p>via: <a href=https://www.networkworld.com/article/3568488/digging-for-dns-answers-on-linux.html>https://www.networkworld.com/article/3568488/digging-for-dns-answers-on-linux.html</a></p><p>作者：<a href=https://www.networkworld.com/author/Sandra-Henry_Stocker/>Sandra Henry-Stocker</a> 选题：<a href=https://github.com/lujun9972>lujun9972</a> 译者：<a href=https://github.com/wxy>wxy</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/dig/ rel=tag>dig</a></li><li class=tags__item><a class="tags__link btn" href=/tags/dns/ rel=tag>DNS</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>