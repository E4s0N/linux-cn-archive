<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Btrfs 文件系统入门 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="Btrfs 文件系统入门"><meta property="og:description" content="B-tree 文件系统（Btrfs）融合了文件系统和卷管理器。它为 Linux 操作系统提供了高级文件系统应当拥有的诸多不错的功能特性。"><meta property="og:type" content="article"><meta property="og:url" content="/article-13440-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-30T07:02:32+00:00"><meta property="article:modified_time" content="2021-05-30T07:02:32+00:00"><meta itemprop=name content="Btrfs 文件系统入门"><meta itemprop=description content="B-tree 文件系统（Btrfs）融合了文件系统和卷管理器。它为 Linux 操作系统提供了高级文件系统应当拥有的诸多不错的功能特性。"><meta itemprop=datePublished content="2021-05-30T07:02:32+00:00"><meta itemprop=dateModified content="2021-05-30T07:02:32+00:00"><meta itemprop=wordCount content="601"><meta itemprop=keywords content="Btrfs,文件系统,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Btrfs 文件系统入门</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2021-05-30T07:02:32Z>May 30, 2021</time></div></div></header><div class="content post__content clearfix"><blockquote><p>B-tree 文件系统（Btrfs）融合了文件系统和卷管理器。它为 Linux 操作系统提供了高级文件系统应当拥有的诸多不错的功能特性。</p></blockquote><p><img src=https://img.linux.net.cn/data/attachment/album/202105/30/070203wkxsufbx1zlccyl9.jpg alt title="Filing cabinet for organization"></p><p>好几年前 Btrfs 就已经可以在 Linux 中使用了，所以你可能已经熟悉它了。如果没有，你可能对它尚有疑虑，尤其是如果你使用的是 Fedora 工作站 （Btrfs 现在是它的默认文件系统）。本文旨在帮助你熟悉它及其高级功能，例如 <a href=https://en.wikipedia.org/wiki/Copy-on-write>写时复制</a> 和 <a href=https://en.wikipedia.org/wiki/Checksum>校验和</a>。</p><p>Btrfs 是 “B-Tree Filesystem” 的缩写，实际上是文件系统和卷管理器的结合体。它通常被视为对 ZFS 的回应，ZFS 早在 2005 年就被引入 Sun 微系统的 Solaris 操作系统中，现在基本上被一个名为 OpenZFS 的开源实现所取代。Ubuntu 和 FreeBSD 常常使用 OpenZFS。其他具有类似特性的示例有红帽的 Stratis 和 Linux 逻辑卷管理器 Logical Volume Manager （LVM）。</p><h3 id=安装>安装</h3><p>为了尝试 Btrfs，我下载了 Fedora 33 工作站 <a href=https://getfedora.org/en/workstation/download/>ISO 文件</a> 并将其安装到一个新的虚拟机（VM）中。安装过程与以前的版本没有变化。我没有自定义任何设置，包括驱动器分区和格式化，以保持本教程的准确“开箱即用”设置。当虚拟机启动并运行后，我安装并运行了 GNOME 分区编辑器（<a href=https://gparted.org/>GParted</a>），以获得一个良好的、工厂级的驱动器布局视图。</p><p><img src=https://img.linux.net.cn/data/attachment/album/202105/30/070234u1vajnxp7d5jam43.png alt="GParted&rsquo;s view of Btrfs on Fedora 33 Workstation using GParted" title="GParted's view of Btrfs on Fedora 33 Workstation using GParted"></p><p>从安装这一点来说，与你以前所习惯的情况没什么不同；事实上，你可以正常使用该系统，甚至可能没有注意到文件系统是 Btrfs。然而，拥有这个新的默认文件系统使你能够利用几个很酷的特性。</p><h3 id=检查-btrfs-文件系统>检查 Btrfs 文件系统</h3><p>我暂时没有找到特定于 Btrfs 的图形工具，尽管它的一些功能已经被合并到现有的磁盘管理工具中。</p><p>在命令行中，你可以更仔细地查看 Btrfs 格式：</p><pre tabindex=0><code># btrfs filesystem show
Label: &#39;fedora_localhost-live&#39;  uuid: f2bb02f9-5c41-4c91-8eae-827a801ee58a
        Total devices 1 FS bytes used 6.36GiB
        devid    1 size 10.41GiB used 8.02GiB path /dev/vda3
</code></pre><h3 id=修改-btrfs-标签>修改 Btrfs 标签</h3><p>我首先注意到的是安装程序设置的文件系统标签：<code>fedora_localhost-live</code>。这是不准确的，因为它现在是一个已安装的系统，不再是 <a href=https://en.wikipedia.org/wiki/Live_CD>livecd</a>。所以我使用 <code>btrfs filesystem label</code> 命令对其进行了更改。</p><p>修改 Btrfs 标签非常的简单：</p><pre tabindex=0><code># btrfs filesystem label /
fedora_localhost-live
# btrfs filesystem label / fedora33workstation
# btrfs filesystem label /
fedora33workstation
</code></pre><h3 id=管理-btrfs-子卷>管理 Btrfs 子卷</h3><p>子卷看起来像是可以由 Btrfs 管理的标准目录。我的新 Fedora 33 工作站上有几个子卷：</p><pre tabindex=0><code># btrfs subvolume list /
ID 256 gen 2458 top level 5 path home
ID 258 gen 2461 top level 5 path root
ID 265 gen 1593 top level 258 path var/lib/machines
</code></pre><p>使用 <code>btrfs subvolume Create</code> 命令创建新的子卷，或使用 <code>btrfs subvolume delete</code> 删除子卷：</p><pre tabindex=0><code># btrfs subvolume create /opt/foo
Create subvolume &#39;/opt/foo&#39;
# btrfs subvolume list /
ID 256 gen 2884 top level 5 path home
ID 258 gen 2888 top level 5 path root
ID 265 gen 1593 top level 258 path var/lib/machines
ID 276 gen 2888 top level 258 path opt/foo
# btrfs subvolume delete /opt/foo
Delete subvolume (no-commit): &#39;/opt/foo&#39;
</code></pre><p>子卷允许设置配额、拍摄快照以及复制到其他位置和其他主机等操作。那么系统管理员如何利用这些功能？用户主目录又是如何操作的呢？</p><h4 id=添加用户>添加用户</h4><p>就像从前一样，添加一个新的用户帐户会创建一个主目录供该帐户使用：</p><pre tabindex=0><code># useradd student1
# getent passwd student1
student1:x:1006:1006::/home/student1:/bin/bash
# ls -l /home
drwx------. 1 student1 student1  80 Oct 29 00:21 student1
</code></pre><p>传统上，用户的主目录是 <code>/home</code> 的子目录。所有权和操作权是为所有者量身定制的，但是特殊功能来没有管理它们。而企业服务器环境是另外一种情况。通常，目录是为特定的应用程序及其用户保留的。你可以利用 Btrfs 来管理和应用对这些目录的约束。</p><p>为了将 Btrfs 子卷作为用户主页，在 <code>useradd</code> 命令中有一个新选项：<code>--Btrfs-subvolume-home</code>。尽管手册页尚未更新（截至本文撰写之时），但你可以通过运行 <code>useradd --help</code> 来查看该选项。通过在添加新用户时传递此选项，将创建一个新的 Btrfs 子卷。它的功能与创建常规目录时的 <code>-d</code> 选项类似：</p><pre tabindex=0><code># useradd --btrfs-subvolume-home student2
Create subvolume &#39;/home/student2&#39;
</code></pre><p>使用 <code>getent passwd student2</code> 验证用户，它将显示为正常。但是，运行 <code>btrfs subvolume</code> 命令列出子卷，你将看到一些有趣的内容：新用户的主目录！</p><pre tabindex=0><code># btrfs subvolume list /
ID 256 gen 2458 top level 5 path home
ID 258 gen 2461 top level 5 path root
ID 265 gen 1593 top level 258 path var/lib/machines
ID 272 gen 2459 top level 256 path home/student2
</code></pre><p>探索企业服务器环境的第二个场景。假设你需要在 <code>/opt</code> 中安装一个 <a href=https://www.wildfly.org/>WildFly</a> 服务器并部署一个 Java web 应用程序。通常，你的第一步是创建一个 <code>wildfly</code> 用户。使用新的 <code>--btrfs-subvolume-home</code> 选项和 <code>-b</code> 选项来指定 <code>/opt</code> 作为基本目录：</p><pre tabindex=0><code># useradd -b /opt --btrfs-subvolume-home wildfly
Create subvolume &#39;/opt/wildfly&#39;
</code></pre><p>于是，<code>wildfly</code> 用户可以使用了，并且主目录设置在了 <code>/opt/wildfly</code>。</p><h4 id=删除用户>删除用户</h4><p>删除用户时，有时需要同时删除该用户的文件和主目录。<code>userdel</code> 命令有 <code>-r</code> 选项，它可以同时删除 Btrfs 子卷：</p><pre tabindex=0><code># userdel -r student2
Delete subvolume (commit): &#39;/home/student2&#39;
</code></pre><h4 id=设置磁盘使用配额>设置磁盘使用配额</h4><p>在我的一节计算机科学课上，一个学生运行了一个失控的 C 程序，然后写进了磁盘，将我们院的 Unix 系统上整个 <code>/home</code> 目录都填满了！在管理员终止失控进程并清除一些空间之前，服务器将无法使用。上述情况也是如此；那个 Wildfly 企业应用程序将为其用户提供越来越多的日志文件和内容存储。如何防止服务器因磁盘已满而死机？设置磁盘使用限制是个好主意。幸运的是，Btrfs 通过设置配额的方式支持这一点。</p><p>配置配额需要几个步骤。第一步是在 Btrfs 文件系统上启用配额：</p><pre tabindex=0><code># btrfs quota enable /
</code></pre><p>确保你知道每个子卷的配额组（qgroup）ID 号，该编号由 <code>btrfs subvolume list</code> 命令显示。每个子卷都需要基于 ID 号码来关联配额组。这可以通过 <code>btrfs qgroup create</code> 单独完成，但是，btrfs 维基提供了以下命令来加快为文件系统上的子卷创建配额组：</p><pre tabindex=0><code>&gt; btrfs subvolume list \&lt;path&gt; | cut -d&#39; &#39; -f2 | xargs -I{} -n1 btrfs qgroup destroy 0/{} \&lt;path&gt;
</code></pre><p>在新安装的 Fedora 33 工作站系统中，你在根文件系统路径上操作，<code>/</code>。用根路径替换 <code>\&lt;path></code>：</p><pre tabindex=0><code># btrfs subvolume list / | cut -d&#39; &#39; -f2 | xargs -I{} -n1 btrfs qgroup create 0/{} /
</code></pre><p>然后运行 <code>btrfs quota rescan</code>，查看新的配额组：</p><pre tabindex=0><code># btrfs quota rescan /
quota rescan started
# btrfs qgroup show /
qgroupid         rfer         excl
--------         ----         ----
0/5          16.00KiB     16.00KiB
0/256       272.04MiB    272.04MiB
0/258         6.08GiB      6.08GiB
0/265        16.00KiB     16.00KiB
0/271        16.00KiB     16.00KiB
0/273        16.00KiB     16.00KiB
</code></pre><p>于是现在，你可以将配额分配给其中一个配额组，然后将配额应用于其关联的子卷。因此，如果要将 <code>student3</code> 的主目录使用限制为 1 GB，请使用 <code>btrfs qgroup limit</code> 命令：</p><pre tabindex=0><code># btrfs qgroup limit 1G /home/student3
</code></pre><p>查看特定子卷的配额：</p><pre tabindex=0><code># btrfs qgroup show -reF /home/student3
qgroupid         rfer         excl     max_rfer     max_excl
--------         ----         ----     --------     --------
0/271        16.00KiB     16.00KiB      1.00GiB         none
</code></pre><p>稍有不同的选项参数将显示所有配额组和设置的所有配额：</p><pre tabindex=0><code># btrfs qgroup show -re /
qgroupid         rfer         excl     max_rfer     max_excl
--------         ----         ----     --------     --------
0/5          16.00KiB     16.00KiB         none         none
0/256       272.04MiB    272.04MiB         none         none
0/258         6.08GiB      6.08GiB         none         none
0/265        16.00KiB     16.00KiB         none         none
0/271        16.00KiB     16.00KiB      1.00GiB         none
0/273        16.00KiB     16.00KiB         none         none
</code></pre><h3 id=其他特性>其他特性</h3><p>这些例子提供了 Btrfs 特性的一些思考。运行 <code>btrfs --help</code> 查看命令的完整列表。还有许多其他值得注意的功能；例如，快照和发送/接收是两个值得学习的功能。</p><h3 id=总结讨论>总结讨论</h3><p>Btrfs 为向 Linux 提供高级文件系统特性集贡献了很多特性。这不是第一次；我知道 ZFS 在大约 15 年前引入了这种类型的文件系统，但是 Btrfs 是完全开源的，不受专利的限制。</p><p>如果你想探索这个文件系统，我建议从虚拟机或备用系统开始。</p><p>我想能够出现一些图形化的管理工具，为那些喜欢用图形工具的系统管理员提供便利。幸运的是，Btrfs 具有强大的开发活动，Fedora 33 项目决定将其设置为工作站上的默认值就证明了这一点。</p><hr><p>via: <a href=https://opensource.com/article/20/11/btrfs-linux>https://opensource.com/article/20/11/btrfs-linux</a></p><p>作者：<a href=https://opensource.com/users/alanfdoss>Alan Formy-Duval</a> 选题：<a href=https://github.com/lujun9972>lujun9972</a> 译者：<a href=https://github.com/Chao-zhi>Chao-zhi</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/btrfs/ rel=tag>Btrfs</a></li><li class=tags__item><a class="tags__link btn" href=/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/ rel=tag>文件系统</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>