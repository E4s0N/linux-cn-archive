<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Samba 系列（六）：使用 Rsync 命令同步两个 Samba4 AD DC 之间的 SysVol 目录 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="Samba 系列（六）：使用 Rsync 命令同步两个 Samba4 AD DC 之间的 SysVol 目录"><meta property="og:description" content="这篇文章讲的是在两个 Samba4 活动目录域控制器之间，通过一些强大的 Linux 工具来完成 SysVol 的复制操作，比如 Rsync 数据同步工具，Cron 任务调度进程和 SSH 协议。"><meta property="og:type" content="article"><meta property="og:url" content="/article-8384-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-04-08T10:32:19+00:00"><meta property="article:modified_time" content="2017-04-08T10:32:19+00:00"><meta itemprop=name content="Samba 系列（六）：使用 Rsync 命令同步两个 Samba4 AD DC 之间的 SysVol 目录"><meta itemprop=description content="这篇文章讲的是在两个 Samba4 活动目录域控制器之间，通过一些强大的 Linux 工具来完成 SysVol 的复制操作，比如 Rsync 数据同步工具，Cron 任务调度进程和 SSH 协议。"><meta itemprop=datePublished content="2017-04-08T10:32:19+00:00"><meta itemprop=dateModified content="2017-04-08T10:32:19+00:00"><meta itemprop=wordCount content="405"><meta itemprop=keywords content="Samba,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Samba 系列（六）：使用 Rsync 命令同步两个 Samba4 AD DC 之间的 SysVol 目录</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2017-04-08T10:32:19Z>April 08, 2017</time></div></div></header><div class="content post__content clearfix"><p><img src=https://img.linux.net.cn/data/attachment/album/201704/08/102924a87i7t2do373z77f.jpg alt></p><p>这篇文章讲的是在两个 <strong>Samba4 活动目录域控制器</strong>之间，通过一些强大的 Linux 工具来完成 SysVol 的复制操作，比如 <a href=http://www.tecmint.com/rsync-local-remote-file-synchronization-commands/>Rsync 数据同步工具</a>，<a href=http://www.tecmint.com/11-cron-scheduling-task-examples-in-linux/>Cron 任务调度进程</a>和 <a href=http://www.tecmint.com/5-best-practices-to-secure-and-protect-ssh-server/>SSH 协议</a>。</p><h3 id=需求>需求：</h3><p>1、<a href=/article-8065-1.html>在 Ubuntu 系统上使用 Samba4 来创建活动目录架构</a></p><p>2、<a href=/article-8070-1.html>在 Linux 命令行下管理 Samba4 AD 架构</a></p><p>3、<a href=/article-8097-1.html>使用 Windows 10 的 RSAT 工具来管理 Samba4 活动目录架构</a></p><p>4、<a href=/article-8258-1.html>在 Windows 下管理 Samba4 AD 域管制器 DNS 和组策略</a></p><p>5、<a href=/article-8358-1.html>将另一台 Ubuntu DC 服务器加入到 Samba4 AD DC 实现双域控主机模式</a></p><h3 id=第一步配置-dc-服务器时间同步>第一步：配置 DC 服务器时间同步</h3><p>1、在两个域控制器之间复制 <strong>sysvol</strong> 目录的内容之前，你得保证这两个服务器时间设置准确且一致。</p><p>如果这两个服务器的时间延迟大于 5 分钟，并且时钟也不同步，你将会遇到 AD 账号和域复制的各种问题。</p><p>为了解决多个域控制器之间时间漂移的问题，你需要在服务器上执行如下命令来<a href=http://www.tecmint.com/install-and-configure-ntp-server-client-in-debian/>安装和配置 NTP 服务</a>。</p><pre tabindex=0><code># apt-get install ntp
</code></pre><p>2、在 NTP 服务安装完成之后，打开主配置文件，把默认的 pool 值注释（在每行 pool 参数前添加 # ），并且添加新的 pool 值，指向已安装了 <strong>NTP</strong> 服务端的主 <strong>Samba4 AD DC FQDN</strong>，如下所示。</p><pre tabindex=0><code># nano /etc/ntp.conf
</code></pre><p>把下面几行添加到 <code>ntp.conf</code> 配置文件。</p><pre tabindex=0><code>pool 0.ubuntu.pool.ntp.org iburst
#pool 1.ubuntu.pool.ntp.org iburst
#pool 2.ubuntu.pool.ntp.org iburst
#pool 3.ubuntu.pool.ntp.org iburst
pool adc1.tecmint.lan
# Use Ubuntu&#39;s ntp server as a fallback.
pool ntp.ubuntu.com
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/201704/08/103221g0z6aph1v4x7wm0m.png alt="Configure NTP for Samba4"></p><p><em>Samba4 配置 NTP 服务</em></p><p>3、先不要关闭该文件，在文件末尾添加如下内容，这是为了让其它客户端能够查询并<a href=http://www.tecmint.com/how-to-synchronize-time-with-ntp-server-in-ubuntu-linux-mint-xubuntu-debian/>与这个 NTP 服务器同步时间</a>，并发出 NTP 签署请求，以防主 DC 离线：</p><pre tabindex=0><code>restrict source notrap nomodify noquery mssntp
ntpsigndsocket /var/lib/samba/ntp_signd/
</code></pre><p>4、最后，关闭并保存该配置文件，然后重启 NTP 服务以应用更改。等待几分钟后时间同步完成，执行 <code>ntpq</code> 命令打印出 <strong>adc1</strong> 时间同步情况。</p><pre tabindex=0><code># systemctl restart ntp
# ntpq -p
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/201704/08/103221fuebr7rrtgbnsmve.png alt="Synchronize NTP Time with Samba4 AD"></p><p><em>与 Samba4 AD 同步 NTP 时间</em></p><h3 id=第二步通过-rsync-命令来复制第一个-dc-服务器上的-sysvol-目录>第二步：通过 Rsync 命令来复制第一个 DC 服务器上的 SysVol 目录</h3><p>默认情况下，<strong>Samba4 AD DC</strong> 不会通过 <strong>DFS-R</strong>（ 分布式文件系统复制 Distributed File System Replication ）或者 <strong>FRS</strong>（ 文件复制服务 File Replication Service ）来复制 SysVol 目录。</p><p>这意味着只有在第一个域控制器联机时， 组策略对象 Group Policy objects 才可用。否则组策略设置和登录脚本不会应用到已加入域的 Windosws 机器上。</p><p>为了克服这个障碍，以及基本实现 SysVol 目录复制的目的，我们通过执行一个<a href=http://www.tecmint.com/ssh-passwordless-login-using-ssh-keygen-in-5-easy-steps/>基于 SSH 的身份认证</a>并使用 SSH 加密通道的<a href=http://www.tecmint.com/rsync-local-remote-file-synchronization-commands/>Linux 同步命令</a>来从第一个域控制器安全地传输 <strong>GPO</strong> 对象到第二个域控制器。</p><p>这种方式能够确保 <strong>GPO</strong> 对象在域控制器之间的一致性，但是也有一个很大的缺点。它只能进行单向同步，因为在同步 GPO 目录的时候， <strong>rsync</strong> 命令会从源 DC 服务器传输所有的更改到目标 DC 服务器，</p><p>源 DC 服务器上不存在的组策略对象也会从目标 DC 服务器上删除，为了限制并避免任何冲突，所有的 GPO 编辑操作只能在第一个 DC 服务器上执行。</p><p>5、要进行 <strong>SysVol</strong> 复制，先到<a href=http://www.tecmint.com/ssh-passwordless-login-using-ssh-keygen-in-5-easy-steps/>第一个 AD DC 服务器上生成 SSH 密钥</a>，然后使用下面的命令把该密钥传输到第二个 DC 服务器。</p><p>在生成密钥的过程中不要设置密码，以便在无用户干预的情况下进行传输。</p><pre tabindex=0><code># ssh-keygen -t RSA  
# ssh-copy-id root@adc2  
# ssh adc2 
# exit 
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/201704/08/103222syu0h29525bw5259.png alt="Generate SSH Key on Samba4 DC"></p><p><em>在 Samba4 DC 服务器上生成 SSH 密钥</em></p><p>6、 当你确认 root 用户可以从第一个 <strong>DC</strong> 服务器以免密码方式登录到第二个 <strong>DC</strong> 服务器时，执行下面的 <code>rsync</code> 命令，加上 <code>--dry-run</code> 参数来模拟 SysVol 复制过程。注意把对应的参数值替换成你自己的数据。</p><pre tabindex=0><code># rsync --dry-run -XAavz --chmod=775 --delete-after  --progress --stats  /var/lib/samba/sysvol/ root@adc2:/var/lib/samba/sysvol/
</code></pre><p>7、如果模拟复制过程正常，那么再次执行去掉 <code>--dry-run</code> 参数的 <code>rsync</code> 命令，来真实的在域控制器之间复制 GPO 对象。</p><pre tabindex=0><code># rsync -XAavz --chmod=775 --delete-after  --progress --stats  /var/lib/samba/sysvol/ root@adc2:/var/lib/samba/sysvol/
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/201704/08/103223jvshyuhxsybdxa8n.png alt="Samba4 AD DC SysVol Replication"></p><p><em>Samba4 AD DC SysVol 复制</em></p><p>8、在 SysVol 复制完成之后，登录到目标域控制器，然后执行下面的命令来列出其中一个 GPO 对象目录的内容。</p><p>从第一个 DC 服务器上执行这个命令时，列出的 GPO 对象也要相同。</p><pre tabindex=0><code># ls -alh /var/lib/samba/sysvol/your_domain/Policiers/
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/201704/08/103224mz6m7c69u8kzu78x.png alt="Verify Samba4 DC SysVol Replication"></p><p><em>验证 Samba4 DC SysVol 复制结果是否正常</em></p><p>9、为了自动完成<strong>组策略</strong>复制的过程（通过网络传输 sysvol 目录），你可以使用 root 账号设置一个任务来执行同步命令，如下所示，设置为每隔 5 分钟执行一次该命令。</p><pre tabindex=0><code># crontab -e 
</code></pre><p>添加一条每隔 5 分钟运行的同步命令，并把执行结果以及错误信息输出到日志文件 <code>/var/log/sysvol-replication.log</code> 。如果执行命令异常，你可以查看该文件来定位问题。</p><pre tabindex=0><code>*/5 * * * * rsync -XAavz --chmod=775 --delete-after  --progress --stats  /var/lib/samba/sysvol/ root@adc2:/var/lib/samba/sysvol/ &gt; /var/log/sysvol-replication.log 2&gt;&amp;1
</code></pre><p>10、如果以后 <strong>SysVol ACL</strong> 权限有问题，你可以通过下面的命令来检测和修复这些异常。</p><pre tabindex=0><code># samba-tool ntacl sysvolcheck
# samba-tool ntacl sysvolreset
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/201704/08/103224e0qzixgqqim3xaik.png alt="Fix SysVol ACL Permissions"></p><p><em>修复 SysVol ACL 权限问题</em></p><p>11、如果第一个 <strong>Samba4 AD DC</strong> 的 <strong>FSMO</strong> 角色，即“PDC 模拟器”不可用，你可以强制 <strong>Microsoft Windows</strong> 系统上的<strong>组策略管理控制台</strong>只连接到第二个域控制器，通过选择更改域控制器选项和手动选择目标机器，如下图所示。</p><p><img src=https://img.linux.net.cn/data/attachment/album/201704/08/103225tb99bfkdcjjrfijk.png alt="Change Samba4 Domain Controller"></p><p><em>更改 Samba4 域控制器</em></p><p><img src=https://img.linux.net.cn/data/attachment/album/201704/08/103225c4wu3uxz0cux11ux.png alt="Select Samba4 Domain Controller"></p><p><em>选择 Samba4 域控制器</em></p><p>当你从<strong>组策略管理控制台</strong>连接到第二个 <strong>DC</strong> 服务器时，你应该避免对<strong>组策略</strong>做任何更改。否则，当第一个 <strong>DC</strong> 服务器恢复正常后， <strong>rsync 命令</strong>将会删除在第二个 DC 服务器上所做的更改。</p><hr><p>作者简介：</p><p>Matei Cezar &ndash; 我是一个电脑迷，开源软件和 Linux 系统爱好者，有超过 4 年的 Linux 桌面、服务器版本系统和 bash 编程经验。</p><hr><p>via: <a href=http://www.tecmint.com/samba4-ad-dc-sysvol-replication/>http://www.tecmint.com/samba4-ad-dc-sysvol-replication/</a></p><p>作者：<a href=http://www.tecmint.com/author/cezarmatei/>Matei Cezar</a> 译者：<a href=https://github.com/rusking>rusking</a> 校对：<a href=https://github.com/jasminepeng>jasminepeng</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/samba/ rel=tag>Samba</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>