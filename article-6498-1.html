<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>使用 openssl 命令行构建 CA 及证书 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="使用 openssl 命令行构建 CA 及证书"><meta property="og:description" content="这是一篇快速指南，使用 OpenSSL 来生成 CA （证书授权中心 （certificate authority））、 中级 CA（intermediate CA）和末端证书（end certificate）。包括 OCSP、CRL 和 CA 颁发者（Issuer）信息、具体颁发和失效日期。 我们将设置我们自己的根 CA（root CA），然后使用根 CA 生成一个示例的中级 CA，并使用中级 CA 签发最终用户证书。  根 CA 为根 CA 创建一个目录，并进入： mkdir -p ~/SSLCA/root/ cd ~/SSLCA/root/  生成根 CA 的 8192 位长的 RSA 密钥： openssl genrsa -out rootca.key 8192  输出类似如下： Generating RSA pri"><meta property="og:type" content="article"><meta property="og:url" content="/article-6498-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-10-30T17:51:55+00:00"><meta property="article:modified_time" content="2015-10-30T17:51:55+00:00"><meta itemprop=name content="使用 openssl 命令行构建 CA 及证书"><meta itemprop=description content="这是一篇快速指南，使用 OpenSSL 来生成 CA （证书授权中心 （certificate authority））、 中级 CA（intermediate CA）和末端证书（end certificate）。包括 OCSP、CRL 和 CA 颁发者（Issuer）信息、具体颁发和失效日期。 我们将设置我们自己的根 CA（root CA），然后使用根 CA 生成一个示例的中级 CA，并使用中级 CA 签发最终用户证书。  根 CA 为根 CA 创建一个目录，并进入： mkdir -p ~/SSLCA/root/ cd ~/SSLCA/root/  生成根 CA 的 8192 位长的 RSA 密钥： openssl genrsa -out rootca.key 8192  输出类似如下： Generating RSA pri"><meta itemprop=datePublished content="2015-10-30T17:51:55+00:00"><meta itemprop=dateModified content="2015-10-30T17:51:55+00:00"><meta itemprop=wordCount content="1322"><meta itemprop=keywords content="SSL,CA,证书,openssl,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>使用 openssl 命令行构建 CA 及证书</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2015-10-30T17:51:55Z>October 30, 2015</time></div></div></header><div class="content post__content clearfix"><p>这是一篇快速指南，使用 OpenSSL 来生成 CA （ 证书授权中心 （ certificate authority ） ）、 中级 CA （ intermediate CA ） 和 末端证书 （ end certificate ） 。包括 OCSP、CRL 和 CA 颁发者 （ Issuer ） 信息、具体颁发和失效日期。</p><p>我们将设置我们自己的 根 CA （ root CA ） ，然后使用根 CA 生成一个示例的中级 CA，并使用中级 CA 签发最终用户证书。</p><p><img src=/data/attachment/album/201510/30/175138m6djbdllr5y7v6r6.jpg alt></p><h3 id=根-ca>根 CA</h3><p>为根 CA 创建一个目录，并进入：</p><pre tabindex=0><code>mkdir -p ~/SSLCA/root/
cd ~/SSLCA/root/
</code></pre><p>生成根 CA 的 8192 位长的 RSA 密钥：</p><pre tabindex=0><code>openssl genrsa -out rootca.key 8192
</code></pre><p>输出类似如下：</p><pre tabindex=0><code>Generating RSA private key, 8192 bit long modulus
.........++
....................................................................................................................++
e is 65537 (0x10001)
</code></pre><p>如果你要用密码保护这个密钥，在命令行添加选项 <code>-aes256</code>。</p><p>创建 SHA-256 自签名的根 CA 证书 <code>ca.crt</code>；你需要为你的根 CA 提供识别信息：</p><pre tabindex=0><code>openssl req -sha256 -new -x509 -days 1826 -key rootca.key -out rootca.crt
</code></pre><p>输出类似如下：</p><pre tabindex=0><code>You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [AU]:CN
State or Province Name (full name) [Some-State]:Beijing
Locality Name (eg, city) []:Chaoyang dist.
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Linux.CN
Organizational Unit Name (eg, section) []:Linux.CN CA
Common Name (e.g. server FQDN or YOUR name) []:Linux.CN Root CA
Email Address []:ca@linux.cn
</code></pre><p>创建几个文件， 用于该 CA 存储其序列号：</p><pre tabindex=0><code>touch certindex
echo 1000 &gt; certserial
echo 1000 &gt; crlnumber
</code></pre><p>创建 CA 的配置文件，该文件包含 CRL 和 OCSP 终端的存根。</p><pre tabindex=0><code># vim ca.conf
[ ca ]
default_ca = myca

[ crl_ext ]
issuerAltName=issuer:copy 
authorityKeyIdentifier=keyid:always

[ myca ]
dir = ./
new_certs_dir = $dir
unique_subject = no
certificate = $dir/rootca.crt
database = $dir/certindex
private_key = $dir/rootca.key
serial = $dir/certserial
default_days = 730
default_md = sha1
policy = myca_policy
x509_extensions = myca_extensions
crlnumber = $dir/crlnumber
default_crl_days = 730

[ myca_policy ]
commonName = supplied
stateOrProvinceName = supplied
countryName = optional
emailAddress = optional
organizationName = supplied
organizationalUnitName = optional

[ myca_extensions ]
basicConstraints = critical,CA:TRUE
keyUsage = critical,any
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer
keyUsage = digitalSignature,keyEncipherment,cRLSign,keyCertSign
extendedKeyUsage = serverAuth
crlDistributionPoints = @crl_section
subjectAltName  = @alt_names
authorityInfoAccess = @ocsp_section

[ v3_ca ]
basicConstraints = critical,CA:TRUE,pathlen:0
keyUsage = critical,any
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer
keyUsage = digitalSignature,keyEncipherment,cRLSign,keyCertSign
extendedKeyUsage = serverAuth
crlDistributionPoints = @crl_section
subjectAltName  = @alt_names
authorityInfoAccess = @ocsp_section

[ alt_names ]
DNS.0 = Linux.CN Root CA
DNS.1 = Linux.CN CA Root
  
[crl_section]
URI.0 = http://pki.linux.cn/rootca.crl
URI.1 = http://pki2.linux.cn/rootca.crl

[ ocsp_section ]
caIssuers;URI.0 = http://pki.linux.cn/rootca.crt
caIssuers;URI.1 = http://pki2.linux.cn/rootca.crt
OCSP;URI.0 = http://pki.linux.cn/ocsp/
OCSP;URI.1 = http://pki2.linux.cn/ocsp/
</code></pre><p>如果你要设置一个特定的证书起止时间，添加下述内容到 <code>[myca]</code>。</p><pre tabindex=0><code># format: YYYYMMDDHHMMSS
default_enddate = 20191222035911
default_startdate = 20181222035911
</code></pre><h3 id=创建1号中级-ca>创建1号中级 CA</h3><p>生成中级 CA 的私钥</p><pre tabindex=0><code>openssl genrsa -out intermediate1.key 4096
</code></pre><p>生成其 CSR：</p><pre tabindex=0><code>openssl req -new -sha256 -key intermediate1.key -out intermediate1.csr
</code></pre><p>输出类似如下：</p><pre tabindex=0><code>You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [AU]:CN
State or Province Name (full name) [Some-State]:Beijing
Locality Name (eg, city) []:Chaoyang dist.
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Linux.CN
Organizational Unit Name (eg, section) []:Linux.CN CA
Common Name (e.g. server FQDN or YOUR name) []:Linux.CN Intermediate CA
Email Address []:

Please enter the following &#39;extra&#39; attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
</code></pre><p>请确保中级 CA 的主题名（CN，Common Name）和根 CA 的不同。</p><p>使用根 CA 为你创建的中级 CA 的 CSR 签名：</p><pre tabindex=0><code>openssl ca -batch -config ca.conf -notext -in intermediate1.csr -out intermediate1.crt
</code></pre><p>输出类似如下：</p><pre tabindex=0><code>Using configuration from ca.conf
Check that the request matches the signature
Signature ok
The Subject&#39;s Distinguished Name is as follows
countryName           :PRINTABLE:&#39;CN&#39;
stateOrProvinceName   :ASN.1 12:&#39;Beijing&#39;
localityName          :ASN.1 12:&#39;chaoyang dist.&#39;
organizationName      :ASN.1 12:&#39;Linux.CN&#39;
organizationalUnitName:ASN.1 12:&#39;Linux.CN CA&#39;
commonName            :ASN.1 12:&#39;Linux.CN Intermediate CA&#39;
Certificate is to be certified until Mar 30 15:07:43 2017 GMT (730 days)

Write out database with 1 new entries
Data Base Updated
</code></pre><p>生成 CRL （包括 PEM 和 DER 两种格式）：</p><pre tabindex=0><code>openssl ca -config ca.conf -gencrl -keyfile rootca.key -cert rootca.crt -out rootca.crl.pem

openssl crl -inform PEM -in rootca.crl.pem -outform DER -out rootca.crl
</code></pre><p>每次使用该 CA 签名证书后都需要生成 CRL。</p><p>如果需要的话，你可以 撤销 （ revoke ） 这个中级证书：</p><pre tabindex=0><code>openssl ca -config ca.conf -revoke intermediate1.crt -keyfile rootca.key -cert rootca.crt
</code></pre><h3 id=配置1号中级-ca>配置1号中级 CA</h3><p>给该中级 CA 创建新目录，并进入：</p><pre tabindex=0><code>mkdir ~/SSLCA/intermediate1/
cd ~/SSLCA/intermediate1/
</code></pre><p>从根 CA 那边复制这个中级 CA 的证书和私钥：</p><pre tabindex=0><code>cp ../root/intermediate1.key ./
cp ../root/intermediate1.crt ./
</code></pre><p>创建索引文件：</p><pre tabindex=0><code>touch certindex
echo 1000 &gt; certserial
echo 1000 &gt; crlnumber
</code></pre><p>创建一个新的 <code>ca.conf</code> ：</p><pre tabindex=0><code># vim ca.conf

[ ca ]
default_ca = myca

[ crl_ext ]
issuerAltName=issuer:copy 
authorityKeyIdentifier=keyid:always

[ myca ]
dir = ./
new_certs_dir = $dir
unique_subject = no
certificate = $dir/intermediate1.crt
database = $dir/certindex
private_key = $dir/intermediate1.key
serial = $dir/certserial
default_days = 365
default_md = sha1
policy = myca_policy
x509_extensions = myca_extensions
crlnumber = $dir/crlnumber
default_crl_days = 365

[ myca_policy ]
commonName = supplied
stateOrProvinceName = supplied
countryName = optional
emailAddress = optional
organizationName = supplied
organizationalUnitName = optional

[ myca_extensions ]
basicConstraints = critical,CA:FALSE
keyUsage = critical,any
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer
keyUsage = digitalSignature,keyEncipherment
extendedKeyUsage = serverAuth
crlDistributionPoints = @crl_section
subjectAltName  = @alt_names
authorityInfoAccess = @ocsp_section

[ alt_names ]
DNS.0 = Linux.CN Intermidiate CA 1
DNS.1 = Linux.CN CA Intermidiate 1

[ crl_section ]
URI.0 = http://pki.linux.cn/intermediate1.crl
URI.1 = http://pki2.linux.cn/intermediate1.crl

[ ocsp_section ]
caIssuers;URI.0 = http://pki.linux.cn/intermediate1.crt
caIssuers;URI.1 = http://pki2.linux.cn/intermediate1.crt
OCSP;URI.0 = http://pki.linux.cn/ocsp/
OCSP;URI.1 = http://pki2.linux.cn/ocsp/
</code></pre><p>修改 <code>[alt_names]</code> 小节为你所需的 替代主题名 （ Subject Alternative names ） 。如果不需要就删除引入它的 <code>subjectAltName = @alt_names</code> 行。</p><p>如果你需要指定起止时间，添加如下行到 <code>[myca]</code> 中。</p><pre tabindex=0><code># format: YYYYMMDDHHMMSS
default_enddate = 20191222035911
default_startdate = 20181222035911
</code></pre><p>生成一个空的 CRL （包括 PEM 和 DER 两种格式）：</p><pre tabindex=0><code>openssl ca -config ca.conf -gencrl -keyfile intermediate1.key -cert intermediate1.crt -out intermediate1.crl.pem

openssl crl -inform PEM -in intermediate1.crl.pem -outform DER -out intermediate1.crl
</code></pre><h3 id=创建最终用户证书>创建最终用户证书</h3><p>我们使用新的中级 CA 来生成最终用户的证书。为每个你需要用此 CA 签名的最终用户证书重复这些步骤。</p><pre tabindex=0><code>mkdir ~/enduser-certs
cd ~/enduser-certs
</code></pre><p>生成最终用户的私钥：</p><pre tabindex=0><code>openssl genrsa -out enduser-example.com.key 4096
</code></pre><p>生成最终用户的 CSR：</p><pre tabindex=0><code>openssl req -new -sha256 -key enduser-example.com.key -out enduser-example.com.csr
</code></pre><p>输出类似如下：</p><pre tabindex=0><code>You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [AU]:CN
State or Province Name (full name) [Some-State]:Shanghai
Locality Name (eg, city) []:Xuhui dist.
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Example Inc
Organizational Unit Name (eg, section) []:IT Dept
Common Name (e.g. server FQDN or YOUR name) []:example.com
Email Address []:

Please enter the following &#39;extra&#39; attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
</code></pre><p>用1号中级 CA 签名最终用户的证书：</p><pre tabindex=0><code>cd ~/SSLCA/intermediate1
openssl ca -batch -config ca.conf -notext -in ~/enduser-certs/enduser-example.com.csr -out ~/enduser-certs/enduser-example.com.crt
</code></pre><p>输出类似如下：</p><pre tabindex=0><code>Using configuration from ca.conf
Check that the request matches the signature
Signature ok
The Subject&#39;s Distinguished Name is as follows
countryName           :PRINTABLE:&#39;CN&#39;
stateOrProvinceName   :ASN.1 12:&#39;Shanghai&#39;
localityName          :ASN.1 12:&#39;Xuhui dist.&#39;
organizationName      :ASN.1 12:&#39;Example Inc&#39;
organizationalUnitName:ASN.1 12:&#39;IT Dept&#39;
commonName            :ASN.1 12:&#39;example.com&#39;
Certificate is to be certified until Mar 30 15:18:26 2016 GMT (365 days)

Write out database with 1 new entries
Data Base Updated
</code></pre><p>生成 CRL （包括 PEM 和 DER 两种格式）：</p><pre tabindex=0><code>cd ~/SSLCA/intermediate1/
openssl ca -config ca.conf -gencrl -keyfile intermediate1.key -cert intermediate1.crt -out intermediate1.crl.pem

openssl crl -inform PEM -in intermediate1.crl.pem -outform DER -out intermediate1.crl
</code></pre><p>每次使用该 CA 签名证书后都需要生成 CRL。</p><p>如果需要的话，你可以撤销revoke这个最终用户证书：</p><pre tabindex=0><code>cd ~/SSLCA/intermediate1/  
openssl ca -config ca.conf -revoke ~/enduser-certs/enduser-example.com.crt -keyfile intermediate1.key -cert intermediate1.crt
</code></pre><p>输出类似如下：</p><pre tabindex=0><code>Using configuration from ca.conf
Revoking Certificate 1000.
Data Base Updated
</code></pre><p>将根证书和中级证书连接起来创建证书链文件：</p><pre tabindex=0><code>cat ../root/rootca.crt intermediate1.crt &gt; ~/enduser-certs/enduser-example.com.chain
</code></pre><p>将这些文件发送给最终用户：</p><pre tabindex=0><code>enduser-example.com.crt
enduser-example.com.key
enduser-example.com.chain
</code></pre><p>你也可以让最终用户提供他们中级的 CSR 文件，而只发回给他们 这个 <code>.crt</code> 文件。不要从服务器上删除它们，否则就不能撤销了。</p><h3 id=校验证书>校验证书</h3><p>你可以通过如下命令使用证书链来验证最终用户证书：</p><pre tabindex=0><code>cd ~/enduser-certs
openssl verify -CAfile enduser-example.com.chain enduser-example.com.crt 
enduser-example.com.crt: OK
</code></pre><p>你也可以用 CRL 来校验它。首先将 PEM CRL 连接到证书链文件：</p><pre tabindex=0><code>cd ~/SSLCA/intermediate1
cat ../root/rootca.crt intermediate1.crt intermediate1.crl.pem &gt; ~/enduser-certs/enduser-example.com.crl.chain
</code></pre><p>校验证书：</p><pre tabindex=0><code>cd ~/enduser-certs
openssl verify -crl_check -CAfile enduser-example.com.crl.chain enduser-example.com.crt
</code></pre><p>如果该证书未撤销，输出如下：</p><pre tabindex=0><code>enduser-example.com.crt: OK
</code></pre><p>如果撤销了，输出如下：</p><pre tabindex=0><code>enduser-example.com.crt: CN = example.com, ST = Beijing, C = CN, O = Example Inc, OU = IT Dept
error 23 at 0 depth lookup:certificate revoked
</code></pre></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/ssl/ rel=tag>SSL</a></li><li class=tags__item><a class="tags__link btn" href=/tags/ca/ rel=tag>CA</a></li><li class=tags__item><a class="tags__link btn" href=/tags/%E8%AF%81%E4%B9%A6/ rel=tag>证书</a></li><li class=tags__item><a class="tags__link btn" href=/tags/openssl/ rel=tag>openssl</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>