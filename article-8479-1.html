<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Samba 系列（八）：使用 Samba 和 Winbind 将 Ubuntu 16.04 添加到 AD 域 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="Samba 系列（八）：使用 Samba 和 Winbind 将 Ubuntu 16.04 添加到 AD 域"><meta property="og:description" content="这篇文章讲述了如何将 Ubuntu 主机加入到 Samba4 AD 域，并实现使用域帐号登录 Ubuntu 系统。"><meta property="og:type" content="article"><meta property="og:url" content="/article-8479-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-05-05T09:21:32+00:00"><meta property="article:modified_time" content="2017-05-05T09:21:32+00:00"><meta itemprop=name content="Samba 系列（八）：使用 Samba 和 Winbind 将 Ubuntu 16.04 添加到 AD 域"><meta itemprop=description content="这篇文章讲述了如何将 Ubuntu 主机加入到 Samba4 AD 域，并实现使用域帐号登录 Ubuntu 系统。"><meta itemprop=datePublished content="2017-05-05T09:21:32+00:00"><meta itemprop=dateModified content="2017-05-05T09:21:32+00:00"><meta itemprop=wordCount content="595"><meta itemprop=keywords content="samba,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Samba 系列（八）：使用 Samba 和 Winbind 将 Ubuntu 16.04 添加到 AD 域</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2017-05-05T09:21:32Z>May 05, 2017</time></div></div></header><div class="content post__content clearfix"><p><img src=/data/attachment/album/201705/05/091853rijznj1nk0l3ikc3.jpg alt></p><p>这篇文章讲述了如何将 Ubuntu 主机加入到 Samba4 AD 域，并实现使用域帐号登录 Ubuntu 系统。</p><h3 id=要求>要求：</h3><ol><li><a href=http://www.tecmint.com/install-samba4-active-directory-ubuntu/>在 Ubuntu 系统上使用 Samba4 软件来创建活动目录架构</a></li></ol><h3 id=第一步-ubuntu-系统加入到-samba4-ad-之前的基本配置>第一步： Ubuntu 系统加入到 Samba4 AD 之前的基本配置</h3><p>1、在将 Ubuntu 主机加入到 AD DC 之前，你得先确保 Ubuntu 系统中的一些服务配置正常。</p><p>主机名是你的机器的一个重要标识。因此，在加入域前，使用 <code>hostnamectl</code> 命令或者通过手动编辑 <code>/etc/hostname</code> 文件来为 Ubuntu 主机设置一个合适的主机名。</p><pre tabindex=0><code># hostnamectl set-hostname your_machine_short_name
# cat /etc/hostname
# hostnamectl
</code></pre><p><img src=/data/attachment/album/201705/05/092133cscb0ucshv0vb5sz.png alt="Set System Hostname"></p><p><em>设置系统主机名</em></p><p>2、在这一步中，打开并编辑网卡配置文件，为你的主机设置一个合适的 IP 地址。注意把 DNS 地址设置为你的域控制器的地址。</p><p>编辑 <code>/etc/network/interfaces</code> 文件，添加 <code>dns-nameservers</code> 参数，并设置为 AD 服务器的 IP 地址；添加 <code>dns-search</code> 参数，其值为域控制器的主机名，如下图所示。</p><p>并且，把上面设置的 DNS IP 地址和域名添加到 <code>/etc/resolv.conf</code> 配置文件中，如下图所示：</p><p><img src=/data/attachment/album/201705/05/092134r00vsi5vrv15919l.png alt="Configure Network Settings for AD"></p><p><em>为 AD 配置网络设置</em></p><p>在上面的截图中， <code>192.168.1.254</code> 和 <code>192.168.1.253</code> 是 Samba4 AD DC 服务器的 IP 地址， <code>Tecmint.lan</code> 是 AD 域名，已加入到这个域中的所有机器都可以查询到该域名。</p><p>3、重启网卡服务或者重启计算机以使网卡配置生效。使用 ping 命令加上域名来检测 DNS 解析是否正常。</p><p>AD DC 应该返回的是 FQDN 。如果你的网络中配置了 DHCP 服务器来为局域网中的计算机自动分配 IP 地址，请确保你已经把 AD DC 服务器的 IP 地址添加到 DHCP 服务器的 DNS 配置中。</p><pre tabindex=0><code># systemctl restart networking.service
# ping -c2 your_domain_name
</code></pre><p>4、最后一步是配置服务器时间同步。安装 <code>ntpdate</code> 包，使用下面的命令来查询并同步 AD DC 服务器的时间。</p><pre tabindex=0><code>$ sudo apt-get install ntpdate
$ sudo ntpdate -q your_domain_name
$ sudo ntpdate your_domain_name
</code></pre><p><img src=/data/attachment/album/201705/05/092134qttwc55c6v9grtrc.png alt="Time Synchronization with AD"></p><p><em>AD 服务器时间同步</em></p><p>5、下一步，在 Ubuntu 机器上执行下面的命令来安装加入域环境所必需软件。</p><pre tabindex=0><code>$ sudo apt-get install samba krb5-config krb5-user winbind libpam-winbind libnss-winbind
</code></pre><p><img src=/data/attachment/album/201705/05/092134rctoya6hjp2yy66e.png alt="Install Samba4 in Ubuntu Client"></p><p><em>在 Ubuntu 机器上安装 Samba4 软件</em></p><p>在 Kerberos 软件包安装的过程中，你会被询问输入默认的域名。输入大写的域名，并按 Enter 键继续安装。</p><p><img src=/data/attachment/album/201705/05/092135jq23h11x0f41e9e0.png alt="Add AD Domain Name"></p><p><em>添加 AD 域名</em></p><p>6、当所有的软件包安装完成之后，使用域管理员帐号来测试 Kerberos 认证，然后执行下面的命令来列出票据信息。</p><pre tabindex=0><code># kinit ad_admin_user
# klist
</code></pre><p><img src=/data/attachment/album/201705/05/092135j9umh4hmh73tpuz1.png alt="Check Kerberos Authentication with AD"></p><p><em>使用 AD 来检查 Kerberos 认证是否正常</em></p><h3 id=第二步将-ubuntu-主机添加到-samba4-ad-dc>第二步：将 Ubuntu 主机添加到 Samba4 AD DC</h3><p>7、将 Ubuntu 主机添加到 Samba4 活动目录域环境中的第一步是编辑 Samba 配置文件。</p><p>备份 Samba 的默认配置文件，这个配置文件是安装 Samba 软件的过程中自动生成的，使用下面的命令来重新初始化配置文件。</p><pre tabindex=0><code># mv /etc/samba/smb.conf /etc/samba/smb.conf.initial
# nano /etc/samba/smb.conf&amp;nbsp;
</code></pre><p>在新的 Samba 配置文件中添加以下内容：</p><pre tabindex=0><code>[global]
workgroup = TECMINT
realm = TECMINT.LAN
netbios name = ubuntu
security = ADS
dns forwarder = 192.168.1.1
idmap config * : backend = tdb
idmap config *:range = 50000-1000000
template homedir = /home/%D/%U
template shell = /bin/bash
winbind use default domain = true
winbind offline logon = false
winbind nss info = rfc2307
winbind enum users = yes
winbind enum groups = yes
vfs objects = acl_xattr
map acl inherit = Yes
store dos attributes = Yes
</code></pre><p><img src=/data/attachment/album/201705/05/092136f5j7x3sosev5x7q8.png alt="Configure Samba for AD"></p><p><em>Samba 服务的 AD 环境配置</em></p><p>根据你本地的实际情况来替换 <code>workgroup</code> ， <code>realm</code> ， <code>netbios name</code> 和 <code>dns forwarder</code> 的参数值。</p><p>由于 <code>winbind use default domain</code> 这个参数会让 winbind 服务把任何登录系统的帐号都当作 AD 帐号。因此，如果存在本地帐号名跟域帐号同名的情况下，请不要设置该参数。</p><p>8、现在，你应该重启 Samba 后台服务，停止并卸载一些不必要的服务，然后启用 samba 服务的 system-wide 功能，使用下面的命令来完成。</p><pre tabindex=0><code>$ sudo systemctl restart smbd nmbd winbind
$ sudo systemctl stop samba-ad-dc
$ sudo systemctl enable smbd nmbd winbind
</code></pre><p>9、通过下面的命令，使用域管理员帐号来把 Ubuntu 主机加入到 Samba4 AD DC 中。</p><pre tabindex=0><code>$ sudo net ads join -U ad_admin_user
</code></pre><p><img src=/data/attachment/album/201705/05/092136mhunab4jz5fvzeke.png alt="Join Ubuntu to Samba4 AD DC"></p><p><em>把 Ubuntu 主机加入到 Samba4 AD DC</em></p><p>10、在 <a href=http://www.tecmint.com/manage-samba4-ad-from-windows-via-rsat/>安装了 RSAT 工具的 Windows 机器上</a> 打开 AD UC ,展开到包含的计算机。你可以看到已加入域的 Ubuntu 计算机。</p><p><img src=/data/attachment/album/201705/05/092136r8tlolof4rlrno2z.png alt="Confirm Ubuntu Client in Windows AD DC"></p><p><em>确认 Ubuntu 计算机已加入到 Windows AD DC</em></p><h3 id=第三步配置-ad-帐号认证>第三步：配置 AD 帐号认证</h3><p>11、为了在本地完成 AD 帐号认证，你需要修改本地机器上的一些服务和配置文件。</p><p>首先，打开并编辑名字服务切换 (NSS) 配置文件。</p><pre tabindex=0><code>$ sudo nano /etc/nsswitch.conf
</code></pre><p>然后在 <code>passwd</code> 和 <code>group</code> 行添加 winbind 值，如下图所示：</p><pre tabindex=0><code>passwd:         compat winbind
group:          compat winbind
</code></pre><p><img src=/data/attachment/album/201705/05/092137xo792w1f8719qqk7.png alt="Configure AD Accounts Authentication"></p><p><em>配置 AD 帐号认证</em></p><p>12、为了测试 Ubuntu 机器是否已加入到域中，你可以使用 <code>wbinfo</code> 命令来列出域帐号和组。</p><pre tabindex=0><code>$ wbinfo -u
$ wbinfo -g
</code></pre><p><img src=/data/attachment/album/201705/05/092137c38xfozuoo4qoibo.png alt="List AD Domain Accounts and Groups"></p><p><em>列出域帐号和组</em></p><p>13、同时，使用 <code>getent</code> 命令加上管道符及 <code>grep</code> 参数来过滤指定域用户或组，以测试 Winbind nsswitch 模块是否运行正常。</p><pre tabindex=0><code>$ sudo getent passwd| grep your_domain_user
$ sudo getent group|grep &#39;domain admins&#39;
</code></pre><p><img src=/data/attachment/album/201705/05/092138n0fmqjp9p9p7u7jz.png alt="Check AD Domain Users and Groups"></p><p><em>检查 AD 域用户和组</em></p><p>14、为了让域帐号在 Ubuntu 机器上完成认证登录，你需要使用 root 帐号运行 <code>pam-auth-update</code> 命令，然后勾选 winbind 服务所需的选项，以让每个域帐号首次登录时自动创建 home 目录。</p><p>查看所有的选项，按 ‘[空格]’键选中，单击 OK 以应用更改。</p><pre tabindex=0><code>$ sudo pam-auth-update
</code></pre><p><img src=/data/attachment/album/201705/05/092138n0m0hsmmrom3rhg1.png alt="Authenticate Ubuntu with Domain Accounts"></p><p><em>使用域帐号登录 Ubuntu 主机</em></p><p>15、在 Debian 系统中，如果想让系统自动为登录的域帐号创建家目录，你需要手动编辑 <code>/etc/pam.d/common-account</code> 配置文件，并添加下面的内容。</p><pre tabindex=0><code>session    required    pam_mkhomedir.so    skel=/etc/skel/    umask=0022
</code></pre><p><img src=/data/attachment/album/201705/05/092139g3l1u50wg5t58k5n.png alt="Authenticate Debian with Domain Accounts"></p><p><em>使用域帐号登录 Debian 系统</em></p><p>16、为了让 AD 用户能够在 Linux 的命令行下修改密码，你需要打开 /etc/pam.d/common-password 配置文件，在 <code>password</code> 那一行删除 <code>use_authtok</code> 参数，如下图所示：</p><pre tabindex=0><code>password       [success=1 default=ignore]      pam_winbind.so try_first_pass
</code></pre><p><img src=/data/attachment/album/201705/05/092139xdwwu1whh7hw24ds.png alt="Users Allowed to Change Password"></p><p><em>允许域帐号在 Linux 命令行下修改密码</em></p><p>17、要使用 Samba4 AD 帐号来登录 Ubuntu 主机，在 <code>su -</code> 后面加上域用户名即可。你还可以通过运行 <code>id</code> 命令来查看 AD 帐号的其它信息。</p><pre tabindex=0><code>$ su - your_ad_user
</code></pre><p><img src=/data/attachment/album/201705/05/092139yt6z05q2cx5lle6u.png alt="Find AD User Information"></p><p><em>查看 AD 用户信息</em></p><p>使用 <a href=http://www.tecmint.com/pwd-command-examples/>pwd 命令</a>来查看域帐号的当前目录，如果你想修改域帐号的密码，你可以使用 <code>passwd</code> 命令来完成。</p><p>18、如果想让域帐号在 ubuntu 机器上拥有 root 权限，你可以使用下面的命令来把 AD 帐号添加到 sudo 系统组中：</p><pre tabindex=0><code>$ sudo usermod -aG sudo your_domain_user
</code></pre><p>登录域帐号登录到 Ubuntu 主机，然后运行 <code>apt-get-update</code> 命令来更新系统，以验证域账号是否拥有 root 权限。</p><p><img src=/data/attachment/album/201705/05/092140ftez2qacg9kwqvaw.png alt="Add Sudo User Root Group"></p><p><em>给域帐号添加 root 权限</em></p><p>19、要为整个域用户组添加 root 权限，使用 <code>vi</code> 命令打开并编辑 <code>/etc/sudoers</code> 配置文件，如下图所示，添加如下内容：</p><pre tabindex=0><code>%YOUR_DOMAIN\\your_domain\  group                ALL=(ALL:ALL) ALL
</code></pre><p><img src=/data/attachment/album/201705/05/092141ipzssy8lyyy8vovo.jpg alt="Add Root Privileges to Domain Group"></p><p><em>为域帐号组添加 root 权限</em></p><p>使用反斜杠来转义域用户组的名称中包含的空格，或者用来转义第一个反斜杠。在上面的例子中， TECMINT 域的域用户组的名字是 “domain admins" 。</p><p>前边的 <code>%</code> 表明我们指定是的用户组而不是用户名。</p><p>20、如果你使用的是图形界面的 Ubuntu 系统，并且你想使用域帐号来登录系统，你需要修改 LightDM 显示管理器，编辑 <code>/usr/share/lightdm/lightdm.conf.d/50-ubuntu.conf</code> 配置文件，添加下面的内容，然后重启系统才能生效。</p><pre tabindex=0><code>greeter-show-manual-login=true
greeter-hide-users=true
</code></pre><p>现在你就可以域帐号来登录 Ubuntu 桌面系统了。使用域用户名或者域用户名@域名.tld 或者域名\域用户名的方式来登录系统。</p><hr><p>作者简介：</p><p>我是一个电脑迷，开源 Linux 系统和软件爱好者，有 4 年多的 Linux 桌面、服务器系统使用和 Base 编程经验。</p><hr><p>via: <a href=http://www.tecmint.com/join-ubuntu-to-active-directory-domain-member-samba-winbind/>http://www.tecmint.com/join-ubuntu-to-active-directory-domain-member-samba-winbind/</a></p><p>作者：<a href=http://www.tecmint.com/author/cezarmatei/>Matei Cezar</a> 译者：<a href=https://github.com/rusking>rusking</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/samba/ rel=tag>samba</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>