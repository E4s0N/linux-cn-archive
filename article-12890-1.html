<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Rails 之旅第 2 天：Rails 关联和拖动 div - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="Rails 之旅第 2 天：Rails 关联和拖动 div"><meta property="og:description" content="大家好！今天是我搭建这个玩具项目的第 2 天。下面再来记录一下关于 Rails 的一些有趣的事情吧！"><meta property="og:type" content="article"><meta property="og:url" content="/article-12890-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-12-05T21:24:53+00:00"><meta property="article:modified_time" content="2020-12-05T21:24:53+00:00"><meta itemprop=name content="Rails 之旅第 2 天：Rails 关联和拖动 div"><meta itemprop=description content="大家好！今天是我搭建这个玩具项目的第 2 天。下面再来记录一下关于 Rails 的一些有趣的事情吧！"><meta itemprop=datePublished content="2020-12-05T21:24:53+00:00"><meta itemprop=dateModified content="2020-12-05T21:24:53+00:00"><meta itemprop=wordCount content="177"><meta itemprop=keywords content="Rails,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Rails 之旅第 2 天：Rails 关联和拖动 div</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2020-12-05T21:24:53Z>December 05, 2020</time></div></div></header><div class="content post__content clearfix"><p><img src=/data/attachment/album/202012/05/212345zz8jajhaj0hh8h2f.jpg alt></p><p>大家好！今天是我搭建这个玩具项目的第 2 天。下面再来记录一下关于 Rails 的一些有趣的事情吧！</p><h3 id=目标做一个冰箱诗歌论坛>目标：做一个冰箱诗歌论坛</h3><p>我想做一种无聊的标准网站来学习 Rails，并且其他人可以与之互动，就像一个论坛一样! 但如果人们真的可以在网站上打字，那就会产生各种各样的问题（如果他们是垃圾邮件发送者怎么办？又或者只是言语刻薄？）。</p><p>我想到的第一个想法是，可以让人们与网站互动，但实际上却不能在网站上打字，那就是一个“冰箱诗歌论坛”，只给你一组固定的字，你就可以随意组合。</p><p>所以，这就是我们的计划！</p><p>我这个项目的目标是想知道我是否能用 Rails 来做其他的小型网络项目（而不是像我通常做的那样，使用一些更基本的东西，比如 Flask，或者放弃后端，用 Javascript 来写所有东西）。</p><h3 id=怎么把字拖来拖去呢jquery-的可拖放-ui>怎么把字拖来拖去呢？jQuery 的可拖放 UI！</h3><p>我想让大家能够把文字拖动起来，但我又不想写很多 Javascript。结果发现这超级简单 —— 有一个 jQuery 库可以做到，它叫做 <code>draggable</code>！一开始，拖动并不成功。</p><p>一开始拖动在手机上是不行的，但是有一个技巧可以让 jQuery UI 在手机上工作，叫做 <a href=https://github.com/furf/jquery-ui-touch-punch>jQuery UI touch punch</a>。下面是它的样子（有兴趣看工作原理的可以查看源码，代码很少）。</p><blockquote><p><code>banana</code> <code>forest</code> <code>cake</code> <code>is</code></p></blockquote><h3 id=一个有趣的-rails-功能关联>一个有趣的 Rails 功能：关联</h3><p>我以前从来没有使用过关系型 ORM，对于 Rails，我很兴奋的一件事就是想看看使用 Active Record 是什么样子的！今天我了解了 Rails 的 ORM 功能之一：<a href=https://guides.rubyonrails.org/association_basics.html>关联</a>。如果你像我一样对 ORM 完全不了解的话，那就来看看是怎么回事吧。</p><p>在我的论坛中，我有：</p><ul><li>用户</li><li>话题（我本来想把它叫做“线索”，但显然这在 Rails 中是一个保留词，所以现在叫做“话题”）。</li><li>帖子</li></ul><p>当显示一个帖子时，我需要显示创建该帖子的用户的用户名。所以我想我可能需要写一些代码来加载帖子，并为每个帖子加载用户，就像这样（在 Rails 中，<code>Post.where</code> 和 <code>User.find</code> 将会运行 SQL 语句，并将结果转化为 Ruby 对象）：</p><pre tabindex=0><code>@posts = Post.where(topic_id: id)
@posts.each do |post|
    user = User.find(post.user_id)
    post.user = user
end
</code></pre><p>这还不够好，它要为每个帖子做一次单独的 SQL 查询！我知道有一个更好的方法，我发现它叫做<a href=https://guides.rubyonrails.org/association_basics.html>关联</a>。这个链接是来自 <a href=https://guides.rubyonrails.org>https://guides.rubyonrails.org</a> 的指南，到目前为止，它对我很有帮助。</p><p>基本上我需要做的就是：</p><ol><li>在 <code>User</code> 模型中添加一行 <code>has_many :post</code>。</li><li>在 <code>Post</code> 模型中添加一行 <code>belongs_to :user</code>。</li><li>Rails 现在知道如何将这两个表连接起来，尽管我没有告诉它要连接到什么列上！我认为这是因为我按照它所期望的惯例命名了 <code>posts</code> 表中的 <code>user_id</code> 列。</li><li>对 <code>User</code> 和 <code>Topic</code> 做完全相同的事情（一个主题也有很多帖子：<code>has_many :posts</code>）。</li></ol><p>然后我加载每一个帖子和它的关联用户的代码就变成了只有一行! 就是这一行：</p><pre tabindex=0><code>@posts = @topic.posts.order(created_at: :asc).preload(:user)
</code></pre><p>比起只有一行更重要的是，它不是单独做一个查询来获取每个帖子的用户，而是在 1 个查询中获取所有用户。显然，在 Rails 中，有一堆<a href=https://blog.bigbinary.com/2013/07/01/preload-vs-eager-load-vs-joins-vs-includes.html>不同的方法</a>来做类似的事情（预加载、急切加载、联接和包含？），我还不知道这些都是什么，但也许我以后会知道的。</p><h3 id=一个有趣的-rails-功能脚手架>一个有趣的 Rails 功能：脚手架！</h3><p>Rails 有一个叫 <code>rails</code> 的命令行工具，它可以生成很多代码。例如，我想添加一个 <code>Topic</code> 模型/控制器。我不用去想在哪里添加所有的代码，可以直接运行</p><pre tabindex=0><code>rails generate scaffold Topic title:text
</code></pre><p>并生成了一堆代码，这样我已经有了基本的端点来创建/编辑/删除主题（<code>Topic</code>）。例如，这是我的<a href=https://github.com/jvns/refrigerator-forum/blob/776b3227cfd7004cb1efb00ec7e3f82a511cbdc4/app/controllers/topics_controller.rb#L13-L15>现在的主题控制器</a>，其中大部分我没有写（我只写了高亮的 3 行）。我可能会删除很多内容，但是有一个起点，让我可以扩展我想要的部分，删除我不想要的部分，感觉还不错。</p><h3 id=数据库迁移>数据库迁移！</h3><p><code>rails</code> 工具还可以生成数据库迁移! 例如，我决定要删除帖子中的 <code>title</code> 字段。</p><p>下面是我要做的：</p><pre tabindex=0><code>rails generate migration RemoveTitleFromPosts title:string
rails db:migrate
</code></pre><p>就是这样 —— 只要运行几个命令行咒语就可以了! 我运行了几个这样的迁移，因为我改变了对我的数据库模式的设想。它是相当直接的，到目前为止 —— 感觉很神奇。</p><p>当我试图在一列中的某些字段为空的地方添加一个“不为空”（<code>not null</code>）约束时，情况就变得有点有趣了 —— 迁移失败。但我可以修复违例的记录，并轻松地重新运行迁移。</p><h3 id=今天就到这里吧>今天就到这里吧！</h3><p>明天，如果我有更多的进展，也许我会把它放在互联网上。</p><hr><p>via: <a href=https://jvns.ca/blog/2020/11/10/day-2--rails-associations---dragging-divs-around/>https://jvns.ca/blog/2020/11/10/day-2--rails-associations---dragging-divs-around/</a></p><p>作者：<a href=https://jvns.ca/>Julia Evans</a> 选题：<a href=https://github.com/lujun9972>lujun9972</a> 译者：<a href=https://github.com/wxy>wxy</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/rails/ rel=tag>Rails</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>