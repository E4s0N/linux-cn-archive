<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>使用 Fedora ARM 服务器来做 3-2-1 备份计划 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="使用 Fedora ARM 服务器来做 3-2-1 备份计划"><meta property="og:description" content="这篇文章针对的用户是想要充分利用实体服务器系统，并使用类似 Cockpit 的内置工具进行数据备份和个人数据的恢复。这里描述了备份的 3 个阶段。"><meta property="og:type" content="article"><meta property="og:url" content="/article-14519-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-28T16:01:04+00:00"><meta property="article:modified_time" content="2022-04-28T16:01:04+00:00"><meta itemprop=name content="使用 Fedora ARM 服务器来做 3-2-1 备份计划"><meta itemprop=description content="这篇文章针对的用户是想要充分利用实体服务器系统，并使用类似 Cockpit 的内置工具进行数据备份和个人数据的恢复。这里描述了备份的 3 个阶段。"><meta itemprop=datePublished content="2022-04-28T16:01:04+00:00"><meta itemprop=dateModified content="2022-04-28T16:01:04+00:00"><meta itemprop=wordCount content="449"><meta itemprop=keywords content="Cockpit,备份,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>使用 Fedora ARM 服务器来做 3-2-1 备份计划</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2022-04-28T16:01:04Z>April 28, 2022</time></div></div></header><div class="content post__content clearfix"><p><img src=/data/attachment/album/202204/28/160106isue6ya6hhlwy7wq.jpg alt></p><p>Fedora 服务器版操作系统可以运行在类似树莓派的单板计算机（SBC）上。这篇文章针对的用户是想要充分利用实体服务器系统，并使用类似 Cockpit 的内置工具进行数据备份和个人数据的恢复。这里描述了备份的 3 个阶段。</p><h3 id=必要的准备>必要的准备</h3><p>想要使用本指南，你所需要的是一个运行着的 Fedora Linux 工作站和以下的项目：</p><ul><li>你应该阅读、理解和实践 Fedora 文档中 <a href=https://docs.fedoraproject.org/en-US/fedora-server/server-installation-sbc/>服务器安装</a> 和 <a href=https://docs.fedoraproject.org/en-US/fedora-server/sysadmin-postinstall/>管理</a> 的要求</li><li>一块用来测试 Fedora Linux 的 SBC（单板计算机）。在这里查看 <a href=https://docs.fedoraproject.org/en-US/quick-docs/raspberry-pi/>硬件需求</a></li><li><a href=https://arm.fedoraproject.org/>Fedora ARM</a> <a href=https://arm.fedoraproject.org/>服务器</a> 原始镜像 & ARM 镜像安装器</li><li>SD 存储卡（64 GB / Class 10）和 SSD 设备两选一</li><li>以太网 / DHCP 预留 IP 地址或者静态 IP 地址</li><li>提供了 ssh 密钥的 Linux 客户端工作站</li><li>选择云存储服务</li><li>有额外可用的 Linux 工作站</li></ul><p>对于这套环境，在写这篇文章的时候，由于成本和可用性的原因，我选择树莓派 3B+/4B+ （其中一个用来热切换）。当使用 Cockpit 远程连接树莓派服务器时，你可以将树莓派放到路由器附近以便设置。</p><h3 id=加强服务器的安全>加强服务器的安全</h3><p>在 SBC 完成服务器的安装和管理后，用 firewalld 加强服务器的安全是一个好的做法。</p><p>连接存储设备到服务器之前，一旦服务器在线你必须设置好防火墙。firewalld 是基于区域的防火墙。在依照 Fedora 文档完成安装和管理指南之后，创建一个名为 <code>FedoraServer</code> 的预定义区域。</p><h4 id=firewalld-里的富规则>firewalld 里的富规则</h4><p>富规则 rich rule 用来阻止或者允许一个特定的 IP 地址或者地址段。下面这条规则只从（客户端工作站）注册的 IP 地址接受 SSH 连接，并断开其它的连接。在 Cockpit 终端或者客户端工作站终端运行命令是通过 ssh 来连接到服务器的。</p><pre tabindex=0><code>firewall-cmd --add-rich-rule=&#39;rule family=ipv4 source address=&lt;registered_ip_address&gt;/24 service name=ssh log prefix=&#34;SSH Logs&#34; level=&#34;notice&#34; accept&#39;
</code></pre><h4 id=拒绝所有主机的-ping-请求>拒绝所有主机的 ping 请求</h4><p>使用这个命令来设置 icmp 拒绝，并且不允许 ping 请求：</p><pre tabindex=0><code>firewall-cmd --add-rich-rule=&#39;rule protocol value=icmp reject&#39;
</code></pre><p>要进行其它防火墙控制，比如管理端口和区域，请查阅以下链接。请注意错配防火墙可能会使安全出现漏洞受到攻击。</p><blockquote><p><strong><a href=https://fedoramagazine.org/managing-network-interfaces-and-firewalld-in-cockpit/>在 Cockpit 中管理防火墙</a></strong></p></blockquote><blockquote><p><strong><a href=https://www.redhat.com/sysadmin/firewalld-rules-and-scenarios>firewalld 规则</a></strong></p></blockquote><h3 id=配置文件服务器的存储>配置文件服务器的存储</h3><p>下一步是连接存储设备到 SBC，然后使用 Cockpit 对新插入的存储设备进行分区。使用 Cockpit 的图形化服务器管理界面，管理一个家庭实验室（可以是一个或者多个服务器）比之前更加简单。Fedora Linux 服务器标准提供了 Cockpit。</p><p>在这个阶段，一个通过 SBC 的 USB 插口接电的 SSD 设备无需额外电源供给就可以工作。</p><ul><li>将存储设备连接到 SBC 的 USB 接口</li><li>运行之后（按上面的“必要的准备”所设置的那样），然后在你的客户端工作站浏览器上访问 <strong>机器的 IP 地址:9090</strong></li><li>登录进 Cockpit 之后，点击 Cockpit 页面顶部的“ 打开管理访问权限 Turn on administrative access ”</li><li>点击左边面板的 “ 存储 Storage ” 按钮</li><li>选择下面显示的 “ 驱动器 Drives ”，然后分区并格式化一个空白的存储设备 <img src=/data/attachment/album/202204/28/160106czrmwcovwpwvqjmm.png alt="Cockpit Storage management"></li><li>在选定的存储设备这个界面上，创建一个新的分区表或者格式化并创建新的分区。当初始化磁盘的时候，在 “ Partitioning 分区 ” 类型选项上，选择 “GPT 分区表”</li><li>选择一个文件系统类型，这里选择 “EXT4” 。这对于一个限制 I/O 能力（比如 USB 2.0 接口）和限制带宽（小于 200MB/s）的设备是适合的 <img src=/data/attachment/album/202204/28/160107veiva32kf357b9a2.png alt="Create a partition in Cockpit"></li><li>要在设备上创建单个占据整个存储空间的分区，指定它的挂载点，比如 <code>/media</code> 然后点击 “ 确定 Ok ” 。</li><li>点击 “ Create partition 创建分区 ”，创建一个挂载点为 <code>/media</code> 的新分区。</li></ul><h3 id=创建备份和恢复备份>创建备份和恢复备份</h3><p>备份很少是一刀切的。这里有一些选择比如数据备份在哪里，备份数据的步骤，验证一些自动化，并确定怎样来恢复备份了的数据。</p><p><img src=/data/attachment/album/202204/28/160107z2bh4guccpe4quzp.jpg alt="Backup workflow – version 1.0"></p><h4 id=备份-1-用-rsync-从客户端远程同步到文件服务器树莓派>备份 1. 用 rsync 从客户端远程同步到文件服务器（树莓派）</h4><p>这个传输用到的命令是：</p><pre tabindex=0><code>rsync -azP ~/source syncuser@host1:/destination
</code></pre><p>参数:</p><ul><li><code>-a</code>/<code>--archive</code>：归档</li><li><code>-z</code>/<code>--compress</code>：压缩</li><li><code>-P</code>/<code>--progress</code>：显示进度</li></ul><p>要使用更多的选项运行 <code>rsync</code>，可以设置以下的选项：</p><ul><li><code>--inplace</code>：直接替换来更新目标文档</li><li><code>--append</code>：追加数据到较短的文档中</li></ul><p>在将文档备份到存储空间之前，源端文档的文件重复消除和压缩是减少备份数据容量最有效的方式。</p><p>每天工作结束，我会手动运行这个。一旦我设置了云备份工作流，自动化脚本是一个优势。</p><p>关于 <code>rsync</code> 的详细信息，请在 <a href=https://fedoramagazine.org/copying-large-files-with-rsync-and-some-misconceptions/>这里</a> 访问 Fedora 杂志的文章。</p><h4 id=备份-2-使用-rysnc-从文件服务器远程同步到主要的云存储上>备份 2. 使用 rysnc 从文件服务器远程同步到主要的云存储上</h4><p>选择云存储是考虑的因素；</p><ul><li>成本：上传、存储空间和下载费用</li><li>支持 <code>rsync</code>、<code>sftp</code></li><li>数据冗余（RAID 10 或者运行中的数据中心冗余计划）</li><li>快照</li></ul><p>符合这些云存储标准之一的就是 Hetzner 托管的 Nextcloud– <a href=https://docs.hetzner.com/robot/storage-box/>存储盒子</a>。你不会受到供应商限制，可以自由切换而没有退出惩罚。</p><h5 id=在文件服务器上生成-ssh-密钥并创建授权密钥文件>在文件服务器上生成 SSH 密钥并创建授权密钥文件</h5><p>使用 <code>ssh-keygen</code> 命令为文件服务器和云存储生成一对新的 SSH 密钥对。</p><pre tabindex=0><code>ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key . . .
</code></pre><p>插入要求的 SSH 公钥到新的本地授权密钥文件中。</p><pre tabindex=0><code>cat .ssh/id_rsa.pub &gt;&gt; storagebox_authorized_keys
</code></pre><h5 id=传输密钥文件到云存储>传输密钥文件到云存储</h5><p>下一步就是上传生成了的授权密钥文件到存储盒子。要做这些，先用 700 权限创建 <code>.ssh</code> 目录，然后用 SSH 公钥创建授权文件并赋予 600 权限。运行以下命令。</p><pre tabindex=0><code>echo -e &#34;mkdir .ssh \n chmod 700 .ssh \n put storagebox_authorized_keys .ssh/authorized_keys \n chmod 600 .ssh/authorized_keys&#34; | sftp &lt;username&gt;@&lt;username&gt;.your-storagebox.de
</code></pre><h5 id=通过-ssh-使用-rsync>通过 ssh 使用 rsync</h5><p>使用 <code>rsync</code> 同步你的文件目录当前状态到存储盒子。</p><pre tabindex=0><code>rsync --progress -e &#39;ssh -p23&#39; --recursive &lt;local_directory&gt; &lt;username&gt;@&lt;username&gt;.your-storagebox.de:&lt;target_directory&gt;
</code></pre><p>这个过程被叫做推送操作，因为它 “推送” 本地系统的一个目录到一个远程的系统中去。</p><h5 id=从云存储中恢复目录>从云存储中恢复目录</h5><p>要从存储盒子恢复目录，转换到这个目录：</p><pre tabindex=0><code>rsync --progress -e &#39;ssh -p23&#39; --recursive &lt;username&gt;@&lt;username&gt;.your-storagebox.de:&lt;remote_directory&gt; &lt;local_directory&gt;
</code></pre><h4 id=备份-3-客户端备份到第二个云储存>备份 3. 客户端备份到第二个云储存</h4><p><a href=https://fedoramagazine.org/easy-backups-with-deja-dup/>Deja Dup</a> 是 Fedora 软件仓库中为 Fedora 工作站提供快速备份解决方案的工具。它拥有 GPG 加密、计划任务、文件包含（哪个目录要备份）等功能。</p><p><img src=/data/attachment/album/202204/28/160107makklr1zglagrlj9.png alt="Backing up to the secondary cloud"></p><p><img src=/data/attachment/album/202204/28/160108nnnjnf2jsf2n119v.png alt="Restoring files from cloud storage"></p><h3 id=归档个人数据>归档个人数据</h3><p>不是所有数据都需要 3-2-1 备份策略。这就是个人数据共享。我将一台拥有 1TB 硬盘的笔记本作为我个人数据的档案（家庭照片）。</p><p>转到设置中的 “ 共享 Sharing ” （在我的例子中是 GNOME 文件管理器）并切换滑块以启用共享。</p><p><img src=/data/attachment/album/202204/28/160108imp1i8c7pfiixxcx.png alt></p><p>打开 “ 文件共享 file sharing ”，“ 网络 Networks ” 和 “ 需要的密码 Required password ”，允许你使用 WebDAV 协议在你的本地网络上分享你的公共文件夹给其它的工作站。</p><p><img src=/data/attachment/album/202204/28/160108yhykm2y7mpa7ay7n.png alt></p><h3 id=准备回滚选项>准备回滚选项</h3><p>未测试的备份并不比完全没有备份好。我在家庭实验室环境中使用 “热切换” 方法来避免像频繁的断电或者液体损坏的情况发生。然而，我的建议方案远没有达到灾难恢复计划或企业 IT 中的自动故障修复。</p><ul><li>定期运行文件恢复操作</li><li>备份 ssh/GPG 密钥到一个额外的存储设备中</li><li>复制一个 Fedora ARM 服务器的原始镜像到一个 SD 卡中</li><li>在主云存储中保持全备份的快照</li><li>自动化备份过程最小化减少人为错误或者疏忽</li></ul><h3 id=使用-cockpit-追踪活动并解决问题>使用 Cockpit 追踪活动并解决问题</h3><p>当你的项目在成长时，你所管理的服务器数量也在增长。在 Cockpit 中追踪活动和警告可以减轻你的管理负担。你可以使用 Cockpit 的图形化界面的三种方法来归档这些。</p><h4 id=selinux-菜单>SELinux 菜单</h4><p>怎样诊断网络问题，找到日志并在 Cockpit 中解决问题：</p><ul><li>去 SELinux 中检查日志</li><li>检查“ 解决方案详细信息 solution details ”</li><li>当必要时，选择 “ 应用这个方案 Apply this solution ”</li><li>如果必要，查看自动化脚本并运行它</li></ul><p><img src=/data/attachment/album/202204/28/160109wye640h965fnge2e.png alt="SELinux logs"></p><h4 id=网络或者存储日志>网络或者存储日志</h4><p>服务器日志会跟踪 CPU 负载、内存使用、网络活动、存储性能和系统日志关联的详细指标。日志会组织在网络面板或者存储面板里显示。</p><p><img src=/data/attachment/album/202204/28/160109wkihzsv7g5j5jxpe.png alt="Storage logs in Cockpit"></p><h4 id=软件更新>软件更新</h4><p>在预设的时间和频率下，Cockpit 可以帮助进行安全更新。当你需要时，你可以运行所有的更新。</p><p><img src=/data/attachment/album/202204/28/160109vmsogoq0wou7vg3j.png alt="Software updates"></p><p>恭喜你在 Fedora ARM 服务器版本上搭建了一个文件/备份服务器。</p><hr><p>via: <a href=https://fedoramagazine.org/3-2-1-backup-plan-with-fedora-arm-server/>https://fedoramagazine.org/3-2-1-backup-plan-with-fedora-arm-server/</a></p><p>作者：<a href=https://fedoramagazine.org/author/hankuoffroad/>Hanku Lee</a> 选题：<a href=https://github.com/lujun9972>lujun9972</a> 译者：<a href=https://github.com/hwlife>hwlife</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/cockpit/ rel=tag>Cockpit</a></li><li class=tags__item><a class="tags__link btn" href=/tags/%E5%A4%87%E4%BB%BD/ rel=tag>备份</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>