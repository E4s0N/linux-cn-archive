<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>如何监测微型的网站服务 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="如何监测微型的网站服务"><meta property="og:description" content="我希望网站大部分时间都能正常工作，但我也希望不用在持续的运营上花费时间。"><meta property="og:type" content="article"><meta property="og:url" content="/article-14840-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-18T10:58:49+00:00"><meta property="article:modified_time" content="2022-07-18T10:58:49+00:00"><meta itemprop=name content="如何监测微型的网站服务"><meta itemprop=description content="我希望网站大部分时间都能正常工作，但我也希望不用在持续的运营上花费时间。"><meta itemprop=datePublished content="2022-07-18T10:58:49+00:00"><meta itemprop=dateModified content="2022-07-18T10:58:49+00:00"><meta itemprop=wordCount content="193"><meta itemprop=keywords content="监控,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>如何监测微型的网站服务</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2022-07-18T10:58:49Z>July 18, 2022</time></div></div></header><div class="content post__content clearfix"><p><img src=/data/attachment/album/202207/18/105829gzviausw5wg7wwxb.jpg alt></p><p>你好! 我最近又开始运行一些服务器（<a href=https://nginx-playground.wizardzines.com>nginx playground</a>、<a href=https://messwithdns.net>mess with dns</a>、<a href=https://dns-lookup.jvns.ca>dns lookup</a>），所以我一直在考虑监控问题。</p><p>最初我并不完全清楚如何监控这些网站，所以我想快速写下我是如何做到的。</p><p>我根本不打算谈如何监控大型的、严肃的关键任务网站，只谈微型的不重要的网站。</p><h3 id=目标在操作上几乎不花时间>目标：在操作上几乎不花时间</h3><p>我希望网站大部分时间都能正常工作，但我也希望不用在持续的运营上花费时间。</p><p>我最初对运行服务器非常警惕，因为在我的上一份工作中，我是 24/7 轮流值班，负责一些关键的服务，在我的印象中，“负责服务器”意味着“在凌晨 2 点被叫起来修理服务器”和“有很多复杂的仪表盘”。</p><p>所以有一段时间我只做静态网站，这样我就不用考虑服务器的问题。</p><p>但最终我意识到，我所要写的任何服务器的风险都很低，如果它们偶尔宕机 2 小时也没什么大不了的，我只需设置一些非常简单的监控来帮助它们保持运行。</p><h3 id=没有监控很糟糕>没有监控很糟糕</h3><p>起初，我根本没有为我的服务器设置任何监控。这样做的结果是非常可预见的：有时网站坏了，而我却没有发现，直到有人告诉我！</p><h3 id=步骤-1uptime-检查器>步骤 1：uptime 检查器</h3><p>第一步是建立一个 uptime 检查器。外面有很多这样的东西，我现在使用的是 <a href=https://updown.io/>updown.io</a> 和 <a href=https://uptimerobot.com/>uptime robot</a>。我更喜欢 updown 的用户界面和 <a href=https://updown.io/#pricing>定价</a> 结构（它是按请求而不是按月收费），但 uptime 机器人有一个更慷慨的免费套餐。</p><p>它们会：</p><ol><li>检查网站是否正常</li><li>如果出现故障，它会给我发电子邮件</li></ol><p>我发现电子邮件通知对我来说是一个很好的通知级别，如果网站宕机，我会很快发现，但它不会吵醒我或做其它的什么打扰。</p><h3 id=步骤-2端到端的健康检查>步骤 2：端到端的健康检查</h3><p>接下来，让我们谈谈“检查网站是否正常”到底是什么意思。</p><p>起初，我只是把我的健康检查端点之一变成一个函数，无论如何都会返回 <code>200 OK</code>。</p><p>这倒是挺有用的 – 它告诉我服务器是启动着的！</p><p>但不出所料，我遇到了问题，因为它没有检查 API 是否真的在 <em>工作</em> – 有时健康检查成功了，尽管服务的其他部分实际上已经进入了一个糟糕的状态。</p><p>所以我更新了它，让它真正地发出 API 请求，并确保它成功了。</p><p>我所有的服务都只做了很少的事情（nginx playground 只有一个端点），所以设置一个健康检查是非常容易的，它实际上贯穿了服务应该做的大部分动作。</p><p>下面是 nginx playground 的端到端健康检查处理程序的样子。它非常基本：它只是发出一个 POST 请求（给自己），并检查该请求是成功还是失败。</p><pre tabindex=0><code>    func healthHandler(w http.ResponseWriter, r *http.Request) {
        // make a request to localhost:8080 with `healthcheckJSON` as the body
        // if it works, return 200
        // if it doesn&#39;t, return 500
        client := http.Client{}
        resp, err := client.Post(&#34;http://localhost:8080/&#34;, &#34;application/json&#34;, strings.NewReader(healthcheckJSON))
        if err != nil {
            log.Println(err)
            w.WriteHeader(http.StatusInternalServerError)
            return
        }
        if resp.StatusCode != http.StatusOK {
            log.Println(resp.StatusCode)
            w.WriteHeader(http.StatusInternalServerError)
            return
        }
        w.WriteHeader(http.StatusOK)
    }
</code></pre><h3 id=健康检查频率每小时一次>健康检查频率：每小时一次</h3><p>现在，我大部分健康检查每小时运行一次，有些每 30 分钟运行一次。</p><p>我每小时运行一次，因为 <a href=http://updown.io>updown.io</a> 的定价是按健康检查次数计算的，我正在监控 18 个不同的 URL，而且我想把我的健康检查预算保持在 5 美元/年的最低水平。</p><p>花一个小时来发现这些网站中的一个出现故障，对我来说是可以的 – 如果有问题，我也不能保证能很快修复它。</p><p>如果可以更频繁地运行它们，我可能会每 5-10 分钟运行一次。</p><h3 id=步骤-3第三步如果健康检查失败自动重新启动>步骤 3：第三步：如果健康检查失败，自动重新启动</h3><p>我的一些网站在 <a href=http://fly.io>fly.io</a> 上，fly 有一个相当标准的功能，我可以为一个服务配置一个 HTTP 健康检查，如果健康检查失败，就重新启动服务。</p><p>“经常重启”是一个非常有用的策略来弥补我尚未修复的 bug，有一段时间，nginx playground 有一个进程泄漏，<code>nginx</code> 进程没有被终止，所以服务器的内存一直在耗尽。</p><p>通过健康检查，其结果是，每隔一天左右就会发生这样的情况：</p><ul><li>服务器的内存用完了</li><li>健康检查开始失败</li><li>它被重新启动</li><li>一切又正常了</li><li>几个小时后再次重复整个传奇</li></ul><p>最终，我开始实际修复进程泄漏，但很高兴有一个解决方法可以在我拖延修复 bug 时保持运行。</p><p>这些用于决定是否重新启动服务的运行状况检查更频繁地运行：每 5 分钟左右。</p><h3 id=这不是监控大型服务的最佳方式>这不是监控大型服务的最佳方式</h3><p>这可能很明显，我在一开始就已经说过了，但是“编写一个 HTTP 健康检查”并不是监控大型复杂服务的最佳方法。 但我不会深入讨论，因为这不是这篇文章的主题。</p><h3 id=到目前为止一直运行良好>到目前为止一直运行良好！</h3><p>我最初在 3 个月前的四月写了这篇文章，但我一直等到现在才发布它以确保整个设置正常工作。</p><p>这带来了很大的不同 – 在我遇到一些非常愚蠢的停机问题之前，现在在过去的几个月里，网站的运行时间达到了 99.95%！</p><hr><p>via: <a href=https://jvns.ca/blog/2022/07/09/monitoring-small-web-services/>https://jvns.ca/blog/2022/07/09/monitoring-small-web-services/</a></p><p>作者：<a href=https://jvns.ca/>Julia Evans</a> 选题：<a href=https://github.com/lujun9972>lujun9972</a> 译者：<a href=https://github.com/geekpi>geekpi</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/%E7%9B%91%E6%8E%A7/ rel=tag>监控</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>