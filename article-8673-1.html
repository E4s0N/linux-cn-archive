<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Samba 系列（十一）：如何配置并集成 iRedMail 服务到 Samba4 AD DC 中 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="Samba 系列（十一）：如何配置并集成 iRedMail 服务到 Samba4 AD DC 中"><meta property="og:description" content="将 iRedMail 集成到 Samba4 AD DC 中，你将得到以下好处：通过 Samba AD DC 得到用户身份验证、管理和状态，在 AD 组和 Roundcube 中的全局 LDAP 地址簿的帮助下创建邮件列表。"><meta property="og:type" content="article"><meta property="og:url" content="/article-8673-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-07-06T11:11:33+00:00"><meta property="article:modified_time" content="2017-07-06T11:11:33+00:00"><meta itemprop=name content="Samba 系列（十一）：如何配置并集成 iRedMail 服务到 Samba4 AD DC 中"><meta itemprop=description content="将 iRedMail 集成到 Samba4 AD DC 中，你将得到以下好处：通过 Samba AD DC 得到用户身份验证、管理和状态，在 AD 组和 Roundcube 中的全局 LDAP 地址簿的帮助下创建邮件列表。"><meta itemprop=datePublished content="2017-07-06T11:11:33+00:00"><meta itemprop=dateModified content="2017-07-06T11:11:33+00:00"><meta itemprop=wordCount content="828"><meta itemprop=keywords content="Samba,iRedMail,邮件,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Samba 系列（十一）：如何配置并集成 iRedMail 服务到 Samba4 AD DC 中</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2017-07-06T11:11:33Z>July 06, 2017</time></div></div></header><div class="content post__content clearfix"><p><img src=https://img.linux.net.cn/data/attachment/album/201707/06/110904jqze64or44zj7zqe.jpg alt></p><p>在本教程中，将学习如何修改提供邮件服务的 iRedMail 主要守护进程，相应地，<a href=https://www.tecmint.com/setup-postfix-mail-server-and-dovecot-with-mariadb-in-centos/>Postfix 用于邮件传输，Dovecot 将邮件传送到帐户邮箱</a>，以便将它们集成到 <a href=/article-8065-1.html>Samba4 AD 域控制器</a>中。</p><p>将 iRedMail 集成到 Samba4 AD DC 中，你将得到以下好处：通过 Samba AD DC 得到用户身份验证、管理和状态，在 AD 组和 Roundcube 中的全局 LDAP 地址簿的帮助下创建邮件列表。</p><h3 id=要求>要求</h3><ol><li><a href=/article-8567-1.html>在 CentOS 7 中为 Samba4 AD 集成安装 iRedMail</a></li></ol><h3 id=第一步准备-iredmail-系统用于-samba4-ad-集成>第一步：准备 iRedMail 系统用于 Samba4 AD 集成</h3><p>1、 在第一步中，你需要<a href=/article-3977-1.html>为你的机器分配一个静态的 IP 地址</a>以防你使用的是由 DHCP 服务器提供的动态 IP 地址。</p><p>运行 <a href=https://www.tecmint.com/ifconfig-command-examples/>ifconfig 命令</a>列出你的机器网络接口名，并对正确的网卡发出 <a href=/article-5410-1.html>nmtui-edit</a> 命令，使用自定义 IP 设置编辑正确的网络接口。</p><p>root 权限运行 nmtui-edit 命令。</p><pre tabindex=0><code># ifconfig
# nmtui-edit eno16777736
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/201707/06/111135jcsb8b34rsgsts8b.png alt="Find Network Interface Name"></p><p><em>找出网络接口名</em></p><p>2、 在打开要编辑的网络接口后，添加正确的静态 IP 设置，确保添加了 Samba4 AD DC 的 DNS 服务器 IP 地址以及你的域的名字，以便从机器查询 realm。使用以下截图作为指导。</p><p><img src=https://img.linux.net.cn/data/attachment/album/201707/06/111136a2uu2tkm4dpzull4.png alt="Configure Network Settings"></p><p><em>配置网络设置</em></p><p>3、 在你完成配置网络接口后，重启网络进程使更改生效，并对域名以及 samba 4 域控制器的 FQDN 使用 ping 命令测试。</p><pre tabindex=0><code># systemctl restart network.service
# cat /etc/resolv.conf     # 验证 DNS 解析器配置是否对域解析使用了正确的 DNS 服务器 IP
# ping -c2 tecmint.lan     # ping 域名
# ping -c2 adc1            # ping 第一个 AD DC
# ping -c2 adc2            # Ping 第二个 AD DC
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/201707/06/111138c2qjeyzxg2wnseq7.png alt="Verify Network DNS Configuration"></p><p><em>验证网络 DNS 配置</em></p><p>4、 接下来，用下面的命令安装 <code>ntpdate</code> 包，与域控制器同步时间，并请求 samba4 机器的 NTP 服务器：</p><pre tabindex=0><code># yum install ntpdate
# ntpdate -qu tecmint.lan      # querry domain NTP servers
# ntpdate tecmint.lan          # Sync time with the domain
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/201707/06/111139z66o74tb36v3m761.png alt="Sync Time with Samba NTP Server"></p><p><em>与 Samba NTP 服务器同步时间</em></p><p>5、 你或许想要本地时间自动与 samba AD 时间服务器同步。为了实现这个设置，通过运行 <a href=https://www.tecmint.com/11-cron-scheduling-task-examples-in-linux/>crontab -e 命令</a>并追加下面的行添加一条计划任务。</p><pre tabindex=0><code>0   */1   *   *   *   /usr/sbin/ntpdate tecmint.lan &gt; /var/log/ntpdate.lan 2&gt;&amp;1
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/201707/06/111140n202ww22wx2m7o0m.png alt="Auto Sync Time with Samba NTP"></p><p><em>自动与 Samba NTP 同步时间</em></p><h3 id=第二步为-iredmail-集成准备-samba4-ad-dc>第二步：为 iRedMail 集成准备 Samba4 AD DC</h3><p>6、 现在，如<a href=/article-8097-1.html>这篇</a>教程所述进入一台<a href=/article-8097-1.html>安装了 RSAT 工具的 Windows 机器</a>管理 Samba4 AD。</p><p>打开 DNS 管理器，转到你的域转发查找区并添加新的 A 记录、MX记录还有 PTR 记录指向你的 iRedMail 系统的 IP 地址。使用以下截图作为指导。</p><p>添加一条 A 记录（相应地用 iRedMail 机器的名字和 IP 替换）。</p><p><img src=https://img.linux.net.cn/data/attachment/album/201707/06/111140py825jj28pp5y7pp.png alt="Create DNS A Record for iRedMail"></p><p><em>为 iRedMail 创建 DNS A 记录</em></p><p>添加 MX 记录（将子域留空，优先级为 10）。</p><p><img src=https://img.linux.net.cn/data/attachment/album/201707/06/111140r0mkny6467azt60a.png alt="Create DNS MX Record for iRedMail"></p><p><em>为 iRedMail 创建 DNS MX 记录</em></p><p>在反向查找区域（相应地替换 iRedMail 服务器的 IP 地址）添加 PTR 记录。如果你尚未为域控制器配置反向区域，请阅读以下教程：<a href=/article-8258-1.html>从 Windows 管理 Samba4 DNS 组策略</a></p><p><img src=https://img.linux.net.cn/data/attachment/album/201707/06/111141vwxthxz9t91h9wxw.png alt="Create DNS PTR Record for iRedMail"></p><p><em>为 iRedMail 创建 DNS PTR 记录</em></p><p>7、添加了使邮件服务器正常运行的基本 DNS 记录后，请进入 iRedMail 机器，安装 bind-utils 软件包，并按如下建议查询新添加的邮件记录。</p><p>Samba4 AD DC DNS 应该会响应之前添加的 DNS 记录。</p><pre tabindex=0><code># yum install bind-utils
# host tecmint.lan
# host mail.tecmint.lan
# host 192.168.1.245
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/201707/06/111143qsihelee4emih6dm.png alt="Install Bind and Query Mail Records"></p><p><em>安装 Bind 并查询邮件记录</em></p><p>在一台 Windows 机器上，打开命令行窗口并使用 <a href=https://www.tecmint.com/8-linux-nslookup-commands-to-troubleshoot-dns-domain-name-server/>nslookup 命令</a>查询上面的邮件服务器记录。</p><p>8、 作为最后一个先决要求，在 Samba4 AD DC 中创建一个具有最小权限的新用户帐户,并使用名称 vmail, 为此用户选择一个强密码, 并确保该用户的密码永不过期。</p><p>vmail 帐户将被 iRedMail 服务用来查询 Samba4 AD DC LDAP 数据库并拉取电子邮件帐户。</p><p>要创建 vmail 账户，如截图所示，使用加入了已安装 RSAT 工具域的 Windows 机器上的 ADUC 图形化工具，或者按照先前主题中那样用 <a href=/article-8070-1.html>samba-tool 命令行</a>直接在域控制器中运行。</p><p>在本指导中，我们会使用上面提到的第一种方法。</p><p><img src=https://img.linux.net.cn/data/attachment/album/201707/06/111144mzjb8bm8y8mt88bm.png alt="Active Directory Users and Computers"></p><p><em>AD 用户和计算机</em></p><p><img src=https://img.linux.net.cn/data/attachment/album/201707/06/111145cdxjtgqj2gq4xspl.png alt="Create New User for iRedMail"></p><p><em>为 iRedMail 创建新的用户</em></p><p><img src=https://img.linux.net.cn/data/attachment/album/201707/06/111145g7prnesr787deye7.png alt="Set Strong Password for User"></p><p><em>为用户设置强密码</em></p><p>9、 在 iRedMail 系统中，用下面的命令测试 vmail 用户能够查询 Samba4 AD DC LDAP 数据库。返回的结果应该是你的域的对象总数, 如下截图所示。</p><pre tabindex=0><code># ldapsearch -x -h tecmint.lan -D &#39;vmail@tecmint.lan&#39; -W -b &#39;cn=users,dc=tecmint,dc=lan&#39;
</code></pre><p>注意：相应地替换域名以及 Samba4 AD 的 LDAP dn （<code>cn=users,dc=tecmint,dc=lan</code>）。</p><p><img src=https://img.linux.net.cn/data/attachment/album/201707/06/111146s5h7hlpn9gg565eh.png alt="Query Samba4 AD DC LDAP"></p><p><em>查询 Samba4 AD DC LDAP</em></p><h3 id=第三步将-iredmail-服务集成到-samba4-ad-dc-中>第三步：将 iRedMail 服务集成到 Samba4 AD DC 中</h3><p>10、 现在是时候修改 iRedMail 服务（Postfix、Dovecot 和 Roundcube）以便为邮箱帐户查询 Samba4 域控制器。</p><p>第一个要修改的服务是 MTA 代理，Postfix。执行以下命令禁用一系列的 MTA 设置，添加你的域名到 Postfix 本地域以及邮箱域中，并使用 Dovecot 代理发送已接收的邮件到用户邮箱中。</p><pre tabindex=0><code># postconf -e virtual_alias_maps=&#39; &#39;
# postconf -e sender_bcc_maps=&#39; &#39;
# postconf -e recipient_bcc_maps= &#39; &#39;
# postconf -e relay_domains=&#39; &#39;
# postconf -e relay_recipient_maps=&#39; &#39;
# postconf -e sender_dependent_relayhost_maps=&#39; &#39;
# postconf -e smtpd_sasl_local_domain=&#39;tecmint.lan&#39; #用你自己的域替换
# postconf -e virtual_mailbox_domains=&#39;tecmint.lan&#39; #用你自己的域替换   
# postconf -e transport_maps=&#39;hash:/etc/postfix/transport&#39;
# postconf -e smtpd_sender_login_maps=&#39;proxy:ldap:/etc/postfix/ad_sender_login_maps.cf&#39;  # 检查 SMTP 发送者
# postconf -e virtual_mailbox_maps=&#39;proxy:ldap:/etc/postfix/ad_virtual_mailbox_maps.cf&#39;  # 检查本地邮件帐户
# postconf -e virtual_alias_maps=&#39;proxy:ldap:/etc/postfix/ad_virtual_group_maps.cf&#39;  # 检查本地邮件列表
# cp /etc/postfix/transport /etc/postfix/transport.backup   # 备份 transport 配置
# echo &#34;tecmint.lan dovecot&#34; &gt; /etc/postfix/transport       # 添加带 dovecot transport 的域
# cat /etc/postfix/transport                    # 验证 transport 文件
# postmap hash:/etc/postfix/transport
</code></pre><p>11、 接下来，用你最喜欢的文本编辑器创建 Postfix 的 <code>/etc/postfix/ad_sender_login_maps.cf</code> 配置文件，并添加下面的配置。</p><pre tabindex=0><code>server_host     = tecmint.lan
server_port     = 389
version         = 3
bind            = yes
start_tls       = no
bind_dn         = vmail@tecmint.lan
bind_pw         = ad_vmail_account_password
search_base     = dc=tecmint,dc=lan
scope           = sub
query_filter    = (&amp;(userPrincipalName=%s)(objectClass=person)(!(userAccountControl:1.2.840.113556.1.4.803:=2)))
result_attribute= userPrincipalName
debuglevel      = 0
</code></pre><p>12、 使用下面的配置创建 <code>/etc/postfix/ad_virtual_mailbox_maps.cf</code>。</p><pre tabindex=0><code>server_host     = tecmint.lan
server_port     = 389
version         = 3
bind            = yes
start_tls       = no
bind_dn         = vmail@tecmint.lan
bind_pw         = ad_vmail_account_password
search_base     = dc=tecmint,dc=lan
scope           = sub
query_filter    = (&amp;(objectclass=person)(userPrincipalName=%s))
result_attribute= userPrincipalName
result_format   = %d/%u/Maildir/
debuglevel      = 0
</code></pre><p>13、 使用下面的配置创建 <code>/etc/postfix/ad_virtual_group_maps.cf</code>。</p><pre tabindex=0><code>server_host     = tecmint.lan
server_port     = 389
version         = 3
bind            = yes
start_tls       = no
bind_dn         = vmail@tecmint.lan
bind_pw         = ad_vmail_account_password
search_base     = dc=tecmint,dc=lan
scope           = sub
query_filter    = (&amp;(objectClass=group)(mail=%s))
special_result_attribute = member
leaf_result_attribute = mail
result_attribute= userPrincipalName
debuglevel      = 0
</code></pre><p>替换上面三个配置文件中的 <code>server_host</code>、<code>bind_dn</code>、<code>bind_pw</code> 和 <code>search_base</code> 以反应你自己域的设置。</p><p>14、 接下来，打开 Postfix 主配置文件，通过在下面的行前添加 <code>#</code> 注释，搜索并禁用 iRedAPD 的 <code>check_policy_service</code> 和 <code>smtpd_end_of_data_restrictions</code>。</p><pre tabindex=0><code># nano /etc/postfix/main.cf
</code></pre><p>注释下面的行：</p><pre tabindex=0><code>#check_policy_service inet:127.0.0.1:7777
#smtpd_end_of_data_restrictions = check_policy_service inet:127.0.0.1:7777
</code></pre><p>15、 现在，通过执行一系列查询，验证 Postfix 是否使用现有的域用户和域组绑定到 Samba AD，如以下示例所示。</p><p>结果应与下面的截图类似。</p><pre tabindex=0><code># postmap -q tecmint_user@tecmint.lan ldap:/etc/postfix/ad_virtual_mailbox_maps.cf
# postmap -q tecmint_user@tecmint.lan ldap:/etc/postfix/ad_sender_login_maps.cf
# postmap -q linux_users@tecmint.lan ldap:/etc/postfix/ad_virtual_group_maps.cf
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/201707/06/111147b4u8w0bo1vvnnvnp.png alt="Verify Postfix Binding to Samba AD"></p><p><em>验证 Postfix 绑定到了 Samba AD</em></p><p>相应替换 AD 用户及组帐户。同样，确保你使用的 AD 组已被分配了一些成员。</p><p>16、 在下一步中修改 Dovecot 配置文件以查询 Samba4 AD DC。打开 <code>/etc/dovecot/dovecot-ldap.conf</code> 文件并添加下面的行。</p><pre tabindex=0><code>hosts           = tecmint.lan:389
ldap_version    = 3
auth_bind       = yes
dn              = vmail@tecmint.lan
dnpass          = ad_vmail_password
base            = dc=tecmint,dc=lan
scope           = subtree
deref           = never
user_filter     = (&amp;(userPrincipalName=%u)(objectClass=person)(!(userAccountControl:1.2.840.113556.1.4.803:=2)))
pass_filter     = (&amp;(userPrincipalName=%u)(objectClass=person)(!(userAccountControl:1.2.840.113556.1.4.803:=2)))
pass_attrs      = userPassword=password
default_pass_scheme = CRYPT
user_attrs      = =home=/var/vmail/vmail1/%Ld/%Ln/Maildir/,=mail=maildir:/var/vmail/vmail1/%Ld/%Ln/Maildir/
</code></pre><p>Samba4 AD 帐户的邮箱将会存储在 <code>/var/vmail/vmail1/your_domain.tld/your_domain_user/Maildir/</code> 中。</p><p>17、 确保 dovecot 的主配置文件中启用了 pop3 和 imap 协议。打开 <code>/etc/dovecot/dovecot.conf</code> 验证是否启用了 <code>quota</code> 和 <code>acl</code> 邮件插件，并检查这些值是否存在。</p><p><img src=https://img.linux.net.cn/data/attachment/album/201707/06/111148fr1nri0b8kk5666n.png alt="Enable Pop3 and Imap in Dovecot"></p><p><em>在 Dovecot 中启用 POP3 和 IMAP</em></p><p>18、 可选地，如果要将全局硬配额设置为每个域用户的最大不超过 500 MB 存储，请在 <code>/etc/dovecot/dovecot.conf</code> 文件中添加以下行。</p><pre tabindex=0><code>quota_rule = *:storage=500M 
</code></pre><p>19、 最后，为了使目前这些更改生效，用 root 权限执行下面的命令重启并验证 Postfix 和 Dovecot 守护进程的状态。</p><pre tabindex=0><code># systemctl restart postfix dovecot
# systemctl status postfix dovecot
</code></pre><p>20、 为了使用 IMAP 协议从命令行测试邮件服务器配置，请使用 telnet 或 <a href=https://www.tecmint.com/check-remote-port-in-linux/>netcat 命令</a>，如下所示。</p><pre tabindex=0><code># nc localhost 143
a1 LOGIN ad_user@your_domain.tld ad_user_password
a2 LIST “” “*”
a3 LOGOUT
</code></pre><p><a href=https://www.tecmint.com/wp-content/uploads/2017/05/Test-iRedMail-Configuration.png><img src=https://img.linux.net.cn/data/attachment/album/201707/06/111150gj3pggpuzhi883gt.png alt="Test iRedMail Configuration"></a></p><p><em>测试 iRedMail 配置</em></p><p>如果你可以使用 Samba4 用户帐户从命令行执行 IMAP 登录，那么 iRedMail 服务器似乎已经准备好发送和接收 AD 帐户的邮件。</p><p>在下一个教程中将讨论如何将 Roundcube webmail 与 Samba4 AD DC 集成，并启用全局 LDAP 地址簿，自定义 Roudcube，从浏览器访问 Roundcube Web 界面，并禁用某些不需要的 iRedMail 服务。</p><hr><p>作者简介：</p><p>我是一个电脑上瘾的家伙，开源和基于 linux 的系统软件的粉丝，在 Linux 发行版桌面、服务器和 bash 脚本方面拥有大约4年的经验。</p><hr><p>via: <a href=https://www.tecmint.com/integrate-iredmail-to-samba4-ad-dc-on-centos-7/>https://www.tecmint.com/integrate-iredmail-to-samba4-ad-dc-on-centos-7/</a></p><p>作者：<a href=https://www.tecmint.com/author/cezarmatei/>Matei Cezar</a> 译者：<a href=https://github.com/geekpi>geekpi</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/samba/ rel=tag>Samba</a></li><li class=tags__item><a class="tags__link btn" href=/tags/iredmail/ rel=tag>iRedMail</a></li><li class=tags__item><a class="tags__link btn" href=/tags/%E9%82%AE%E4%BB%B6/ rel=tag>邮件</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>