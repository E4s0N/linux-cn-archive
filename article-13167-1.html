<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Ansible 剧本快速入门指南 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="Ansible 剧本快速入门指南"><meta property="og:description" content="我们已经写了两篇关于 Ansible 的文章，这是第三篇。"><meta property="og:type" content="article"><meta property="og:url" content="/article-13167-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-03-01T22:57:33+00:00"><meta property="article:modified_time" content="2021-03-01T22:57:33+00:00"><meta itemprop=name content="Ansible 剧本快速入门指南"><meta itemprop=description content="我们已经写了两篇关于 Ansible 的文章，这是第三篇。"><meta itemprop=datePublished content="2021-03-01T22:57:33+00:00"><meta itemprop=dateModified content="2021-03-01T22:57:33+00:00"><meta itemprop=wordCount content="858"><meta itemprop=keywords content="Ansible,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Ansible 剧本快速入门指南</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2021-03-01T22:57:33Z>March 01, 2021</time></div></div></header><div class="content post__content clearfix"><p><img src=/data/attachment/album/202103/01/225645ree2x6zf756o23x8.jpg alt></p><p>我们已经写了两篇关于 Ansible 的文章，这是第三篇。</p><p>如果你是 Ansible 新手，我建议你阅读下面这两篇文章，它会教你一些 Ansible 的基础以及它是什么。</p><ul><li>第一篇: <a href=/article-13142-1.html>Ansible 自动化工具安装、配置和快速入门指南</a></li><li>第二篇: <a href=/article-13163-1.html>Ansible 点对点命令快速入门指南示例</a></li></ul><p>如果你已经阅读过了，那么在阅读本文时你才不会感到突兀。</p><h3 id=什么是-ansible-剧本>什么是 Ansible 剧本?</h3><p>剧本 playbook 比点对点命令模式更强大，而且完全不同。</p><p>它使用了 <code>/usr/bin/ansible-playbook</code> 二进制文件，并且提供丰富的特性使得复杂的任务变得更容易。</p><p>如果你想经常运行一个任务，剧本是非常有用的。此外，如果你想在服务器组上执行多个任务，它也是非常有用的。</p><p>剧本是由 YAML 语言编写。YAML 代表一种标记语言，它比其它常见的数据格式（如 XML 或 JSON）更容易读写。</p><p>下面这张 Ansible 剧本流程图将告诉你它的详细结构。</p><p><img src=/data/attachment/album/202103/01/225735j6sbgq56rqqpkadk.png alt></p><h3 id=理解-ansible-剧本的术语>理解 Ansible 剧本的术语</h3><ul><li>控制节点 Control node ：Ansible 安装的机器，它负责管理客户端节点。</li><li>受控节点 Managed node ：控制节点管理的主机列表。</li><li>剧本 playbook ：一个剧本文件包含一组自动化任务。</li><li>主机清单 Inventory ：这个文件包含有关管理的服务器的信息。</li><li>任务 Task ：每个剧本都有大量的任务。任务在指定机器上依次执行（一个主机或多个主机）。</li><li>模块 Module ： 模块是一个代码单元，用于从客户端节点收集信息。</li><li>角色 Role ：角色是根据已知文件结构自动加载一些变量文件、任务和处理程序的方法。</li><li>动作 Play ：每个剧本含有大量的动作，一个动作从头到尾执行一个特定的自动化。</li><li>处理程序 Handler ： 它可以帮助你减少在剧本中的重启任务。处理程序任务列表实际上与常规任务没有什么不同，更改由通知程序通知。如果处理程序没有收到任何通知，它将不起作用。</li></ul><h3 id=基本的剧本是怎样的>基本的剧本是怎样的？</h3><p>下面是一个剧本的模板：</p><pre tabindex=0><code>---                                [YAML 文件应该以三个破折号开头]
- name:                            [脚本描述]
  hosts: group                     [添加主机或主机组]
  become: true                     [如果你想以 root 身份运行任务，则标记它]
  tasks:                           [你想在任务下执行什么动作]
    - name:                        [输入模块选项]
      module:                      [输入要执行的模块]
        module_options-1: value    [输入模块选项]
        module_options-2: value
        .
        module_options-N: value
</code></pre><h3 id=如何理解-ansible-的输出>如何理解 Ansible 的输出</h3><p>Ansible 剧本的输出有四种颜色，下面是具体含义：</p><ul><li><strong>绿色</strong>：<code>ok</code> 代表成功，关联的任务数据已经存在，并且已经根据需要进行了配置。</li><li><strong>黄色</strong>：<code>changed</code> 指定的数据已经根据任务的需要更新或修改。</li><li><strong>红色</strong>：<code>FAILED</code> 如果在执行任务时出现任何问题，它将返回一个失败消息，它可能是任何东西，你需要相应地修复它。</li><li><strong>白色</strong>：表示有多个参数。</li></ul><p>为此，创建一个剧本目录，将它们都放在同一个地方。</p><pre tabindex=0><code>$ sudo mkdir /etc/ansible/playbooks
</code></pre><h3 id=剧本-1在-rhel-系统上安装-apache-web-服务器>剧本-1：在 RHEL 系统上安装 Apache Web 服务器</h3><p>这个示例剧本允许你在指定的目标机器上安装 Apache Web 服务器：</p><pre tabindex=0><code>$ sudo nano /etc/ansible/playbooks/apache.yml

---
- hosts: web
  become: yes
  name: &#34;Install and Configure Apache Web server&#34;
  tasks:
    - name: &#34;Install Apache Web Server&#34;
      yum:
        name: httpd
        state: latest
    - name: &#34;Ensure Apache Web Server is Running&#34;
      service:
        name: httpd
        state: started
</code></pre><pre tabindex=0><code>$ ansible-playbook apache1.yml
</code></pre><p><img src=/data/attachment/album/202103/01/225735j6sbgq56rqqpkadk.png alt></p><h3 id=如何理解-ansible-中剧本的执行>如何理解 Ansible 中剧本的执行</h3><p>使用以下命令来查看语法错误。如果没有发现错误，它只显示剧本文件名。如果它检测到任何错误，你将得到一个如下所示的错误，但内容可能根据你的输入文件而有所不同。</p><pre tabindex=0><code>$ ansible-playbook apache1.yml --syntax-check

ERROR! Syntax Error while loading YAML.
  found a tab character that violate indentation
The error appears to be in &#39;/etc/ansible/playbooks/apache1.yml&#39;: line 10, column 1, but may
be elsewhere in the file depending on the exact syntax problem.
The offending line appears to be:
        state: latest
^ here
There appears to be a tab character at the start of the line.

YAML does not use tabs for formatting. Tabs should be replaced with spaces.
For example:
    - name: update tooling
      vars:
        version: 1.2.3
# ^--- there is a tab there.
Should be written as:
    - name: update tooling
      vars:
        version: 1.2.3
# ^--- all spaces here.
</code></pre><p>或者，你可以使用这个 URL <a href=http://www.yamllint.com/>YAML Lint</a> 在线检查 Ansible 剧本内容。</p><p>执行以下命令进行“演练”。当你运行带有 <code>--check</code> 选项的剧本时，它不会对远程机器进行任何修改。相反，它会告诉你它将要做什么改变但不是真的执行。</p><pre tabindex=0><code>$ ansible-playbook apache.yml --check

PLAY [Install and Configure Apache Webserver] ********************************************************************

TASK [Gathering Facts] *******************************************************************************************
ok: [node2.2g.lab]
ok: [node1.2g.lab]

TASK [Install Apache Web Server] *********************************************************************************
changed: [node2.2g.lab]
changed: [node1.2g.lab]

TASK [Ensure Apache Web Server is Running] ***********************************************************************
changed: [node1.2g.lab]
changed: [node2.2g.lab]

PLAY RECAP *******************************************************************************************************
node1.2g.lab               : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
node2.2g.lab               : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre><p>如果你想要知道 ansible 剧本实现的详细信息，使用 <code>-vv</code> 选项，它会展示如何收集这些信息。</p><pre tabindex=0><code>$ ansible-playbook apache.yml --check -vv

ansible-playbook 2.9.2
  config file = /etc/ansible/ansible.cfg
  configured module search path = [&#39;/home/daygeek/.ansible/plugins/modules&#39;, &#39;/usr/share/ansible/plugins/modules&#39;]
  ansible python module location = /usr/lib/python3.8/site-packages/ansible
  executable location = /usr/bin/ansible-playbook
  python version = 3.8.1 (default, Jan  8 2020, 23:09:20) [GCC 9.2.0]
Using /etc/ansible/ansible.cfg as config file

PLAYBOOK: apache.yml *****************************************************************************************************
1 plays in apache.yml

PLAY [Install and Configure Apache Webserver] ****************************************************************************

TASK [Gathering Facts] ***************************************************************************************************
task path: /etc/ansible/playbooks/apache.yml:2
ok: [node2.2g.lab]
ok: [node1.2g.lab]
META: ran handlers

TASK [Install Apache Web Server] *****************************************************************************************
task path: /etc/ansible/playbooks/apache.yml:6
changed: [node2.2g.lab] =&gt; {&#34;changed&#34;: true, &#34;msg&#34;: &#34;Check mode: No changes made, but would have if not in check mod
e&#34;, &#34;rc&#34;: 0, &#34;results&#34;: [&#34;Installed: httpd&#34;]}
changed: [node1.2g.lab] =&gt; {&#34;changed&#34;: true, &#34;changes&#34;: {&#34;installed&#34;: [&#34;httpd&#34;], &#34;updated&#34;: []}, &#34;msg&#34;: &#34;&#34;, &#34;obsolet
es&#34;: {&#34;urw-fonts&#34;: {&#34;dist&#34;: &#34;noarch&#34;, &#34;repo&#34;: &#34;@anaconda&#34;, &#34;version&#34;: &#34;2.4-16.el7&#34;}}, &#34;rc&#34;: 0, &#34;results&#34;: []}

TASK [Ensure Apache Web Server is Running] *******************************************************************************
task path: /etc/ansible/playbooks/apache.yml:10
changed: [node1.2g.lab] =&gt; {&#34;changed&#34;: true, &#34;msg&#34;: &#34;Service httpd not found on host, assuming it will exist on full run&#34;}
changed: [node2.2g.lab] =&gt; {&#34;changed&#34;: true, &#34;msg&#34;: &#34;Service httpd not found on host, assuming it will exist on full run&#34;}
META: ran handlers
META: ran handlers

PLAY RECAP ***************************************************************************************************************
node1.2g.lab               : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
node2.2g.lab               : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre><h3 id=剧本-2在-ubuntu-系统上安装-apache-web-服务器>剧本-2：在 Ubuntu 系统上安装 Apache Web 服务器</h3><p>这个示例剧本允许你在指定的目标节点上安装 Apache Web 服务器。</p><pre tabindex=0><code>$ sudo nano /etc/ansible/playbooks/apache-ubuntu.yml

---
- hosts: web
  become: yes
  name: &#34;Install and Configure Apache Web Server&#34;
  tasks:
    - name: &#34;Install Apache Web Server&#34;
      yum:
        name: apache2
        state: latest

    - name: &#34;Start the Apache Web Server&#34;
      service:
        name: apaceh2
        state: started

    - name: &#34;Enable mod_rewrite module&#34;
      apache2_module:
        name: rewrite
        state: present

      notify:
      - start apache

  handlers:
    - name: &#34;Ensure Apache Web Server is Running&#34;
      service:
        name: apache2
        state: restarted
        enabled: yes
</code></pre><h3 id=剧本-3在-red-hat-系统上安装软件包列表>剧本-3：在 Red Hat 系统上安装软件包列表</h3><p>这个示例剧本允许你在指定的目标节点上安装软件包。</p><p><strong>方法-1：</strong></p><pre tabindex=0><code>$ sudo nano /etc/ansible/playbooks/packages-redhat.yml

---
- hosts: web
  become: yes
  name: &#34;Install a List of Packages on Red Hat Based System&#34;
  tasks:
    - name: &#34;Installing a list of packages&#34;
      yum:
        name:
          - curl
          - httpd
          - nano
          - htop
</code></pre><p><strong>方法-2：</strong></p><pre tabindex=0><code>$ sudo nano /etc/ansible/playbooks/packages-redhat-1.yml

---
- hosts: web
  become: yes
  name: &#34;Install a List of Packages on Red Hat Based System&#34;
  tasks:
    - name: &#34;Installing a list of packages&#34;
      yum: name={{ item }} state=latest
      with_items:
        - curl
        - httpd
        - nano
        - htop
</code></pre><p><strong>方法-3：使用数组变量</strong></p><pre tabindex=0><code>$ sudo nano /etc/ansible/playbooks/packages-redhat-2.yml

---
- hosts: web
  become: yes
  name: &#34;Install a List of Packages on Red Hat Based System&#34;
  vars:
     packages: [ &#39;curl&#39;, &#39;git&#39;, &#39;htop&#39; ]
  tasks:
     - name: Install a list of packages
       yum: name={{ item }} state=latest
       with_items: &#34;{{ packages }}&#34;
</code></pre><h3 id=剧本-4在-linux-系统上安装更新>剧本-4：在 Linux 系统上安装更新</h3><p>这个示例剧本允许你在基于 Red Hat 或 Debian 的 Linux 系统上安装更新。</p><pre tabindex=0><code>$ sudo nano /etc/ansible/playbooks/security-update.yml

---
- hosts: web
  become: yes
  name: &#34;Install Security Update&#34;
  tasks:
    - name: &#34;Installing Security Update on Red Hat Based System&#34;
      yum: name=* update_cache=yes security=yes state=latest
      when: ansible_facts[&#39;distribution&#39;] == &#34;CentOS&#34;

    - name: &#34;Installing Security Update on Ubuntu Based System&#34;
      apt: upgrade=dist update_cache=yes
      when: ansible_facts[&#39;distribution&#39;] == &#34;Ubuntu&#34;
</code></pre><hr><p>via: <a href=https://www.2daygeek.com/ansible-playbooks-quick-start-guide-with-examples/>https://www.2daygeek.com/ansible-playbooks-quick-start-guide-with-examples/</a></p><p>作者：<a href=https://www.2daygeek.com/author/magesh/>Magesh Maruthamuthu</a> 选题：<a href=https://github.com/lujun9972>lujun9972</a> 译者：<a href=https://github.com/MjSeven>MjSeven</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/ansible/ rel=tag>Ansible</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>