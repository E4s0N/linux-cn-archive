<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>RHCE 系列（五）：如何在 RHEL 7 中管理系统日志（配置、轮换以及导入到数据库） - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="RHCE 系列（五）：如何在 RHEL 7 中管理系统日志（配置、轮换以及导入到数据库）"><meta property="og:description" content="为了确保你的 RHEL 7 系统安全，你需要通过查看日志文件来监控系统中发生的所有活动。这样，你就可以检测到任何不正常或有潜在破坏的活动并进行系统故障排除或者其它恰当的操作。  RHCE 考试 - 第五部分：使用 Rsyslog 和 Logrotate 管理系统日志 在 RHEL 7 中，rsyslogd 守护进程负责系统日志，它从 /etc/rsyslog.conf（该文件指定所有系统日志的默认路径）和 /etc/rsyslog.d 中的所有文件（如果有的话）读取配置信息。 Rsyslogd 配置 快速浏览一下 rsyslog.conf 会是一个好的开端。该文件分为 3 个主要部分：模块（rsyslong 按照模块化"><meta property="og:type" content="article"><meta property="og:url" content="/article-6531-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-11-06T09:53:00+00:00"><meta property="article:modified_time" content="2015-11-06T09:53:00+00:00"><meta itemprop=name content="RHCE 系列（五）：如何在 RHEL 7 中管理系统日志（配置、轮换以及导入到数据库）"><meta itemprop=description content="为了确保你的 RHEL 7 系统安全，你需要通过查看日志文件来监控系统中发生的所有活动。这样，你就可以检测到任何不正常或有潜在破坏的活动并进行系统故障排除或者其它恰当的操作。  RHCE 考试 - 第五部分：使用 Rsyslog 和 Logrotate 管理系统日志 在 RHEL 7 中，rsyslogd 守护进程负责系统日志，它从 /etc/rsyslog.conf（该文件指定所有系统日志的默认路径）和 /etc/rsyslog.d 中的所有文件（如果有的话）读取配置信息。 Rsyslogd 配置 快速浏览一下 rsyslog.conf 会是一个好的开端。该文件分为 3 个主要部分：模块（rsyslong 按照模块化"><meta itemprop=datePublished content="2015-11-06T09:53:00+00:00"><meta itemprop=dateModified content="2015-11-06T09:53:00+00:00"><meta itemprop=wordCount content="265"><meta itemprop=keywords content="RHCE,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>RHCE 系列（五）：如何在 RHEL 7 中管理系统日志（配置、轮换以及导入到数据库）</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2015-11-06T09:53:00Z>November 06, 2015</time></div></div></header><div class="content post__content clearfix"><p>为了确保你的 RHEL 7 系统安全，你需要通过查看日志文件来监控系统中发生的所有活动。这样，你就可以检测到任何不正常或有潜在破坏的活动并进行系统故障排除或者其它恰当的操作。</p><p><img src=/data/attachment/album/201511/05/125611y2uyy9mmozzuyv7m.jpg alt="Linux 中使用 Rsyslog 和 Logrotate 轮换日志文件"></p><p><em>RHCE 考试 - 第五部分：使用 Rsyslog 和 Logrotate 管理系统日志</em></p><p>在 RHEL 7 中，<a href=http://www.tecmint.com/wp-content/pdf/rsyslogd.pdf>rsyslogd</a> 守护进程负责系统日志，它从 /etc/rsyslog.conf（该文件指定所有系统日志的默认路径）和 /etc/rsyslog.d 中的所有文件（如果有的话）读取配置信息。</p><h3 id=rsyslogd-配置>Rsyslogd 配置</h3><p>快速浏览一下 <a href=http://www.tecmint.com/wp-content/pdf/rsyslog.conf.pdf>rsyslog.conf</a> 会是一个好的开端。该文件分为 3 个主要部分：模块（rsyslong 按照模块化设计），全局指令（用于设置 rsyslogd 守护进程的全局属性），以及规则。正如你可能猜想的，最后一个部分指示记录或显示什么以及在哪里保存（也称为 选择子 （ selector ） ），这也是这篇文章关注的重点。</p><p>rsyslog.conf 中典型的一行如下所示：</p><p><img src=/data/attachment/album/201511/05/125612ccuxx237l1lbmaxj.png alt="Rsyslogd 配置"></p><p><em>Rsyslogd 配置</em></p><p>在上面的图片中，我们可以看到一个选择子包括了一个或多个用分号分隔的 “设备:优先级” （ Facility:Priority ） 对，其中设备描述了消息类型（参考 <a href=https://tools.ietf.org/html/rfc3164#section-4.1.1>RFC 3164 4.1.1 章节</a>，查看 rsyslog 可用的完整设备列表），优先级指示它的严重性，这可能是以下几种之一：</p><ul><li>debug</li><li>info</li><li>notice</li><li>warning</li><li>err</li><li>crit</li><li>alert</li><li>emerg</li></ul><p>尽管 none 并不是一个优先级，不过它意味着指定设备没有任何优先级。</p><p><strong>注意</strong>：给定一个优先级表示该优先级以及之上的消息都应该记录到日志中。因此，上面例子中的行指示 rsyslogd 守护进程记录所有优先级为 info 以及以上（不管是什么设备）的除了属于 mail、authpriv、以及 cron 服务（不考虑来自这些设备的消息）的消息到 /var/log/messages。</p><p>你也可以使用逗号将多个设备分为一组，对同组中的设备使用相同的优先级。例如下面这行：</p><pre tabindex=0><code>*.info;mail.none;authpriv.none;cron.none                /var/log/messages
</code></pre><p>也可以这样写：</p><pre tabindex=0><code>*.info;mail,authpriv,cron.none                /var/log/messages
</code></pre><p>换句话说，mail、authpriv 以及 cron 被分为一组，并使用关键字 none。</p><h4 id=创建自定义日志文件>创建自定义日志文件</h4><p>要把所有的守护进程消息记录到 /var/log/tecmint.log，我们需要在 rsyslog.conf 或者 /etc/rsyslog.d 目录中的单独文件（这样易于管理）添加下面一行：</p><pre tabindex=0><code>daemon.*    /var/log/tecmint.log
</code></pre><p>然后重启守护进程（注意服务名称不以 d 结尾）：</p><pre tabindex=0><code># systemctl restart rsyslog
</code></pre><p>在随便重启两个守护进程之前和之后查看下自定义日志的内容：</p><p><img src=/data/attachment/album/201511/05/125616hozb920700x1wbou.png alt="Linux 创建自定义日志文件"></p><p><em>创建自定义日志文件</em></p><p>作为一个自学练习，我建议你重点关注设备和优先级，添加额外的消息到已有的日志文件或者像上面那样创建一个新的日志文件。</p><h3 id=使用-logrotate-轮换日志>使用 Logrotate 轮换日志</h3><p>为了防止日志文件无限制增长，logrotate 工具用于轮换、压缩、移除或者通过电子邮件发送日志，从而减轻管理会产生大量日志文件系统的困难。（译者注：<a href=https://en.wikipedia.org/wiki/Log_rotation>日志轮换</a>（rotate）是系统管理中归档每天产生的日志文件的自动化过程）</p><p>Logrotate 作为一个 cron 任务（/etc/cron.daily/logrotate）每天运行，并从 /etc/logrotate.conf 和 /etc/logrotate.d 中的文件（如果有的话）读取配置信息。</p><p>对于 rsyslog，即使你可以在主文件中为指定服务包含设置，为每个服务创建单独的配置文件能帮助你更好地组织设置。</p><p>让我们来看一个典型的 logrotate.conf：</p><p><img src=/data/attachment/album/201511/05/125622lti103gx7kk33pgi.png alt="Logrotate 配置"></p><p><em>Logrotate 配置</em></p><p>在上面的例子中，logrotate 会为 /var/log/wtmp 进行以下操作：尝试每个月轮换一次，但至少文件要大于 1MB，然后用 0664 权限、用户 root、组 utmp 创建一个新的日志文件。下一步只保存一个归档日志，正如轮换指令指定的：</p><p><img src=/data/attachment/album/201511/05/125623lraxnglzd2d32d62.png alt="每月 Logrotate 日志"></p><p><em>每月 Logrotate 日志</em></p><p>让我们再来看看 /etc/logrotate.d/httpd 中的另一个例子：</p><p><img src=/data/attachment/album/201511/05/125627v2ghs5p1pppp1pi1.png alt="轮换 Apache 日志文件"></p><p><em>轮换 Apache 日志文件</em></p><p>你可以在 logrotate 的 man 手册（<a href=http://www.tecmint.com/wp-content/pdf/logrotate.pdf>man logrotate</a> 和 <a href=http://www.tecmint.com/wp-content/pdf/logrotate.conf.pdf>man logrotate.conf</a>）中阅读更多有关它的设置。为了方便你的阅读，本文还提供了两篇文章的 PDF 格式。</p><p>作为一个系统工程师，很可能由你决定多久按照什么格式保存一次日志，这取决于你是否有一个单独的分区/逻辑卷给 <code>/var</code>。否则，你真的要考虑删除旧日志以节省存储空间。另一方面，根据你公司和客户内部的政策，为了以后的安全审核，你可能必须要保留多个日志。</p><h4 id=保存日志到数据库>保存日志到数据库</h4><p>当然检查日志可能是一个很繁琐的工作（即使有类似 grep 工具和正则表达式的帮助）。因为这个原因，rsyslog 允许我们把它们导出到数据库（OTB 支持的关系数据库管理系统包括 MySQL、MariaDB、PostgreSQL 和 Oracle 等）。</p><p>指南的这部分假设你已经在要管理日志的 RHEL 7 上安装了 MariaDB 服务器和客户端：</p><pre tabindex=0><code># yum update &amp;&amp; yum install mariadb mariadb-server mariadb-client rsyslog-mysql
# systemctl enable mariadb &amp;&amp; systemctl start mariadb
</code></pre><p>然后使用 <code>mysql_secure_installation</code> 工具为 root 用户设置密码以及其它安全考量：</p><p><img src=/data/attachment/album/201511/05/125629xsi14yo1k12y4mi5.png alt="保证 MySQL 数据库安全"></p><p><em>保证 MySQL 数据库安全</em></p><p>注意：如果你不想用 MariaDB root 用户插入日志消息到数据库，你也可以配置用另一个用户账户。如何实现的介绍已经超出了本文的范围，但在 <a href=https://mariadb.com/kb/en/mariadb/create-user/>MariaDB 知识</a> 中有详细解析。为了简单在这篇指南中我们会使用 root 账户。</p><p>下一步，从 <a href=https://github.com/sematext/rsyslog/blob/master/plugins/ommysql/createDB.sql>GitHub</a> 下载 createDB.sql 脚本并导入到你的数据库服务器：</p><pre tabindex=0><code># mysql -u root -p &lt; createDB.sql
</code></pre><p><img src=/data/attachment/album/201511/05/125633a2ad02ldaab2hppp.png alt=保存服务器日志到数据库></p><p><em>保存服务器日志到数据库</em></p><p>最后，添加下面的行到 /etc/rsyslog.conf：</p><pre tabindex=0><code>$ModLoad ommysql
$ActionOmmysqlServerPort 3306
*.* :ommysql:localhost,Syslog,root,YourPasswordHere
</code></pre><p>重启 rsyslog 和数据库服务器：</p><pre tabindex=0><code># systemctl restart rsyslog 
# systemctl restart mariadb
</code></pre><h4 id=使用-sql-语法查询日志>使用 SQL 语法查询日志</h4><p>现在执行一些会改变日志的操作（例如停止和启动服务），然后登录到你的数据库服务器并使用标准的 SQL 命令显示和查询日志：</p><pre tabindex=0><code>USE Syslog;
SELECT ReceivedAt, Message FROM SystemEvents;
</code></pre><p><img src=/data/attachment/album/201511/05/125637h5dmcmpi5aomeum4.png alt=在数据库中查询日志></p><p><em>在数据库中查询日志</em></p><h3 id=总结>总结</h3><p>在这篇文章中我们介绍了如何设置系统日志，如果轮换日志以及为了简化查询如何重定向消息到数据库。我们希望这些技巧能对你准备 <a href=/article-6451-1.html>RHCE 考试</a> 和日常工作有所帮助。</p><p>正如往常，非常欢迎你的反馈。用下面的表单和我们联系吧。</p><hr><p>via: <a href=http://www.tecmint.com/manage-linux-system-logs-using-rsyslogd-and-logrotate/>http://www.tecmint.com/manage-linux-system-logs-using-rsyslogd-and-logrotate/</a></p><p>作者：<a href=http://www.tecmint.com/author/gacanepa/>Gabriel Cánepa</a> 译者：<a href=http://www.mutouxiaogui.cn/blog/>ictlyh</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创翻译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/rhce/ rel=tag>RHCE</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>