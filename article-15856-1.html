<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>如何在 RHEL 9/8 上设置高可用性 Apache（HTTP）集群 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="如何在 RHEL 9/8 上设置高可用性 Apache（HTTP）集群"><meta property="og:description" content="在本文中，我们将介绍如何在 RHEL 9/8 上使用 Pacemaker 设置两节点高可用性 Apache 集群。"><meta property="og:type" content="article"><meta property="og:url" content="/article-15856-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-29T17:28:00+00:00"><meta property="article:modified_time" content="2023-05-29T17:28:00+00:00"><meta itemprop=name content="如何在 RHEL 9/8 上设置高可用性 Apache（HTTP）集群"><meta itemprop=description content="在本文中，我们将介绍如何在 RHEL 9/8 上使用 Pacemaker 设置两节点高可用性 Apache 集群。"><meta itemprop=datePublished content="2023-05-29T17:28:00+00:00"><meta itemprop=dateModified content="2023-05-29T17:28:00+00:00"><meta itemprop=wordCount content="552"><meta itemprop=keywords content="集群,Pacemaker,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>如何在 RHEL 9/8 上设置高可用性 Apache（HTTP）集群</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2023-05-29T17:28:00Z>May 29, 2023</time></div></div></header><div class="content post__content clearfix"><p><img src=https://img.linux.net.cn/data/attachment/album/202305/29/172810i24a4jppa4744avv.jpg alt></p><blockquote><p>在本文中，我们将介绍如何在 RHEL 9/8 上使用 Pacemaker 设置两节点高可用性 Apache 集群。</p></blockquote><p>Pacemaker 是适用于类 Linux 操作系统的高可用性集群软件。Pacemaker 被称为“集群资源管理器”，它通过在集群节点之间进行资源故障转移来提供集群资源的最大可用性。Pacemaker 使用 Corosync 进行集群组件之间的心跳和内部通信，Corosync 还负责集群中的投票选举（Quorum）。</p><h3 id=先决条件>先决条件</h3><p>在我们开始之前，请确保你拥有以下内容：</p><ul><li>两台 RHEL 9/8 服务器</li><li>Red Hat 订阅或本地配置的仓库</li><li>通过 SSH 访问两台服务器</li><li>root 或 sudo 权限</li><li>互联网连接</li></ul><h3 id=实验室详情>实验室详情：</h3><ul><li>服务器 1：<a href=http://node1.example.com>node1.example.com</a>（192.168.1.6）</li><li>服务器 2：<a href=http://node2.exaple.com>node2.exaple.com</a>（192.168.1.7）</li><li>VIP：192.168.1.81</li><li>共享磁盘：<code>/dev/sdb</code>（2GB）</li></ul><p>事不宜迟，让我们深入了解这些步骤。</p><h3 id=1更新-etchosts-文件>1、更新 /etc/hosts 文件</h3><p>在两个节点上的 <code>/etc/hosts</code> 文件中添加以下条目：</p><pre tabindex=0><code>192.168.1.6  node1.example.com
192.168.1.7  node2.example.com
</code></pre><h3 id=2安装高可用包-pacemaker>2、安装高可用包 Pacemaker</h3><p>Pacemaker 和其他必需的包在 RHEL 9/8 的默认包仓库中不可用。因此，我们必须启用高可用仓库。在两个节点上运行以下订阅管理器命令。</p><p>对于 RHEL 9 服务器：</p><pre tabindex=0><code>$ sudo subscription-manager repos --enable=rhel-9-for-x86_64-highavailability-rpms
</code></pre><p>对于 RHEL 8 服务器：</p><pre tabindex=0><code>$ sudo subscription-manager repos --enable=rhel-8-for-x86_64-highavailability-rpms
</code></pre><p>启用仓库后，运行命令在两个节点上安装 <code>pacemaker</code> 包：</p><pre tabindex=0><code>$ sudo dnf install pcs pacemaker fence-agents-all -y
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/202305/29/173049abnmgf6zg73gbm1w.jpg alt></p><h3 id=3在防火墙中允许高可用端口>3、在防火墙中允许高可用端口</h3><p>要允许防火墙中的高可用端口，请在每个节点上运行以下命令：</p><pre tabindex=0><code>$ sudo firewall-cmd --permanent --add-service=high-availability
$ sudo firewall-cmd --reload
</code></pre><h3 id=4为-hacluster-用户设置密码并启动-pcsd-服务>4、为 hacluster 用户设置密码并启动 pcsd 服务</h3><p>在两台服务器上为 <code>hacluster</code> 用户设置密码，运行以下 <code>echo</code> 命令：</p><pre tabindex=0><code>$ echo &#34;&lt;Enter-Password&gt;&#34; | sudo passwd --stdin hacluster
</code></pre><p>执行以下命令在两台服务器上启动并启用集群服务：</p><pre tabindex=0><code>$ sudo systemctl start pcsd.service
$ sudo systemctl enable pcsd.service
</code></pre><h3 id=5创建高可用集群>5、创建高可用集群</h3><p>使用 <code>pcs</code> 命令对两个节点进行身份验证，从任何节点运行以下命令。在我的例子中，我在 <code>node1</code> 上运行它：</p><pre tabindex=0><code>$ sudo pcs host auth node1.example.com node2.example.com
</code></pre><p>使用 <code>hacluster</code> 用户进行身份验证。</p><p><img src=https://img.linux.net.cn/data/attachment/album/202305/29/173101ngnfgtqfftxgvxpy.jpg alt></p><p>使用下面的 <code>pcs cluster setup</code> 命令将两个节点添加到集群，这里我使用的集群名称为 <code>http_cluster</code>。仅在 <code>node1</code> 上运行命令：</p><pre tabindex=0><code>$ sudo pcs cluster setup http_cluster --start node1.example.com node2.example.com
$ sudo pcs cluster enable --all
</code></pre><p>这两个命令的输出如下所示：</p><p><img src=https://img.linux.net.cn/data/attachment/album/202305/29/173111q58q3f5gs2glz2iq.jpg alt></p><p>从任何节点验证初始集群状态：</p><pre tabindex=0><code>$ sudo pcs cluster status
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/202305/29/173349qavgniatgnnwo6qi.jpg alt></p><p>注意：在我们的实验室中，我们没有任何防护设备，因此我们将其禁用。但在生产环境中，强烈建议配置防护。</p><pre tabindex=0><code>$ sudo pcs property set stonith-enabled=false
$ sudo pcs property set no-quorum-policy=ignore
</code></pre><h3 id=6为集群配置共享卷>6、为集群配置共享卷</h3><p>在服务器上，挂载了一个大小为 2GB 的共享磁盘（<code>/dev/sdb</code>）。因此，我们将其配置为 LVM 卷并将其格式化为 XFS 文件系统。</p><p>在开始创建 LVM 卷之前，编辑两个节点上的 <code>/etc/lvm/lvm.conf</code> 文件。</p><p>将参数 <code>#system_id_source = "none"</code> 更改为 <code>system_id_source = "uname"</code>：</p><pre tabindex=0><code>$ sudo sed -i &#39;s/# system_id_source = &#34;none&#34;/ system_id_source = &#34;uname&#34;/g&#39; /etc/lvm/lvm.conf
</code></pre><p>在 <code>node1</code> 上依次执行以下一组命令创建 LVM 卷：</p><pre tabindex=0><code>$ sudo pvcreate /dev/sdb
$ sudo vgcreate --setautoactivation n vg01 /dev/sdb
$ sudo lvcreate -L1.99G -n lv01 vg01
$ sudo lvs /dev/vg01/lv01
$ sudo mkfs.xfs /dev/vg01/lv01
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/202305/29/173411j50z7o964b0s6s40.jpg alt></p><p>将共享设备添加到集群第二个节点（<code>node2.example.com</code>）上的 LVM 设备文件中，仅在 <code>node2</code> 上运行以下命令：</p><pre tabindex=0><code>[sysops@node2 ~]$ sudo lvmdevices --adddev /dev/sdb
</code></pre><h3 id=7安装和配置-apache-web-服务器httpd>7、安装和配置 Apache Web 服务器（httpd）</h3><p>在两台服务器上安装 Apache web 服务器（httpd)，运行以下 <code>dnf</code> 命令：</p><pre tabindex=0><code>$ sudo dnf install -y httpd wget
</code></pre><p>并允许防火墙中的 Apache 端口，在两台服务器上运行以下 <code>firewall-cmd</code> 命令：</p><pre tabindex=0><code>$ sudo firewall-cmd --permanent --zone=public --add-service=http
$ sudo firewall-cmd --permanent --zone=public --add-service=https
$ sudo firewall-cmd --reload
</code></pre><p>在两个节点上创建 <code>status.conf</code> 文件，以便 Apache 资源代理获取 Apache 的状态：</p><pre tabindex=0><code>$ sudo bash -c &#39;cat &lt;&lt;-END &gt; /etc/httpd/conf.d/status.conf
&lt;Location /server-status&gt;
    SetHandler server-status
    Require local
&lt;/Location&gt;
END&#39;
$
</code></pre><p>修改两个节点上的 <code>/etc/logrotate.d/httpd</code>：</p><p>替换下面的行</p><pre tabindex=0><code>/bin/systemctl reload httpd.service &gt; /dev/null 2&gt;/dev/null || true
</code></pre><p>为</p><pre tabindex=0><code>/usr/bin/test -f /run/httpd.pid &gt;/dev/null 2&gt;/dev/null &amp;&amp;
/usr/bin/ps -q $(/usr/bin/cat /run/httpd.pid) &gt;/dev/null 2&gt;/dev/null &amp;&amp;
/usr/sbin/httpd -f /etc/httpd/conf/httpd.conf \
-c &#34;PidFile /run/httpd.pid&#34; -k graceful &gt; /dev/null 2&gt;/dev/null || true
</code></pre><p>保存并退出文件。</p><p><img src=https://img.linux.net.cn/data/attachment/album/202305/29/173439emr4ui8uf8rm8wzc.jpg alt></p><h3 id=8为-apache-创建一个示例网页>8、为 Apache 创建一个示例网页</h3><p>仅在 <code>node1</code> 上执行以下命令：</p><pre tabindex=0><code>$ sudo lvchange -ay vg01/lv01
$ sudo mount /dev/vg01/lv01 /var/www/
$ sudo mkdir /var/www/html
$ sudo mkdir /var/www/cgi-bin
$ sudo mkdir /var/www/error
$ sudo bash -c &#39; cat &lt;&lt;-END &gt;/var/www/html/index.html
&lt;html&gt;
&lt;body&gt;High Availability Apache Cluster - Test Page &lt;/body&gt;
&lt;/html&gt;
END&#39;
$
$ sudo umount /var/www
</code></pre><p>注意：如果启用了 SElinux，则在两台服务器上运行以下命令：</p><pre tabindex=0><code>$ sudo restorecon -R /var/www
</code></pre><h3 id=9创建集群资源和资源组>9、创建集群资源和资源组</h3><p>为集群定义资源组和集群资源。在我的例子中，我们使用 <code>webgroup</code> 作为资源组。</p><ul><li><code>web_lvm</code> 是共享 LVM 卷的资源名称（<code>/dev/vg01/lv01</code>）</li><li><code>web_fs</code> 是将挂载在 <code>/var/www</code> 上的文件系统资源的名称</li><li><code>VirtualIP</code> 是网卡 <code>enp0s3</code> 的 VIP（<code>IPadd2</code>）资源</li><li><code>Website</code> 是 Apache 配置文件的资源。</li></ul><p>从任何节点执行以下命令集。</p><pre tabindex=0><code>$ sudo pcs resource create web_lvm ocf:heartbeat:LVM-activate vgname=vg01 vg_access_mode=system_id --group webgroup
$ sudo pcs resource create web_fs Filesystem device=&#34;/dev/vg01/lv01&#34; directory=&#34;/var/www&#34; fstype=&#34;xfs&#34; --group webgroup
$ sudo pcs resource create VirtualIP IPaddr2 ip=192.168.1.81 cidr_netmask=24 nic=enp0s3 --group webgroup
$ sudo pcs resource create Website apache configfile=&#34;/etc/httpd/conf/httpd.conf&#34; statusurl=&#34;http://127.0.0.1/server-status&#34; --group webgroup
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/202305/29/173458gcpjkcz01sgpzv0c.jpg alt></p><p>现在验证集群资源状态，运行：</p><pre tabindex=0><code>$ sudo pcs status
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/202305/29/173515q3kkq5295zy9kh5y.jpg alt></p><p>很好，上面的输出显示所有资源都在 <code>node1</code> 上启动。</p><h3 id=10测试-apache-集群>10、测试 Apache 集群</h3><p>尝试使用 VIP（192.168.1.81）访问网页。</p><p>使用 <code>curl</code> 命令或网络浏览器访问网页：</p><pre tabindex=0><code>$ curl http://192.168.1.81
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/202305/29/173530i9dpgee7h8dpy7lg.jpg alt></p><p>或者</p><p><img src=https://img.linux.net.cn/data/attachment/album/202305/29/173540oe1kuy28yz1fyege.jpg alt></p><p>完美！以上输出确认我们能够访问我们高可用 Apache 集群的网页。</p><p>让我们尝试将集群资源从 <code>node1</code> 移动到 <code>node2</code>，运行：</p><pre tabindex=0><code>$ sudo pcs node standby node1.example.com
$ sudo pcs status
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/202305/29/173550mc7hkygbkdtd77th.jpg alt></p><p>完美，以上输出确认集群资源已从 <code>node1</code> 迁移到 <code>node2</code>。</p><p>要从备用节点（<code>node1.example.com</code>）中删除节点，运行以下命令：</p><pre tabindex=0><code>$ sudo pcs node unstandby node1.example.com
</code></pre><p><img src=https://img.linux.net.cn/data/attachment/album/202305/29/173601nzg634au4jgd8g82.jpg alt></p><p>以上就是这篇文章的全部内容，我希望你发现它提供了丰富的信息，请在下面的评论部分中发表你的疑问和反馈。</p><p><em>（题图：MJ/3bf8c775-72ed-4e44-a28d-c872c7c8632f）</em></p><hr><p>via: <a href=https://www.linuxtechi.com/high-availability-apache-cluster-on-rhel/>https://www.linuxtechi.com/high-availability-apache-cluster-on-rhel/</a></p><p>作者：<a href=https://www.linuxtechi.com/author/pradeep/>Pradeep Kumar</a> 选题：<a href=https://github.com/lkxed/>lkxed</a> 译者：<a href=https://github.com/geekpi>geekpi</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/%E9%9B%86%E7%BE%A4/ rel=tag>集群</a></li><li class=tags__item><a class="tags__link btn" href=/tags/pacemaker/ rel=tag>Pacemaker</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>