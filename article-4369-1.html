<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>如何在 Linux 系统中创建一个云端加密文件系统 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="如何在 Linux 系统中创建一个云端加密文件系统"><meta property="og:description" content="Amazon S3 和 Google Cloud Storage 之类的商业云存储服务以能承受的价格提供了高可用性、可扩展、无限容量的对象存储服务。为了加速这些云产品的广泛采用，这些提供商为他们的产品通过明确的 API 和 SDK 培养了一个良好的开发者生态系统。而基于云的文件系统便是这些活跃的开发者社区中的典型产品，已经有了好几个开源的实现。 S3QL 便是最流行的开源云端文件系统之一。它是一个基于 FUSE 的文件系统，提供了好几个商业或开源的云存储后端，比如 Amazon S3、Google Cloud Storage、Rackspace CloudFiles，还有 OpenStack。作为一个功能完"><meta property="og:type" content="article"><meta property="og:url" content="/article-4369-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2014-12-03T21:49:06+00:00"><meta property="article:modified_time" content="2014-12-03T21:49:06+00:00"><meta itemprop=name content="如何在 Linux 系统中创建一个云端加密文件系统"><meta itemprop=description content="Amazon S3 和 Google Cloud Storage 之类的商业云存储服务以能承受的价格提供了高可用性、可扩展、无限容量的对象存储服务。为了加速这些云产品的广泛采用，这些提供商为他们的产品通过明确的 API 和 SDK 培养了一个良好的开发者生态系统。而基于云的文件系统便是这些活跃的开发者社区中的典型产品，已经有了好几个开源的实现。 S3QL 便是最流行的开源云端文件系统之一。它是一个基于 FUSE 的文件系统，提供了好几个商业或开源的云存储后端，比如 Amazon S3、Google Cloud Storage、Rackspace CloudFiles，还有 OpenStack。作为一个功能完"><meta itemprop=datePublished content="2014-12-03T21:49:06+00:00"><meta itemprop=dateModified content="2014-12-03T21:49:06+00:00"><meta itemprop=wordCount content="313"><meta itemprop=keywords content="S3QL,文件系统,云服务,Amazon,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>如何在 Linux 系统中创建一个云端加密文件系统</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2014-12-03T21:49:06Z>December 03, 2014</time></div></div></header><div class="content post__content clearfix"><p><a href=http://aws.amazon.com/s3>Amazon S3</a> 和 <a href=http://code.google.com/apis/storage/>Google Cloud Storage</a> 之类的商业云存储服务以能承受的价格提供了高可用性、可扩展、无限容量的对象存储服务。为了加速这些云产品的广泛采用，这些提供商为他们的产品通过明确的 API 和 SDK 培养了一个良好的开发者生态系统。而基于云的文件系统便是这些活跃的开发者社区中的典型产品，已经有了好几个开源的实现。</p><p><a href=https://bitbucket.org/nikratio/s3ql/>S3QL</a> 便是最流行的开源云端文件系统之一。它是一个基于 FUSE 的文件系统，提供了好几个商业或开源的云存储后端，比如 Amazon S3、Google Cloud Storage、Rackspace CloudFiles，还有 OpenStack。作为一个功能完整的文件系统，S3QL 拥有不少强大的功能：最大 2T 的文件大小、压缩、UNIX 属性、加密、基于写入时复制的快照、不可变树、重复数据删除，以及软、硬链接支持等等。写入 S3QL 文件系统任何数据都将首先被本地压缩、加密，之后才会传输到云后端。当你试图从 S3QL 文件系统中取出内容的时候，如果它们不在本地缓存中，相应的对象会从云端下载回来，然后再即时地解密、解压缩。</p><p><img src=/data/attachment/album/201412/03/214908zv11ioidj8ikxzxa.png alt></p><p>需要明确的是，S3QL 的确也有它的限制。比如，你不能把同一个 S3FS 文件系统在几个不同的电脑上同时挂载，只能有一台电脑同时访问它。另外，ACL（访问控制列表）也并没有被支持。</p><p>在这篇教程中，我将会描述“如何基于 Amazon S3 用 S3QL 配置一个加密文件系统”。作为一个使用范例，我还会说明如何在挂载的 S3QL 文件系统上运行 rsync 备份工具。</p><h3 id=准备工作>准备工作</h3><p>本教程首先需要你创建一个 <a href=http://aws.amazon.com/>Amazon AWS 帐号</a>（注册是免费的，但是需要一张有效的信用卡）。</p><p>然后 <a href=http://aws.amazon.com/>创建一个 AWS access key</a>（access key ID 和 secret access key），S3QL 使用这些信息来访问你的 AWS 帐号。</p><p>之后通过 AWS 管理面板访问 AWS S3，并为 S3QL 创建一个新的空 bucket。</p><p><img src=/data/attachment/album/201412/03/214915cgrbcl4ji0x04jgs.jpg alt></p><p>为最佳性能考虑，请选择一个地理上距离你最近的区域。</p><p><img src=/data/attachment/album/201412/03/214917bfgjyjd87zzrprgt.jpg alt></p><h3 id=在-linux-上安装-s3ql>在 Linux 上安装 S3QL</h3><p>在大多数 Linux 发行版中都有预先编译好的 S3QL 软件包。</p><h4 id=对于-debianubuntu-或-linux-mint>对于 Debian、Ubuntu 或 Linux Mint：</h4><pre tabindex=0><code>$ sudo apt-get install s3ql
</code></pre><h4 id=对于-fedora>对于 Fedora：</h4><pre tabindex=0><code>$ sudo yum install s3ql
</code></pre><p>对于 Arch Linux，使用 <a href=https://aur.archlinux.org/packages/s3ql/>AUR</a>。</p><h3 id=首次配置-s3ql>首次配置 S3QL</h3><p>在 ~/.s3ql 目录中创建 autoinfo2 文件，它是 S3QL 的一个默认的配置文件。这个文件里的信息包括必须的 AWS access key，S3 bucket 名，以及加密口令。这个加密口令将被用来加密一个随机生成的主密钥，而主密钥将被用来实际地加密 S3QL 文件系统数据。</p><pre tabindex=0><code>$ mkdir ~/.s3ql
$ vi ~/.s3ql/authinfo2
</code></pre><hr><pre tabindex=0><code>[s3]
storage-url: s3://[bucket-name]
backend-login: [your-access-key-id]
backend-password: [your-secret-access-key]
fs-passphrase: [your-encryption-passphrase]
</code></pre><p>指定的 AWS S3 bucket 需要预先通过 AWS 管理面板来创建。</p><p>为了安全起见，让 authinfo2 文件仅对你可访问。</p><pre tabindex=0><code>$ chmod 600 ~/.s3ql/authinfo2
</code></pre><h3 id=创建-s3ql-文件系统>创建 S3QL 文件系统</h3><p>现在你已经准备好可以在 AWS S3 上创建一个 S3QL 文件系统了。</p><p>使用 mkfs.s3ql 工具来创建一个新的 S3QL 文件系统。这个命令中的 bucket 名应该与 authinfo2 文件中所指定的相符。使用“&ndash;ssl”参数将强制使用 SSL 连接到后端存储服务器。默认情况下，mkfs.s3ql 命令会在 S3QL 文件系统中启用压缩和加密。</p><pre tabindex=0><code>$ mkfs.s3ql s3://[bucket-name] --ssl
</code></pre><p>你会被要求输入一个加密口令。请输入你在 ~/.s3ql/autoinfo2 中通过“fs-passphrase”指定的那个口令。</p><p>如果一个新文件系统被成功创建，你将会看到这样的输出：</p><p><img src=/data/attachment/album/201412/03/214924tcexnjy1efyzy8cx.jpg alt></p><h3 id=挂载-s3ql-文件系统>挂载 S3QL 文件系统</h3><p>当你创建了一个 S3QL 文件系统之后，下一步便是要挂载它。</p><p>首先创建一个本地的挂载点，然后使用 mount.s3ql 命令来挂载 S3QL 文件系统。</p><pre tabindex=0><code>$ mkdir ~/mnt_s3ql
$ mount.s3ql s3://[bucket-name] ~/mnt_s3ql
</code></pre><p>挂载一个 S3QL 文件系统不需要特权用户，只要确定你对该挂载点有写权限即可。</p><p>视情况，你可以使用“&ndash;compress”参数来指定一个压缩算法（如 lzma、bzip2、zlib）。在不指定的情况下，lzma 将被默认使用。注意如果你指定了一个自定义的压缩算法，它将只会应用到新创建的数据对象上，并不会影响已经存在的数据对象。</p><pre tabindex=0><code>$ mount.s3ql --compress bzip2 s3://[bucket-name] ~/mnt_s3ql
</code></pre><p>因为性能原因，S3QL 文件系统维护了一份本地文件缓存，里面包括了最近访问的（部分或全部的）文件。你可以通过“&ndash;cachesize”和“&ndash;max-cache-entries”选项来自定义文件缓存的大小。</p><p>如果想要除你以外的用户访问一个已挂载的 S3QL 文件系统，请使用“&ndash;allow-other”选项。</p><p>如果你想通过 NFS 导出已挂载的 S3QL 文件系统到其他机器，请使用“&ndash;nfs”选项。</p><p>运行 mount.s3ql 之后，检查 S3QL 文件系统是否被成功挂载了：</p><pre tabindex=0><code>$ df ~/mnt_s3ql
$ mount | grep s3ql
</code></pre><p><img src=/data/attachment/album/201412/03/214927nqqfjj82u6jqqv3z.jpg alt></p><h3 id=卸载-s3ql-文件系统>卸载 S3QL 文件系统</h3><p>想要安全地卸载一个（可能含有未提交数据的）S3QL 文件系统，请使用 umount.s3ql 命令。它将会等待所有数据（包括本地文件系统缓存中的部分）成功传输到后端服务器。取决于等待写的数据的多少，这个过程可能需要一些时间。</p><pre tabindex=0><code>$ umount.s3ql ~/mnt_s3ql
</code></pre><h3 id=查看-s3ql-文件系统统计信息及修复-s3ql-文件系统>查看 S3QL 文件系统统计信息及修复 S3QL 文件系统</h3><p>若要查看 S3QL 文件系统统计信息，你可以使用 s3qlstat 命令，它将会显示诸如总的数据、元数据大小、重复文件删除率和压缩率等信息。</p><pre tabindex=0><code>$ s3qlstat ~/mnt_s3ql
</code></pre><p><img src=/data/attachment/album/201412/03/214929zyu08ukyme4r2x80.jpg alt></p><p>你可以使用 fsck.s3ql 命令来检查和修复 S3QL 文件系统。与 fsck 命令类似，待检查的文件系统必须首先被卸载。</p><pre tabindex=0><code>$ fsck.s3ql s3://[bucket-name]
</code></pre><h3 id=s3ql-使用案例rsync-备份>S3QL 使用案例：Rsync 备份</h3><p>让我用一个流行的使用案例来结束这篇教程：本地文件系统备份。为此，我推荐使用 rsync 增量备份工具，特别是因为 S3QL 提供了一个 rsync 的封装脚本（/usr/lib/s3ql/pcp.py）。这个脚本允许你使用多个 rsync 进程递归地复制目录树到 S3QL 目标。</p><pre tabindex=0><code>$ /usr/lib/s3ql/pcp.py -h
</code></pre><p><img src=/data/attachment/album/201412/03/214932jvr7ye1z7a6ee272.jpg alt></p><p>下面这个命令将会使用 4 个并发的 rsync 连接来备份 ~/Documents 里的所有内容到一个 S3QL 文件系统。</p><pre tabindex=0><code> $ /usr/lib/s3ql/pcp.py -a --quiet --processes=4 ~/Documents ~/mnt_s3ql
</code></pre><p>这些文件将首先被复制到本地文件缓存中，然后在后台再逐步地同步到后端服务器。</p><p>若想了解与 S3QL 有关的更多信息，如自动挂载、快照、不可变树，我强烈推荐阅读 <a href=http://www.rath.org/s3ql-docs/>官方用户指南</a>。欢迎告诉我你对 S3QL 怎么看，以及你对任何其他工具的使用经验。</p><hr><p>via: <a href=http://xmodulo.com/2014/09/create-cloud-based-encrypted-file-system-linux.html>http://xmodulo.com/2014/09/create-cloud-based-encrypted-file-system-linux.html</a></p><p>作者：<a href=http://xmodulo.com/author/nanni>Dan Nanni</a> 译者：<a href=https://github.com/felixonmars>felixonmars</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创翻译，<a href=http://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/s3ql/ rel=tag>S3QL</a></li><li class=tags__item><a class="tags__link btn" href=/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/ rel=tag>文件系统</a></li><li class=tags__item><a class="tags__link btn" href=/tags/%E4%BA%91%E6%9C%8D%E5%8A%A1/ rel=tag>云服务</a></li><li class=tags__item><a class="tags__link btn" href=/tags/amazon/ rel=tag>Amazon</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>