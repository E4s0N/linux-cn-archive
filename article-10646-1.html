<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>在 Fedora 上为 SSH 设置双因子验证 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="在 Fedora 上为 SSH 设置双因子验证"><meta property="og:description" content="使用双因子验证，你不能仅仅使用 SSH 密钥连接到服务器，你还需要提供手机上的验证器应用程序随机生成的数字。"><meta property="og:type" content="article"><meta property="og:url" content="/article-10646-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-03-24T09:10:55+00:00"><meta property="article:modified_time" content="2019-03-24T09:10:55+00:00"><meta itemprop=name content="在 Fedora 上为 SSH 设置双因子验证"><meta itemprop=description content="使用双因子验证，你不能仅仅使用 SSH 密钥连接到服务器，你还需要提供手机上的验证器应用程序随机生成的数字。"><meta itemprop=datePublished content="2019-03-24T09:10:55+00:00"><meta itemprop=dateModified content="2019-03-24T09:10:55+00:00"><meta itemprop=wordCount content="340"><meta itemprop=keywords content="双因子,SSH,OTP,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>在 Fedora 上为 SSH 设置双因子验证</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2019-03-24T09:10:55Z>March 24, 2019</time></div></div></header><div class="content post__content clearfix"><p><img src=/data/attachment/album/201903/24/091059htuvvhpttruuvzkh.png alt></p><p>每天似乎都有一个安全漏洞的新闻报道，说我们的数据会因此而存在风险。尽管 SSH 是一种远程连接系统的安全方式，但你仍然可以使它更安全。本文将向你展示如何做到这一点。</p><p>此时 双因子验证 two-factor authentication （2FA）就有用武之地了。即使你禁用密码并只允许使用公钥和私钥进行 SSH 连接，但如果未经授权的用户偷窃了你的密钥，他仍然可以借此访问系统。</p><p>使用双因子验证，你不能仅仅使用 SSH 密钥连接到服务器，你还需要提供手机上的验证器应用程序随机生成的数字。</p><p>本文展示的方法是 基于时间的一次性密码 Time-based One-time Password （TOTP）算法。<a href=https://en.wikipedia.org/wiki/Google_Authenticator>Google Authenticator</a> 用作服务器应用程序。默认情况下，Google Authenticator 在 Fedora 中是可用的。</p><p>至于手机，你可以使用与 TOTP 兼容的任何可以双路验证的应用程序。Andorid 或 iOS 有许多可以与 TOTP 和 Google Authenticator 配合使用的免费应用程序。本文与 <a href=https://freeotp.github.io/>FreeOTP</a> 为例。</p><h3 id=安装并设置-google-authenticator>安装并设置 Google Authenticator</h3><p>首先，在你的服务器上安装 Google Authenticator。 <code>$ sudo dnf install -y google-authenticator</code></p><p>运行应用程序：</p><pre tabindex=0><code>$ google-authenticator
</code></pre><p>该应用程序提供了一系列问题。下面的片段展示了如何进行合理的安全设置：</p><pre tabindex=0><code>Do you want authentication tokens to be time-based (y/n) y
Do you want me to update your &#34;/home/user/.google_authenticator&#34; file (y/n)? y
</code></pre><p>这个应用程序为你提供一个密钥、验证码和恢复码。把它们放在安全的地方。如果你丢失了手机，恢复码是访问服务器的<strong>唯一</strong>方式。</p><h3 id=设置手机验证>设置手机验证</h3><p>在你的手机上安装验证器应用程序（FreeOTP）。如果你有一台安卓手机，那么你可以在 Google Play 中找到它，也可以在苹果 iPhone 的 iTunes 商店中找到它。</p><p>Google Authenticator 会在屏幕上显示一个二维码。打开手机上的 FreeOTP 应用程序，选择添加新账户，在应用程序顶部选择二维码形状工具，然后扫描二维码即可。设置完成后，在每次远程连接服务器时，你必须提供验证器应用程序生成的随机数。</p><h3 id=完成配置>完成配置</h3><p>应用程序会向你询问更多的问题。下面示例展示了如何设置合理的安全配置。</p><pre tabindex=0><code>Do you want to disallow multiple uses of the same authentication token? This restricts you to one login about every 30s, but it increases your chances to notice or even prevent man-in-the-middle attacks (y/n) y
By default, tokens are good for 30 seconds. In order to compensate for possible time-skew between the client and the server, we allow an extra token before and after the current time. If you experience problems with poor time synchronization, you can increase the window from its default size of +-1min (window size of 3) to about +-4min (window size of 17 acceptable tokens).
Do you want to do so? (y/n) n
If the computer that you are logging into isn&#39;t hardened against brute-force login attempts, you can enable rate-limiting for the authentication module. By default, this limits attackers to no more than 3 login attempts every 30s.
Do you want to enable rate-limiting (y/n) y
</code></pre><p>现在，你必须设置 SSH 来利用新的双路验证。</p><h3 id=配置-ssh>配置 SSH</h3><p>在完成此步骤之前，<strong>确保你已使用公钥建立了一个可用的 SSH 连接</strong>，因为我们将禁用密码连接。如果出现问题或错误，一个已经建立的连接将允许你修复问题。</p><p>在你的服务器上，使用 <a href=https://fedoramagazine.org/howto-use-sudo/>sudo</a> 编辑 <code>/etc/pam.d/sshd</code> 文件。</p><pre tabindex=0><code>$ sudo vi /etc/pam.d/ssh
</code></pre><p>注释掉 <code>auth substack password-auth</code> 这一行：</p><pre tabindex=0><code>#auth       substack     password-auth
</code></pre><p>将以下行添加到文件底部：</p><pre tabindex=0><code>auth sufficient pam_google_authenticator.so
</code></pre><p>保存并关闭文件。然后编辑 <code>/etc/ssh/sshd_config</code> 文件：</p><pre tabindex=0><code>$ sudo vi /etc/ssh/sshd_config
</code></pre><p>找到 <code>ChallengeResponseAuthentication</code> 这一行并将其更改为 <code>yes</code>：</p><pre tabindex=0><code>ChallengeResponseAuthentication yes
</code></pre><p>找到 <code>PasswordAuthentication</code> 这一行并将其更改为 <code>no</code>：</p><pre tabindex=0><code>PasswordAuthentication no
</code></pre><p>将以下行添加到文件底部：</p><pre tabindex=0><code>AuthenticationMethods publickey,password publickey,keyboard-interactive
</code></pre><p>保存并关闭文件，然后重新启动 SSH：</p><pre tabindex=0><code>$ sudo systemctl restart sshd
</code></pre><h3 id=测试双因子验证>测试双因子验证</h3><p>当你尝试连接到服务器时，系统会提示你输入验证码：</p><pre tabindex=0><code>[user@client ~]$ ssh user@example.com
Verification code:
</code></pre><p>验证码由你手机上的验证器应用程序随机生成。由于这个数字每隔几秒就会发生变化，因此你需要在它变化之前输入它。</p><p><img src=/data/attachment/album/201903/24/091059twxbg02bi240aokd.png alt></p><p>如果你不输入验证码，你将无法访问系统，你会收到一个权限被拒绝的错误：</p><pre tabindex=0><code>[user@client ~]$ ssh user@example.com
Verification code:
Verification code:
Verification code:
Permission denied (keyboard-interactive).
[user@client ~]$
</code></pre><h3 id=结论>结论</h3><p>通过添加这种简单的双路验证，现在未经授权的用户访问你的服务器将变得更加困难。</p><hr><p>via: <a href=https://fedoramagazine.org/two-factor-authentication-ssh-fedora/>https://fedoramagazine.org/two-factor-authentication-ssh-fedora/</a></p><p>作者：<a href=https://fedoramagazine.org/author/rcurtiswarfield/>Curt Warfield</a> 选题：<a href=https://github.com/lujun9972>lujun9972</a> 译者：<a href=https://github.com/MjSeven>MjSeven</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/%E5%8F%8C%E5%9B%A0%E5%AD%90/ rel=tag>双因子</a></li><li class=tags__item><a class="tags__link btn" href=/tags/ssh/ rel=tag>SSH</a></li><li class=tags__item><a class="tags__link btn" href=/tags/otp/ rel=tag>OTP</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>