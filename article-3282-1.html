<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>怎样使用linux的iptables工具进行网络共享 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="怎样使用linux的iptables工具进行网络共享"><meta property="og:description" content="在本教程中，我将解释多个设备怎样在linux下共享一个网络连接。目前无线路由器已经成为主流的消费品，从而解决了本文这一问题。这里假设你家中并没有一台无线路由器，不过，你却有一台已经有&#34;猫&#34;和有线网卡的的linux主机。&#34;猫&#34;是以动态公有IP地址的模式连接到互联网，主机的网卡连接到你的交换机或者集线器。其他设备（如linux或者windows的PC或者笔记本）以网桥的形式连接，并且没有连接到互联网。为了共享linux主机的互联网，你必须把主机转换成网关，以便它能实现从其他设备中传送和接受信息。  术语字汇  私有IP地址（路由不可达地址"><meta property="og:type" content="article"><meta property="og:url" content="/article-3282-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2014-06-27T16:46:10+00:00"><meta property="article:modified_time" content="2014-06-27T16:46:10+00:00"><meta itemprop=name content="怎样使用linux的iptables工具进行网络共享"><meta itemprop=description content="在本教程中，我将解释多个设备怎样在linux下共享一个网络连接。目前无线路由器已经成为主流的消费品，从而解决了本文这一问题。这里假设你家中并没有一台无线路由器，不过，你却有一台已经有&#34;猫&#34;和有线网卡的的linux主机。&#34;猫&#34;是以动态公有IP地址的模式连接到互联网，主机的网卡连接到你的交换机或者集线器。其他设备（如linux或者windows的PC或者笔记本）以网桥的形式连接，并且没有连接到互联网。为了共享linux主机的互联网，你必须把主机转换成网关，以便它能实现从其他设备中传送和接受信息。  术语字汇  私有IP地址（路由不可达地址"><meta itemprop=datePublished content="2014-06-27T16:46:10+00:00"><meta itemprop=dateModified content="2014-06-27T16:46:10+00:00"><meta itemprop=wordCount content="198"><meta itemprop=keywords content="iptables,路由器,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>怎样使用linux的iptables工具进行网络共享</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2014-06-27T16:46:10Z>June 27, 2014</time></div></div></header><div class="content post__content clearfix"><p>在本教程中，我将解释多个设备怎样在linux下共享一个网络连接。目前无线路由器已经成为主流的消费品，从而解决了本文这一问题。这里假设你家中并没有一台无线路由器，不过，你却有一台已经有"猫"和有线网卡的的linux主机。&ldquo;猫"是以动态公有IP地址的模式连接到互联网，主机的网卡连接到你的交换机或者集线器。其他设备（如linux或者windows的PC或者笔记本）以网桥的形式连接，并且没有连接到互联网。为了共享linux主机的互联网，你必须把主机转换成网关，以便它能实现从其他设备中传送和接受信息。</p><p><img src=/data/attachment/album/201406/27/164612j059995so0l900e9.png alt></p><h3 id=术语字汇>术语字汇</h3><ul><li><strong>私有IP地址</strong>（路由不可达地址）是一个被用于本地局域网的IP地址（在互联网中不可见）。</li><li><strong>公用IP地址</strong>（路由可达地址）是一个在互联网中可见的IP地址。</li><li><strong>IP伪装</strong>是一项允许一系列机器通过MASQ网关连接互联网的功能。这些MASQ网关之外的机器在互联网中是不可见的。MASQ之后的机器中任何流入或流出的数据必须经过MASQ网关。</li><li><strong>网络地址转换</strong>（NAT）是一项通过IP伪装技术可以使私有IP地址访问互联网的功能。</li></ul><h3 id=hardware-requirements>Hardware Requirements</h3><p>硬件要求</p><ul><li>一台有两个接口（一个公有IP地址和其他的私有IP地址）的linux主机，这个主机将被用作网关。</li><li>一台或者多台拥有私有IP地址的linux/windows系统的PC或者笔记本。</li><li>交换机/集线器（可选）。</li></ul><h3 id=教程步骤>教程步骤</h3><p>接下来的过程需要在linux主机（用于共享的网关）上完成。</p><h4 id=1激活ip转发>1、激活IP转发</h4><p>为了设置网络共享，你需要在linux主机上更改一个内核参数来使能IP转发功能。内核启动参数设定在/etc/sysctl.conf文件中。</p><p>打开这个文件，定位到含有&rdquo;# net.ipv4.ip_forward = 0"的这一行，移除#号（即取消注释），然后将其值设置为1，改好之后应该和下面的一致。</p><pre tabindex=0><code>net.ipv4.ip_forward = 1
</code></pre><p>你还要使激活IP转发功能生效，通过执行下面的命令：</p><pre tabindex=0><code>$ sudo sysctl -w net.ipv4.ip_forward=1
$ sudo sysctl -p
</code></pre><h4 id=2nat配置>2、NAT配置</h4><p>另一个网络共享的重要部分是NAT配置，这可以通过使用iptables的命令，iptables包含四个防火墙的规则表：</p><ul><li>FILTER (默认表格)</li><li>NAT</li><li>MANGLE</li><li>RAW</li></ul><p>这个教程中我们将仅使用两个表格：FILTER和NAT表格。</p><p>首先，刷新所有活跃的防火墙的规则。</p><pre tabindex=0><code>$ sudo iptables -X
$ sudo iptables -F
$ sudo iptables -t nat -X
$ sudo iptables -t nat -F
</code></pre><p>在输入表格中，你需要设置转发链（FORWARD）成可接受的（ACCEPT）目的地，因此所有通过主机的数据包将会被正确的处理。</p><pre tabindex=0><code>$ sudo iptables -I INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
$ sudo iptables -I FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
</code></pre><p>在NAT表中，你必须为你的WAN口启用IP伪装功能，我们假设WAN口协议是ppp0。为了在ppp0接口上使能IP伪造技术，我们使用以下的命令：</p><pre tabindex=0><code>$ sudo iptables -t nat -I POSTROUTING -o ppp0 -j MASQUERADE
</code></pre><h4 id=3配置私有ip地址>3、配置私有IP地址</h4><p>在linux主机上的所有配置完成后，你需要配置其他设备（linux/windows的PC或笔记本）的DNS服务器以及默认网关，让它们的数据流可以指向linux主机。注意你不需要在linux主机上设置一个DNS服务器，从其他设备发出的每一个DNS请求都会通过上游的ISP自动转发到linux主机上。</p><p>如果你的其他设备上用的系统是linux，你可以通过以下命令来更改他们的默认网关和DNS服务器。假设你的网段是192.168.1.0/24的私有IP地址网段，linux主机上绑定的IP地址是192.168.1.1。</p><pre tabindex=0><code>$ sudo ip route del default
$ sudo ip route add default via 192.168.1.1
$ sudo sh -c &#34;echo &#39;nameserver 192.168.1.1&#39; &gt; /etc/resolv.conf&#34;
</code></pre><p>如果还有其他的linux设备，那么你可以重复以上命令。</p><p>如果你有windows设备，你可以通过控制面板的网络连接属性来更改默认网关和DNS服务器。</p><h4 id=4完整的脚本>4、完整的脚本</h4><p>这是一个在linux主机上设置网络连接共享的一个完整的脚本。WAN口（ppp0协议）需要根据你具体的网络接口协议来替换。</p><pre tabindex=0><code>$ sudo vi /usr/local/bin/ishare
</code></pre><hr><pre tabindex=0><code>#!/bin/bash

## Internet connection shating script

sysctl -w net.ipv4.ip_forward=1
sysctl -p
iptables -X
iptables -F
iptables -t nat -X
iptables -t nat -F
iptables -I INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -I FORWARD  -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -t nat -I POSTROUTING -o ppp0 -j MASQUERADE
</code></pre><p>保存以上的脚本为/usr/local/bin/ishare，然后添加可执行权限通过执行下面的命令。</p><pre tabindex=0><code>$ sudo chmox +x /usr/local/bin/ishare
</code></pre><p>如果你需要这个脚本开机启动，你需要在/etc/rc.local文件中执行这个脚本，并在该文件中的"exit 0"之前添加下面一行。</p><pre tabindex=0><code>/usr/local/bin/ishare
</code></pre><hr><p>via: <a href=http://xmodulo.com/2014/06/internet-connection-sharing-iptables-linux.html>http://xmodulo.com/2014/06/internet-connection-sharing-iptables-linux.html</a></p><p>译者：<a href=https://github.com/yujianxuechuan>yujianxuechuan</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创翻译，<a href=http://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/iptables/ rel=tag>iptables</a></li><li class=tags__item><a class="tags__link btn" href=/tags/%E8%B7%AF%E7%94%B1%E5%99%A8/ rel=tag>路由器</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>