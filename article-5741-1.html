<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>如何用 Nagios 监控通用服务 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="如何用 Nagios 监控通用服务"><meta property="og:description" content="Nagios内置了很多脚本来监控服务。本篇会使用其中一些来检查通用服务如MySql、Apache、DNS等等。 为了保证本篇集中在系统监控，我们不会在这里配置主机组或者模板，它们已经在 前面的教程中覆盖了，它们可以满足需要了。  在命令行中运行Nagios 通常建议在添加到Nagios前，先在命令行中运行Nagios服务检测脚本。它会给出执行是否成功以及脚本的输出将会看上去的样子。 这些脚本存储在 /etc/nagios-plugins/config/ ，可执行文件在 /usr/lib/nagios/plugins/。 下面就是该怎么做 root@nagios:~# cd /etc/nagios-plugins/config/  提供的脚"><meta property="og:type" content="article"><meta property="og:url" content="/article-5741-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-07-02T16:33:41+00:00"><meta property="article:modified_time" content="2015-07-02T16:33:41+00:00"><meta itemprop=name content="如何用 Nagios 监控通用服务"><meta itemprop=description content="Nagios内置了很多脚本来监控服务。本篇会使用其中一些来检查通用服务如MySql、Apache、DNS等等。 为了保证本篇集中在系统监控，我们不会在这里配置主机组或者模板，它们已经在 前面的教程中覆盖了，它们可以满足需要了。  在命令行中运行Nagios 通常建议在添加到Nagios前，先在命令行中运行Nagios服务检测脚本。它会给出执行是否成功以及脚本的输出将会看上去的样子。 这些脚本存储在 /etc/nagios-plugins/config/ ，可执行文件在 /usr/lib/nagios/plugins/。 下面就是该怎么做 root@nagios:~# cd /etc/nagios-plugins/config/  提供的脚"><meta itemprop=datePublished content="2015-07-02T16:33:41+00:00"><meta itemprop=dateModified content="2015-07-02T16:33:41+00:00"><meta itemprop=wordCount content="398"><meta itemprop=keywords content="Nagios,监控,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>如何用 Nagios 监控通用服务</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2015-07-02T16:33:41Z>July 02, 2015</time></div></div></header><div class="content post__content clearfix"><p>Nagios内置了很多脚本来监控服务。本篇会使用其中一些来检查通用服务如MySql、Apache、DNS等等。</p><p>为了保证本篇集中在系统监控，我们不会在这里配置主机组或者模板，它们已经在 <a href=/article-2436-1.html>前面的教程</a>中覆盖了，它们可以满足需要了。</p><p><img src=/data/attachment/album/201507/02/163344eo0tnj54x3d5odb3.jpg alt></p><h3 id=在命令行中运行nagios>在命令行中运行Nagios</h3><p>通常建议在添加到Nagios前，先在命令行中运行Nagios服务检测脚本。它会给出执行是否成功以及脚本的输出将会看上去的样子。</p><p>这些脚本存储在 /etc/nagios-plugins/config/ ，可执行文件在 /usr/lib/nagios/plugins/。</p><p>下面就是该怎么做</p><pre tabindex=0><code>root@nagios:~# cd /etc/nagios-plugins/config/
</code></pre><p>提供的脚本包含了语法帮助。示例包含了部分输出。</p><pre tabindex=0><code>root@nagios:~# cat /etc/nagios-plugins/config/tcp_udp.cfg
</code></pre><hr><pre tabindex=0><code># &#39;check_tcp&#39; command definition
define command{
        command_name    check_tcp
        command_line    /usr/lib/nagios/plugins/check_tcp -H &#39;$HOSTADDRESS$&#39; -p &#39;$ARG1$&#39;
</code></pre><p>了解了语法，TCP 80端口可以用下面的方法检查。</p><pre tabindex=0><code>root@nagios:~# /usr/lib/nagios/plugins/check_tcp -H 10.10.10.1 -p 80
</code></pre><hr><pre tabindex=0><code>TCP OK - 0.000 second response time on port 80|time=0.000222s;;;0.000000;10.000000
</code></pre><h3 id=示例拓扑>示例拓扑</h3><p>本片中使用下面三台服务器。每台服务器运行多个通用服务。Nagios服务器现在运行的是Ubuntu。</p><ul><li>Server 1 (10.10.10.1) : MySQL, Apache2</li><li>Server 2 (10.10.10.2) : Postfix, Apache2</li><li>Server 3 (10.10.10.3) : DNS</li></ul><p>首先，这些服务器被定义在了Nagios中。</p><pre tabindex=0><code>root@nagios:~# vim /etc/nagios3/conf.d/example.cfg
</code></pre><hr><pre tabindex=0><code>define host{
        use                     generic-host            
        host_name               test-server-1
        alias                   test-server-1
        address                 10.10.10.1
        }

define host{
        use                     generic-host            
        host_name               test-server-2
        alias                   test-server-2
        address                 10.10.10.2
        }

define host{
        use                     generic-host            
        host_name               test-server-3
        alias                   test-server-3
        address                 10.10.10.3
        }
</code></pre><h3 id=监控mysql服务>监控MySQL服务</h3><h4 id=mysql-监控需要>MySQL 监控需要</h4><ul><li>通过检查3306端口来检测MySQL是否运行中。</li><li>检测特定的数据库&rsquo;testDB&rsquo;是否可用。</li></ul><h4 id=mysql-服务器设置>MySQL 服务器设置</h4><p>开始检测MySQL时，需要记住MySQL默认只监听回环接口127.0.0.1。这增加了数据库的安全。手动调节需要告诉MySQL该监听什么其他接口。下面是该怎么做。</p><p>这个设置要在所有的MySQL服务器上完成。</p><pre tabindex=0><code>root@nagios:~# vim /etc/mysql/my.cnf
</code></pre><p>下面这行被注释掉以监听所有网络接口。</p><pre tabindex=0><code>#bind-address           = 127.0.0.1
</code></pre><p>同样，MySQL也不会让任意主机来连接它。需要为localhost和“任意”主机创建MySQL用户‘nagios’，接着在所有的数据库中为这个用户授予ALL权限，会这将在会用在监控中。</p><p>下面的设置对所有的MySQL服务器都已经设置。</p><pre tabindex=0><code>root@nagios:~# mysql -u root –p
## MySQL root 密码 ##
</code></pre><p>在MySQL服务器中创建&rsquo;nagios@localhost&rsquo;用户。</p><pre tabindex=0><code>mysql&gt; CREATE USER &#39;nagios&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;nagios-pass&#39;;
mysql&gt; GRANT ALL PRIVILEGES ON *.* TO &#39;nagios&#39;@&#39;localhost&#39;;
</code></pre><p>创建&rsquo;nagios@任意主机&rsquo;用户。（LCTT 译注：实际上这两个是同一个用户，只是分别授权给localhost和任意主机的访问；因为它们所用的密码的同一个，修改任何一个，另外一个也相应变化。）</p><pre tabindex=0><code>mysql&gt; CREATE USER &#39;nagios&#39;@&#39;%&#39; IDENTIFIED BY &#39;nagios-pass&#39;;
mysql&gt; GRANT ALL PRIVILEGES ON *.* TO &#39;nagios&#39;@&#39;%&#39;;

mysql&gt; FLUSH PRIVILEGES;
</code></pre><p>这使MySQL监听所有的网络接口，同样接受来自用户&rsquo;nagios&rsquo;的进入连接。</p><p>请注意，这种修改可能有安全隐患，所以需要提示几点：</p><ul><li>这个设置将会暴露MySQL给所有的接口，包括外网。确保只有合法的网络访问是非常重要的。应该使用防火墙和TCP wrapper等过滤器。</li><li>MySQL用户‘nagios’的密码应该非常强。如果只有几台Nagios服务器，那么应该创建&rsquo;nagios@服务器名&rsquo;用户而不是任意用户的&rsquo;nagios@%&rsquo;。</li></ul><h4 id=对mysql的nagios配置>对MySQL的Nagios配置</h4><p>按如下配置来做一些调整。</p><pre tabindex=0><code>root@nagios:~# vim /etc/nagios3/conf.d/services_nagios2.cfg
</code></pre><hr><pre tabindex=0><code>define service{
use         generic-service
host_name       test-server-1
;hostgroup can be used instead as well

service_description     Check MYSQL via TCP port
check_command           check_tcp!3306
        }

define service{
use             generic-service
host_name           test-server-1
;hostgroup can be used instead as well

service_description Check availability of database &#39;testDB&#39;
check_command   check_mysql_database!nagios!nagios-pass!testDB
;check_mysql!userName!userPassword!databaseName
        }
</code></pre><p>这样，Nagios就可以同时监控MySQL服务器及其数据库的可用性。</p><h3 id=监控apache服务器>监控Apache服务器</h3><p>Nagios同样也可以监控Apache服务。</p><h4 id=apache监控需要>Apache监控需要</h4><ul><li>监控apache服务是否可用</li></ul><p>这个任务非常简单因为Nagios有一个内置命令。</p><pre tabindex=0><code>root@nagios:~# vim /etc/nagios3/conf.d/services_nagios2.cfg
</code></pre><hr><pre tabindex=0><code>define service{
use         generic-service
host_name       test-server-1, test-server-2
service_description Check Apache Web Server
check_command       check_http
        }
</code></pre><p>现在就非常简单了。</p><h3 id=监控dns服务>监控DNS服务</h3><p>Nagios通过向DNS服务器查询一个完全限定域名（FQDN），或者使用dig工具来查询。默认用于查询的FQDN的是www.google.com，但是这个可以按需改变。按照下面的文件修改来完成这个任务。</p><pre tabindex=0><code>root@nagios:~# vim /etc/nagios-plugins/config/dns.cfg
</code></pre><hr><pre tabindex=0><code>## The -H portion can be modified to replace Google ##
define command{
command_name    check_dns
command_line    /usr/lib/nagios/plugins/check_dns -H www.google.com -s &#39;$HOSTADDRESS$&#39;
}
</code></pre><p>编辑下面的行。</p><pre tabindex=0><code>root@nagios:~# vim /etc/nagios3/conf.d/services_nagios2.cfg
</code></pre><hr><pre tabindex=0><code>## Nagios asks server-3 to resolve the IP for google.com ##
define service{
use                             generic-service
host_name                       test-server-3
service_description     Check DNS
check_command           check_dns
        }

## Nagios asks server-3 to dig google.com ##
define service{
use                             generic-service
host_name                       test-server-3
service_description     Check DNS via dig
check_command           check_dig!www.google.com
        }
</code></pre><h3 id=监控邮件服务器>监控邮件服务器</h3><p>Nagios可以监控不同的邮件服务组件如SMTP、POP、IMAP和mailq。之前提过，server-2设置了Postfix邮件服务。Nagios将被配置来监控SMTP和邮件队列。</p><pre tabindex=0><code>root@nagios:~# vim /etc/nagios3/conf.d/services_nagios2.cfg
</code></pre><hr><pre tabindex=0><code>define service{
use                     generic-service
host_name               test-server-2
service_description     Check SMTP
check_command           check_smtp
        }

define service{
use                     generic-service
host_name               test-server-2
service_description     Check Mail Queue
check_command           check_mailq_postfix!50!100
                    ;warning at 50, critical at 100
        }
</code></pre><p>下面的截屏显示了目前配置监控服务的概览。</p><p><img src=/data/attachment/album/201507/02/163346zzfav21gnfn13pfp.jpg alt></p><h3 id=基于端口自定义监控程序>基于端口自定义监控程序</h3><p>让我们假设如下定制程序同样运行在网络中，监听着一个特定的端口。</p><ul><li>测试1号服务器：定制程序（TCP端口 12345）</li></ul><p>做一些小的调整，Nagios也可以帮助我们监控这个程序。</p><pre tabindex=0><code>root@nagios:~# vim /etc/nagios3/conf.d/services_nagios2.cfg
</code></pre><hr><pre tabindex=0><code>define service{
use                     generic-service
host_name               test-server-1
service_description     Check server 1 custom application
check_command           check_tcp!12345
        }
</code></pre><p>在结束之前的提示，Nagios可以监控网络很多其他的方面。存储在/etc/nagios-plugins/config/中的脚本为Nagios提供了很棒的能力。</p><p>一些Nagios提供的脚本被仅限于本地服务器，比如，服务器负载、进程并发数量、登录用户数量等。这些检查可以提供Nagios服务器内有用的信息。</p><p>希望这篇文章对你有用。</p><hr><p>via: <a href=http://xmodulo.com/monitor-common-services-nagios.html>http://xmodulo.com/monitor-common-services-nagios.html</a></p><p>作者：<a href=http://xmodulo.com/author/sarmed>Sarmed Rahman</a> 译者：<a href=https://github.com/geekpi>geekpi</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创翻译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/nagios/ rel=tag>Nagios</a></li><li class=tags__item><a class="tags__link btn" href=/tags/%E7%9B%91%E6%8E%A7/ rel=tag>监控</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>