<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>RHCE 系列（四）： 使用 Shell 脚本自动化 Linux 系统维护任务 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="RHCE 系列（四）： 使用 Shell 脚本自动化 Linux 系统维护任务"><meta property="og:description" content="之前我听说高效的系统管理员的一个特点是懒惰。一开始看起来很矛盾，但作者接下来解释了其中的原因：  RHCE 系列：第四部分 - 自动化 Linux 系统维护任务 如果一个系统管理员花费大量的时间解决问题以及做重复的工作，你就应该怀疑他这么做是否正确。换句话说，一个高效的系统管理员/工程师应该制定一个计划使得其尽量花费少的时间去做重复的工作，以及通过使用本系列中第三部分 使用 Linux 工具集监视系统活动报告 介绍的工具来预见问题。因此，尽管看起来他/她没有做很多的工作，但那是因为 shell 脚本帮助完成了他的/她的大部分任务，"><meta property="og:type" content="article"><meta property="og:url" content="/article-6526-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-11-05T09:48:00+00:00"><meta property="article:modified_time" content="2015-11-05T09:48:00+00:00"><meta itemprop=name content="RHCE 系列（四）： 使用 Shell 脚本自动化 Linux 系统维护任务"><meta itemprop=description content="之前我听说高效的系统管理员的一个特点是懒惰。一开始看起来很矛盾，但作者接下来解释了其中的原因：  RHCE 系列：第四部分 - 自动化 Linux 系统维护任务 如果一个系统管理员花费大量的时间解决问题以及做重复的工作，你就应该怀疑他这么做是否正确。换句话说，一个高效的系统管理员/工程师应该制定一个计划使得其尽量花费少的时间去做重复的工作，以及通过使用本系列中第三部分 使用 Linux 工具集监视系统活动报告 介绍的工具来预见问题。因此，尽管看起来他/她没有做很多的工作，但那是因为 shell 脚本帮助完成了他的/她的大部分任务，"><meta itemprop=datePublished content="2015-11-05T09:48:00+00:00"><meta itemprop=dateModified content="2015-11-05T09:48:00+00:00"><meta itemprop=wordCount content="604"><meta itemprop=keywords content="RHCE,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>RHCE 系列（四）： 使用 Shell 脚本自动化 Linux 系统维护任务</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2015-11-05T09:48:00Z>November 05, 2015</time></div></div></header><div class="content post__content clearfix"><p>之前我听说高效的系统管理员的一个特点是懒惰。一开始看起来很矛盾，但作者接下来解释了其中的原因：</p><p><img src=/data/attachment/album/201511/04/225001vtqsnzkwsiibqtln.png alt="自动化 Linux 系统维护任务"></p><p><em>RHCE 系列：第四部分 - 自动化 Linux 系统维护任务</em></p><p>如果一个系统管理员花费大量的时间解决问题以及做重复的工作，你就应该怀疑他这么做是否正确。换句话说，一个高效的系统管理员/工程师应该制定一个计划使得其尽量花费少的时间去做重复的工作，以及通过使用本系列中第三部分 <a href=/article-6512-1.html>使用 Linux 工具集监视系统活动报告</a> 介绍的工具来预见问题。因此，尽管看起来他/她没有做很多的工作，但那是因为 shell 脚本帮助完成了他的/她的大部分任务，这也就是本章我们将要探讨的东西。</p><h3 id=什么是-shell-脚本>什么是 shell 脚本？</h3><p>简单的说，shell 脚本就是一个由 shell 一步一步执行的程序，而 shell 是在 Linux 内核和最终用户之间提供接口的另一个程序。</p><p>默认情况下，RHEL 7 中用户使用的 shell 是 bash（/bin/bash）。如果你想知道详细的信息和历史背景，你可以查看这个<a href=https://en.wikipedia.org/wiki/Bash_%28Unix_shell%29>维基页面</a>。</p><p>关于这个 shell 提供的众多功能的介绍，可以查看 <strong>man 手册</strong>，也可以从 （<a href=http://www.tecmint.com/wp-content/pdf/bash.pdf>Bash 命令</a>）处下载 PDF 格式。除此之外，假设你已经熟悉 Linux 命令（否则我强烈建议你首先看一下 <strong>Tecmint.com</strong> 中的文章 <a href=http://www.tecmint.com/60-commands-of-linux-a-guide-from-newbies-to-system-administrator/>从新手到系统管理员指南</a> ）。现在让我们开始吧。</p><h3 id=写一个脚本显示系统信息>写一个脚本显示系统信息</h3><p>为了方便，首先让我们新建一个目录用于保存我们的 shell 脚本：</p><pre tabindex=0><code># mkdir scripts
# cd scripts
</code></pre><p>然后用喜欢的文本编辑器打开新的文本文件 <code>system_info.sh</code>。我们首先在头部插入一些注释以及一些命令：</p><pre tabindex=0><code>#!/bin/bash

# RHCE 系列第四部分示例脚本
# 该脚本会返回以下这些系统信息：
# -主机名称:
echo -e &#34;\e[31;43m***** HOSTNAME INFORMATION *****\e[0m&#34;
hostnamectl
echo &#34;&#34;
# -文件系统磁盘空间使用：
echo -e &#34;\e[31;43m***** FILE SYSTEM DISK SPACE USAGE *****\e[0m&#34;
df -h
echo &#34;&#34;
# -系统空闲和使用中的内存：
echo -e &#34;\e[31;43m ***** FREE AND USED MEMORY *****\e[0m&#34;
free
echo &#34;&#34;
# -系统启动时间：
echo -e &#34;\e[31;43m***** SYSTEM UPTIME AND LOAD *****\e[0m&#34;
uptime
echo &#34;&#34;
# -登录的用户：
echo -e &#34;\e[31;43m***** CURRENTLY LOGGED-IN USERS *****\e[0m&#34;
who
echo &#34;&#34;
# -使用内存最多的 5 个进程
echo -e &#34;\e[31;43m***** TOP 5 MEMORY-CONSUMING PROCESSES *****\e[0m&#34;
ps -eo %mem,%cpu,comm --sort=-%mem | head -n 6
echo &#34;&#34;
echo -e &#34;\e[1;32mDone.\e[0m&#34;
</code></pre><p>然后，给脚本可执行权限：</p><pre tabindex=0><code># chmod +x system_info.sh
</code></pre><p>运行脚本：</p><pre tabindex=0><code>./system_info.sh
</code></pre><p>注意为了更好的可视化效果各部分标题都用颜色显示：</p><p><img src=/data/attachment/album/201511/04/225004xk7aapo8odn1pdd7.png alt="服务器监视 Shell 脚本"></p><p><em>服务器监视 Shell 脚本</em></p><p>颜色功能是由以下命令提供的：</p><pre tabindex=0><code>echo -e &#34;\e[COLOR1;COLOR2m&lt;YOUR TEXT HERE&gt;\e[0m&#34;
</code></pre><p>其中 COLOR1 和 COLOR2 是前景色和背景色（<a href=https://wiki.archlinux.org/index.php/Color_Bash_Prompt>Arch Linux Wiki</a> 有更多的信息和选项解释）， 是你想用颜色显示的字符串。</p><h3 id=使任务自动化>使任务自动化</h3><p>你想使其自动化的任务可能因情况而不同。因此，我们不可能在一篇文章中覆盖所有可能的场景，但是我们会介绍使用 shell 脚本可以使其自动化的三种典型任务：</p><ol><li>更新本地文件数据库， 2) 查找（或者删除）有 777 权限的文件， 以及 3) 文件系统使用超过定义的阀值时发出警告。</li></ol><p>让我们在脚本目录中新建一个名为 <code>auto_tasks.sh</code> 的文件并添加以下内容：</p><pre tabindex=0><code>#!/bin/bash

# 自动化任务示例脚本：
# -更新本地文件数据库：
echo -e &#34;\e[4;32mUPDATING LOCAL FILE DATABASE\e[0m&#34;
updatedb
if [ $? == 0 ]; then
        echo &#34;The local file database was updated correctly.&#34;
else
        echo &#34;The local file database was not updated correctly.&#34;
fi
echo &#34;&#34;

# -查找 和/或 删除有 777 权限的文件。
echo -e &#34;\e[4;32mLOOKING FOR FILES WITH 777 PERMISSIONS\e[0m&#34;
# Enable either option (comment out the other line), but not both.
# Option 1: Delete files without prompting for confirmation. Assumes GNU version of find.
#find -type f -perm 0777 -delete
# Option 2: Ask for confirmation before deleting files. More portable across systems.
find -type f -perm 0777 -exec rm -i {} +;
echo &#34;&#34;
# -文件系统使用率超过定义的阀值时发出警告 
echo -e &#34;\e[4;32mCHECKING FILE SYSTEM USAGE\e[0m&#34;
THRESHOLD=30
while read line; do
        # This variable stores the file system path as a string
        FILESYSTEM=$(echo $line | awk &#39;{print $1}&#39;)
        # This variable stores the use percentage (XX%)
        PERCENTAGE=$(echo $line | awk &#39;{print $5}&#39;)
        # Use percentage without the % sign.
        USAGE=${PERCENTAGE%?}
        if [ $USAGE -gt $THRESHOLD ]; then
                echo &#34;The remaining available space in $FILESYSTEM is critically low. Used: $PERCENTAGE&#34;
        fi
done &lt; &lt;(df -h --total | grep -vi filesystem)
</code></pre><p>请注意该脚本最后一行两个 <code>&lt;</code> 符号之间有个空格。</p><p><img src=/data/attachment/album/201511/04/225005dyi8as23sg2aylzj.png alt="查找 777 权限文件的 Shell 脚本"></p><p><em>查找 777 权限文件的 Shell 脚本</em></p><h3 id=使用-cron>使用 Cron</h3><p>想更进一步提高效率，你不会想只是坐在你的电脑前手动执行这些脚本。相反，你会使用 cron 来调度这些任务周期性地执行，并把结果通过邮件发动给预先指定的接收者，或者将它们保存到使用 web 浏览器可以查看的文件中。</p><p>下面的脚本（filesystem_usage.sh）会运行有名的 <strong>df -h</strong> 命令，格式化输出到 HTML 表格并保存到 <strong>report.html</strong> 文件中：</p><pre tabindex=0><code>#!/bin/bash
# 演示使用 shell 脚本创建 HTML 报告的示例脚本
# Web directory
WEB_DIR=/var/www/html
# A little CSS and table layout to make the report look a little nicer
echo &#34;&lt;HTML&gt;
&lt;HEAD&gt;
&lt;style&gt;
.titulo{font-size: 1em; color: white; background:#0863CE; padding: 0.1em 0.2em;}
table
{
border-collapse:collapse;
}
table, td, th
{
border:1px solid black;
}
&lt;/style&gt;
&lt;meta http-equiv=&#39;Content-Type&#39; content=&#39;text/html; charset=UTF-8&#39; /&gt;
&lt;/HEAD&gt;
&lt;BODY&gt;&#34; &gt; $WEB_DIR/report.html
# View hostname and insert it at the top of the html body
HOST=$(hostname)
echo &#34;Filesystem usage for host &lt;strong&gt;$HOST&lt;/strong&gt;&lt;br&gt;
Last updated: &lt;strong&gt;$(date)&lt;/strong&gt;&lt;br&gt;&lt;br&gt;
&lt;table border=&#39;1&#39;&gt;
&lt;tr&gt;&lt;th class=&#39;titulo&#39;&gt;Filesystem&lt;/td&gt;
&lt;th class=&#39;titulo&#39;&gt;Size&lt;/td&gt;
&lt;th class=&#39;titulo&#39;&gt;Use %&lt;/td&gt;
&lt;/tr&gt;&#34; &gt;&gt; $WEB_DIR/report.html
# Read the output of df -h line by line
while read line; do
echo &#34;&lt;tr&gt;&lt;td align=&#39;center&#39;&gt;&#34; &gt;&gt; $WEB_DIR/report.html
echo $line | awk &#39;{print $1}&#39; &gt;&gt; $WEB_DIR/report.html
echo &#34;&lt;/td&gt;&lt;td align=&#39;center&#39;&gt;&#34; &gt;&gt; $WEB_DIR/report.html
echo $line | awk &#39;{print $2}&#39; &gt;&gt; $WEB_DIR/report.html
echo &#34;&lt;/td&gt;&lt;td align=&#39;center&#39;&gt;&#34; &gt;&gt; $WEB_DIR/report.html
echo $line | awk &#39;{print $5}&#39; &gt;&gt; $WEB_DIR/report.html
echo &#34;&lt;/td&gt;&lt;/tr&gt;&#34; &gt;&gt; $WEB_DIR/report.html
done &lt; &lt;(df -h | grep -vi filesystem)
echo &#34;&lt;/table&gt;&lt;/BODY&gt;&lt;/HTML&gt;&#34; &gt;&gt; $WEB_DIR/report.html
</code></pre><p>在我们的 <strong>RHEL 7</strong> 服务器（<strong>192.168.0.18</strong>）中，看起来像下面这样：</p><p><img src=/data/attachment/album/201511/04/225008za1cii1ni12cwg1e.png alt=服务器监视报告></p><p><em>服务器监视报告</em></p><p>你可以添加任何你想要的信息到那个报告中。添加下面的 crontab 条目在每天下午的 1：30 运行该脚本：</p><pre tabindex=0><code>30 13 * * * /root/scripts/filesystem_usage.sh
</code></pre><h3 id=总结>总结</h3><p>你很可能想起各种其他想要自动化的任务；正如你看到的，使用 shell 脚本能极大的简化任务。如果你觉得这篇文章对你有所帮助就告诉我们吧，别犹豫在下面的表格中添加你自己的想法或评论。</p><hr><p>via: <a href=http://www.tecmint.com/using-shell-script-to-automate-linux-system-maintenance-tasks/>http://www.tecmint.com/using-shell-script-to-automate-linux-system-maintenance-tasks/</a></p><p>作者：<a href=http://www.tecmint.com/author/gacanepa/>Gabriel Cánepa</a> 译者：<a href=https://github.com/ictlyh>ictlyh</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创翻译，<a href=http://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/rhce/ rel=tag>RHCE</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>