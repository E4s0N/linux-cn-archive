<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Samba 系列（十五）：用 SSSD 和 Realm 集成 Ubuntu 到 Samba4 AD DC - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="Samba 系列（十五）：用 SSSD 和 Realm 集成 Ubuntu 到 Samba4 AD DC"><meta property="og:description" content="本教程将告诉你如何将 Ubuntu 桌面版机器加入到带有 SSSD 和 Realm 服务的 Samba4 活动目录域中，以在活动目录中认证用户。"><meta property="og:type" content="article"><meta property="og:url" content="/article-8853-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-09-09T18:14:00+00:00"><meta property="article:modified_time" content="2017-09-09T18:14:00+00:00"><meta itemprop=name content="Samba 系列（十五）：用 SSSD 和 Realm 集成 Ubuntu 到 Samba4 AD DC"><meta itemprop=description content="本教程将告诉你如何将 Ubuntu 桌面版机器加入到带有 SSSD 和 Realm 服务的 Samba4 活动目录域中，以在活动目录中认证用户。"><meta itemprop=datePublished content="2017-09-09T18:14:00+00:00"><meta itemprop=dateModified content="2017-09-09T18:14:00+00:00"><meta itemprop=wordCount content="741"><meta itemprop=keywords content="Samba,SSSD,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Samba 系列（十五）：用 SSSD 和 Realm 集成 Ubuntu 到 Samba4 AD DC</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2017-09-09T18:14:00Z>September 09, 2017</time></div></div></header><div class="content post__content clearfix"><p><img src=/data/attachment/album/201709/09/181412dtnflmmtymtod5py.jpg alt></p><p>本教程将告诉你如何将 Ubuntu 桌面版机器加入到带有 SSSD 和 Realm 服务的 Samba4 活动目录域中，以在活动目录中认证用户。</p><h3 id=要求>要求：</h3><ol><li><a href=/article-8065-1.html>在 Ubuntu 上用 Samba4 创建一个活动目录架构</a></li></ol><h3 id=第-1-步初始配置>第 1 步：初始配置</h3><p>1、 在把 Ubuntu 加入活动目录前确保主机名被正确设置了。使用 <code>hostnamectl</code> 命令设置机器名字或者手动编辑 <code>/etc/hostname</code> 文件。</p><pre tabindex=0><code>$ sudo hostnamectl set-hostname your_machine_short_hostname
$ cat /etc/hostname
$ hostnamectl
</code></pre><p>2、 接下来，编辑机器网络接口设置并且添加合适的 IP 设置，并将正确的 DNS IP 服务器地址指向 Samba 活动目录域控制器，如下图所示。</p><p>如果你已经配置了 DHCP 服务来为局域网机器自动分配包括合适的 AD DNS IP 地址的 IP 设置，那么你可以跳过这一步。</p><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/Configure-Network-Interface.jpg><img src=/data/attachment/album/201709/09/181436ahce300hu5z5cdnc.jpg alt=设置网络接口></a></p><p><em>设置网络接口</em></p><p>上图中，<code>192.168.1.254</code> 和 <code>192.168.1.253</code> 代表 Samba4 域控制器的 IP 地址。</p><p>3、 用 GUI（图形用户界面）或命令行重启网络服务来应用修改，并且对你的域名发起一系列 ping 请求来测试 DNS 解析如预期工作。 也用 <code>host</code> 命令来测试 DNS 解析。</p><pre tabindex=0><code>$ sudo systemctl restart networking.service
$ host your_domain.tld
$ ping -c2 your_domain_name
$ ping -c2 adc1
$ ping -c2 adc2
</code></pre><p>4、 最后, 确保机器时间和 Samba4 AD 同步。安装 <code>ntpdate</code> 包并用下列指令和 AD 同步时间。</p><pre tabindex=0><code>$ sudo apt-get install ntpdate
$ sudo ntpdate your_domain_name
</code></pre><h3 id=第-2-步安装需要的包>第 2 步：安装需要的包</h3><p>5、 这一步将安装将 Ubuntu 加入 Samba4 活动目录域控制器所必须的软件和依赖：Realmd 和 SSSD 服务。</p><pre tabindex=0><code>$ sudo apt install adcli realmd krb5-user samba-common-bin samba-libs samba-dsdb-modules sssd sssd-tools libnss-sss libpam-sss packagekit policykit-1 
</code></pre><p>6、 输入大写的默认 realm 名称，然后按下回车继续安装。</p><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/Set-realm-name.png><img src=/data/attachment/album/201709/09/181438hjwwb6nruxwrkw6x.png alt="输入 Realm 名称"></a></p><p><em>输入 Realm 名称</em></p><p>7、 接着，创建包含以下内容的 SSSD 配置文件。</p><pre tabindex=0><code>$ sudo nano /etc/sssd/sssd.conf
</code></pre><p>加入下面的内容到 <code>sssd.conf</code> 文件。</p><pre tabindex=0><code>[nss]
filter_groups = root
filter_users = root
reconnection_retries = 3
[pam]
reconnection_retries = 3
[sssd]
domains = tecmint.lan
config_file_version = 2
services = nss, pam
default_domain_suffix = TECMINT.LAN
[domain/tecmint.lan]
ad_domain = tecmint.lan
krb5_realm = TECMINT.LAN
realmd_tags = manages-system joined-with-samba
cache_credentials = True
id_provider = ad
krb5_store_password_if_offline = True
default_shell = /bin/bash
ldap_id_mapping = True
use_fully_qualified_names = True
fallback_homedir = /home/%d/%u
access_provider = ad
auth_provider = ad
chpass_provider = ad
access_provider = ad
ldap_schema = ad
dyndns_update = true
dyndsn_refresh_interval = 43200
dyndns_update_ptr = true
dyndns_ttl = 3600
</code></pre><p>确保你对应地替换了下列参数的域名：</p><pre tabindex=0><code>domains = tecmint.lan
default_domain_suffix = TECMINT.LAN
[domain/tecmint.lan]
ad_domain = tecmint.lan
krb5_realm = TECMINT.LAN
</code></pre><p>8、 接着，用下列命令给 SSSD 配置文件适当的权限：</p><pre tabindex=0><code>$ sudo chmod 700 /etc/sssd/sssd.conf
</code></pre><p>9、 现在，打开并编辑 Realmd 配置文件，输入下面这行：</p><pre tabindex=0><code>$ sudo nano /etc/realmd.conf
</code></pre><p><code>realmd.conf</code> 文件摘录：</p><pre tabindex=0><code>[active-directory]
os-name = Linux Ubuntu
os-version = 17.04
[service]
automatic-install = yes
[users]
default-home = /home/%d/%u
default-shell = /bin/bash
[tecmint.lan]
user-principal = yes
fully-qualified-names = no
</code></pre><p>10、 最后需要修改的文件属于 Samba 守护进程。 打开 <code>/etc/samba/smb.conf</code> 文件编辑，然后在文件开头加入下面这块代码，在 <code>[global]</code> 之后的部分如下图所示。</p><pre tabindex=0><code>workgroup = TECMINT
client signing = yes
client use spnego = yes
kerberos method = secrets and keytab
realm = TECMINT.LAN
security = ads
</code></pre><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/Configure-Samba-Server.jpg><img src=/data/attachment/album/201709/09/181440khjfh6dmhff2pdpn.jpg alt="配置 Samba 服务器"></a></p><p><em>配置 Samba 服务器</em></p><p>确保你替换了域名值，特别是对应域名的 realm 值，并运行 <code>testparm</code> 命令检验设置文件是否包含错误。</p><pre tabindex=0><code>$ sudo testparm
</code></pre><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/Test-Samba-Configuration.jpg><img src=/data/attachment/album/201709/09/181442pm7zp3ogp72ss3z2.jpg alt="测试 Samba 配置"></a></p><p><em>测试 Samba 配置</em></p><p>11、 在做完所有必需的修改之后，用 AD 管理员帐号验证 Kerberos 认证并用下面的命令列出票据。</p><pre tabindex=0><code>$ sudo kinit ad_admin_user@DOMAIN.TLD
$ sudo klist
</code></pre><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/Check-Kerberos-Authentication.jpg><img src=/data/attachment/album/201709/09/181444h4dtt9e07zd7tno1.jpg alt="检验 Kerberos 认证"></a></p><p><em>检验 Kerberos 认证</em></p><h3 id=第-3-步-加入-ubuntu-到-samba4-realm>第 3 步： 加入 Ubuntu 到 Samba4 Realm</h3><p>12、 键入下列命令将 Ubuntu 机器加入到 Samba4 活动目录。用有管理员权限的 AD DC 账户名字，以便绑定 realm 可以如预期般工作，并替换对应的域名值。</p><pre tabindex=0><code>$ sudo realm discover -v DOMAIN.TLD
$ sudo realm list
$ sudo realm join TECMINT.LAN -U ad_admin_user -v
$ sudo net ads join -k
</code></pre><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/Join-Ubuntu-to-Samba4-Realm.jpg><img src=/data/attachment/album/201709/09/181447ou8pzkdygi7pj8gd.jpg alt="加入 Ubuntu 到 Samba4 Realm"></a></p><p><em>加入 Ubuntu 到 Samba4 Realm</em></p><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/List-Realm-Domain-Info.jpg><img src=/data/attachment/album/201709/09/181449bfmd94dm96eor84h.jpg alt="列出 Realm Domain 信息"></a></p><p><em>列出 Realm Domain 信息</em></p><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/Add-User-to-Realm-Domain.jpg><img src=/data/attachment/album/201709/09/181449kowj143j4g487taj.jpg alt="加入用户到 Realm Domain"></a></p><p><em>添加用户到 Realm Domain</em></p><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/Add-Domain-to-Realm.jpg><img src=/data/attachment/album/201709/09/181449x3vzhe27b7vd33vh.jpg alt="表列 Realm Domain 信息"></a></p><p><em>添加 Domain 到 Realm</em></p><p>13、 区域绑定好了之后，运行下面的命令确保所有域账户允许在这台机器上认证。</p><pre tabindex=0><code>$ sudo realm permit -all
</code></pre><p>然后你可以使用下面举例的 <code>realm</code> 命令允许或者禁止域用户帐号或群组访问。</p><pre tabindex=0><code>$ sudo realm deny -a
$ realm permit --groups ‘domain.tld\Linux Admins’
$ realm permit user@domain.lan
$ realm permit DOMAIN\\User2
</code></pre><p>14、 从一个 <a href=/article-8097-1.html>安装了 RSAT 工具的</a> Windows 机器上你可以打开 AD UC 并浏览“ 电脑 computers ”容器，并检验是否有一个使用你机器名的对象帐号已经创建。</p><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/Confirm-Domain-Added.jpg><img src=/data/attachment/album/201709/09/181449mt2kuqdbyq4k5lyq.jpg alt="确保域被加入 AD DC"></a></p><p><em>确保域被加入 AD DC</em></p><h3 id=第-4-步配置-ad-账户认证>第 4 步：配置 AD 账户认证</h3><p>15、 为了在 Ubuntu 机器上用域账户认证，你需要用 root 权限运行 <code>pam-auth-update</code> 命令并允许所有 PAM 配置文件，包括为每个域账户在第一次注册的时候自动创建家目录的选项。</p><p>按 [空格] 键检验所有配置项并点击 ok 来应用配置。</p><pre tabindex=0><code>$ sudo pam-auth-update
</code></pre><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/PAM-Configuration.jpg><img src=/data/attachment/album/201709/09/181452ih09uu3e11tu41zy.jpg alt="PAM 配置"></a></p><p><em>PAM 配置</em></p><p>16、 在系统上手动编辑 <code>/etc/pam.d/common-account</code> 文件，下面这几行是为了给认证过的域用户自动创建家目录。</p><pre tabindex=0><code>session    required    pam_mkhomedir.so    skel=/etc/skel/    umask=0022
</code></pre><p>17、 如果活动目录用户不能用 linux 命令行修改他们的密码，打开 <code>/etc/pam.d/common-password</code> 文件并在 <code>password</code> 行移除 <code>use_authtok</code> 语句，最后如下：</p><pre tabindex=0><code>password       [success=1 default=ignore]      pam_winbind.so try_first_pass
</code></pre><p>18、 最后，用下面的命令重启并启用以应用 Realmd 和 SSSD 服务的修改：</p><pre tabindex=0><code>$ sudo systemctl restart realmd sssd
$ sudo systemctl enable realmd sssd
</code></pre><p>19、 为了测试 Ubuntu 机器是是否成功集成到 realm ，安装 winbind 包并运行 <code>wbinfo</code> 命令列出域账户和群组，如下所示。</p><pre tabindex=0><code>$ sudo apt-get install winbind
$ wbinfo -u
$ wbinfo -g
</code></pre><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/List-Domain-Accounts.jpg><img src=/data/attachment/album/201709/09/181454wnn111fux3ovonv0.jpg alt=列出域账户></a></p><p><em>列出域账户</em></p><p>20、 同样，也可以针对特定的域用户或群组使用 <code>getent</code> 命令检验 Winbind nsswitch 模块。</p><pre tabindex=0><code>$ sudo getent passwd your_domain_user
$ sudo getent group ‘domain admins’
</code></pre><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/check-Winbind-nsswitch.jpg><img src=/data/attachment/album/201709/09/181456w3n6fabun2s392s1.jpg alt="检验 Winbind Nsswitch"></a></p><p><em>检验 Winbind Nsswitch</em></p><p>21、 你也可以用 Linux <code>id</code> 命令获取 AD 账户的信息，命令如下：</p><pre tabindex=0><code>$ id tecmint_user
</code></pre><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/Check-AD-User-Info.jpg><img src=/data/attachment/album/201709/09/181457o40kbocfkb3bg4b9.jpg alt="检验 AD 用户信息"></a></p><p><em>检验 AD 用户信息</em></p><p>22、 用 <code>su -</code> 后跟上域用户名参数来认证 Ubuntu 主机的一个 Samba4 AD 账户。运行 <code>id</code> 命令获取该 AD 账户的更多信息。</p><pre tabindex=0><code>$ su - your_ad_user
</code></pre><p><a href=https://www.tecmint.com/wp-content/uploads/2017/07/AD-User-Authentication.jpg><img src=/data/attachment/album/201709/09/181457npiti0065gijz645.jpg alt="AD 用户认证"></a></p><p><em>AD 用户认证</em></p><p>用 <code>pwd</code> 命令查看你的域用户当前工作目录，和用 <code>passwd</code> 命令修改密码。</p><p>23、 在 Ubuntu 上使用有 root 权限的域账户，你需要用下面的命令添加 AD 用户名到 sudo 系统群组：</p><pre tabindex=0><code>$ sudo usermod -aG sudo your_domain_user@domain.tld
</code></pre><p>用域账户登录 Ubuntu 并运行 <code>apt update</code> 命令来更新你的系统以检验 root 权限。</p><p>24、 给一个域群组 root 权限，用 <code>visudo</code> 命令打开并编辑 <code>/etc/sudoers</code> 文件，并加入如下行：</p><pre tabindex=0><code>%domain\ admins@tecmint.lan              ALL=(ALL:ALL) ALL
</code></pre><p>25、 要在 Ubuntu 桌面使用域账户认证，通过编辑 <code>/usr/share/lightdm/lightdm.conf.d/50-ubuntu.conf</code> 文件来修改 LightDM 显示管理器，增加以下两行并重启 lightdm 服务或重启机器应用修改。</p><pre tabindex=0><code>greeter-show-manual-login=true
greeter-hide-users=true
</code></pre><p>域账户用“你的域用户”或“你的域用户@你的域” 格式来登录 Ubuntu 桌面。</p><p>26、 为使用 Samba AD 账户的简称格式，编辑 <code>/etc/sssd/sssd.conf</code> 文件，在 <code>[sssd]</code> 块加入如下几行命令。</p><pre tabindex=0><code>full_name_format = %1$s
</code></pre><p>并重启 SSSD 守护进程应用改变。</p><pre tabindex=0><code>$ sudo systemctl restart sssd
</code></pre><p>你会注意到 bash 提示符会变成了没有附加域名部分的 AD 用户名。</p><p>27、 万一你因为 <code>sssd.conf</code> 里的 <code>enumerate=true</code> 参数设定而不能登录，你得用下面的命令清空 sssd 缓存数据：</p><pre tabindex=0><code>$ rm /var/lib/sss/db/cache_tecmint.lan.ldb
</code></pre><p>这就是全部了！虽然这个教程主要集中于集成 Samba4 活动目录，同样的步骤也能被用于把使用 Realm 和 SSSD 服务的 Ubuntu 整合到微软 Windows 服务器活动目录。</p><hr><p>作者简介：</p><p>Matei Cezar - 我是一名网瘾少年，开源和基于 linux 系统软件的粉丝，有4年经验在 linux 发行版桌面、服务器和 bash 脚本。</p><hr><p>via: <a href=https://www.tecmint.com/integrate-ubuntu-to-samba4-ad-dc-with-sssd-and-realm/>https://www.tecmint.com/integrate-ubuntu-to-samba4-ad-dc-with-sssd-and-realm/</a></p><p>作者：<a href=https://www.tecmint.com/author/cezarmatei/>Matei Cezar</a> 译者：<a href=https://github.com/XYenChi>XYenChi</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/samba/ rel=tag>Samba</a></li><li class=tags__item><a class="tags__link btn" href=/tags/sssd/ rel=tag>SSSD</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>