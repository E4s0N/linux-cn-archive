<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>建立你自己的 CA 服务：OpenSSL 命令行 CA 操作快速指南 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="建立你自己的 CA 服务：OpenSSL 命令行 CA 操作快速指南"><meta property="og:description" content="这些是关于使用 OpenSSL 生成证书授权（CA）、中间证书授权和末端证书的速记随笔，内容包括 OCSP、CRL 和 CA 颁发者信息，以及指定颁发和有效期限等。 我们将建立我们自己的根 CA，我们将使用根 CA 来生成一个中间 CA 的例子，我们将使用中间 CA 来签署末端用户证书。  根 CA 创建根 CA 授权目录并切换到该目录： mkdir ~/SSLCA/root/ cd ~/SSLCA/root/  为我们的根 CA 生成一个8192位长的 SHA-256 RSA 密钥： openssl genrsa -aes256 -out rootca.key 8192  样例输出： Generating RSA private key, 8192 bit long modulus &mldr;&mldr;&mldr;++ ."><meta property="og:type" content="article"><meta property="og:url" content="/article-5443-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-05-14T08:19:00+00:00"><meta property="article:modified_time" content="2015-05-14T08:19:00+00:00"><meta itemprop=name content="建立你自己的 CA 服务：OpenSSL 命令行 CA 操作快速指南"><meta itemprop=description content="这些是关于使用 OpenSSL 生成证书授权（CA）、中间证书授权和末端证书的速记随笔，内容包括 OCSP、CRL 和 CA 颁发者信息，以及指定颁发和有效期限等。 我们将建立我们自己的根 CA，我们将使用根 CA 来生成一个中间 CA 的例子，我们将使用中间 CA 来签署末端用户证书。  根 CA 创建根 CA 授权目录并切换到该目录： mkdir ~/SSLCA/root/ cd ~/SSLCA/root/  为我们的根 CA 生成一个8192位长的 SHA-256 RSA 密钥： openssl genrsa -aes256 -out rootca.key 8192  样例输出： Generating RSA private key, 8192 bit long modulus &mldr;&mldr;&mldr;++ ."><meta itemprop=datePublished content="2015-05-14T08:19:00+00:00"><meta itemprop=dateModified content="2015-05-14T08:19:00+00:00"><meta itemprop=wordCount content="1256"><meta itemprop=keywords content="CA,证书,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>建立你自己的 CA 服务：OpenSSL 命令行 CA 操作快速指南</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2015-05-14T08:19:00Z>May 14, 2015</time></div></div></header><div class="content post__content clearfix"><p>这些是关于使用 OpenSSL 生成证书授权（CA）、中间证书授权和末端证书的速记随笔，内容包括 OCSP、CRL 和 CA 颁发者信息，以及指定颁发和有效期限等。</p><p>我们将建立我们自己的根 CA，我们将使用根 CA 来生成一个中间 CA 的例子，我们将使用中间 CA 来签署末端用户证书。</p><p><img src=/data/attachment/album/201505/14/002424qm1ntrmmr1m15azf.jpg alt></p><h3 id=根-ca>根 CA</h3><p>创建根 CA 授权目录并切换到该目录：</p><pre tabindex=0><code>mkdir ~/SSLCA/root/
cd ~/SSLCA/root/
</code></pre><p>为我们的根 CA 生成一个8192位长的 SHA-256 RSA 密钥：</p><pre tabindex=0><code>openssl genrsa -aes256 -out rootca.key 8192
</code></pre><p>样例输出：</p><pre tabindex=0><code>Generating RSA private key, 8192 bit long modulus
.........++
....................................................................................................................++
e is 65537 (0x10001)
</code></pre><p>如果你想要用密码保护该密钥，请添加 <code>-aes256</code> 选项。</p><p>创建自签名根 CA 证书 <code>ca.crt</code>；你需要为你的根 CA 提供一个身份：</p><pre tabindex=0><code>openssl req -sha256 -new -x509 -days 1826 -key rootca.key -out rootca.crt
</code></pre><p>样例输出：</p><pre tabindex=0><code>You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [AU]:NL
State or Province Name (full name) [Some-State]:Zuid Holland
Locality Name (eg, city) []:Rotterdam
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Sparkling Network
Organizational Unit Name (eg, section) []:Sparkling CA
Common Name (e.g. server FQDN or YOUR name) []:Sparkling Root CA
Email Address []:
</code></pre><p>创建一个存储 CA 序列的文件：</p><pre tabindex=0><code>touch certindex
echo 1000 &gt; certserial
echo 1000 &gt; crlnumber
</code></pre><p>放置 CA 配置文件，该文件持有 CRL 和 OCSP 末端的存根。</p><pre tabindex=0><code># vim ca.conf
[ ca ]
default_ca = myca

[ crl_ext ]
issuerAltName=issuer:copy 
authorityKeyIdentifier=keyid:always

 [ myca ]
 dir = ./
 new_certs_dir = $dir
 unique_subject = no
 certificate = $dir/rootca.crt
 database = $dir/certindex
 private_key = $dir/rootca.key
 serial = $dir/certserial
 default_days = 730
 default_md = sha1
 policy = myca_policy
 x509_extensions = myca_extensions
 crlnumber = $dir/crlnumber
 default_crl_days = 730

 [ myca_policy ]
 commonName = supplied
 stateOrProvinceName = supplied
 countryName = optional
 emailAddress = optional
 organizationName = supplied
 organizationalUnitName = optional

 [ myca_extensions ]
 basicConstraints = critical,CA:TRUE
 keyUsage = critical,any
 subjectKeyIdentifier = hash
 authorityKeyIdentifier = keyid:always,issuer
 keyUsage = digitalSignature,keyEncipherment,cRLSign,keyCertSign
 extendedKeyUsage = serverAuth
 crlDistributionPoints = @crl_section
 subjectAltName  = @alt_names
 authorityInfoAccess = @ocsp_section

 [ v3_ca ]
 basicConstraints = critical,CA:TRUE,pathlen:0
 keyUsage = critical,any
 subjectKeyIdentifier = hash
 authorityKeyIdentifier = keyid:always,issuer
 keyUsage = digitalSignature,keyEncipherment,cRLSign,keyCertSign
 extendedKeyUsage = serverAuth
 crlDistributionPoints = @crl_section
 subjectAltName  = @alt_names
 authorityInfoAccess = @ocsp_section

 [alt_names]
 DNS.0 = Sparkling Intermidiate CA 1
 DNS.1 = Sparkling CA Intermidiate 1

 [crl_section]
 URI.0 = http://pki.sparklingca.com/SparklingRoot.crl
 URI.1 = http://pki.backup.com/SparklingRoot.crl

 [ocsp_section]
 caIssuers;URI.0 = http://pki.sparklingca.com/SparklingRoot.crt
 caIssuers;URI.1 = http://pki.backup.com/SparklingRoot.crt
 OCSP;URI.0 = http://pki.sparklingca.com/ocsp/
 OCSP;URI.1 = http://pki.backup.com/ocsp/
</code></pre><p>如果你需要设置某个特定的证书生效/过期日期，请添加以下内容到<code>[myca]</code>：</p><pre tabindex=0><code># format: YYYYMMDDHHMMSS
default_enddate = 20191222035911
default_startdate = 20181222035911
</code></pre><h3 id=创建中间-ca>创建中间 CA</h3><p>生成中间 CA （名为 intermediate1）的私钥：</p><pre tabindex=0><code>openssl genrsa -out intermediate1.key 4096
</code></pre><p>生成中间 CA 的 CSR：</p><pre tabindex=0><code>openssl req -new -sha256 -key intermediate1.key -out intermediate1.csr
</code></pre><p>样例输出：</p><pre tabindex=0><code>You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [AU]:NL
State or Province Name (full name) [Some-State]:Zuid Holland
Locality Name (eg, city) []:Rotterdam
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Sparkling Network
Organizational Unit Name (eg, section) []:Sparkling CA
Common Name (e.g. server FQDN or YOUR name) []:Sparkling Intermediate CA
Email Address []:

Please enter the following &#39;extra&#39; attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
</code></pre><p>确保中间 CA 的主体（CN）和根 CA 不同。</p><p>用根 CA 签署中间 CA 的 CSR：</p><pre tabindex=0><code>openssl ca -batch -config ca.conf -notext -in intermediate1.csr -out intermediate1.crt
</code></pre><p>样例输出：</p><pre tabindex=0><code>Using configuration from ca.conf
Check that the request matches the signature
Signature ok
The Subject&#39;s Distinguished Name is as follows
countryName           :PRINTABLE:&#39;NL&#39;
stateOrProvinceName   :ASN.1 12:&#39;Zuid Holland&#39;
localityName          :ASN.1 12:&#39;Rotterdam&#39;
organizationName      :ASN.1 12:&#39;Sparkling Network&#39;
organizationalUnitName:ASN.1 12:&#39;Sparkling CA&#39;
commonName            :ASN.1 12:&#39;Sparkling Intermediate CA&#39;
Certificate is to be certified until Mar 30 15:07:43 2017 GMT (730 days)

Write out database with 1 new entries
Data Base Updated
</code></pre><p>生成 CRL（同时采用 PEM 和 DER 格式）：</p><pre tabindex=0><code>openssl ca -config ca.conf -gencrl -keyfile rootca.key -cert rootca.crt -out rootca.crl.pem

openssl crl -inform PEM -in rootca.crl.pem -outform DER -out rootca.crl
</code></pre><p>每次使用该 CA 签署证书后，请生成 CRL。</p><p>如果你需要撤销该中间证书：</p><pre tabindex=0><code>openssl ca -config ca.conf -revoke intermediate1.crt -keyfile rootca.key -cert rootca.crt
</code></pre><h3 id=配置中间-ca>配置中间 CA</h3><p>为该中间 CA 创建一个新文件夹，然后进入该文件夹：</p><pre tabindex=0><code>mkdir ~/SSLCA/intermediate1/
cd ~/SSLCA/intermediate1/
</code></pre><p>从根 CA 拷贝中间证书和密钥：</p><pre tabindex=0><code>cp ~/SSLCA/root/intermediate1.key ./
cp ~/SSLCA/root/intermediate1.crt ./
</code></pre><p>创建索引文件：</p><pre tabindex=0><code>touch certindex
echo 1000 &gt; certserial
echo 1000 &gt; crlnumber
</code></pre><p>创建一个新的 <code>ca.conf</code> 文件：</p><pre tabindex=0><code># vim ca.conf
[ ca ]
default_ca = myca

[ crl_ext ]
issuerAltName=issuer:copy 
authorityKeyIdentifier=keyid:always

 [ myca ]
 dir = ./
 new_certs_dir = $dir
 unique_subject = no
 certificate = $dir/intermediate1.crt
 database = $dir/certindex
 private_key = $dir/intermediate1.key
 serial = $dir/certserial
 default_days = 365
 default_md = sha1
 policy = myca_policy
 x509_extensions = myca_extensions
 crlnumber = $dir/crlnumber
 default_crl_days = 365

 [ myca_policy ]
 commonName = supplied
 stateOrProvinceName = supplied
 countryName = optional
 emailAddress = optional
 organizationName = supplied
 organizationalUnitName = optional

 [ myca_extensions ]
 basicConstraints = critical,CA:FALSE
 keyUsage = critical,any
 subjectKeyIdentifier = hash
 authorityKeyIdentifier = keyid:always,issuer
 keyUsage = digitalSignature,keyEncipherment
 extendedKeyUsage = serverAuth
 crlDistributionPoints = @crl_section
 subjectAltName  = @alt_names
 authorityInfoAccess = @ocsp_section

 [alt_names]
 DNS.0 = example.com
 DNS.1 = example.org

 [crl_section]
 URI.0 = http://pki.sparklingca.com/SparklingIntermidiate1.crl
 URI.1 = http://pki.backup.com/SparklingIntermidiate1.crl

 [ocsp_section]
 caIssuers;URI.0 = http://pki.sparklingca.com/SparklingIntermediate1.crt
 caIssuers;URI.1 = http://pki.backup.com/SparklingIntermediate1.crt
 OCSP;URI.0 = http://pki.sparklingca.com/ocsp/
 OCSP;URI.1 = http://pki.backup.com/ocsp/
</code></pre><p>修改 <code>[alt_names]</code> 部分，添加你需要的主体备选名。如果你不需要主体备选名，请移除该部分包括<code>subjectAltName = @alt_names</code>的行。</p><p>如果你需要设置一个指定的生效/到期日期，请添加以下内容到 <code>[myca]</code>：</p><pre tabindex=0><code># format: YYYYMMDDHHMMSS
default_enddate = 20191222035911
default_startdate = 20181222035911
</code></pre><p>生成一个空白 CRL（同时以 PEM 和 DER 格式）：</p><pre tabindex=0><code>openssl ca -config ca.conf -gencrl -keyfile rootca.key -cert rootca.crt -out rootca.crl.pem

openssl crl -inform PEM -in rootca.crl.pem -outform DER -out rootca.crl
</code></pre><h3 id=生成末端用户证书>生成末端用户证书</h3><p>我们使用这个新的中间 CA 来生成一个末端用户证书，请重复以下操作来使用该 CA 为每个用户签署。</p><pre tabindex=0><code>mkdir enduser-certs
</code></pre><p>生成末端用户的私钥：</p><pre tabindex=0><code>openssl genrsa -out enduser-certs/enduser-example.com.key 4096
</code></pre><p>生成末端用户的 CSR：</p><pre tabindex=0><code>openssl req -new -sha256 -key enduser-certs/enduser-example.com.key -out enduser-certs/enduser-example.com.csr
</code></pre><p>样例输出：</p><pre tabindex=0><code>You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [AU]:NL
State or Province Name (full name) [Some-State]:Noord Holland
Locality Name (eg, city) []:Amsterdam
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Example Inc
Organizational Unit Name (eg, section) []:IT Dept
Common Name (e.g. server FQDN or YOUR name) []:example.com
Email Address []:

Please enter the following &#39;extra&#39; attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
</code></pre><p>使用中间 CA 签署末端用户的 CSR：</p><pre tabindex=0><code>openssl ca -batch -config ca.conf -notext -in enduser-certs/enduser-example.com.csr -out enduser-certs/enduser-example.com.crt
</code></pre><p>样例输出：</p><pre tabindex=0><code>Using configuration from ca.conf
Check that the request matches the signature
Signature ok
The Subject&#39;s Distinguished Name is as follows
countryName           :PRINTABLE:&#39;NL&#39;
stateOrProvinceName   :ASN.1 12:&#39;Noord Holland&#39;
localityName          :ASN.1 12:&#39;Amsterdam&#39;
organizationName      :ASN.1 12:&#39;Example Inc&#39;
organizationalUnitName:ASN.1 12:&#39;IT Dept&#39;
commonName            :ASN.1 12:&#39;example.com&#39;
Certificate is to be certified until Mar 30 15:18:26 2016 GMT (365 days)

Write out database with 1 new entries
Data Base Updated
</code></pre><p>生成 CRL（同时以 PEM 和 DER 格式）：</p><pre tabindex=0><code>openssl ca -config ca.conf -gencrl -keyfile intermediate1.key -cert intermediate1.crt -out intermediate1.crl.pem

openssl crl -inform PEM -in intermediate1.crl.pem -outform DER -out intermediate1.crl
</code></pre><p>每次你使用该 CA 签署证书后，都需要生成 CRL。</p><p>如果你需要撤销该末端用户证书：</p><pre tabindex=0><code>openssl ca -config ca.conf -revoke enduser-certs/enduser-example.com.crt -keyfile intermediate1.key -cert intermediate1.crt
</code></pre><p>样例输出：</p><pre tabindex=0><code>Using configuration from ca.conf
Revoking Certificate 1000.
Data Base Updated
</code></pre><p>通过连接根证书和中间证书来创建证书链文件。</p><pre tabindex=0><code>cat ../root/rootca.crt intermediate1.crt &gt; enduser-certs/enduser-example.com.chain
</code></pre><p>发送以下文件给末端用户：</p><pre tabindex=0><code>enduser-example.com.crt
enduser-example.com.key
enduser-example.com.chain
</code></pre><p>你也可以让末端用户提供他们自己的 CSR，而只发送给他们这个 .crt 文件。不要把它从服务器删除，否则你就不能撤销了。</p><h3 id=校验证书>校验证书</h3><p>你可以对证书链使用以下命令来验证末端用户证书：</p><pre tabindex=0><code>openssl verify -CAfile enduser-certs/enduser-example.com.chain enduser-certs/enduser-example.com.crt 
enduser-certs/enduser-example.com.crt: OK
</code></pre><p>你也可以针对 CRL 来验证。首先，将 PEM 格式的 CRL 和证书链相连接：</p><pre tabindex=0><code>cat ../root/rootca.crt intermediate1.crt intermediate1.crl.pem &gt; enduser-certs/enduser-example.com.crl.chain
</code></pre><p>验证证书：</p><pre tabindex=0><code>openssl verify -crl_check -CAfile enduser-certs/enduser-example.com.crl.chain enduser-certs/enduser-example.com.crt
</code></pre><p>没有撤销时的输出：</p><pre tabindex=0><code>enduser-certs/enduser-example.com.crt: OK
</code></pre><p>撤销后的输出如下：</p><pre tabindex=0><code>enduser-certs/enduser-example.com.crt: CN = example.com, ST = Noord Holland, C = NL, O = Example Inc, OU = IT Dept
error 23 at 0 depth lookup:certificate revoked
</code></pre><hr><p>via: <a href=https://raymii.org/s/tutorials/OpenSSL_command_line_Root_and_Intermediate_CA_including_OCSP_CRL%20and_revocation.html>https://raymii.org/s/tutorials/OpenSSL_command_line_Root_and_Intermediate_CA_including_OCSP_CRL%20and_revocation.html</a></p><p>作者：Remy van Elst 译者：<a href=https://github.com/GOLinux>GOLinux</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创翻译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/ca/ rel=tag>CA</a></li><li class=tags__item><a class="tags__link btn" href=/tags/%E8%AF%81%E4%B9%A6/ rel=tag>证书</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>