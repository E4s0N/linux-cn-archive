<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>为什么 Chrome 又不支持我的 HTTP/2 网站了？ - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="为什么 Chrome 又不支持我的 HTTP/2 网站了？"><meta property="og:description" content="原来是从 Chrome 51 开始，在 2016 年 5 月 31 日之前，对支持 NPN 协商协议的 HTTP/2 网站还会采用 HTTP/2 访问；而之后就只支持 ALPN 协商协议的 HTTP/2 网站了"><meta property="og:type" content="article"><meta property="og:url" content="/article-7934-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-11-06T13:01:00+00:00"><meta property="article:modified_time" content="2016-11-06T13:01:00+00:00"><meta itemprop=name content="为什么 Chrome 又不支持我的 HTTP/2 网站了？"><meta itemprop=description content="原来是从 Chrome 51 开始，在 2016 年 5 月 31 日之前，对支持 NPN 协商协议的 HTTP/2 网站还会采用 HTTP/2 访问；而之后就只支持 ALPN 协商协议的 HTTP/2 网站了"><meta itemprop=datePublished content="2016-11-06T13:01:00+00:00"><meta itemprop=dateModified content="2016-11-06T13:01:00+00:00"><meta itemprop=wordCount content="397"><meta itemprop=keywords content="Chrome,HTTP/2,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>为什么 Chrome 又不支持我的 HTTP/2 网站了？</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2016-11-06T13:01:00Z>November 06, 2016</time></div></div></header><div class="content post__content clearfix"><p>昨晚偶尔清理 Chrome 插件时发现我的 “<a href=https://chrome.google.com/webstore/detail/http2-and-spdy-indicator/mpbpobfflnpcgagjijhmgnchggcjblin>HTTP/2 and SPDY indicator</a>”插件好像好久没亮了。这个插件在你访问到一个支持 HTTP/2 （或之前的 SPDY 协议）的网站时会点亮，而我明明记得之前专门让 <a href=https://linux.cn/>https://linux.cn/</a> 支持了 HTTP/2 。</p><p>我的第一反应是不是这个插件有问题了？于是打开 Chrome 调试工具，然后发现，真的是请求和响应都是 HTTP/1.1 哎！</p><p>经过一番研究，原来是从 Chrome 51 开始，在 2016 年 5 月 31 日之前，对支持 NPN 协商协议的 HTTP/2 网站还会采用 HTTP/2 访问；而之后就只支持 ALPN 协商协议的 HTTP/2 网站了——而目前 ALPN 协议仅被鲜少有发行版支持 openssl-1.0.2 支持。</p><p><img src=https://img.linux.net.cn/data/attachment/album/201611/06/130031xmoaa0lutlcrualu.jpg alt></p><h3 id=发生了什么>发生了什么？</h3><h4 id=服务器端>服务器端</h4><p>我们知道，最初的 Web 访问协议是 HTTP/1，包括以前的 HTTP/1.0 和现在大部分网站采用的 HTTP/1.1（HTTP/0.9 是试验性协议，已经废弃）。但是随着 Web 应用越来越复杂，之前的 HTTP/1.x 协议就看起来不能满足日益庞杂的 Web 服务需求了。比如说，明文请求、请求复用等问题。因此，谷歌就开发了一个新的传输层协议，名为 SPDY。由于这个新的协议用了的人都说好，因此谷歌就把这个协议提交到了 IETF，然后大家觉得，SPDY 这名字不好听（SPDY 是谷歌的注册商标），就干脆叫 <a href=https://tools.ietf.org/html/rfc7540>HTTP/2</a> 吧！</p><p>SPDY 协议是基于 SSL/TLS 的，谷歌开发了一个名为 下一代协议协商 （ Next Protocol Negotiation ） （NPN）的 SSL/TLS 扩展，用于在客户端连接服务器时协商是否采用 HTTP/2 协议。SPDY 协议是由 Web 服务器所实现支持的，而 NPN 则是由 OpenSSL 等 SSL 实现支持的。</p><p>但是，随着 SPDY 被提交到 IETF，然后变成了 HTTP/2 协议，谷歌也放弃了 SPDY 的开发，全力投入到了 HTTP/2 的开发中，之前所采用 NPN 也被一种新的协商协议 ALPN —— 应用层协议协商 （ Application-Layer Protocol Negotiation ） 所替代。NPN 和 ALPN 是不兼容的，它们的主要不同是：</p><ul><li>NPN 是服务器发送所支持的协议列表，由客户端进行选择。而 ALPN 则是客户端发送该列表，由服务端选择。</li><li>在 NPN 中，最终的选择结果是在 Change Cipher Spec 之后发送给服务端的，也就是说是被加密了的。而在 ALPN 中，所有的协商都是明文的。</li></ul><p>这样做的好处主要是安全性方面的考虑，但是这造成了一个问题就是，NPN 已经广泛地被 OpenSSL 支持，而 ALPN 则目前只有最新的 openssl-1.0.2 才支持。当前的几个主流 Linux 发行版的 OpenSSL 版本以及支持的协商协议如下：</p><table><thead><tr><th>Linux 发行版</th><th>OpenSSL 版本</th><th>所支持的协商协议</th></tr></thead><tbody><tr><td>CentOS/Oracle Linux/RHEL 5.10+</td><td>0.9.8e</td><td>不支持</td></tr><tr><td>CentOS/Oracle Linux/RHEL 6.5+, 7.0+</td><td>1.0.1e</td><td>NPN</td></tr><tr><td>Ubuntu 12.04 LTS</td><td>1.0.1</td><td>NPN</td></tr><tr><td>Ubuntu 14.04 LTS</td><td>1.0.1f</td><td>NPN</td></tr><tr><td><em>Ubuntu 16.04 LTS</em></td><td><em>1.0.2g</em></td><td><em>ALPN 和 NPN</em></td></tr><tr><td>Debian 7.0</td><td>1.0.1e</td><td>NPN</td></tr><tr><td>Debian 8.0</td><td>1.0.1k</td><td>NPN</td></tr></tbody></table><p>从上面我们可以看到，基本上所有的服务器级的 Linux 发行版都不支持 OpenSSL 及 ALPN，唯一支持的 Ubuntu 16.04 LTS 显然用的不会很多。不要小看这 0.0.1 的版本差异，对于别的软件来说这 0.0.1 的差异基本上可以忽略，但是对于 OpenSSL 来说，那就是两个版本代际。OpenSSL 是个相当底层的库，很多重要的软件都依赖于它，因此各个发行版在升级 OpenSSL 时采用的态度是相当保守，比如我们可以看看 CentOS 系统中有哪些软件使用了 OpenSSL：</p><pre tabindex=0><code>$ lsof | grep libssl | awk &#39;{print $1}&#39; | sort | uniq
anvil
fail2ban
gdbus
gmain
httpd
postfix
mysqld
NetworkManager
nginx
php-fpm
puppet
sshd
sudo
tuned
zabbix_agent
</code></pre><p>没有经过足够的测试，Linux 发行版是不会在产品级（服务器级）的环境中随便升级的。为了解决旧版本（1.0.1）中的安全问题，他们宁可将新的版本（1.0.2）中安全修复移植回旧版本，也不会升级到有新功能的新版本（1.0.2），这就是你见到了各种 1.0.1e、1.0.1k 这样的版本号的原因。</p><p>当然，你可以自己编译一个最新 OpenSSL 替代你系统中的 openssl-1.0.1，但是我想你不会这样做的，是吧？</p><p>顺便提一句，NPN 和 ALPN 可以并存，但是会客户端会优先选择 ALPN。</p><h4 id=浏览器端chrome>浏览器端（Chrome）</h4><p>从 Chrome 51 开始，谷歌就去掉了对 SPDY 的支持，不过这不是个事，因为不但使用 SPDY 的 Web 服务器比较少，而且从 SPDY 升级到 HTTP/2 也很简单，这方面 Nginx、Apache 等服务器的配置都很简单。</p><p>但不幸的是，在 Chrome 51 中，谷歌也去掉了对 NPN 的支持！如果你的 Web 服务器使用的是 openssl-1.0.2 以下的版本，不支持 ALPN 协商，那么 Chrome 51 及以后版本就会以 HTTP/1 协议访问你的网站。</p><p>谷歌对放弃 NPN 支持做了一个<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=527066">简短的解释</a>，但是不管怎么说，NPN 协议在 Chrome 51 之后的版本不会再次回来了。而另一方面，OpenSSL 在 2016 年 12 月 31 日之后也不会继续发布 openssl-1.0.1 系列的新版本了，安全修复到此为止。</p><p>而在这种情况下，你原本支持 HTTP/2 的网站通过连接复用等 HTTP/2 所提供的新特性，在 Chrome 下访问取得了不错的体验，而现在又跌回了之前的残旧状态。</p><h3 id=怎么办呢>怎么办呢？</h3><p>有几种办法：</p><h4 id=换浏览器>换浏览器</h4><p>山不来就我，我去就山。Chrome 51+ 不支持带 NPN 的 HTTP/2 网站，作为浏览者，你可以使用其它的浏览器，比如 Safari、Edge 之类的。这样，你就可以用新的协议来访问世界上那 <a href=https://w3techs.com/technologies/details/ce-http2/all/all>10% 支持 HTTP/2 的 Web 服务器</a>了。</p><p>但是，作为服务器运营者，你却不能忽视<a href="https://www.netmarketshare.com/browser-market-share.aspx?qprid=0&amp;qpcustomd=0">高达 50% 以上的 Chrome 用户</a>。</p><h4 id=换服务器>换服务器</h4><p>如上面所示，Ubuntu 16.04 LTS 是目前唯一官方支持 openssl-1.0.2 的 Linux 发行版，如果你一直采用 Ubuntu 做服务器，考虑一下升级吧。LTS 版本的支持期长达五年。</p><p>当然，在产品环境中，即便你是 Ubuntu 服务器，更新版本也是一件重大事宜，宜慎思之。</p><h4 id=重新编译>重新编译</h4><p>既然换服务器不是一个好的选择，那你还有一个方案，就是使用新的 openssl-1.0.2 源代码重新编译你的 Web 服务器，比如 nginx。</p><p>下面我简单介绍一下如何用 openssl-1.0.2 来编译 nginx。（1.0.2 系列的最新版本是 1.0.2j，当然你要非用 1.1.0，我也无话可说……）</p><p>首先下载并解压 openssl-1.0.2j：</p><pre tabindex=0><code># wget https://www.openssl.org/source/openssl-1.0.2j.tar.gz
# tar -zxvf openssl-1.0.2j.tar.gz
</code></pre><p>然后在编译 nginx 的时候使用 <code>--with-openssl=../openssl-1.0.2j</code> 选项以及你的其它选项：</p><pre tabindex=0><code>./configure --with-openssl=../openssl-1.0.2j --with-http_v2_module --with-http_ssl_module
</code></pre><p>配置并编译之后，你可以用 <code>nginx -V</code>来看一下你的 nginx 中的 OpenSSL 版本。</p><p>这种自行编译的好处是灵活性高，但是你需要随时注意各个组件是否有严重的安全漏洞，并在出了修复版本之后重新编译。</p><h4 id=容器>容器</h4><p>除了自己编译之外，如果你的系统环境中已经有了容器支持，你还可以在容器中运行一个 Ubuntu 16.04 LTS，并将 Web 服务器运行在其中。</p><h3 id=总结>总结</h3><p>以上就是 HTTP/2 和 Chrome 之间的故事，你准备去升级 HTTP/2 支持了吗？要知道相比 HTTP/2 的访问体验，你肯定不会想再回到 HTTP/1 了。</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/chrome/ rel=tag>Chrome</a></li><li class=tags__item><a class="tags__link btn" href=/tags/http/2/ rel=tag>HTTP/2</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>