<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>为 Nginx 配置 ModSecurity 网络应用防火墙 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="为 Nginx 配置 ModSecurity 网络应用防火墙"><meta property="og:description" content="网络应用防火墙（WAF）是一种在应用层监控网络流量的应用程序。"><meta property="og:type" content="article"><meta property="og:url" content="/article-16479-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-12-16T09:25:48+00:00"><meta property="article:modified_time" content="2023-12-16T09:25:48+00:00"><meta itemprop=name content="为 Nginx 配置 ModSecurity 网络应用防火墙"><meta itemprop=description content="网络应用防火墙（WAF）是一种在应用层监控网络流量的应用程序。"><meta itemprop=datePublished content="2023-12-16T09:25:48+00:00"><meta itemprop=dateModified content="2023-12-16T09:25:48+00:00"><meta itemprop=wordCount content="523"><meta itemprop=keywords content="WAF,ModSecurity,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>为 Nginx 配置 ModSecurity 网络应用防火墙</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2023-12-16T09:25:48Z>December 16, 2023</time></div></div></header><div class="content post__content clearfix"><p><img src=https://img.linux.net.cn/data/attachment/album/202312/16/092516o1kqhzphvhh4h1hl.jpg alt></p><blockquote><p>网络应用防火墙（WAF）是一种在应用层监控网络流量的应用程序。</p></blockquote><p><a href=https://osi-model.com/>OSI（开放系统互联）</a> 是最常被网络相关讨论引用的网络流量框架之一。当数据包通过第 6 层（表示层）移动到第 7 层（应用层）时，它会进行解密或解码操作。这些操作可能会因异常解码和解释而产生漏洞，而这些漏洞可能被利用来打破标准应用上下文。注入就是这种漏洞的一种类型，而且因为传统的 <a href=https://en.wikipedia.org/wiki/Intrusion_detection_system>IDS/IPS</a> 设备无法应对这些威胁，所以其长时间以来一直是人们特别关注的问题。</p><h3 id=modsecurity-简介>ModSecurity 简介</h3><p><a href=https://github.com/SpiderLabs/ModSecurity>ModSecurity</a> 本质上就是 网络应用防火墙 web application firewall （WAF）引擎。它与 Apache、IIS 和 Nginx 兼容，并由第三方公司维护。该防火墙会将一份规则列表与由 Web 服务器/代理提供的 HTTP 头流进行交叉引用。目前这个仓库已经被简化，只包含主要的 LibModSecurity 库。你可以直接在自己的服务器实现中调用这个库，或通过特定编程语言的封装进行调用。</p><p>其母公司的支持计划于 2024 年 7 月 1 日结束，之后这个项目将由开源社区维护。</p><h3 id=安装-nginx-连接器>安装 Nginx 连接器</h3><p><a href=https://github.com/SpiderLabs/ModSecurity-nginx>Nginx 连接器</a> 是一个 Nginx 动态模块，可以通过 Fedora 包 <code>nginx-mod-modsecurity</code> 进行安装。它依赖于 <code>libmodsecurity.so</code>，所以在这个使用场景中，这个包本身就是防火墙。</p><pre tabindex=0><code>[user@fedora ~]$ sudo dnf install -y nginx nginx-mod-modsecurity
[user@fedora ~]$ rpm -qR nginx-mod-modsecurity
config(nginx-mod-modsecurity) = 1.0.3-3.fc38
libc.so.6(GLIBC_2.4)(64bit)
libmodsecurity.so.3()(64bit)
nginx(abi) = 1.24.0
nginx-filesystem
...
</code></pre><p>安装完成后，你会见到连接器在 <code>/etc/nginx</code> 中添加了一些重要的文件。</p><pre tabindex=0><code>[user@fedora ~]$ rpm -ql nginx-mod-modsecurity
/etc/nginx/modsecurity.conf                   # waf 配置
/etc/nginx/nginx.conf.modsecurity             # nginx 示例配置
/usr/lib64/nginx/modules/ngx_http_modsecurity_module.so
/usr/share/nginx/modules/mod-modsecurity.conf
/usr/share/doc/nginx-mod-modsecurity/README.md
...
</code></pre><p>通过提供一些额外的配置指令，连接器对 Nginx 进行了扩展。下面的部分将演示 <code>nginx.conf.modsecurity</code> 文件中一些示例指令。指令的完整列表可以在 <code>README.md</code> 文件或项目的 GitHub 页面找到。</p><h3 id=启动网络应用防火墙>启动网络应用防火墙</h3><p><code>nginx.conf.modsecurity</code> 是我们将要运行的 Nginx 配置。解开如下所示的 <em>modsecurity</em> 行注释：</p><pre tabindex=0><code>[user@fedora ~]$ sudo sed -i &#39;s/#modsec/modsec/g&#39; /etc/nginx/nginx.conf.modsecurity
[user@fedora ~]$ grep -C2 modsecurity /etc/nginx/nginx.conf.modsecurity
        # 如有需要，启用 ModSecurity WAF
        modsecurity on;
        # 如有需要，加载 ModSecurity CRS
        modsecurity_rules_file /etc/nginx/modsecurity.conf;
</code></pre><p>在 shell 中启动服务器并查看日志，确保在 <code>modsecurity.conf</code> 加载了七个默认规则。</p><pre tabindex=0><code>[user@fedora ~]$ sudo nginx -c /etc/nginx/nginx.conf.modsecurity
[user@fedora ~]$ head /var/log/nginx/error.log
2023/10/21 23:55:09 [notice] 46218#46218: ModSecurity-nginx v1.0.3 (rules loaded inline/local/remote: 0/7/0)
2023/10/21 23:55:09 [notice] 46218#46218: using the &#34;epoll&#34; event method
2023/10/21 23:55:09 [notice] 46218#46218: nginx/1.24.0
2023/10/21 23:55:09 [notice] 46218#46218: OS: Linux 6.5.7-200.fc38.x86_64
</code></pre><p>通过发送一些不符合 <code>Content-Type</code> 头格式的数据来测试默认规则。</p><pre tabindex=0><code>[user@fedora ~]$ curl -X POST http://localhost -H &#34;Content-Type: application/json&#34; --data &#34;&lt;xml&gt;&lt;/xml&gt;&#34;
[user@fedora ~]$ tail /var/log/modsec_audit.log
...
---rH5bFain---H--
ModSecurity: Warning. Matched &#34;Operator `Eq&#39; with parameter `0&#39; against variable `REQBODY_ERROR&#39; (Value: `1&#39; ) [file &#34;/etc/nginx/modsecurity.conf&#34;] [line &#34;75&#34;] [id &#34;200002&#34;] [rev &#34;&#34;] [msg &#34;Failed to parse request body.&#34;] [data &#34;JSON parsing error: lexical error: invalid char in json text.\n&#34;] [severity &#34;2&#34;] [ver &#34;&#34;] [maturity &#34;0&#34;] [accuracy &#34;0&#34;] [hostname &#34;10.0.2.100&#34;] [uri &#34;/&#34;] [unique_id &#34;169795900388.487044&#34;] [ref &#34;v121,1&#34;]
</code></pre><h3 id=用-owasp-核心规则集扩展你的网络应用防火墙>用 OWASP 核心规则集扩展你的网络应用防火墙</h3><p>默认的 Nginx 连接器带有七条规则。OWASP <a href=https://github.com/coreruleset/coreruleset/tree/v3.3.5/rules>Core Rule Set v3.3.5</a> 则更为详尽，涵盖了许多场景。</p><p>复制并提取规则的存档。</p><pre tabindex=0><code>[user@fedora ~]$ curl -fSL https://github.com/coreruleset/coreruleset/archive/refs/tags/v3.3.5.tar.gz --output /tmp/v3.3.5.tar.gz
[user@fedora ~]$ sudo tar -C /etc/nginx -xvf /tmp/v3.3.5.tar.gz
[user@fedora ~]$ tree -L 1 /etc/nginx/
/etc/nginx/
├── conf.d
├── default.d
├── modsecurity.conf          # waf 配置
├── nginx.conf
├── nginx.conf.modsecurity    # nginx 启用 waf
├── coreruleset-3.3.5
├   ├── rules                 # 规则目录
├       ...
├   ...
</code></pre><p>现在，你在 Nginx 配置文件夹中有了一个包含所有当前 OWASP 规则的 <code>rules</code> 目录。接下来，让 Nginx 知道这些规则。以下操作指南来源于 OWASP <a href=https://github.com/coreruleset/coreruleset/blob/v3.3.5/INSTALL>INSTALL</a> 文件。</p><p>创建一个 <code>crs.conf</code> 文件，并在全局网络应用防火墙配置文件（ <code>modsecurity.conf</code> ）中包含所有相关的配置文件。</p><pre tabindex=0><code>[user@fedora ~]$ sudo cp /etc/nginx/coreruleset-3.3.5/crs-setup.conf.example /etc/nginx/coreruleset-3.3.5/crs.conf
[user@fedora ~]$ echo -e &#34;\nInclude /etc/nginx/coreruleset-3.3.5/crs.conf&#34;  | sudo tee -a /etc/nginx/modsecurity.conf
[user@fedora ~]$ echo -e &#34;\nInclude /etc/nginx/coreruleset-3.3.5/rules/*.conf&#34; | sudo tee -a /etc/nginx/modsecurity.conf
[user@fedora ~]$ tail /etc/nginx/modsecurity.conf
Include /etc/nginx/coreruleset-3.3.5/crs.conf
Include /etc/nginx/coreruleset-3.3.5/rules/*.conf
</code></pre><p>根据文档，包含这些文件的顺序很重要。上面的 <code>tee</code> 的命令将新的 <code>Include</code> 行放在了 <code>modsecurity.conf</code> 文件的末尾。现在，用这个新配置重启 Nginx。</p><pre tabindex=0><code>[user@fedora ~]$ sudo nginx -s stop &amp;&amp; sudo nginx -c /etc/nginx/nginx.conf.modsecurity
[user@fedora ~]$ tail /var/log/nginx/error.log
2023/10/22 10:53:23 [notice] 202#202: exit
2023/10/22 10:53:50 [notice] 230#230: ModSecurity-nginx v1.0.3 (rules loaded inline/local/remote: 0/921/0)
2023/10/22 10:53:50 [notice] 230#230: using the &#34;epoll&#34; event method
2023/10/22 10:53:50 [notice] 230#230: nginx/1.24.0
2023/10/22 10:53:50 [notice] 230#230: OS: Linux 6.5.7-200.fc38.x86_64
2023/10/22 10:53:50 [notice] 230#230: getrlimit(RLIMIT_NOFILE): 524288:524288
2023/10/22 10:53:50 [notice] 231#231: start worker processes
</code></pre><p>注意，Nginx 成功加载了 921 条规则。还需要做一些测试来确保规则实际上是被网络应用防火墙检查过的。这里再次引用 <code>INSTALL</code> 文件中的 “Testing the Installation” 片段。</p><pre tabindex=0><code>[user@fedora ~]$ curl &#39;http://localhost/?param=&#39;&#39;&gt;&lt;script&gt;alert(1);&lt;/script&gt;&#39;
[user@fedora ~]$ tail /var/log/modsec_audit.log
...
---8NSpdnLe---H--
ModSecurity: Warning. detected XSS using libinjection. [file &#34;/etc/nginx/coreruleset-3.3.5/rules/REQUEST-941-APPLICATION-ATTACK-XSS.conf&#34;] [line &#34;38&#34;] [id &#34;941100&#34;] [rev &#34;&#34;] [msg &#34;XSS Attack Detected via libinjection&#34;] [data &#34;Matched Data: XSS data found within ARGS:param: &gt;&lt;script&gt;alert(1);&lt;/script&gt;&#34;] [severity &#34;2&#34;] [ver &#34;OWASP_CRS/3.3.5&#34;]
...
</code></pre><h3 id=结论>结论</h3><p>本文演示了如何为 Nginx 服务器配置网络应用防火墙。这个部署使用了标准规则和 OWASP Core Rule Set v3.3.5。演示的防火墙在<strong>检测模式</strong>中运行并记录不寻常的行为。将防火墙运行在<strong>防御模式</strong>要对 <code>modsecurity.conf</code> 进行更多改动。请参考 <a href=https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual-(v3.x)>ModSecurity Reference Manual v3.x</a> 获取如何启用防御模式和更多信息。</p><p>祝你好运。</p><p><em>（题图：DA/7ec85bc4-b209-4fc6-9275-8f7d1430f6ca）</em></p><hr><p>via: <a href=https://fedoramagazine.org/a-web-application-firewall-for-nginx/>https://fedoramagazine.org/a-web-application-firewall-for-nginx/</a></p><p>作者：<a href=https://fedoramagazine.org/author/romangherta/>Roman Gherta</a> 选题：<a href=https://github.com/lujun9972>lujun9972</a> 译者：<a href=https://linux.cn/lctt/ChatGPT>ChatGPT</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=https://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/waf/ rel=tag>WAF</a></li><li class=tags__item><a class="tags__link btn" href=/tags/modsecurity/ rel=tag>ModSecurity</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>