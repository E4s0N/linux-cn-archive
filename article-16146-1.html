<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>FreeBSD 现在能在 25 毫秒内完成启动 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="FreeBSD 现在能在 25 毫秒内完成启动"><meta property="og:description" content="这是运行在 AWS Firecracker 上的，当然，同时也有其他的新兴微虚拟机引擎可供选择。"><meta property="og:type" content="article"><meta property="og:url" content="/article-16146-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-31T16:28:00+00:00"><meta property="article:modified_time" content="2023-08-31T16:28:00+00:00"><meta itemprop=name content="FreeBSD 现在能在 25 毫秒内完成启动"><meta itemprop=description content="这是运行在 AWS Firecracker 上的，当然，同时也有其他的新兴微虚拟机引擎可供选择。"><meta itemprop=datePublished content="2023-08-31T16:28:00+00:00"><meta itemprop=dateModified content="2023-08-31T16:28:00+00:00"><meta itemprop=wordCount content="201"><meta itemprop=keywords content="微虚拟机,FreeBSD,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>FreeBSD 现在能在 25 毫秒内完成启动</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2023-08-31T16:28:00Z>August 31, 2023</time></div></div></header><div class="content post__content clearfix"><blockquote><p>这是运行在 AWS Firecracker 上的，当然，同时也有其他的新兴微 虚拟机 （ microVM ） 引擎可供选择。</p></blockquote><p><img src=https://img.linux.net.cn/data/attachment/album/202308/31/162750z9mduhkks254zsdd.jpg alt></p><p>在更换了 FreeBSD 内核中的排序算法后，其启动速度提高了 100 倍以上……虽然这是专门针对 微虚拟机 microVM 的优化，但所有人都应能从中受益。</p><p>过去五年，微虚拟机在科技研发领域中备受关注。其核心理念是重新包装和创新了 IBM 在 1960 年代随着 虚拟机管理程序 hypervisor 诞生所发明的 <a href=https://www.theregister.com/2011/07/14/brief_history_of_virtualisation_part_2/>一些概念和技术</a>：设计专门作为另一个操作系统上的访客系统运行的操作系统。这意味着该操作系统必须专门构建在虚拟机内执行，并与特定的管理程序提供的资源进行交互，而不是模拟硬件。</p><p>这就意味着访客操作系统几乎不需要针对真实硬件的支持，只需要 <a href=https://wiki.osdev.org/Virtio>VirtIO</a> 驱动，它们可以直接和宿主机的管理程序提供的功能进行交互。反过来说，管理程序无需提供模拟的 PCI 总线、模拟的电源管理、模拟的显卡、模拟的网卡等等。结果就是，管理程序本身可以变得更加微型和简化。</p><p>通过无情地缩减虚拟机监视器和运行在其内部的操作系统，这让两端都能更小、更简洁。意味着虚拟机能更少的使用资源，并能更快速地启动。</p><p>目前，这个商业目标是提供 “ 无服务器 serverless ” 的计算能力。实际上，“无服务器” 是一种市场双关语：当然，真实世界中的服务器仍存在于某个数据中心中。但这与提供“基础设施即服务（IaaS）”模型不同，而是提供“<a href=https://www.theregister.com/2018/12/19/serverless_computing_study/>函数即服务（FaaS）</a>”的模式。这就代表着你不需要了解任何有关基础设施的知识 —— 你的程序直接调用另一个程序，然后管理工具会运行所需的特定操作，返回结果，然后删除用于执行计算的虚拟机。你根本不需要知道这过程在何处，如何进行。</p><p>对消费者来说，这种技术的优势在于其快速和易用性。而对服务提供商而言，因为能够更快地回收和再利用资源，使得相同的硬件能服务更多的客户，这是一个巨大的优势。</p><p>AWS 通过一项名为 Lambda 的服务提供 FaaS，这个名称是来源于一个深奥的函数式编程术语。Lambda 由亚马逊自家研发的 <a href=https://www.theregister.com/2018/11/27/aws_sets_firecracker/>Firecracker</a> 管理程序提供支持，Firecracker 同样也支撑着 <a href=https://www.theregister.com/2020/04/09/aws_revamps_fargate_serverless_containers/>Fargate</a> 这一无服务器服务。</p><p>Firecracker 基于 Linux 内核的内建 KVM 管理程序：这本身就有别于之前 AWS <a href=https://www.theregister.com/2017/11/07/aws_writes_new_kvm_based_hypervisor_to_make_its_cloud_go_faster/>基于 Xen 管理程序</a> 的实践。这也就意味着它本质上是一个 Linux-on-Linux 的解决方案。这听起来对 FreeBSD 内核开发者 Colin Percival 来说像是一个挑战，正如我们 <a href=https://www.theregister.com/2022/10/19/freebsd_comes_to_amazons_lightweight/>一年前的报道</a>：他决定在 Firecracker 上运行 FreeBSD。然而就如同大部分的计算任务一样，优化的过程大致上是：首先，让它可以运行；然后，提高其运行速度。</p><p>根据他本周稍早的一则 <a href=https://twitter.com/cperciva/status/1693127769901969772>推文</a>，他最新的性能优化成果相当令人震惊：替换排序算法使 FreeBSD 内核启动过程加速了约一百倍，将内核加载时间降至了惊人的 25 毫秒。换言之，只有四十分之一秒的时间。</p><blockquote><p>FreeBSD（HEAD）现已不再执行其 SYSINIT 上的冒泡排序。如今，我们运行的是更高效、速度大概快了 100 倍的归并排序：<a href="https://cgit.freebsd.org/src/commit/?id=9a7add6d01f3c5f7eba811e794cf860d2bce131d">https://cgit.freebsd.org/src/commit/?id=9a7add6d01f3c5f7eba811e794cf860d2bce131d</a></p><blockquote><p>当 FreeBSD 内核在 Firecracker （配备 1 CPU，128 MB 内存）中启动时，现在有大约 7% 的时间用于执行其 SYSINIT 上的冒泡排序。</p><p>当你需要对上千个条目进行排序时，<code>O(N^2)</code> 的复杂度可能会带来较大的影响。因此，是时候将冒泡排序替换为更高效的算法了。</p></blockquote></blockquote><p>这一调整只是一系列优化措施中的最新一个环节，两天后，他进一步 <a href=https://www.usenix.org/publications/loginonline/freebsd-firecracker>详细</a> 阐述了这些优化。这包括了引导所需的初始更改：消除了假定在 Xen 下引导的一些初始化步骤，然后查询 ACPI 获取处理器的类型和数量。这一步出现了问题，因为 Firecracker 并未提供 ACPI。接着，对其仿真的唯一的硬件，串行控制台，进行初始化也失败了。</p><p>在内核成功启动之后，内存的使用迅速成为了一个问题：Firecracker 默认只给客户端分配了 128MB 的内存，原因在于一个必须修改的假设。之后是一整套的优化清单，每一项都为减少时间作出了一部分贡献。</p><p>即便你不是特别懂技术，阅读这篇文章也会很有趣。一些步骤更改了在专用硬件上引导的合理选择，在虚拟环境中，这些选择在机器产生、做工作、然后在几秒钟内再次被删除的情况下，已经无法适用。</p><p>Percival <a href="https://news.ycombinator.com/item?id=37205578">评论</a> 称：</p><blockquote><p>我相信在相同的环境下，Linux 的引导时间是 75-80 毫秒，而我已经让 FreeBSD 在 25 毫秒内引导。</p></blockquote><p>他 <a href="https://news.ycombinator.com/item?id=37205475">接着</a> 说道：</p><blockquote><p>当我开始研究提速引导的过程时，内核大约需要 10 秒钟的时间来引导，所以现在我拥有的内核引导速度，比我几年前快约 400 倍。</p></blockquote><p>目前，已经优化的系统内核是 FreeBSD 14 版的，运行在 x86-64 架构上，但也正在进行适配到 Arm64 的工作 —— AWS 是世界上 <a href=https://www.theregister.com/2023/08/08/amazon_arm_servers/>最大的 Arm 服务器用户</a>。</p><p>Firecracker 是众多备受瞩目的微虚拟机中的一员，但也有其他的微虚拟机，而且它的成功也激励了 QEMU 开发者增加了一个 <a href=https://qemu.readthedocs.io/en/v8.1.0/system/i386/microvm.html>微虚拟机</a> 平台。Canonical 的开发者 Christian Erhardt 在 <a href=https://cpaelzer.github.io/blogs/009-microvm-in-ubuntu/>博客</a> 上介绍了如何在 Ubuntu 中使用这种技术，并且在线代码开发环境供应商 Hocus 最近 <a href=https://hocus.dev/blog/qemu-vs-firecracker/>解释</a> 了为什么它从 Firecracker 转移到了 QEMU 等价物。</p><p>我们可以看到微虚拟机有很多潜在的使用场景，不仅仅是在云场景中。能够在一个完全不同的 OS 上运行为另一个 OS 构建的单个程序，而不需要始终运行完整的模拟环境，可能在各种情况下都非常方便。</p><p>容器是一个非常有用的工具，但在容器中你只能运行与宿主 OS 相同的二进制文件。运行任何其他的东西 —— 比如在 macOS 上运行 Docker Linux 容器 —— 意味着有一些模拟和一个访客操作系统被隐藏在堆栈的某个位置。这个 VM 能够越小，并且使用的资源越少，无论是对容器还是整个机器的整体性能来说都会更好。</p><p><em>（题图：MJ/a5910e84-656d-4a5c-abad-bb0b0ffcb3fc）</em></p><hr><p>via: <a href=https://www.theregister.com/2023/08/29/freebsd_boots_in_25ms/>https://www.theregister.com/2023/08/29/freebsd_boots_in_25ms/</a></p><p>作者：<a href=https://www.theregister.com/Author/Liam-Proven>Liam Proven</a> 译者：ChatGPT 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创编译，<a href=/article-16144-1.html>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/%E5%BE%AE%E8%99%9A%E6%8B%9F%E6%9C%BA/ rel=tag>微虚拟机</a></li><li class=tags__item><a class="tags__link btn" href=/tags/freebsd/ rel=tag>FreeBSD</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>