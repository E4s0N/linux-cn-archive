<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>如何在 Quagga BGP 路由器中设置 IPv6 的 BGP 对等体和过滤 - Linux.cn Archive</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="如何在 Quagga BGP 路由器中设置 IPv6 的 BGP 对等体和过滤"><meta property="og:description" content="在之前的教程中，我们演示了如何使用Quagga建立一个完备的BGP路由器和配置前缀过滤。在本教程中，我们会向你演示如何创建IPv6 BGP对等体并通过BGP通告IPv6前缀。同时我们也将演示如何使用前缀列表和路由映射特性来过滤通告的或者获取到的IPv6前缀。 拓扑 教程中，我们主要参考如下拓扑。  服务供应商A和B希望在他们之间建立一个IPv6的BGP对等体。他们的IPv6地址和AS信息如下所示。  对等体IP块: 2001:DB8:3::/64 供应商A: AS 100, 2001:DB8:1::/48 供应商B: AS 200, 2001:DB8:2::/48  CentOS/RHEL安装Quagga 如果Quagga还没有安装，我们可"><meta property="og:type" content="article"><meta property="og:url" content="/article-6147-1.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-09-04T17:39:00+00:00"><meta property="article:modified_time" content="2015-09-04T17:39:00+00:00"><meta itemprop=name content="如何在 Quagga BGP 路由器中设置 IPv6 的 BGP 对等体和过滤"><meta itemprop=description content="在之前的教程中，我们演示了如何使用Quagga建立一个完备的BGP路由器和配置前缀过滤。在本教程中，我们会向你演示如何创建IPv6 BGP对等体并通过BGP通告IPv6前缀。同时我们也将演示如何使用前缀列表和路由映射特性来过滤通告的或者获取到的IPv6前缀。 拓扑 教程中，我们主要参考如下拓扑。  服务供应商A和B希望在他们之间建立一个IPv6的BGP对等体。他们的IPv6地址和AS信息如下所示。  对等体IP块: 2001:DB8:3::/64 供应商A: AS 100, 2001:DB8:1::/48 供应商B: AS 200, 2001:DB8:2::/48  CentOS/RHEL安装Quagga 如果Quagga还没有安装，我们可"><meta itemprop=datePublished content="2015-09-04T17:39:00+00:00"><meta itemprop=dateModified content="2015-09-04T17:39:00+00:00"><meta itemprop=wordCount content="384"><meta itemprop=keywords content="Quagga,路由器,"><link rel=preconnect href=https://fonts.bunny.net crossorigin><link rel=dns-prefetch href=//fonts.bunny.net><link rel=dns-prefetch href=//fonts.bunny.net><link rel=stylesheet href="https://fonts.bunny.net/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Linux.cn Archive" rel=home><div class="logo__item logo__text"><div class=logo__title>Linux.cn Archive</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>Categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>Tags</span></a></li><li class=menu__item><a class=menu__link href><span class=menu__text>RSS</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>如何在 Quagga BGP 路由器中设置 IPv6 的 BGP 对等体和过滤</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2015-09-04T17:39:00Z>September 04, 2015</time></div></div></header><div class="content post__content clearfix"><p>在之前的教程中，我们演示了如何使用Quagga建立一个<a href=/article-4232-1.html>完备的BGP路由器</a>和配置<a href=http://xmodulo.com/filter-bgp-routes-quagga-bgp-router.html>前缀过滤</a>。在本教程中，我们会向你演示如何创建IPv6 BGP对等体并通过BGP通告IPv6前缀。同时我们也将演示如何使用前缀列表和路由映射特性来过滤通告的或者获取到的IPv6前缀。</p><h3 id=拓扑>拓扑</h3><p>教程中，我们主要参考如下拓扑。</p><p><img src=/data/attachment/album/201509/04/173911o1e7oo1d9m1coao8.jpg alt></p><p>服务供应商A和B希望在他们之间建立一个IPv6的BGP对等体。他们的IPv6地址和AS信息如下所示。</p><ul><li>对等体IP块: 2001:DB8:3::/64</li><li>供应商A: AS 100, 2001:DB8:1::/48</li><li>供应商B: AS 200, 2001:DB8:2::/48</li></ul><h3 id=centosrhel安装quagga>CentOS/RHEL安装Quagga</h3><p>如果Quagga还没有安装，我们可以先使用yum安装。</p><pre tabindex=0><code># yum install quagga 
</code></pre><p>在CentOS/RHEL 7，SELinux策略会默认的阻止对于/usr/sbin/zebra配置目录的写操作，这会对我们将要介绍的安装操作有所影响。因此我们需要像下面这样关闭这个策略。如果你使用的是CentOS/RHEL 6可以跳过这一步。</p><pre tabindex=0><code># setsebool -P zebra_write_config 1 
</code></pre><h3 id=创建配置文件>创建配置文件</h3><p>在安装过后，我们先创建配置文件zebra/bgpd作为配置流程的开始。</p><pre tabindex=0><code># cp /usr/share/doc/quagga-XXXXX/zebra.conf.sample /etc/quagga/zebra.conf
# cp /usr/share/doc/quagga-XXXXX/bgpd.conf.sample /etc/quagga/bgpd.conf
</code></pre><p>然后，允许这些服务开机自启。</p><p><strong>在 CentOS/RHEL 6:</strong></p><pre tabindex=0><code># service zebra start; service bgpd start
# chkconfig zebra on; chkconfig bgpd on 
</code></pre><p><strong>在 CentOS/RHEL 7:</strong></p><pre tabindex=0><code># systemctl start zebra; systemctl start bgpd
# systemctl enable zebra; systmectl enable bgpd 
</code></pre><p>Quagga内部提供一个叫作vtysh的shell，其界面与那些主流路由厂商Cisco或Juniper十分相似。启动vtysh shell命令行：</p><pre tabindex=0><code># vtysh
</code></pre><p>提示符将改为：</p><pre tabindex=0><code>router-a#
</code></pre><p>或</p><pre tabindex=0><code>router-b# 
</code></pre><p>在教程的其余部分，这个提示可以表明你正身处在哪个路由的vtysh shell中。</p><h3 id=为zebra指定日志文件>为Zebra指定日志文件</h3><p>来为Zebra配置日志文件，这会有助于调试。</p><p>首先，进入全局配置模式通过输入：</p><pre tabindex=0><code>router-a# configure terminal 
</code></pre><p>提示符将变更成：</p><pre tabindex=0><code>router-a(config)#
</code></pre><p>指定日志文件的位置。然后退出配置模式：</p><pre tabindex=0><code>router-a(config)# log file /var/log/quagga/quagga.log
router-a(config)# exit 
</code></pre><p>保存配置通过：</p><pre tabindex=0><code>router-a# write 
</code></pre><h3 id=配置接口ip地址>配置接口IP地址</h3><p>现在，让我们为Quagga的物理接口配置IP地址。</p><p>首先，查看一下vtysh中现有的接口。</p><pre tabindex=0><code>router-a# show interfaces 
</code></pre><hr><pre tabindex=0><code>Interface eth0 is up, line protocol detection is disabled
## OUTPUT TRUNCATED ###
Interface eth1 is up, line protocol detection is disabled
## OUTPUT TRUNCATED ##
</code></pre><p>现在我们配置IPv6地址。</p><pre tabindex=0><code>router-a# conf terminal
router-a(config)# interface eth0
router-a(config-if)# ipv6 address 2001:db8:3::1/64
router-a(config-if)# interface eth1
router-a(config-if)# ipv6 address 2001:db8:1::1/64
</code></pre><p>在路由B上采用同样的方式分配IPv6地址。我将配置汇总成如下。</p><pre tabindex=0><code>router-b# show running-config 
</code></pre><hr><pre tabindex=0><code>interface eth0
ipv6 address 2001:db8:3::2/64

interface eth1
ipv6 address 2001:db8:2::1/64
</code></pre><p>由于两台路由的eth0端口同属一个子网，即2001：DB8：3::/64，你应该可以相互ping通。在保证ping通的情况下，我们开始下面的内容。</p><pre tabindex=0><code>router-a# ping ipv6 2001:db8:3::2 
</code></pre><hr><pre tabindex=0><code>PING 2001:db8:3::2(2001:db8:3::2) 56 data bytes
64 bytes from 2001:db8:3::2: icmp_seq=1 ttl=64 time=3.20 ms
64 bytes from 2001:db8:3::2: icmp_seq=2 ttl=64 time=1.05 ms
</code></pre><h3 id=步骤-1-ipv6-bgp-对等体>步骤 1: IPv6 BGP 对等体</h3><p>本段，我们将在两个路由之间配置IPv6 BGP。首先，我们在路由A上指定BGP邻居。</p><pre tabindex=0><code>router-a# conf t
router-a(config)# router bgp 100
router-a(config-router)# no auto-summary
router-a(config-router)# no synchronization
router-a(config-router)# neighbor 2001:DB8:3::2 remote-as 200
</code></pre><p>然后，我们定义IPv6的地址族。在地址族中，我们需要定义要通告的网段，并激活邻居。</p><pre tabindex=0><code>router-a(config-router)# address-family ipv6
router-a(config-router-af)# network 2001:DB8:1::/48
router-a(config-router-af)# neighbor 2001:DB8:3::2 activate
</code></pre><p>我们在路由B上也实施相同的配置。这里提供我归总后的配置。</p><pre tabindex=0><code>router-b# conf t
router-b(config)# router bgp 200
router-b(config-router)# no auto-summary
router-b(config-router)# no synchronization
router-b(config-router)# neighbor 2001:DB8:3::1 remote-as 100
router-b(config-router)# address-family ipv6
router-b(config-router-af)# network 2001:DB8:2::/48
router-b(config-router-af)# neighbor 2001:DB8:3::1 activate
</code></pre><p>如果一切顺利，在路由间将会形成一个IPv6 BGP会话。如果失败了，请确保<a href=http://ask.xmodulo.com/open-port-firewall-centos-rhel.html>在防火墙中开启了</a>必要的端口（TCP 179）。</p><p>我们使用以下命令来确认IPv6 BGP会话的信息。</p><p><strong>查看BGP汇总：</strong></p><pre tabindex=0><code>router-a# show bgp ipv6 unicast summary 
</code></pre><p><strong>查看BGP通告的路由：</strong></p><pre tabindex=0><code>router-a# show bgp ipv6 neighbors &lt;neighbor-IPv6-address&gt; advertised-routes 
</code></pre><p><strong>查看BGP获得的路由：</strong></p><pre tabindex=0><code>router-a# show bgp ipv6 neighbors &lt;neighbor-IPv6-address&gt; routes 
</code></pre><p><img src=/data/attachment/album/201509/04/173914ea9umab6x0bzbpbr.jpg alt></p><h3 id=步骤-2-过滤ipv6前缀>步骤 2： 过滤IPv6前缀</h3><p>正如我们在上面看到的输出信息那样，路由间通告了他们完整的/48 IPv6前缀。出于演示的目的，我们会考虑以下要求。</p><ul><li>Router-B将通告一个/64前缀，一个/56前缀，和一个完整的/48前缀.</li><li>Router-A将接受任由B提供的何形式的IPv6前缀，其中包含有/56和/64之间的网络掩码长度。</li></ul><p>我们将根据需要过滤的前缀，来使用路由器的前缀列表和路由映射。</p><p><img src=/data/attachment/album/201509/04/173914lxqhqv7vznp2wllv.jpg alt></p><h4 id=为路由b修改通告的前缀>为路由B修改通告的前缀</h4><p>目前，路由B只通告一个/48前缀。我们修改路由B的BGP配置使它可以通告额外的/56和/64前缀。</p><pre tabindex=0><code>router-b# conf t
router-b(config)# router bgp 200
router-b(config-router)# address-family ipv6
router-b(config-router-af)# network 2001:DB8:2::/56
router-b(config-router-af)# network 2001:DB8:2::/64
</code></pre><p>我们将路由A上验证了所有的前缀都获得到了。</p><p><img src=/data/attachment/album/201509/04/173916aqr7rd8sf70o37fs.jpg alt></p><p>太好了！我们在路由A上收到了所有的前缀，那么我们可以更进一步创建前缀列表和路由映射来过滤这些前缀。</p><h4 id=创建前缀列表>创建前缀列表</h4><p>就像在<a href=http://xmodulo.com/filter-bgp-routes-quagga-bgp-router.html>上则教程中</a>描述的那样，前缀列表是一种机制用来匹配带有子网长度的IP地址前缀。按照我们指定的需求，我们需要在路由A的前缀列表中创建一则必要的条目。</p><pre tabindex=0><code>router-a# conf t
router-a(config)# ipv6 prefix-list FILTER-IPV6-PRFX permit 2001:DB8:2::/56 le 64
</code></pre><p>以上的命令会创建一个名为&rsquo;FILTER-IPV6-PRFX&rsquo;的前缀列表，用以匹配任何2001:DB8:2::池内掩码在56和64之间的所有前缀。</p><h4 id=创建并应用路由映射>创建并应用路由映射</h4><p>现在已经在前缀列表中创建了条目，我们也应该相应的创建一条使用此条目的路由映射规则了。</p><pre tabindex=0><code>router-a# conf t
router-a(config)# route-map FILTER-IPV6-RMAP permit 10
router-a(config-route-map)# match ipv6 address prefix-list FILTER-IPV6-PRFX
</code></pre><p>以上的命令会创建一条名为&rsquo;FILTER-IPV6-RMAP&rsquo;的路由映射规则。这则规则将会允许与之前在前缀列表中创建&rsquo;FILTER-IPV6-PRFX&rsquo;所匹配的IPv6</p><p>要记住路由映射规则只有在应用在邻居或者端口的指定方向时才有效。我们将把路由映射应用到BGP的邻居配置中。我们将路由映射应用于入方向，作为进入路由端的前缀过滤器。</p><pre tabindex=0><code>router-a# conf t
router-a(config)# router bgp 100
router-a(config-router)# address-family ipv6
router-a(config-router-af)# neighbor 2001:DB8:3::2 route-map FILTER-IPV6-RMAP in
</code></pre><p>现在我们在路由A上再查看一边获得到的路由，我们应该只能看见两个被允许的前缀了。</p><p><img src=/data/attachment/album/201509/04/173916dobocuovowbvbcuw.jpg alt></p><p><strong>注意</strong>： 你可能需要重置BGP会话来刷新路由表。</p><p>所有IPv6的BGP会话可以使用以下的命令重启：</p><pre tabindex=0><code>router-a# clear bgp ipv6 * 
</code></pre><p>我汇总了两个路由的配置，并做成了一张清晰的图片以便阅读。</p><p><img src=/data/attachment/album/201509/04/173917kwv7fq0cfcv2n0nx.jpg alt></p><h3 id=总结>总结</h3><p>总结一下，这篇教程重点在于如何创建BGP对等体和IPv6的过滤。我们演示了如何向邻居BGP路由通告IPv6前缀，和如何过滤通告前缀或获得的通告。需要注意，本教程使用的过程可能会对网络供应商的网络运作有所影响，请谨慎参考。</p><p>希望这些对你有用。</p><hr><p>via: <a href=http://xmodulo.com/ipv6-bgp-peering-filtering-quagga-bgp-router.html>http://xmodulo.com/ipv6-bgp-peering-filtering-quagga-bgp-router.html</a></p><p>作者：<a href=http://xmodulo.com/author/sarmed>Sarmed Rahman</a> 译者：<a href=https://github.com/martin2011qi>martin2011qi</a> 校对：<a href=https://github.com/wxy>wxy</a></p><p>本文由 <a href=https://github.com/LCTT/TranslateProject>LCTT</a> 原创翻译，<a href=http://linux.cn/>Linux中国</a> 荣誉推出</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/quagga/ rel=tag>Quagga</a></li><li class=tags__item><a class="tags__link btn" href=/tags/%E8%B7%AF%E7%94%B1%E5%99%A8/ rel=tag>路由器</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 Linux.cn Archive.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>